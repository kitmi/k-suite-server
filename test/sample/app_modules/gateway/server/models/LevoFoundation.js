"use strict";

require("source-map-support/register");

const {
  pascalCase
} = require('rk-utils');

const {
  Connector,
  getEntityModelOfDriver
} = require('@k-suite/oolong');

const BaseEntityModel = getEntityModelOfDriver('mysql');

class LevoFoundation {
  constructor(connection, options) {
    if (typeof connection === 'string') {
      this.connector = Connector.createConnector('mysql', connection, options);
      this._connectorOwner = true;
    } else {
      if (!(connection.driver && connection.connectionString)) {
        throw new Error("Assertion failed: connection.driver && connection.connectionString");
      }

      this.connector = connection;
      this.i18n = options;
    }

    this._modelCache = {};
  }

  model(entityName) {
    if (this._modelCache[entityName]) return this._modelCache[entityName];
    let modelClassName = pascalCase(entityName);
    if (this._modelCache[modelClassName]) return this._modelCache[modelClassName];

    const entitySpecMixin = require(`./levoFoundation/${modelClassName}`);

    let modelClass = entitySpecMixin(this, BaseEntityModel);
    this._modelCache[entityName] = modelClass;

    if (modelClassName !== entityName) {
      this._modelCache[modelClassName] = modelClass;
    }

    return modelClass;
  }

  async close_() {
    if (this._connectorOwner) {
      await this.connector.end_();
      delete this._connectorOwner;
    }

    delete this._modelCache;
    delete this.connector;
  }

}

LevoFoundation.driver = 'mysql';
LevoFoundation.schemaName = 'levoFoundation';
module.exports = LevoFoundation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbHMvTGV2b0ZvdW5kYXRpb24uanMiXSwibmFtZXMiOlsicGFzY2FsQ2FzZSIsInJlcXVpcmUiLCJDb25uZWN0b3IiLCJnZXRFbnRpdHlNb2RlbE9mRHJpdmVyIiwiQmFzZUVudGl0eU1vZGVsIiwiTGV2b0ZvdW5kYXRpb24iLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb24iLCJvcHRpb25zIiwiY29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiX2Nvbm5lY3Rvck93bmVyIiwiZHJpdmVyIiwiY29ubmVjdGlvblN0cmluZyIsImkxOG4iLCJfbW9kZWxDYWNoZSIsIm1vZGVsIiwiZW50aXR5TmFtZSIsIm1vZGVsQ2xhc3NOYW1lIiwiZW50aXR5U3BlY01peGluIiwibW9kZWxDbGFzcyIsImNsb3NlXyIsImVuZF8iLCJzY2hlbWFOYW1lIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFpQkMsT0FBTyxDQUFDLFVBQUQsQ0FBOUI7O0FBRUEsTUFBTTtBQUFFQyxFQUFBQSxTQUFGO0FBQWFDLEVBQUFBO0FBQWIsSUFBd0NGLE9BQU8sQ0FBQyxpQkFBRCxDQUFyRDs7QUFDQSxNQUFNRyxlQUFlLEdBQUdELHNCQUFzQixDQUFDLE9BQUQsQ0FBOUM7O0FBRUEsTUFBTUUsY0FBTixDQUFxQjtBQUNqQkMsRUFBQUEsV0FBVyxDQUFDQyxVQUFELEVBQWFDLE9BQWIsRUFBc0I7QUFDN0IsUUFBSSxPQUFPRCxVQUFQLEtBQXNCLFFBQTFCLEVBQW9DO0FBQ2hDLFdBQUtFLFNBQUwsR0FBaUJQLFNBQVMsQ0FBQ1EsZUFBVixDQUEwQixPQUExQixFQUFtQ0gsVUFBbkMsRUFBK0NDLE9BQS9DLENBQWpCO0FBQ0EsV0FBS0csZUFBTCxHQUF1QixJQUF2QjtBQUNILEtBSEQsTUFHTztBQUFBLFlBQ0tKLFVBQVUsQ0FBQ0ssTUFBWCxJQUFxQkwsVUFBVSxDQUFDTSxnQkFEckM7QUFBQTtBQUFBOztBQUdILFdBQUtKLFNBQUwsR0FBaUJGLFVBQWpCO0FBQ0EsV0FBS08sSUFBTCxHQUFZTixPQUFaO0FBQ0g7O0FBRUQsU0FBS08sV0FBTCxHQUFtQixFQUFuQjtBQUNIOztBQUVEQyxFQUFBQSxLQUFLLENBQUNDLFVBQUQsRUFBYTtBQUNkLFFBQUksS0FBS0YsV0FBTCxDQUFpQkUsVUFBakIsQ0FBSixFQUFrQyxPQUFPLEtBQUtGLFdBQUwsQ0FBaUJFLFVBQWpCLENBQVA7QUFFbEMsUUFBSUMsY0FBYyxHQUFHbEIsVUFBVSxDQUFDaUIsVUFBRCxDQUEvQjtBQUNBLFFBQUksS0FBS0YsV0FBTCxDQUFpQkcsY0FBakIsQ0FBSixFQUFzQyxPQUFPLEtBQUtILFdBQUwsQ0FBaUJHLGNBQWpCLENBQVA7O0FBRXRDLFVBQU1DLGVBQWUsR0FBR2xCLE9BQU8sQ0FBRSxvQkFBbUJpQixjQUFlLEVBQXBDLENBQS9COztBQUNBLFFBQUlFLFVBQVUsR0FBR0QsZUFBZSxDQUFDLElBQUQsRUFBT2YsZUFBUCxDQUFoQztBQUVBLFNBQUtXLFdBQUwsQ0FBaUJFLFVBQWpCLElBQStCRyxVQUEvQjs7QUFDQSxRQUFJRixjQUFjLEtBQUtELFVBQXZCLEVBQW1DO0FBQy9CLFdBQUtGLFdBQUwsQ0FBaUJHLGNBQWpCLElBQW1DRSxVQUFuQztBQUNIOztBQUVELFdBQU9BLFVBQVA7QUFDSDs7QUFFRCxRQUFNQyxNQUFOLEdBQWU7QUFDWCxRQUFJLEtBQUtWLGVBQVQsRUFBMEI7QUFDdEIsWUFBTSxLQUFLRixTQUFMLENBQWVhLElBQWYsRUFBTjtBQUNBLGFBQU8sS0FBS1gsZUFBWjtBQUNIOztBQUVELFdBQU8sS0FBS0ksV0FBWjtBQUNBLFdBQU8sS0FBS04sU0FBWjtBQUNIOztBQXhDZ0I7O0FBMkNyQkosY0FBYyxDQUFDTyxNQUFmLEdBQXdCLE9BQXhCO0FBQ0FQLGNBQWMsQ0FBQ2tCLFVBQWYsR0FBNEIsZ0JBQTVCO0FBRUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBCLGNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBwYXNjYWxDYXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jb25zdCB7IENvbm5lY3RvciwgZ2V0RW50aXR5TW9kZWxPZkRyaXZlciB9ID0gcmVxdWlyZSgnQGstc3VpdGUvb29sb25nJyk7XG5jb25zdCBCYXNlRW50aXR5TW9kZWwgPSBnZXRFbnRpdHlNb2RlbE9mRHJpdmVyKCdteXNxbCcpO1xuXG5jbGFzcyBMZXZvRm91bmRhdGlvbiB7XG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIGlmICh0eXBlb2YgY29ubmVjdGlvbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdG9yID0gQ29ubmVjdG9yLmNyZWF0ZUNvbm5lY3RvcignbXlzcWwnLCBjb25uZWN0aW9uLCBvcHRpb25zKTtcbiAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rvck93bmVyID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHsgIFxuICAgICAgICAgICAgYXNzZXJ0OiBjb25uZWN0aW9uLmRyaXZlciAmJiBjb25uZWN0aW9uLmNvbm5lY3Rpb25TdHJpbmc7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdGlvbjtcbiAgICAgICAgICAgIHRoaXMuaTE4biA9IG9wdGlvbnM7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9tb2RlbENhY2hlID0ge307XG4gICAgfVxuXG4gICAgbW9kZWwoZW50aXR5TmFtZSkge1xuICAgICAgICBpZiAodGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXSkgcmV0dXJuIHRoaXMuX21vZGVsQ2FjaGVbZW50aXR5TmFtZV07XG5cbiAgICAgICAgbGV0IG1vZGVsQ2xhc3NOYW1lID0gcGFzY2FsQ2FzZShlbnRpdHlOYW1lKTtcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsQ2FjaGVbbW9kZWxDbGFzc05hbWVdKSByZXR1cm4gdGhpcy5fbW9kZWxDYWNoZVttb2RlbENsYXNzTmFtZV07XG5cbiAgICAgICAgY29uc3QgZW50aXR5U3BlY01peGluID0gcmVxdWlyZShgLi9sZXZvRm91bmRhdGlvbi8ke21vZGVsQ2xhc3NOYW1lfWApOyAgICAgICAgXG4gICAgICAgIGxldCBtb2RlbENsYXNzID0gZW50aXR5U3BlY01peGluKHRoaXMsIEJhc2VFbnRpdHlNb2RlbCk7XG5cbiAgICAgICAgdGhpcy5fbW9kZWxDYWNoZVtlbnRpdHlOYW1lXSA9IG1vZGVsQ2xhc3M7XG4gICAgICAgIGlmIChtb2RlbENsYXNzTmFtZSAhPT0gZW50aXR5TmFtZSkge1xuICAgICAgICAgICAgdGhpcy5fbW9kZWxDYWNoZVttb2RlbENsYXNzTmFtZV0gPSBtb2RlbENsYXNzO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbW9kZWxDbGFzcztcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZV8oKSB7XG4gICAgICAgIGlmICh0aGlzLl9jb25uZWN0b3JPd25lcikge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jb25uZWN0b3IuZW5kXygpO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2Nvbm5lY3Rvck93bmVyO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuX21vZGVsQ2FjaGU7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbm5lY3RvcjtcbiAgICB9XG59XG5cbkxldm9Gb3VuZGF0aW9uLmRyaXZlciA9ICdteXNxbCc7XG5MZXZvRm91bmRhdGlvbi5zY2hlbWFOYW1lID0gJ2xldm9Gb3VuZGF0aW9uJztcblxubW9kdWxlLmV4cG9ydHMgPSBMZXZvRm91bmRhdGlvbjsiXX0=
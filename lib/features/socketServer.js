"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  urlJoin
} = require('rk-utils');

const {
  Feature,
  Literal
} = require('..').enum;

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const SocketServer = tryRequire('socket.io');

const {
  InvalidConfiguration
} = require('../Errors');

function loadEventHandler(appModule, channelName, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, `socketServer.channels.${channelName}.middlewares`);
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.channels.${channelName}.events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, `socketServer.channels.${channelName}.middlewares`);
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.channels.${channelName}.events`);
    }
  }

  return middlewareHandler;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, config) => {
    let io,
        standalone = false;
    let endpointPath = config.path ? urlJoin(appModule.route, config.path) : appModule.route;
    appModule.log('verbose', 'Socket server listening path: ' + endpointPath);
    let options = {
      path: endpointPath
    };

    if (config.port) {
      io = new SocketServer(options);
      standalone = true;
    } else {
      io = new SocketServer(appModule.server.httpServer, options);
    }

    let logger;

    if (config.logger) {
      logger = appModule.getService('logger:' + config.logger);
    }

    if (_.isEmpty(config.channels)) {
      throw new InvalidConfiguration('Missing channels config.', appModule, 'socketServer.channels');
    }

    let controllersPath = path.join(appModule.backendPath, Literal.REMOTE_CALLS_PATH);

    _.forOwn(config.channels, (info, name) => {
      let ioChannel = io.of(name);

      if (logger) {
        ioChannel.use((socket, next) => {
          next && next();
          logger.info('Access from [' + socket.id + '].');
        });
      }

      if (info.middlewares) {
        let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
        m.forEach(middlewareName => {
          ioChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
        });
      }

      let eventHandlers;

      if (info.controller) {
        if (info.events) {
          appModule.log('warn', 'When controller is set for a rpc endpoint, "events" hooks will be ignored.');
        }

        let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
        eventHandlers = require(rpcControllerPath);
      } else if (info.events) {
        eventHandlers = {};

        _.forOwn(info.events, (handler, event) => {
          eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
        });
      }

      if (_.isEmpty(eventHandlers)) {
        throw new InvalidConfiguration('Missing socket response controller or event hooks.', appModule, `socketServer.channels.${name}`);
      }

      ioChannel.on('connection', function (socket) {
        _.forOwn(eventHandlers, (handler, event) => {
          socket.on(event, (data, cb) => {
            logger && logger.log('verbose', 'Socket client event emitted: ' + event + ', argument number: ' + arguments.length);
            console.log('arg0: ' + data);
            handler({
              appModule,
              socket
            }, data).then(res => cb(res));
          });
        });

        logger && logger.log('verbose', 'Socket client connected.');

        if (info.welcomeMessage) {
          socket.emit('welcome', info.welcomeMessage);
        }
      });
    });

    if (standalone) {
      io.listen(config.port);
      appModule.log('info', `A socket server is listening on port [${config.port}] ...`);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsSm9pbiIsIkZlYXR1cmUiLCJMaXRlcmFsIiwiZW51bSIsInRyeVJlcXVpcmUiLCJTb2NrZXRTZXJ2ZXIiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsImxvYWRFdmVudEhhbmRsZXIiLCJhcHBNb2R1bGUiLCJjaGFubmVsTmFtZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJQTFVHSU4iLCJsb2FkXyIsImNvbmZpZyIsImlvIiwic3RhbmRhbG9uZSIsImVuZHBvaW50UGF0aCIsInJvdXRlIiwibG9nIiwib3B0aW9ucyIsInBvcnQiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwibG9nZ2VyIiwiZ2V0U2VydmljZSIsImlzRW1wdHkiLCJjaGFubmVscyIsImNvbnRyb2xsZXJzUGF0aCIsImpvaW4iLCJiYWNrZW5kUGF0aCIsIlJFTU9URV9DQUxMU19QQVRIIiwiZm9yT3duIiwiaW5mbyIsIm5hbWUiLCJpb0NoYW5uZWwiLCJvZiIsInVzZSIsInNvY2tldCIsIm5leHQiLCJpZCIsIm1pZGRsZXdhcmVzIiwibSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJtaWRkbGV3YXJlTmFtZSIsImV2ZW50SGFuZGxlcnMiLCJldmVudHMiLCJycGNDb250cm9sbGVyUGF0aCIsImhhbmRsZXIiLCJldmVudCIsIm9uIiwiZGF0YSIsImNiIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiY29uc29sZSIsInRoZW4iLCJyZXMiLCJ3ZWxjb21lTWVzc2FnZSIsImVtaXQiLCJs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NUMsVUFBSixFQUFnQjtBQUNaRCxNQUFBQSxFQUFFLENBQUMrQyxNQUFILENBQVVoRCxNQUFNLENBQUNPLElBQWpCO0FBQ0ExQixNQUFBQSxTQUFTLENBQUN3QixHQUFWLENBQWMsTUFBZCxFQUF1Qix5Q0FBd0NMLE1BQU0sQ0FBQ08sSUFBSyxPQUEzRTtBQUNIO0FBQ0o7QUFsSFksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuLyoqXG4gKiBTb2NrZXQgYmFzZWQgUnBjIFNlcnZlclxuICogQG1vZHVsZSBGZWF0dXJlX1NvY2tldFNlcnZlclxuICovXG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIHVybEpvaW4gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IEZlYXR1cmUsIExpdGVyYWwgfSA9IHJlcXVpcmUoJy4uJykuZW51bTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBTb2NrZXRTZXJ2ZXIgPSB0cnlSZXF1aXJlKCdzb2NrZXQuaW8nKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuXG5mdW5jdGlvbiBsb2FkRXZlbnRIYW5kbGVyKGFwcE1vZHVsZSwgY2hhbm5lbE5hbWUsIGNvbnRyb2xsZXJCYXNlUGF0aCwgaGFuZGxlck5hbWUsIGlzTWlkZGxld2FyZSA9IGZhbHNlKSB7XG4gICAgbGV0IHBvcyA9IGhhbmRsZXJOYW1lLmxhc3RJbmRleE9mKCcuJyk7XG4gICAgaWYgKHBvcyA8IDApIHtcbiAgICAgICAgaWYgKGlzTWlkZGxld2FyZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBJbnZhbGlkIG1pZGRsZXdhcmUgcmVmZXJlbmNlOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXIuY2hhbm5lbHMuJHtjaGFubmVsTmFtZX0ubWlkZGxld2FyZXNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXIuY2hhbm5lbHMuJHtjaGFubmVsTmFtZX0uZXZlbnRzYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBjb250cm9sbGVyID0gaGFuZGxlck5hbWUuc3Vic3RyKDAsIHBvcyk7XG4gICAgbGV0IGFjdGlvbiA9IGhhbmRsZXJOYW1lLnN1YnN0cihwb3MgKyAxKTtcblxuICAgIGxldCBjb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyQmFzZVBhdGgsIGNvbnRyb2xsZXIgKyAnLmpzJyk7XG4gICAgbGV0IGN0cmwgPSByZXF1aXJlKGNvbnRyb2xsZXJQYXRoKTtcbiAgICBsZXQgbWlkZGxld2FyZUhhbmRsZXIgPSBjdHJsW2FjdGlvbl07XG4gICAgaWYgKHR5cGVvZiBtaWRkbGV3YXJlSGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBpZiAoaXNNaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgYE1pZGRsZXdhcmUgZnVuY3Rpb24gbm90IGZvdW5kOiAke2hhbmRsZXJOYW1lfWAsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXIuY2hhbm5lbHMuJHtjaGFubmVsTmFtZX0ubWlkZGxld2FyZXNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBFdmVudCBoYW5kbGVyIGZ1bmN0aW9uIG5vdCBmb3VuZDogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7Y2hhbm5lbE5hbWV9LmV2ZW50c2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWlkZGxld2FyZUhhbmRsZXI7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBwbHVnaW4gc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5QTFVHSU4sXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBycGMgU2VydmVyXG4gICAgICogQHBhcmFtIHtBcHBNb2R1bGV9IGFwcE1vZHVsZSAtIFRoZSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgLSBScGMgc2VydmVyIGNvbmZpZ1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbY29uZmlnLnBhdGhdIC0gVGhlIHBhdGggb2Ygc29ja2V0IHNlcnZlclxuICAgICAqIEBwcm9wZXJ0eSB7aW50fSBbY29uZmlnLnBvcnRdIC0gVGhlIHBvcnQgbnVtYmVyIG9mIHRoZSBzZXJ2ZXJcbiAgICAgKiBAcHJvcGVydHkge09iamVjdC48c3RyaW5nLCBPYmplY3Q+fSBbY29uZmlnLmNoYW5uZWxzXSAtIENoYW5uZWxzXG4gICAgICovXG4gICAgbG9hZF86IChhcHBNb2R1bGUsIGNvbmZpZykgPT4geyAgICAgICAgXG4gICAgICAgIGxldCBpbywgc3RhbmRhbG9uZSA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgbGV0IGVuZHBvaW50UGF0aCA9IGNvbmZpZy5wYXRoID8gdXJsSm9pbihhcHBNb2R1bGUucm91dGUsIGNvbmZpZy5wYXRoKSA6IGFwcE1vZHVsZS5yb3V0ZTtcbiAgICAgICAgYXBwTW9kdWxlLmxvZygndmVyYm9zZScsICdTb2NrZXQgc2VydmVyIGxpc3RlbmluZyBwYXRoOiAnICsgZW5kcG9pbnRQYXRoKTtcblxuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHBhdGg6IGVuZHBvaW50UGF0aFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChjb25maWcucG9ydCkge1xuICAgICAgICAgICAgaW8gPSBuZXcgU29ja2V0U2VydmVyKG9wdGlvbnMpO1xuICAgICAgICAgICAgc3RhbmRhbG9uZSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbyA9IG5ldyBTb2NrZXRTZXJ2ZXIoYXBwTW9kdWxlLnNlcnZlci5odHRwU2VydmVyLCBvcHRpb25zKVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGxvZ2dlcjtcbiAgICAgICAgaWYgKGNvbmZpZy5sb2dnZXIpIHtcbiAgICAgICAgICAgIGxvZ2dlciA9IGFwcE1vZHVsZS5nZXRTZXJ2aWNlKCdsb2dnZXI6JyArIGNvbmZpZy5sb2dnZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKF8uaXNFbXB0eShjb25maWcuY2hhbm5lbHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgJ01pc3NpbmcgY2hhbm5lbHMgY29uZmlnLicsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlLFxuICAgICAgICAgICAgICAgICdzb2NrZXRTZXJ2ZXIuY2hhbm5lbHMnXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbnRyb2xsZXJzUGF0aCA9IHBhdGguam9pbihhcHBNb2R1bGUuYmFja2VuZFBhdGgsIExpdGVyYWwuUkVNT1RFX0NBTExTX1BBVEgpO1xuXG4gICAgICAgIF8uZm9yT3duKGNvbmZpZy5jaGFubmVscywgKGluZm8sIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBpb0NoYW5uZWwgPSBpby5vZihuYW1lKTtcblxuICAgICAgICAgICAgaWYgKGxvZ2dlcikge1xuICAgICAgICAgICAgICAgIGlvQ2hhbm5lbC51c2UoKHNvY2tldCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBuZXh0ICYmIG5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ0FjY2VzcyBmcm9tIFsnICsgc29ja2V0LmlkICsgJ10uJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpbmZvLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgICAgICAgICAgbGV0IG0gPSBBcnJheS5pc0FycmF5KGluZm8ubWlkZGxld2FyZXMpID8gaW5mby5taWRkbGV3YXJlcyA6IFsgaW5mby5taWRkbGV3YXJlcyBdO1xuICAgICAgICAgICAgICAgIG0uZm9yRWFjaChtaWRkbGV3YXJlTmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlvQ2hhbm5lbC51c2UobG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgbWlkZGxld2FyZU5hbWUsIHRydWUpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGV2ZW50SGFuZGxlcnM7XG5cbiAgICAgICAgICAgIGlmIChpbmZvLmNvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5mby5ldmVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwTW9kdWxlLmxvZygnd2FybicsICdXaGVuIGNvbnRyb2xsZXIgaXMgc2V0IGZvciBhIHJwYyBlbmRwb2ludCwgXCJldmVudHNcIiBob29rcyB3aWxsIGJlIGlnbm9yZWQuJyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IHJwY0NvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJzUGF0aCwgaW5mby5jb250cm9sbGVyICsgJy5qcycpO1xuICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlcnMgPSByZXF1aXJlKHJwY0NvbnRyb2xsZXJQYXRoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5mby5ldmVudHMpIHtcbiAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzID0ge307XG5cbiAgICAgICAgICAgICAgICBfLmZvck93bihpbmZvLmV2ZW50cywgKGhhbmRsZXIsIGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlcnNbZXZlbnRdID0gbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIG5hbWUsIGNvbnRyb2xsZXJzUGF0aCwgaGFuZGxlcik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChfLmlzRW1wdHkoZXZlbnRIYW5kbGVycykpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICdNaXNzaW5nIHNvY2tldCByZXNwb25zZSBjb250cm9sbGVyIG9yIGV2ZW50IGhvb2tzLicsXG4gICAgICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICAgICAgYHNvY2tldFNlcnZlci5jaGFubmVscy4ke25hbWV9YFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlvQ2hhbm5lbC5vbignY29ubmVjdGlvbicsIGZ1bmN0aW9uIChzb2NrZXQpIHtcbiAgICAgICAgICAgICAgICAvL1JlZ2lzdGVyIGV2ZW50IGhhbmRsZXJzXG4gICAgICAgICAgICAgICAgXy5mb3JPd24oZXZlbnRIYW5kbGVycywgKGhhbmRsZXIsIGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5vbihldmVudCwgKGRhdGEsIGNiKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIgJiYgbG9nZ2VyLmxvZygndmVyYm9zZScsICdTb2NrZXQgY2xpZW50IGV2ZW50IGVtaXR0ZWQ6ICcgKyBldmVudCArICcsIGFyZ3VtZW50IG51bWJlcjogJyArIGFyZ3VtZW50cy5sZW5ndGgpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYXJnMDogJyArIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyKHsgYXBwTW9kdWxlLCBzb2NrZXQgfSwgZGF0YSkudGhlbigocmVzKSA9PiBjYihyZXMpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBsb2dnZXIgJiYgbG9nZ2VyLmxvZygndmVyYm9zZScsICdTb2NrZXQgY2xpZW50IGNvbm5lY3RlZC4nKTtcblxuICAgICAgICAgICAgICAgIGlmIChpbmZvLndlbGNvbWVNZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KCd3ZWxjb21lJywgaW5mby53ZWxjb21lTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChzdGFuZGFsb25lKSB7XG4gICAgICAgICAgICBpby5saXN0ZW4oY29uZmlnLnBvcnQpO1xuICAgICAgICAgICAgYXBwTW9kdWxlLmxvZygnaW5mbycsIGBBIHNvY2tldCBzZXJ2ZXIgaXMgbGlzdGVuaW5nIG9uIHBvcnQgWyR7Y29uZmlnLnBvcnR9XSAuLi5gKTtcbiAgICAgICAgfVxuICAgIH1cbn07Il19
"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  urlJoin
} = require('rk-utils');

const {
  Feature,
  Literal
} = require('..').enum;

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const SocketServer = tryRequire('socket.io');

const {
  InvalidConfiguration
} = require('../utils/Errors');

function loadEventHandler(appModule, channelName, controllerBasePath, handlerName, isMiddleware = false) {
  let pos = handlerName.lastIndexOf('.');

  if (pos < 0) {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Invalid middleware reference: ${handlerName}`, appModule, `socketServer.channels.${channelName}.middlewares`);
    } else {
      throw new InvalidConfiguration(`Invalid event handler reference: ${handlerName}`, appModule, `socketServer.channels.${channelName}.events`);
    }
  }

  let controller = handlerName.substr(0, pos);
  let action = handlerName.substr(pos + 1);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let middlewareHandler = ctrl[action];

  if (typeof middlewareHandler !== 'function') {
    if (isMiddleware) {
      throw new InvalidConfiguration(`Middleware function not found: ${handlerName}`, appModule, `socketServer.channels.${channelName}.middlewares`);
    } else {
      throw new InvalidConfiguration(`Event handler function not found: ${handlerName}`, appModule, `socketServer.channels.${channelName}.events`);
    }
  }

  return middlewareHandler;
}

module.exports = {
  type: Feature.PLUGIN,
  load_: (appModule, config) => {
    let io,
        standalone = false;
    let endpointPath = config.path ? urlJoin(appModule.route, config.path) : appModule.route;
    appModule.log('verbose', 'Socket server listening path: ' + endpointPath);
    let options = {
      path: endpointPath
    };

    if (config.port) {
      io = new SocketServer(options);
      standalone = true;
    } else {
      io = new SocketServer(appModule.server.httpServer, options);
    }

    let logger;

    if (config.logger) {
      logger = appModule.getService('logger:' + config.logger);
    }

    if (_.isEmpty(config.channels)) {
      throw new InvalidConfiguration('Missing channels config.', appModule, 'socketServer.channels');
    }

    let controllersPath = path.join(appModule.backendPath, Literal.REMOTE_CALLS_PATH);

    _.forOwn(config.channels, (info, name) => {
      let ioChannel = io.of(name);

      if (logger) {
        ioChannel.use((socket, next) => {
          next && next();
          logger.info('Access from [' + socket.id + '].');
        });
      }

      if (info.middlewares) {
        let m = Array.isArray(info.middlewares) ? info.middlewares : [info.middlewares];
        m.forEach(middlewareName => {
          ioChannel.use(loadEventHandler(appModule, name, controllersPath, middlewareName, true));
        });
      }

      let eventHandlers;

      if (info.controller) {
        if (info.events) {
          appModule.log('warn', 'When controller is set for a rpc endpoint, "events" hooks will be ignored.');
        }

        let rpcControllerPath = path.resolve(controllersPath, info.controller + '.js');
        eventHandlers = require(rpcControllerPath);
      } else if (info.events) {
        eventHandlers = {};

        _.forOwn(info.events, (handler, event) => {
          eventHandlers[event] = loadEventHandler(appModule, name, controllersPath, handler);
        });
      }

      if (_.isEmpty(eventHandlers)) {
        throw new InvalidConfiguration('Missing socket response controller or event hooks.', appModule, `socketServer.channels.${name}`);
      }

      ioChannel.on('connection', function (socket) {
        _.forOwn(eventHandlers, (handler, event) => {
          socket.on(event, (data, cb) => {
            logger && logger.log('verbose', 'Socket client event emitted: ' + event + ', argument number: ' + arguments.length);
            console.log('arg0: ' + data);
            handler({
              appModule,
              socket
            }, data).then(res => cb(res));
          });
        });

        logger && logger.log('verbose', 'Socket client connected.');

        if (info.welcomeMessage) {
          socket.emit('welcome', info.welcomeMessage);
        }
      });
    });

    if (standalone) {
      io.listen(config.port);
      appModule.log('info', `A socket server is listening on port [${config.port}] ...`);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwidXJsSm9pbiIsIkZlYXR1cmUiLCJMaXRlcmFsIiwiZW51bSIsInRyeVJlcXVpcmUiLCJTb2NrZXRTZXJ2ZXIiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsImxvYWRFdmVudEhhbmRsZXIiLCJhcHBNb2R1bGUiLCJjaGFubmVsTmFtZSIsImNvbnRyb2xsZXJCYXNlUGF0aCIsImhhbmRsZXJOYW1lIiwiaXNNaWRkbGV3YXJlIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlclBhdGgiLCJyZXNvbHZlIiwiY3RybCIsIm1pZGRsZXdhcmVIYW5kbGVyIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJQTFVHSU4iLCJsb2FkXyIsImNvbmZpZyIsImlvIiwic3RhbmRhbG9uZSIsImVuZHBvaW50UGF0aCIsInJvdXRlIiwibG9nIiwib3B0aW9ucyIsInBvcnQiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwibG9nZ2VyIiwiZ2V0U2VydmljZSIsImlzRW1wdHkiLCJjaGFubmVscyIsImNvbnRyb2xsZXJzUGF0aCIsImpvaW4iLCJiYWNrZW5kUGF0aCIsIlJFTU9URV9DQUxMU19QQVRIIiwiZm9yT3duIiwiaW5mbyIsIm5hbWUiLCJpb0NoYW5uZWwiLCJvZiIsInVzZSIsInNvY2tldCIsIm5leHQiLCJpZCIsIm1pZGRsZXdhcmVzIiwibSIsIkFycmF5IiwiaXNBcnJheSIsImZvckVhY2giLCJtaWRkbGV3YXJlTmFtZSIsImV2ZW50SGFuZGxlcnMiLCJldmVudHMiLCJycGNDb250cm9sbGVyUGF0aCIsImhhbmRsZXIiLCJldmVudCIsIm9uIiwiZGF0YSIsImNiIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiY29uc29sZSIsInRoZW4iLCJyZXMiLCJ3ZWxjb21lTWVzc2FnZSIsImVtaXQiLCJs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STVDLFVBQUosRUFBZ0I7QUFDWkQsTUFBQUEsRUFBRSxDQUFDK0MsTUFBSCxDQUFVaEQsTUFBTSxDQUFDTyxJQUFqQjtBQUNBMUIsTUFBQUEsU0FBUyxDQUFDd0IsR0FBVixDQUFjLE1BQWQsRUFBdUIseUNBQXdDTCxNQUFNLENBQUNPLElBQUssT0FBM0U7QUFDSDtBQUNKO0FBbEhZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogU29ja2V0IGJhc2VkIFJwYyBTZXJ2ZXJcbiAqIEBtb2R1bGUgRmVhdHVyZV9Tb2NrZXRTZXJ2ZXJcbiAqL1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCB1cmxKb2luIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBGZWF0dXJlLCBMaXRlcmFsIH0gPSByZXF1aXJlKCcuLicpLmVudW07XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgU29ja2V0U2VydmVyID0gdHJ5UmVxdWlyZSgnc29ja2V0LmlvJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi91dGlscy9FcnJvcnMnKTtcblxuZnVuY3Rpb24gbG9hZEV2ZW50SGFuZGxlcihhcHBNb2R1bGUsIGNoYW5uZWxOYW1lLCBjb250cm9sbGVyQmFzZVBhdGgsIGhhbmRsZXJOYW1lLCBpc01pZGRsZXdhcmUgPSBmYWxzZSkge1xuICAgIGxldCBwb3MgPSBoYW5kbGVyTmFtZS5sYXN0SW5kZXhPZignLicpO1xuICAgIGlmIChwb3MgPCAwKSB7XG4gICAgICAgIGlmIChpc01pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgSW52YWxpZCBtaWRkbGV3YXJlIHJlZmVyZW5jZTogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7Y2hhbm5lbE5hbWV9Lm1pZGRsZXdhcmVzYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgSW52YWxpZCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZTogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7Y2hhbm5lbE5hbWV9LmV2ZW50c2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgY29udHJvbGxlciA9IGhhbmRsZXJOYW1lLnN1YnN0cigwLCBwb3MpO1xuICAgIGxldCBhY3Rpb24gPSBoYW5kbGVyTmFtZS5zdWJzdHIocG9zICsgMSk7XG5cbiAgICBsZXQgY29udHJvbGxlclBhdGggPSBwYXRoLnJlc29sdmUoY29udHJvbGxlckJhc2VQYXRoLCBjb250cm9sbGVyICsgJy5qcycpO1xuICAgIGxldCBjdHJsID0gcmVxdWlyZShjb250cm9sbGVyUGF0aCk7XG4gICAgbGV0IG1pZGRsZXdhcmVIYW5kbGVyID0gY3RybFthY3Rpb25dO1xuICAgIGlmICh0eXBlb2YgbWlkZGxld2FyZUhhbmRsZXIgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgaWYgKGlzTWlkZGxld2FyZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGBNaWRkbGV3YXJlIGZ1bmN0aW9uIG5vdCBmb3VuZDogJHtoYW5kbGVyTmFtZX1gLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICBgc29ja2V0U2VydmVyLmNoYW5uZWxzLiR7Y2hhbm5lbE5hbWV9Lm1pZGRsZXdhcmVzYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICBgRXZlbnQgaGFuZGxlciBmdW5jdGlvbiBub3QgZm91bmQ6ICR7aGFuZGxlck5hbWV9YCxcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgYHNvY2tldFNlcnZlci5jaGFubmVscy4ke2NoYW5uZWxOYW1lfS5ldmVudHNgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1pZGRsZXdhcmVIYW5kbGVyO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgcGx1Z2luIHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuUExVR0lOLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgcnBjIFNlcnZlclxuICAgICAqIEBwYXJhbSB7QXBwTW9kdWxlfSBhcHBNb2R1bGUgLSBUaGUgYXBwIG1vZHVsZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIC0gUnBjIHNlcnZlciBjb25maWdcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbmZpZy5wYXRoXSAtIFRoZSBwYXRoIG9mIHNvY2tldCBzZXJ2ZXJcbiAgICAgKiBAcHJvcGVydHkge2ludH0gW2NvbmZpZy5wb3J0XSAtIFRoZSBwb3J0IG51bWJlciBvZiB0aGUgc2VydmVyXG4gICAgICogQHByb3BlcnR5IHtPYmplY3QuPHN0cmluZywgT2JqZWN0Pn0gW2NvbmZpZy5jaGFubmVsc10gLSBDaGFubmVsc1xuICAgICAqL1xuICAgIGxvYWRfOiAoYXBwTW9kdWxlLCBjb25maWcpID0+IHsgICAgICAgIFxuICAgICAgICBsZXQgaW8sIHN0YW5kYWxvbmUgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIGxldCBlbmRwb2ludFBhdGggPSBjb25maWcucGF0aCA/IHVybEpvaW4oYXBwTW9kdWxlLnJvdXRlLCBjb25maWcucGF0aCkgOiBhcHBNb2R1bGUucm91dGU7XG4gICAgICAgIGFwcE1vZHVsZS5sb2coJ3ZlcmJvc2UnLCAnU29ja2V0IHNlcnZlciBsaXN0ZW5pbmcgcGF0aDogJyArIGVuZHBvaW50UGF0aCk7XG5cbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICBwYXRoOiBlbmRwb2ludFBhdGhcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY29uZmlnLnBvcnQpIHtcbiAgICAgICAgICAgIGlvID0gbmV3IFNvY2tldFNlcnZlcihvcHRpb25zKTtcbiAgICAgICAgICAgIHN0YW5kYWxvbmUgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW8gPSBuZXcgU29ja2V0U2VydmVyKGFwcE1vZHVsZS5zZXJ2ZXIuaHR0cFNlcnZlciwgb3B0aW9ucylcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsb2dnZXI7XG4gICAgICAgIGlmIChjb25maWcubG9nZ2VyKSB7XG4gICAgICAgICAgICBsb2dnZXIgPSBhcHBNb2R1bGUuZ2V0U2VydmljZSgnbG9nZ2VyOicgKyBjb25maWcubG9nZ2VyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChfLmlzRW1wdHkoY29uZmlnLmNoYW5uZWxzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICdNaXNzaW5nIGNoYW5uZWxzIGNvbmZpZy4nLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZSxcbiAgICAgICAgICAgICAgICAnc29ja2V0U2VydmVyLmNoYW5uZWxzJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb250cm9sbGVyc1BhdGggPSBwYXRoLmpvaW4oYXBwTW9kdWxlLmJhY2tlbmRQYXRoLCBMaXRlcmFsLlJFTU9URV9DQUxMU19QQVRIKTtcblxuICAgICAgICBfLmZvck93bihjb25maWcuY2hhbm5lbHMsIChpbmZvLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgaW9DaGFubmVsID0gaW8ub2YobmFtZSk7XG5cbiAgICAgICAgICAgIGlmIChsb2dnZXIpIHtcbiAgICAgICAgICAgICAgICBpb0NoYW5uZWwudXNlKChzb2NrZXQsIG5leHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dCAmJiBuZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdBY2Nlc3MgZnJvbSBbJyArIHNvY2tldC5pZCArICddLicpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaW5mby5taWRkbGV3YXJlcykge1xuICAgICAgICAgICAgICAgIGxldCBtID0gQXJyYXkuaXNBcnJheShpbmZvLm1pZGRsZXdhcmVzKSA/IGluZm8ubWlkZGxld2FyZXMgOiBbIGluZm8ubWlkZGxld2FyZXMgXTtcbiAgICAgICAgICAgICAgICBtLmZvckVhY2gobWlkZGxld2FyZU5hbWUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpb0NoYW5uZWwudXNlKGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lLCBjb250cm9sbGVyc1BhdGgsIG1pZGRsZXdhcmVOYW1lLCB0cnVlKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBldmVudEhhbmRsZXJzO1xuXG4gICAgICAgICAgICBpZiAoaW5mby5jb250cm9sbGVyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGluZm8uZXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ3dhcm4nLCAnV2hlbiBjb250cm9sbGVyIGlzIHNldCBmb3IgYSBycGMgZW5kcG9pbnQsIFwiZXZlbnRzXCIgaG9va3Mgd2lsbCBiZSBpZ25vcmVkLicpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBycGNDb250cm9sbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShjb250cm9sbGVyc1BhdGgsIGluZm8uY29udHJvbGxlciArICcuanMnKTtcbiAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzID0gcmVxdWlyZShycGNDb250cm9sbGVyUGF0aCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGluZm8uZXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVycyA9IHt9O1xuXG4gICAgICAgICAgICAgICAgXy5mb3JPd24oaW5mby5ldmVudHMsIChoYW5kbGVyLCBldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXJzW2V2ZW50XSA9IGxvYWRFdmVudEhhbmRsZXIoYXBwTW9kdWxlLCBuYW1lLCBjb250cm9sbGVyc1BhdGgsIGhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGV2ZW50SGFuZGxlcnMpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAnTWlzc2luZyBzb2NrZXQgcmVzcG9uc2UgY29udHJvbGxlciBvciBldmVudCBob29rcy4nLFxuICAgICAgICAgICAgICAgICAgICBhcHBNb2R1bGUsXG4gICAgICAgICAgICAgICAgICAgIGBzb2NrZXRTZXJ2ZXIuY2hhbm5lbHMuJHtuYW1lfWBcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpb0NoYW5uZWwub24oJ2Nvbm5lY3Rpb24nLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgICAgICAgICAgICAgLy9SZWdpc3RlciBldmVudCBoYW5kbGVyc1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGV2ZW50SGFuZGxlcnMsIChoYW5kbGVyLCBldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXQub24oZXZlbnQsIChkYXRhLCBjYikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyICYmIGxvZ2dlci5sb2coJ3ZlcmJvc2UnLCAnU29ja2V0IGNsaWVudCBldmVudCBlbWl0dGVkOiAnICsgZXZlbnQgKyAnLCBhcmd1bWVudCBudW1iZXI6ICcgKyBhcmd1bWVudHMubGVuZ3RoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2FyZzA6ICcgKyBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcih7IGFwcE1vZHVsZSwgc29ja2V0IH0sIGRhdGEpLnRoZW4oKHJlcykgPT4gY2IocmVzKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgbG9nZ2VyICYmIGxvZ2dlci5sb2coJ3ZlcmJvc2UnLCAnU29ja2V0IGNsaWVudCBjb25uZWN0ZWQuJyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5mby53ZWxjb21lTWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnd2VsY29tZScsIGluZm8ud2VsY29tZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoc3RhbmRhbG9uZSkge1xuICAgICAgICAgICAgaW8ubGlzdGVuKGNvbmZpZy5wb3J0KTtcbiAgICAgICAgICAgIGFwcE1vZHVsZS5sb2coJ2luZm8nLCBgQSBzb2NrZXQgc2VydmVyIGlzIGxpc3RlbmluZyBvbiBwb3J0IFske2NvbmZpZy5wb3J0fV0gLi4uYCk7XG4gICAgICAgIH1cbiAgICB9XG59OyJdfQ==
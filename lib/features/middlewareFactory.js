"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  Feature
} = require('..').enum;

const {
  InvalidConfiguration
} = require('../Errors');

module.exports = {
  type: Feature.INIT,
  load_: (app, factories) => {
    _.forOwn(factories, (factoryInfo, name) => {
      app.registerMiddlewareFactory(name, (opt, ownerApp) => {
        if (!_.isEmpty(opt)) {
          throw new Error(`Pre-configured middleware factory "${name}" should be used with empty options.`);
        }

        let chains;

        if (_.isPlainObject(factoryInfo)) {
          chains = [];

          _.forOwn(factoryInfo, (options, middleware) => {
            chains.push(app.getMiddlewareFactory(middleware)(options, ownerApp));
          });
        } else if (Array.isArray(factoryInfo)) {
          chains = factoryInfo.map((middlewareInfo, i) => {
            if (_.isPlainObject(middlewareInfo)) {
              if (!middlewareInfo.name) {
                throw new InvalidConfiguration('Missing referenced middleware name.', app, `middlewareFactory.${name}[${i}].name`);
              }

              return app.getMiddlewareFactory(middlewareInfo.name)(middlewareInfo.options, ownerApp);
            }

            if (Array.isArray(middlewareInfo)) {
              if (middlewareInfo.length < 1 || middlewareInfo.length > 2 || typeof middlewareInfo[0] !== 'string') {
                throw new InvalidConfiguration('Invalid middleware factory item config.', app, `middlewareFactory.${name}[${i}]`);
              }

              return app.getMiddlewareFactory(middlewareInfo[0])(middlewareInfo.length > 1 ? middlewareInfo[1] : undefined, ownerApp);
            }

            if (typeof middlewareInfo === 'string') {
              return app.getMiddlewareFactory(middlewareInfo)(undefined, ownerApp);
            }

            throw new InvalidConfiguration('Invalid middleware factory item config.', app, `middlewareFactory.${name}[${i}]`);
          });
        } else {
          throw new InvalidConfiguration('Invalid middleware factory config.', app, `middlewareFactory.${name}`);
        }

        return chains.length === 1 ? chains[0] : chains;
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9taWRkbGV3YXJlRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkZlYXR1cmUiLCJlbnVtIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIklOSVQiLCJsb2FkXyIsImFwcCIsImZhY3RvcmllcyIsImZvck93biIsImZhY3RvcnlJbmZvIiwibmFtZSIsInJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkiLCJvcHQiLCJvd25lckFwcCIsImlzRW1wdHkiLCJjaGFpbnMiLCJpc1BsYWluT2JqZWN0Iiwib3B0aW9ucyIsIm1pZGRsZXdhcmUiLCJwdXNoIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJtaWRkbGV3YXJlSW5mbyIsImkiLCJsZW5ndGgiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBNEJBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBY0QsT0FBTyxDQUFDLElBQUQsQ0FBUCxDQUFjRSxJQUFsQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBMkJILE9BQU8sQ0FBQyxXQUFELENBQXhDOztBQUdBSSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFLYkMsRUFBQUEsSUFBSSxFQUFFTCxPQUFPLENBQUNNLElBTEQ7QUFhYkMsRUFBQUEsS0FBSyxFQUFFLENBQUNDLEdBQUQsRUFBTUMsU0FBTixLQUFvQjtBQUN2QlgsSUFBQUEsQ0FBQyxDQUFDWSxNQUFGLENBQVNELFNBQVQsRUFBb0IsQ0FBQ0UsV0FBRCxFQUFjQyxJQUFkLEtBQXVCO0FBQ3ZDSixNQUFBQSxHQUFHLENBQUNLLHlCQUFKLENBQThCRCxJQUE5QixFQUFvQyxDQUFDRSxHQUFELEVBQU1DLFFBQU4sS0FBbUI7QUFBQSxhQUMzQ2pCLENBQUMsQ0FBQ2tCLE9BQUYsQ0FBVUYsR0FBVixDQUQyQztBQUFBLDBCQUMxQixzQ0FBcUNGLElBQUssc0NBRGhCO0FBQUE7O0FBRW5ELFlBQUlLLE1BQUo7O0FBRUEsWUFBSW5CLENBQUMsQ0FBQ29CLGFBQUYsQ0FBZ0JQLFdBQWhCLENBQUosRUFBa0M7QUFDOUJNLFVBQUFBLE1BQU0sR0FBRyxFQUFUOztBQUVBbkIsVUFBQUEsQ0FBQyxDQUFDWSxNQUFGLENBQVNDLFdBQVQsRUFBc0IsQ0FBQ1EsT0FBRCxFQUFVQyxVQUFWLEtBQXlCO0FBQzNDSCxZQUFBQSxNQUFNLENBQUNJLElBQVAsQ0FBWWIsR0FBRyxDQUFDYyxvQkFBSixDQUF5QkYsVUFBekIsRUFBcUNELE9BQXJDLEVBQThDSixRQUE5QyxDQUFaO0FBQ0gsV0FGRDtBQUdILFNBTkQsTUFNTyxJQUFJUSxLQUFLLENBQUNDLE9BQU4sQ0FBY2IsV0FBZCxDQUFKLEVBQWdDO0FBQ25DTSxVQUFBQSxNQUFNLEdBQUdOLFdBQVcsQ0FBQ2MsR0FBWixDQUFnQixDQUFDQyxjQUFELEVBQWlCQyxDQUFqQixLQUF1QjtBQUM1QyxnQkFBSTdCLENBQUMsQ0FBQ29CLGFBQUYsQ0FBZ0JRLGNBQWhCLENBQUosRUFBcUM7QUFDakMsa0JBQUksQ0FBQ0EsY0FBYyxDQUFDZCxJQUFwQixFQUEwQjtBQUN0QixzQkFBTSxJQUFJVixvQkFBSixDQUNGLHFDQURFLEVBRUZNLEdBRkUsRUFHRCxxQkFBb0JJLElBQUssSUFBR2UsQ0FBRSxRQUg3QixDQUFOO0FBSUg7O0FBRUQscUJBQU9uQixHQUFHLENBQUNjLG9CQUFKLENBQXlCSSxjQUFjLENBQUNkLElBQXhDLEVBQThDYyxjQUFjLENBQUNQLE9BQTdELEVBQXNFSixRQUF0RSxDQUFQO0FBQ0g7O0FBRUQsZ0JBQUlRLEtBQUssQ0FBQ0MsT0FBTixDQUFjRSxjQUFkLENBQUosRUFBbUM7QUFDL0Isa0JBQUlBLGNBQWMsQ0FBQ0UsTUFBZixHQUF3QixDQUF4QixJQUE2QkYsY0FBYyxDQUFDRSxNQUFmLEdBQXdCLENBQXJELElBQTBELE9BQU9GLGNBQWMsQ0FBQyxDQUFELENBQXJCLEtBQTZCLFFBQTNGLEVBQXFHO0FBQ2pHLHNCQUFNLElBQUl4QixvQkFBSixDQUNGLHlDQURFLEVBRUZNLEdBRkUsRUFHRCxxQkFBb0JJLElBQUssSUFBR2UsQ0FBRSxHQUg3QixDQUFOO0FBSUg7O0FBRUQscUJBQU9uQixHQUFHLENBQUNjLG9CQUFKLENBQXlCSSxjQUFjLENBQUMsQ0FBRCxDQUF2QyxFQUE0Q0EsY0FBYyxDQUFDRSxNQUFmLEdBQXdCLENBQXhCLEdBQTRCRixjQUFjLENBQUMsQ0FBRCxDQUExQyxHQUFnREcsU0FBNUYsRUFBdUdkLFFBQXZHLENBQVA7QUFDSDs7QUFFRCxnQkFBSSxPQUFPVyxjQUFQLEtBQTBCLFFBQTlCLEVBQXdDO0FBQ3BDLHFCQUFPbEIsR0FBRyxDQUFDYyxvQkFBSixDQUF5QkksY0FBekIsRUFBeUNHLFNBQXpDLEVBQW9EZCxRQUFwRCxDQUFQO0FBQ0g7O0FBRUQsa0JBQU0sSUFBSWIsb0JBQUosQ0FDRix5Q0FERSxFQUVGTSxHQUZFLEVBR0QscUJBQW9CSSxJQUFLLElBQUdlLENBQUUsR0FIN0IsQ0FBTjtBQUlILFdBL0JRLENBQVQ7QUFnQ0gsU0FqQ00sTUFpQ0E7QUFDSCxnQkFBTSxJQUFJekIsb0JBQUosQ0FDRixvQ0FERSxFQUVGTSxHQUZFLEVBR0QscUJBQW9CSSxJQUFLLEVBSHhCLENBQU47QUFJSDs7QUFFRCxlQUFPSyxNQUFNLENBQUNXLE1BQVAsS0FBa0IsQ0FBbEIsR0FBc0JYLE1BQU0sQ0FBQyxDQUFELENBQTVCLEdBQWtDQSxNQUF6QztBQUNILE9BbkREO0FBb0RILEtBckREO0FBc0RIO0FBcEVZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogRW5hYmxlIG9iamVjdCBzdG9yZSBmZWF0dXJlXG4gKiBAbW9kdWxlIEZlYXR1cmVfT2JqZWN0U3RvcmVcbiAqIFxuICogQGV4YW1wbGVcbiAqICAgXCJtaWRkbGV3YXJlRmFjdG9yeVwiOiB7XG4gKiAgICAgICAvL25ldyBtaWRkbGV3YXJlIG5hbWVcbiAqICAgICAgIFwibGlzdE9mTWlkZGxld2FyZVwiOiB7XG4gKiAgICAgICAgICAgXCJtaWRkbGV3YXJlMVwiOiB7IC8vIG9wdGlvbnNcbiAqICAgICAgICAgICAgICAgLi4uXG4gKiAgICAgICAgICAgfSxcbiAqICAgICAgICAgICBcIm1pZGRsZXdhcmUyXCI6IHsgLy8gb3B0aW9uc1xuICogICAgICAgICAgICAgICAuLi5cbiAqICAgICAgICAgICB9XG4gKiAgICAgICB9LFxuICogICAgICAgIFwiYWx0TGlzdE9mTWlkZGxld2FyZVwiOiBbXG4gKiAgICAgICAgICAge1xuICogICAgICAgICAgICAgICBcIm5hbWVcIjogXCJtaWRkbGV3YXJlMVwiLFxuICogICAgICAgICAgICAgICBcIm9wdGlvbnNcIjogeyAuLi4gfSBcbiAqICAgICAgICAgICB9LFxuICogICAgICAgICAgIFsgXCJtaWRkbGV3YXJlMlwiLCB7IC4uLiB9IF0sXG4gKiAgICAgICAgICAgXCJtaWRkbGV3YXJlM1wiXG4gKiAgICAgICBdXG4gKiAgIH0sXG4gKi9cblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBGZWF0dXJlIH0gPSByZXF1aXJlKCcuLicpLmVudW07XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcbiBcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGlzIGxvYWRlZCBhdCBpbml0IHN0YWdlXG4gICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAqL1xuICAgIHR5cGU6IEZlYXR1cmUuSU5JVCxcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGZhY3RvcmllcyAtIE9iamVjdCBmYWN0b3JpZXNcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gICAgICovXG4gICAgbG9hZF86IChhcHAsIGZhY3RvcmllcykgPT4ge1xuICAgICAgICBfLmZvck93bihmYWN0b3JpZXMsIChmYWN0b3J5SW5mbywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgYXBwLnJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkobmFtZSwgKG9wdCwgb3duZXJBcHApID0+IHsgXG4gICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzRW1wdHkob3B0KSwgYFByZS1jb25maWd1cmVkIG1pZGRsZXdhcmUgZmFjdG9yeSBcIiR7bmFtZX1cIiBzaG91bGQgYmUgdXNlZCB3aXRoIGVtcHR5IG9wdGlvbnMuYDtcbiAgICAgICAgICAgICAgICBsZXQgY2hhaW5zO1xuXG4gICAgICAgICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChmYWN0b3J5SW5mbykpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hhaW5zID0gW107XG4gICAgXG4gICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGZhY3RvcnlJbmZvLCAob3B0aW9ucywgbWlkZGxld2FyZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW5zLnB1c2goYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmUpKG9wdGlvbnMsIG93bmVyQXBwKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGZhY3RvcnlJbmZvKSkge1xuICAgICAgICAgICAgICAgICAgICBjaGFpbnMgPSBmYWN0b3J5SW5mby5tYXAoKG1pZGRsZXdhcmVJbmZvLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVJbmZvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbWlkZGxld2FyZUluZm8ubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTWlzc2luZyByZWZlcmVuY2VkIG1pZGRsZXdhcmUgbmFtZS4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYG1pZGRsZXdhcmVGYWN0b3J5LiR7bmFtZX1bJHtpfV0ubmFtZWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUluZm8ubmFtZSkobWlkZGxld2FyZUluZm8ub3B0aW9ucywgb3duZXJBcHApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlSW5mbykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWlkZGxld2FyZUluZm8ubGVuZ3RoIDwgMSB8fCBtaWRkbGV3YXJlSW5mby5sZW5ndGggPiAyIHx8IHR5cGVvZiBtaWRkbGV3YXJlSW5mb1swXSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0ludmFsaWQgbWlkZGxld2FyZSBmYWN0b3J5IGl0ZW0gY29uZmlnLicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgbWlkZGxld2FyZUZhY3RvcnkuJHtuYW1lfVske2l9XWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUluZm9bMF0pKG1pZGRsZXdhcmVJbmZvLmxlbmd0aCA+IDEgPyBtaWRkbGV3YXJlSW5mb1sxXSA6IHVuZGVmaW5lZCwgb3duZXJBcHApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG1pZGRsZXdhcmVJbmZvID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUluZm8pKHVuZGVmaW5lZCwgb3duZXJBcHApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0ludmFsaWQgbWlkZGxld2FyZSBmYWN0b3J5IGl0ZW0gY29uZmlnLicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBtaWRkbGV3YXJlRmFjdG9yeS4ke25hbWV9WyR7aX1dYCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeSBjb25maWcuJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGBtaWRkbGV3YXJlRmFjdG9yeS4ke25hbWV9YCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNoYWlucy5sZW5ndGggPT09IDEgPyBjaGFpbnNbMF0gOiBjaGFpbnM7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTsiXX0=
"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  Runable,
  ServiceContainer
} = require('@k-suite/app');

const Routable = require('./Routable');

const Literal = require('./enum/Literal');

const mount = require('koa-mount');

class WebServer extends Routable(Runable(ServiceContainer)) {
  constructor(name, options) {
    if (typeof options === 'undefined' && _.isPlainObject(name)) {
      options = name;
      name = undefined;
    }

    super(name || 'server', Object.assign({
      configName: Literal.SERVER_CFG_NAME
    }, options));
    this.server = this;
    this.isServer = true;
    this.appModulesPath = this.toAbsolutePath(this.options.appModulesPath || Literal.APP_MODULES_PATH);
    this.route = "/";
    this.on('configLoaded', () => {
      this.loadMiddlewaresFrom(path.resolve(__dirname, Literal.MIDDLEWARES_PATH));
    });
  }

  async stop_() {
    if (this.started && this.appModules) {
      await eachAsync_(this.appModules, app => app.stop_());
      delete this.appModules;
    }

    if (this.httpServer) {
      await new Promise((resolve, reject) => {
        this.httpServer.close(err => {
          if (err) return reject(err);
          resolve();
        });
      });
      delete this.httpServer;
      this.log('info', `The http service is stopped.`);
    }

    return super.stop_();
  }

  mountApp(mountedRoute, app) {
    if (!this.appModules) {
      this.appModules = {};
    }

    if (!!this.appModules.hasOwnProperty(mountedRoute)) {
      throw new Error("Assertion failed: !this.appModules.hasOwnProperty(mountedRoute)");
    }

    this.router.use(mount(mountedRoute, app.router));
    this.appModules[mountedRoute] = app;
    this.log('verbose', `All routes from app [${app.name}] are mounted under "${mountedRoute}".`);
  }

  _getFeatureFallbackPath() {
    let pathArray = super._getFeatureFallbackPath();

    pathArray.splice(1, 0, path.resolve(__dirname, Literal.FEATURES_PATH), path.resolve(__dirname, Literal.SERVER_FEATURES_PATH));
    return pathArray;
  }

}

module.exports = WebServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZWFjaEFzeW5jXyIsIlJ1bmFibGUiLCJTZXJ2aWNlQ29udGFpbmVyIiwiUm91dGFibGUiLCJMaXRlcmFsIiwibW91bnQiLCJXZWJTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwiaXNQbGFpbk9iamVjdCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImFzc2lnbiIsImNvbmZpZ05hbWUiLCJTRVJWRVJfQ0ZHX05BTUUiLCJzZXJ2ZXIiLCJpc1NlcnZlciIsImFwcE1vZHVsZXNQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJBUFBfTU9EVUxFU19QQVRIIiwicm91dGUiLCJvbiIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiTUlERExFV0FSRVNfUEFUSCIsInN0b3BfIiwic3RhcnRlZCIsImFwcE1vZHVsZXMiLCJhcHAiLCJodHRwU2VydmVyIiwiUHJvbWlzZSIsInJlamVjdCIsImNsb3NlIiwiZXJyIiwibG9nIiwibW91bnRBcHAiLCJtb3VudGVkUm91dGUiLCJoYXNPd25Qcm9wZXJ0eSIsInJvdXRlciIsInVzZSIsIl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoIiwicGF0aEFycmF5Iiwic3BsaWNlIiwiRkVBVFVSRVNfUEFUSCIsIlNFUlZFUl9GRUFUVVJFU19QQVRIIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CRixPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLE9BQUY7QUFBV0MsRUFBQUE7QUFBWCxJQUFnQ0osT0FBTyxDQUFDLGNBQUQsQ0FBN0M7O0FBQ0EsTUFBTUssUUFBUSxHQUFH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QixFQUF1Qi9DLElBQUksQ0FBQzJCLE9BQUwsQ0FBYUMsU0FBYixFQUF3QnJCLE9BQU8sQ0FBQ3lDLGFBQWhDLENBQXZCLEVBQXVFaEQsSUFBSSxDQUFDMkIsT0FBTCxDQUFhQyxTQUFiLEVBQXdCckIsT0FBTyxDQUFDMEMsb0JBQWhDLENBQXZFO0FBQ0EsV0FBT0gsU0FBUDtBQUNIOztBQWhHdUQ7O0FBbUc1REksTUFBTSxDQUFDQyxPQUFQLEdBQWlCMUMsU0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZWFjaEFzeW5jXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgUnVuYWJsZSwgU2VydmljZUNvbnRhaW5lciB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwJyk7XG5jb25zdCBSb3V0YWJsZSA9IHJlcXVpcmUoJy4vUm91dGFibGUnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuY29uc3QgbW91bnQgPSByZXF1aXJlKCdrb2EtbW91bnQnKTtcblxuLyoqXG4gKiBXZWIgc2VydmVyIGNsYXNzLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBSb3V0YWJsZShBcHApXG4gKi9cbmNsYXNzIFdlYlNlcnZlciBleHRlbmRzIFJvdXRhYmxlKFJ1bmFibGUoU2VydmljZUNvbnRhaW5lcikpIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPSdzZXJ2ZXInXSAtIFRoZSBuYW1lIG9mIHRoZSBzZXJ2ZXIuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gVGhlIGFwcCBtb2R1bGUncyBleHRyYSBvcHRpb25zIGRlZmluZWQgaW4gaXRzIHBhcmVudCdzIGNvbmZpZ3VyYXRpb24uXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmxvZ2dlcl0gLSBMb2dnZXIgb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMudmVyYm9zZT1mYWxzZV0gLSBGbGFnIHRvIG91dHB1dCB0cml2aWFsIGluZm9ybWF0aW9uIGZvciBkaWFnbm9zdGljc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5lbnZdIC0gRW52aXJvbm1lbnQsIGRlZmF1bHQgdG8gcHJvY2Vzcy5lbnYuTk9ERV9FTlZcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMud29ya2luZ1BhdGhdIC0gQXBwJ3Mgd29ya2luZyBwYXRoLCBkZWZhdWx0IHRvIHByb2Nlc3MuY3dkKClcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnUGF0aF0gLSBBcHAncyBjb25maWcgcGF0aCwgZGVmYXVsdCB0byBcImNvbmZcIiB1bmRlciB3b3JraW5nUGF0aCAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdOYW1lXSAtIEFwcCdzIGNvbmZpZyBiYXNlbmFtZSwgZGVmYXVsdCB0byBcImFwcFwiXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJhY2tlbmRQYXRoPSdzZXJ2ZXInXSAtIFJlbGF0aXZlIHBhdGggb2YgYmFjay1lbmQgc2VydmVyIHNvdXJjZSBmaWxlc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jbGllbnRQYXRoPSdjbGllbnQnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIGNsaWVudCBzb3VyY2UgZmlsZXMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5wdWJsaWNQYXRoPSdwdWJsaWMnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIHN0YXRpYyBmaWxlcyAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYXBwTW9kdWxlc1BhdGg9YXBwX21vZHVsZXNdIC0gUmVsYXRpdmUgcGF0aCBvZiBjaGlsZCBtb2R1bGVzICAgICAgICAgICAgICAgICAgICBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3VuZGVmaW5lZCcgJiYgXy5pc1BsYWluT2JqZWN0KG5hbWUpKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gbmFtZTtcbiAgICAgICAgICAgIG5hbWUgPSB1bmRlZmluZWQ7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHN1cGVyKG5hbWUgfHwgJ3NlcnZlcicsIE9iamVjdC5hc3NpZ24oeyBjb25maWdOYW1lOiBMaXRlcmFsLlNFUlZFUl9DRkdfTkFNRSB9LCBvcHRpb25zKSk7ICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIb3N0aW5nIHNlcnZlci5cbiAgICAgICAgICogQG1lbWJlciB7V2ViU2VydmVyfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuc2VydmVyID0gdGhpcztcblxuICAgICAgICAvKipcbiAgICAgICAgICogV2hldGhlciBpdCBpcyBhIHNlcnZlci5cbiAgICAgICAgICogQG1lbWJlciB7Ym9vbGVhbn1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmlzU2VydmVyID0gdHJ1ZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIG1vZHVsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5hcHBNb2R1bGVzUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmFwcE1vZHVsZXNQYXRoIHx8IExpdGVyYWwuQVBQX01PRFVMRVNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEJhc2Ugcm91dGUuXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucm91dGUgPSBcIi9cIjtcbiAgICAgICAgXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vIGxvYWQgYnVpbHRpbiBtaWRkbGV3YXJlc1xuICAgICAgICAgICAgdGhpcy5sb2FkTWlkZGxld2FyZXNGcm9tKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuTUlERExFV0FSRVNfUEFUSCkpO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkICYmIHRoaXMuYXBwTW9kdWxlcykge1xuICAgICAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyh0aGlzLmFwcE1vZHVsZXMsIGFwcCA9PiBhcHAuc3RvcF8oKSk7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5hcHBNb2R1bGVzO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBpZiAodGhpcy5odHRwU2VydmVyKSB7XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5odHRwU2VydmVyLmNsb3NlKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmh0dHBTZXJ2ZXI7XG4gICAgICAgICAgICB0aGlzLmxvZygnaW5mbycsIGBUaGUgaHR0cCBzZXJ2aWNlIGlzIHN0b3BwZWQuYCk7IFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0b3BfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTW91bnQgYW4gYXBwIGF0IHNwZWNpZmllZCByb3V0ZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW91bnRlZFJvdXRlIFxuICAgICAqIEBwYXJhbSB7V2ViTW9kdWxlfSBhcHAgXG4gICAgICovXG4gICAgbW91bnRBcHAobW91bnRlZFJvdXRlLCBhcHApIHtcbiAgICAgICAgaWYgKCF0aGlzLmFwcE1vZHVsZXMpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwTW9kdWxlcyA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgYXNzZXJ0OiAhdGhpcy5hcHBNb2R1bGVzLmhhc093blByb3BlcnR5KG1vdW50ZWRSb3V0ZSk7XG5cbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG1vdW50KG1vdW50ZWRSb3V0ZSwgYXBwLnJvdXRlcikpO1xuICAgICAgICB0aGlzLmFwcE1vZHVsZXNbbW91bnRlZFJvdXRlXSA9IGFwcDtcblxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBBbGwgcm91dGVzIGZyb20gYXBwIFske2FwcC5uYW1lfV0gYXJlIG1vdW50ZWQgdW5kZXIgXCIke21vdW50ZWRSb3V0ZX1cIi5gKTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgbGV0IHBhdGhBcnJheSA9IHN1cGVyLl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCk7XG4gICAgICAgIHBhdGhBcnJheS5zcGxpY2UoMSwgMCwgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSwgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5TRVJWRVJfRkVBVFVSRVNfUEFUSCkpO1xuICAgICAgICByZXR1cm4gcGF0aEFycmF5O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBXZWJTZXJ2ZXI7Il19
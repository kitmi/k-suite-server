"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  Runable,
  ServiceContainer
} = require('@k-suite/app');

const Routable = require('./Routable');

const Literal = require('./enum/Literal');

const mount = require('koa-mount');

class WebServer extends Routable(Runable(ServiceContainer)) {
  constructor(name, options) {
    if (typeof options === 'undefined' && _.isPlainObject(name)) {
      options = name;
      name = undefined;
    }

    super(name || 'server', Object.assign({
      configName: Literal.SERVER_CFG_NAME
    }, options));
    this.server = this;
    this.appModulesPath = this.toAbsolutePath(this.options.appModulesPath || Literal.APP_MODULES_PATH);
    this.route = "/";
    this.on('configLoaded', () => {
      this.loadMiddlewaresFrom(path.resolve(__dirname, Literal.MIDDLEWARES_PATH));
    });
  }

  async stop_() {
    if (this.started && this.appModules) {
      await eachAsync_(this.appModules, app => app.stop_());
      delete this.appModules;
    }

    if (this.httpServer) {
      await new Promise((resolve, reject) => {
        this.httpServer.close(err => {
          if (err) return reject(err);
          resolve();
        });
      });
      delete this.httpServer;
      this.log('info', `The http service is stopped.`);
    }

    return super.stop_();
  }

  mountApp(mountedRoute, app) {
    if (!this.appModules) {
      this.appModules = {};
    }

    if (!!this.appModules.hasOwnProperty(mountedRoute)) {
      throw new Error("Assertion failed: !this.appModules.hasOwnProperty(mountedRoute)");
    }

    this.router.use(mount(mountedRoute, app.router));
    this.appModules[mountedRoute] = app;
    this.log('verbose', `All routes from app [${app.name}] are mounted under "${mountedRoute}".`);
  }

  _getFeatureFallbackPath() {
    let pathArray = super._getFeatureFallbackPath();

    pathArray.splice(1, 0, path.resolve(__dirname, Literal.FEATURES_PATH), path.resolve(__dirname, Literal.SERVER_FEATURES_PATH));
    return pathArray;
  }

}

module.exports = WebServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJTZXJ2ZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZWFjaEFzeW5jXyIsIlJ1bmFibGUiLCJTZXJ2aWNlQ29udGFpbmVyIiwiUm91dGFibGUiLCJMaXRlcmFsIiwibW91bnQiLCJXZWJTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwiaXNQbGFpbk9iamVjdCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImFzc2lnbiIsImNvbmZpZ05hbWUiLCJTRVJWRVJfQ0ZHX05BTUUiLCJzZXJ2ZXIiLCJhcHBNb2R1bGVzUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiQVBQX01PRFVMRVNfUEFUSCIsInJvdXRlIiwib24iLCJsb2FkTWlkZGxld2FyZXNGcm9tIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIk1JRERMRVdBUkVTX1BBVEgiLCJzdG9wXyIsInN0YXJ0ZWQiLCJhcHBNb2R1bGVzIiwiYXBwIiwiaHR0cFNlcnZlciIsIlByb21pc2UiLCJyZWplY3QiLCJjbG9zZSIsImVyciIsImxvZyIsIm1vdW50QXBwIiwibW91bnRlZFJvdXRlIiwiaGFzT3duUHJvcGVydHkiLCJyb3V0ZXIiLCJ1c2UiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsInBhdGhBcnJheSIsInNwbGljZSIsIkZFQVRVUkVTX1BBVEgiLCJTRVJWRVJfRkVBVFVSRVNfUEFUSCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFvQkYsT0FBTyxDQUFDLFVBQUQsQ0FBakM7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxPQUFGO0FBQVdDLEVBQUFBO0FBQVgsSUFBZ0NKLE9BQU8sQ0FBQyxjQUFELENBQTdDOztBQUNBLE1BQU1LLFFBQVEsR0FBR0wsT0FBTyxDQUFD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QXdCcEIsT0FBTyxDQUFDd0MsYUFBaEMsQ0FBdkIsRUFBdUUvQyxJQUFJLENBQUMwQixPQUFMLENBQWFDLFNBQWIsRUFBd0JwQixPQUFPLENBQUN5QyxvQkFBaEMsQ0FBdkU7QUFDQSxXQUFPSCxTQUFQO0FBQ0g7O0FBMUZ1RDs7QUE2RjVESSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ6QyxTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBSdW5hYmxlLCBTZXJ2aWNlQ29udGFpbmVyIH0gPSByZXF1aXJlKCdAay1zdWl0ZS9hcHAnKTtcbmNvbnN0IFJvdXRhYmxlID0gcmVxdWlyZSgnLi9Sb3V0YWJsZScpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBtb3VudCA9IHJlcXVpcmUoJ2tvYS1tb3VudCcpO1xuXG4vKipcbiAqIFdlYiBzZXJ2ZXIgY2xhc3MuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIFJvdXRhYmxlKEFwcClcbiAqL1xuY2xhc3MgV2ViU2VydmVyIGV4dGVuZHMgUm91dGFibGUoUnVuYWJsZShTZXJ2aWNlQ29udGFpbmVyKSkge1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9J3NlcnZlciddIC0gVGhlIG5hbWUgb2YgdGhlIHNlcnZlci4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBUaGUgYXBwIG1vZHVsZSdzIGV4dHJhIG9wdGlvbnMgZGVmaW5lZCBpbiBpdHMgcGFyZW50J3MgY29uZmlndXJhdGlvbi5cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMubG9nZ2VyXSAtIExvZ2dlciBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy52ZXJib3NlPWZhbHNlXSAtIEZsYWcgdG8gb3V0cHV0IHRyaXZpYWwgaW5mb3JtYXRpb24gZm9yIGRpYWdub3N0aWNzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmVudl0gLSBFbnZpcm9ubWVudCwgZGVmYXVsdCB0byBwcm9jZXNzLmVudi5OT0RFX0VOVlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy53b3JraW5nUGF0aF0gLSBBcHAncyB3b3JraW5nIHBhdGgsIGRlZmF1bHQgdG8gcHJvY2Vzcy5jd2QoKVxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdQYXRoXSAtIEFwcCdzIGNvbmZpZyBwYXRoLCBkZWZhdWx0IHRvIFwiY29uZlwiIHVuZGVyIHdvcmtpbmdQYXRoICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNvbmZpZ05hbWVdIC0gQXBwJ3MgY29uZmlnIGJhc2VuYW1lLCBkZWZhdWx0IHRvIFwiYXBwXCJcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYmFja2VuZFBhdGg9J3NlcnZlciddIC0gUmVsYXRpdmUgcGF0aCBvZiBiYWNrLWVuZCBzZXJ2ZXIgc291cmNlIGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNsaWVudFBhdGg9J2NsaWVudCddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgY2xpZW50IHNvdXJjZSBmaWxlcyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnB1YmxpY1BhdGg9J3B1YmxpYyddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgc3RhdGljIGZpbGVzICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5hcHBNb2R1bGVzUGF0aD1hcHBfbW9kdWxlc10gLSBSZWxhdGl2ZSBwYXRoIG9mIGNoaWxkIG1vZHVsZXMgICAgICAgICAgICAgICAgICAgIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAndW5kZWZpbmVkJyAmJiBfLmlzUGxhaW5PYmplY3QobmFtZSkpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBuYW1lO1xuICAgICAgICAgICAgbmFtZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgc3VwZXIobmFtZSB8fCAnc2VydmVyJywgT2JqZWN0LmFzc2lnbih7IGNvbmZpZ05hbWU6IExpdGVyYWwuU0VSVkVSX0NGR19OQU1FIH0sIG9wdGlvbnMpKTsgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEhvc3Rpbmcgc2VydmVyLlxuICAgICAgICAgKiBAbWVtYmVyIHtXZWJTZXJ2ZXJ9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5zZXJ2ZXIgPSB0aGlzO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHAgbW9kdWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmFwcE1vZHVsZXNQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuYXBwTW9kdWxlc1BhdGggfHwgTGl0ZXJhbC5BUFBfTU9EVUxFU19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQmFzZSByb3V0ZS5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5yb3V0ZSA9IFwiL1wiO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gbG9hZCBidWlsdGluIG1pZGRsZXdhcmVzXG4gICAgICAgICAgICB0aGlzLmxvYWRNaWRkbGV3YXJlc0Zyb20ocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5NSURETEVXQVJFU19QQVRIKSk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQgJiYgdGhpcy5hcHBNb2R1bGVzKSB7XG4gICAgICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKHRoaXMuYXBwTW9kdWxlcywgYXBwID0+IGFwcC5zdG9wXygpKTtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFwcE1vZHVsZXM7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmICh0aGlzLmh0dHBTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHBTZXJ2ZXIuY2xvc2UoKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuaHR0cFNlcnZlcjtcbiAgICAgICAgICAgIHRoaXMubG9nKCdpbmZvJywgYFRoZSBodHRwIHNlcnZpY2UgaXMgc3RvcHBlZC5gKTsgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RvcF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNb3VudCBhbiBhcHAgYXQgc3BlY2lmaWVkIHJvdXRlLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb3VudGVkUm91dGUgXG4gICAgICogQHBhcmFtIHtXZWJNb2R1bGV9IGFwcCBcbiAgICAgKi9cbiAgICBtb3VudEFwcChtb3VudGVkUm91dGUsIGFwcCkge1xuICAgICAgICBpZiAoIXRoaXMuYXBwTW9kdWxlcykge1xuICAgICAgICAgICAgdGhpcy5hcHBNb2R1bGVzID0ge307XG4gICAgICAgIH1cblxuICAgICAgICBhc3NlcnQ6ICF0aGlzLmFwcE1vZHVsZXMuaGFzT3duUHJvcGVydHkobW91bnRlZFJvdXRlKTtcblxuICAgICAgICB0aGlzLnJvdXRlci51c2UobW91bnQobW91bnRlZFJvdXRlLCBhcHAucm91dGVyKSk7XG4gICAgICAgIHRoaXMuYXBwTW9kdWxlc1ttb3VudGVkUm91dGVdID0gYXBwO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEFsbCByb3V0ZXMgZnJvbSBhcHAgWyR7YXBwLm5hbWV9XSBhcmUgbW91bnRlZCB1bmRlciBcIiR7bW91bnRlZFJvdXRlfVwiLmApO1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICBsZXQgcGF0aEFycmF5ID0gc3VwZXIuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKTtcbiAgICAgICAgcGF0aEFycmF5LnNwbGljZSgxLCAwLCBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpLCBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLlNFUlZFUl9GRUFUVVJFU19QQVRIKSk7XG4gICAgICAgIHJldHVybiBwYXRoQXJyYXk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdlYlNlcnZlcjsiXX0=
"use strict";

require("source-map-support/register");

module.exports = (opt, app) => {
  let passportService = app.getService('passport');

  if (!passportService) {
    throw new InvalidConfiguration('Passport feature is not enabled.', app, 'passport');
  }

  let options = { ...passportService.config.auth,
    ...opt
  };
  return async (ctx, next) => {
    if (ctx.isAuthenticated()) {
      return next();
    }

    if (options.successReturnToOrRedirect && ctx.session) {
      ctx.session.returnTo = ctx.originalUrl || ctx.url;
    }

    return ctx.redirect(options.loginUrl);
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9wYXNzcG9ydENoZWNrLmpzIl0sIm5hbWVzIjpbIm1vZHVsZSIsImV4cG9ydHMiLCJvcHQiLCJhcHAiLCJwYXNzcG9ydFNlcnZpY2UiLCJnZXRTZXJ2aWNlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJvcHRpb25zIiwiY29uZmlnIiwiYXV0aCIsImN0eCIsIm5leHQiLCJpc0F1dGhlbnRpY2F0ZWQiLCJzdWNjZXNzUmV0dXJuVG9PclJlZGlyZWN0Iiwic2Vzc2lvbiIsInJldHVyblRvIiwib3JpZ2luYWxVcmwiLCJ1cmwiLCJyZWRpcmVjdCIsImxvZ2luVXJsIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQVlBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsQ0FBQ0MsR0FBRCxFQUFNQyxHQUFOLEtBQWM7QUFDM0IsTUFBSUMsZUFBZSxHQUFHRCxHQUFHLENBQUNFLFVBQUosQ0FBZSxVQUFmLENBQXRCOztBQUVBLE1BQUksQ0FBQ0QsZUFBTCxFQUFzQjtBQUNsQixVQUFNLElBQUlFLG9CQUFKLENBQ0Ysa0NBREUsRUFFRkgsR0FGRSxFQUdGLFVBSEUsQ0FBTjtBQUtIOztBQUVELE1BQUlJLE9BQU8sR0FBRyxFQUFFLEdBQUdILGVBQWUsQ0FBQ0ksTUFBaEIsQ0FBdUJDLElBQTVCO0FBQWtDLE9BQUdQO0FBQXJDLEdBQWQ7QUFFQSxTQUFPLE9BQU9RLEdBQVAsRUFBWUMsSUFBWixLQUFxQjtBQUN4QixRQUFJRCxHQUFHLENBQUNFLGVBQUosRUFBSixFQUEyQjtBQUN2QixhQUFPRCxJQUFJLEVBQVg7QUFDSDs7QUFFRCxRQUFJSixPQUFPLENBQUNNLHlCQUFSLElBQXFDSCxHQUFHLENBQUNJLE9BQTdDLEVBQXNEO0FBQ2xESixNQUFBQSxHQUFHLENBQUNJLE9BQUosQ0FBWUMsUUFBWixHQUF1QkwsR0FBRyxDQUFDTSxXQUFKLElBQW1CTixHQUFHLENBQUNPLEdBQTlDO0FBQ0g7O0FBRUQsV0FBT1AsR0FBRyxDQUFDUSxRQUFKLENBQWFYLE9BQU8sQ0FBQ1ksUUFBckIsQ0FBUDtBQUNILEdBVkQ7QUFXSCxDQXhCRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIE1pZGRsZXdhcmUgdG8gY2hlY2sgdXNlciBsb2dnZWQgaW4gc3RhdHVzIGJhc2VkIG9uIHBhc3Nwb3J0XG4gKiBAbW9kdWxlIE1pZGRsZXdhcmVfUGFzc3BvcnRDaGVja1xuICovXG5cbi8qKlxuICogSW5pdGlhbGl6ZSBlbnN1cmVMb2dnZWRJbiBtaWRkbGV3YXJlXG4gKiBAcGFyYW0ge29iamVjdH0gb3B0aW9uc1xuICogQHBhcmFtIHtSb3V0YWJsZX0gYXBwXG4gKi8gIFxubW9kdWxlLmV4cG9ydHMgPSAob3B0LCBhcHApID0+IHtcbiAgICBsZXQgcGFzc3BvcnRTZXJ2aWNlID0gYXBwLmdldFNlcnZpY2UoJ3Bhc3Nwb3J0Jyk7ICAgIFxuXG4gICAgaWYgKCFwYXNzcG9ydFNlcnZpY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ1Bhc3Nwb3J0IGZlYXR1cmUgaXMgbm90IGVuYWJsZWQuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgICdwYXNzcG9ydCdcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBsZXQgb3B0aW9ucyA9IHsgLi4ucGFzc3BvcnRTZXJ2aWNlLmNvbmZpZy5hdXRoLCAuLi5vcHQgfTtcblxuICAgIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIGlmIChjdHguaXNBdXRoZW50aWNhdGVkKCkpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5zdWNjZXNzUmV0dXJuVG9PclJlZGlyZWN0ICYmIGN0eC5zZXNzaW9uKSB7XG4gICAgICAgICAgICBjdHguc2Vzc2lvbi5yZXR1cm5UbyA9IGN0eC5vcmlnaW5hbFVybCB8fCBjdHgudXJsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGN0eC5yZWRpcmVjdChvcHRpb25zLmxvZ2luVXJsKTtcbiAgICB9XG59OyJdfQ==
"use strict";

require("source-map-support/register");

const HttpCode = require('http-status-codes');

module.exports = (options, app) => {
  let passportService = app.getService('passport');

  if (!passportService) {
    throw new InvalidConfiguration('Passport feature is not enabled.', app, 'passport');
  }

  return async (ctx, next) => {
    if (ctx.isAuthenticated()) {
      return next();
    }

    if (options.successReturnToOrRedirect && ctx.session) {
      ctx.session.returnTo = ctx.originalUrl || ctx.url;
    }

    if (!options.loginUrl) {
      ctx.throw(HttpCode.UNAUTHORIZED, 'authentication required');
    }

    return ctx.redirect(options.loginUrl);
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9wYXNzcG9ydENoZWNrLmpzIl0sIm5hbWVzIjpbIkh0dHBDb2RlIiwicmVxdWlyZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJvcHRpb25zIiwiYXBwIiwicGFzc3BvcnRTZXJ2aWNlIiwiZ2V0U2VydmljZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiY3R4IiwibmV4dCIsImlzQXV0aGVudGljYXRlZCIsInN1Y2Nlc3NSZXR1cm5Ub09yUmVkaXJlY3QiLCJzZXNzaW9uIiwicmV0dXJuVG8iLCJvcmlnaW5hbFVybCIsInVybCIsImxvZ2luVXJsIiwidGhyb3ciLCJVTkFVVEhPUklaRUQiLCJyZWRpcmVjdCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxtQkFBRCxDQUF4Qjs7QUFTQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLENBQUNDLE9BQUQsRUFBVUMsR0FBVixLQUFrQjtBQUUvQixNQUFJQyxlQUFlLEdBQUdELEdBQUcsQ0FBQ0UsVUFBSixDQUFlLFVBQWYsQ0FBdEI7O0FBRUEsTUFBSSxDQUFDRCxlQUFMLEVBQXNCO0FBQ2xCLFVBQU0sSUFBSUUsb0JBQUosQ0FDRixrQ0FERSxFQUVGSCxHQUZFLEVBR0YsVUFIRSxDQUFOO0FBS0g7O0FBRUQsU0FBTyxPQUFPSSxHQUFQLEVBQVlDLElBQVosS0FBcUI7QUFDeEIsUUFBSUQsR0FBRyxDQUFDRSxlQUFKLEVBQUosRUFBMkI7QUFDdkIsYUFBT0QsSUFBSSxFQUFYO0FBQ0g7O0FBRUQsUUFBSU4sT0FBTyxDQUFDUSx5QkFBUixJQUFxQ0gsR0FBRyxDQUFDSSxPQUE3QyxFQUFzRDtBQUNsREosTUFBQUEsR0FBRyxDQUFDSSxPQUFKLENBQVlDLFFBQVosR0FBdUJMLEdBQUcsQ0FBQ00sV0FBSixJQUFtQk4sR0FBRyxDQUFDTyxHQUE5QztBQUNIOztBQUVELFFBQUksQ0FBQ1osT0FBTyxDQUFDYSxRQUFiLEVBQXVCO0FBQ25CUixNQUFBQSxHQUFHLENBQUNTLEtBQUosQ0FBVWxCLFFBQVEsQ0FBQ21CLFlBQW5CLEVBQWlDLHlCQUFqQztBQUNIOztBQUVELFdBQU9WLEdBQUcsQ0FBQ1csUUFBSixDQUFhaEIsT0FBTyxDQUFDYSxRQUFyQixDQUFQO0FBQ0gsR0FkRDtBQWVILENBM0JEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogTWlkZGxld2FyZSB0byBjaGVjayB1c2VyIGxvZ2dlZCBpbiBzdGF0dXMgYmFzZWQgb24gcGFzc3BvcnRcbiAqIEBtb2R1bGUgTWlkZGxld2FyZV9QYXNzcG9ydENoZWNrXG4gKi9cblxuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuXG4vKipcbiAqIEluaXRpYWxpemUgZW5zdXJlTG9nZ2VkSW4gbWlkZGxld2FyZVxuICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5sb2dpblVybF0gLSBJZiBnaXZlbiwgd2lsbCByZWRpcmVjdCB0byBsb2dpblVybCBpZiBub3QgbG9nZ2VkSW5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMuc3VjY2Vzc1JldHVyblRvT3JSZWRpcmVjdF0gLSBJZiBnaXZlbiwgd2lsbCByZWRpcmVjdCB0byBsb2dpblVybCBpZiBub3QgbG9nZ2VkSW4gXG4gKiBAcGFyYW0ge1JvdXRhYmxlfSBhcHBcbiAqLyAgXG5tb2R1bGUuZXhwb3J0cyA9IChvcHRpb25zLCBhcHApID0+IHtcblxuICAgIGxldCBwYXNzcG9ydFNlcnZpY2UgPSBhcHAuZ2V0U2VydmljZSgncGFzc3BvcnQnKTtcblxuICAgIGlmICghcGFzc3BvcnRTZXJ2aWNlKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdQYXNzcG9ydCBmZWF0dXJlIGlzIG5vdCBlbmFibGVkLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAncGFzc3BvcnQnXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgaWYgKGN0eC5pc0F1dGhlbnRpY2F0ZWQoKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLnN1Y2Nlc3NSZXR1cm5Ub09yUmVkaXJlY3QgJiYgY3R4LnNlc3Npb24pIHtcbiAgICAgICAgICAgIGN0eC5zZXNzaW9uLnJldHVyblRvID0gY3R4Lm9yaWdpbmFsVXJsIHx8IGN0eC51cmw7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW9wdGlvbnMubG9naW5VcmwpIHtcbiAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5VTkFVVEhPUklaRUQsICdhdXRoZW50aWNhdGlvbiByZXF1aXJlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGN0eC5yZWRpcmVjdChvcHRpb25zLmxvZ2luVXJsKTtcbiAgICB9XG59OyJdfQ==
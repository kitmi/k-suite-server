"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const _ = Util._;
const fs = Util.fs;

const path = require('path');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration
} = require('../Errors');

let favicon = (options, app) => {
  if (_.isString(options)) {
    options = {
      path: options
    };
  }

  let faviconPath = options && options.path && app.toAbsolutePath(options.path) || path.join(app.publicPath, 'favicon.ico');

  if (!fs.existsSync(faviconPath)) {
    throw new InvalidConfiguration(`Favicon path "${faviconPath}" not exists.`, app, 'middlewares.favicon');
  }

  let icon;
  const maxAge = options.maxAge == null ? 86400000 : Math.min(Math.max(0, options.maxAge), 31556926000);
  const cacheControl = `public, max-age=${maxAge / 1000 | 0}`;
  return async (ctx, next) => {
    if ('/favicon.ico' !== ctx.path || 'GET' !== ctx.method && 'HEAD' !== ctx.method) {
      return next();
    }

    if (!icon) {
      let stats = await fs.stat(faviconPath);

      if (stats.size > 1048576) {
        app.log('warn', 'favicon.ico too large.', stats);
        ctx.throw(HttpCode.NOT_FOUND);
      }

      icon = await fs.readFile(faviconPath);
    }

    ctx.set('Cache-Control', cacheControl);
    ctx.type = 'image/x-icon';
    ctx.body = icon;
  };
};

module.exports = favicon;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9mYXZpY29uLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsImZzIiwicGF0aCIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJmYXZpY29uIiwib3B0aW9ucyIsImFwcCIsImlzU3RyaW5nIiwiZmF2aWNvblBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsImpvaW4iLCJwdWJsaWNQYXRoIiwiZXhpc3RzU3luYyIsImljb24iLCJtYXhBZ2UiLCJNYXRoIiwibWluIiwibWF4IiwiY2FjaGVDb250cm9sIiwiY3R4IiwibmV4dCIsIm1ldGhvZCIsInN0YXRzIiwic3RhdCIsInNpemUiLCJsb2ciLCJ0aHJvdyIsIk5PVF9GT1VORCIsInJlYWRGaWxlIiwic2V0IiwidHlwZSIsImJvZHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQU9BLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsQ0FBQyxHQUFHRixJQUFJLENBQUNFLENBQWY7QUFDQSxNQUFNQyxFQUFFLEdBQUdILElBQUksQ0FBQ0csRUFBaEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHSCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNSSxRQUFRLEdBQUdKLE9BQU8sQ0FBQyxtQkFBRCxDQUF4Qjs7QUFDQSxNQUFNO0FBQUVLLEVBQUFBO0FBQUYsSUFBMkJMLE9BQU8sQ0FBQyxXQUFELENBQXhDOztBQUVBLElBQUlNLE9BQU8sR0FBRyxDQUFDQyxPQUFELEVBQVVDLEdBQVYsS0FBa0I7QUFDNUIsTUFBSVAsQ0FBQyxDQUFDUSxRQUFGLENBQVdGLE9BQVgsQ0FBSixFQUF5QjtBQUNyQkEsSUFBQUEsT0FBTyxHQUFHO0FBQUVKLE1BQUFBLElBQUksRUFBRUk7QUFBUixLQUFWO0FBQ0g7O0FBRUQsTUFBSUcsV0FBVyxHQUFHSCxPQUFPLElBQUlBLE9BQU8sQ0FBQ0osSUFBbkIsSUFBMkJLLEdBQUcsQ0FBQ0csY0FBSixDQUFtQkosT0FBTyxDQUFDSixJQUEzQixDQUEzQixJQUErREEsSUFBSSxDQUFDUyxJQUFMLENBQVVKLEdBQUcsQ0FBQ0ssVUFBZCxFQUEwQixhQUExQixDQUFqRjs7QUFDQSxNQUFJLENBQUNYLEVBQUUsQ0FBQ1ksVUFBSCxDQUFjSixXQUFkLENBQUwsRUFBaUM7QUFDN0IsVUFBTSxJQUFJTCxvQkFBSixDQUNELGlCQUFnQkssV0FBWSxlQUQzQixFQUVGRixHQUZFLEVBR0YscUJBSEUsQ0FBTjtBQUtIOztBQUVELE1BQUlPLElBQUo7QUFDQSxRQUFNQyxNQUFNLEdBQUdULE9BQU8sQ0FBQ1MsTUFBUixJQUFrQixJQUFsQixHQUNULFFBRFMsR0FFVEMsSUFBSSxDQUFDQyxHQUFMLENBQVNELElBQUksQ0FBQ0UsR0FBTCxDQUFTLENBQVQsRUFBWVosT0FBTyxDQUFDUyxNQUFwQixDQUFULEVBQXNDLFdBQXRDLENBRk47QUFHQSxRQUFNSSxZQUFZLEdBQUksbUJBQWtCSixNQUFNLEdBQUcsSUFBVCxHQUFnQixDQUFFLEVBQTFEO0FBRUEsU0FBTyxPQUFPSyxHQUFQLEVBQVlDLElBQVosS0FBcUI7QUFDeEIsUUFBSSxtQkFBbUJELEdBQUcsQ0FBQ2xCLElBQXZCLElBQWdDLFVBQVVrQixHQUFHLENBQUNFLE1BQWQsSUFBd0IsV0FBV0YsR0FBRyxDQUFDRSxNQUEzRSxFQUFvRjtBQUNoRixhQUFPRCxJQUFJLEVBQVg7QUFDSDs7QUFFRCxRQUFJLENBQUNQLElBQUwsRUFBVztBQUNQLFVBQUlTLEtBQUssR0FBRyxNQUFNdEIsRUFBRSxDQUFDdUIsSUFBSCxDQUFRZixXQUFSLENBQWxCOztBQUVBLFVBQUljLEtBQUssQ0FBQ0UsSUFBTixHQUFhLE9BQWpCLEVBQTBCO0FBQ3RCbEIsUUFBQUEsR0FBRyxDQUFDbUIsR0FBSixDQUFRLE1BQVIsRUFBZ0Isd0JBQWhCLEVBQTBDSCxLQUExQztBQUNBSCxRQUFBQSxHQUFHLENBQUNPLEtBQUosQ0FBVXhCLFFBQVEsQ0FBQ3lCLFNBQW5CO0FBQ0g7O0FBRURkLE1BQUFBLElBQUksR0FBRyxNQUFNYixFQUFFLENBQUM0QixRQUFILENBQVlwQixXQUFaLENBQWI7QUFDSDs7QUFDRFcsSUFBQUEsR0FBRyxDQUFDVSxHQUFKLENBQVEsZUFBUixFQUF5QlgsWUFBekI7QUFDQUMsSUFBQUEsR0FBRyxDQUFDVyxJQUFKLEdBQVcsY0FBWDtBQUNBWCxJQUFBQSxHQUFHLENBQUNZLElBQUosR0FBV2xCLElBQVg7QUFDSCxHQWxCRDtBQW1CSCxDQXZDRDs7QUF5Q0FtQixNQUFNLENBQUNDLE9BQVAsR0FBaUI3QixPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIE1pZGRsZXdhcmUgdG8gc2VydmUgZmF2aWNvbiByZXF1ZXN0LlxuICogQG1vZHVsZSBNaWRkbGV3YXJlX0Zhdmljb25cbiAqL1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IF8gPSBVdGlsLl87XG5jb25zdCBmcyA9IFV0aWwuZnM7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5cbmxldCBmYXZpY29uID0gKG9wdGlvbnMsIGFwcCkgPT4ge1xuICAgIGlmIChfLmlzU3RyaW5nKG9wdGlvbnMpKSB7XG4gICAgICAgIG9wdGlvbnMgPSB7IHBhdGg6IG9wdGlvbnMgfTtcbiAgICB9IFxuICAgIFxuICAgIGxldCBmYXZpY29uUGF0aCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5wYXRoICYmIGFwcC50b0Fic29sdXRlUGF0aChvcHRpb25zLnBhdGgpIHx8IHBhdGguam9pbihhcHAucHVibGljUGF0aCwgJ2Zhdmljb24uaWNvJyk7XG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGZhdmljb25QYXRoKSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICBgRmF2aWNvbiBwYXRoIFwiJHtmYXZpY29uUGF0aH1cIiBub3QgZXhpc3RzLmAsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAnbWlkZGxld2FyZXMuZmF2aWNvbidcbiAgICAgICAgKTtcbiAgICB9ICAgXG5cbiAgICBsZXQgaWNvbjtcbiAgICBjb25zdCBtYXhBZ2UgPSBvcHRpb25zLm1heEFnZSA9PSBudWxsXG4gICAgICAgID8gODY0MDAwMDBcbiAgICAgICAgOiBNYXRoLm1pbihNYXRoLm1heCgwLCBvcHRpb25zLm1heEFnZSksIDMxNTU2OTI2MDAwKTtcbiAgICBjb25zdCBjYWNoZUNvbnRyb2wgPSBgcHVibGljLCBtYXgtYWdlPSR7bWF4QWdlIC8gMTAwMCB8IDB9YDtcblxuICAgIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIGlmICgnL2Zhdmljb24uaWNvJyAhPT0gY3R4LnBhdGggfHwgKCdHRVQnICE9PSBjdHgubWV0aG9kICYmICdIRUFEJyAhPT0gY3R4Lm1ldGhvZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWljb24pIHtcbiAgICAgICAgICAgIGxldCBzdGF0cyA9IGF3YWl0IGZzLnN0YXQoZmF2aWNvblBhdGgpO1xuICAgICAgICAgICAgLy9tYXhpbXVtIDFNXG4gICAgICAgICAgICBpZiAoc3RhdHMuc2l6ZSA+IDEwNDg1NzYpIHtcbiAgICAgICAgICAgICAgICBhcHAubG9nKCd3YXJuJywgJ2Zhdmljb24uaWNvIHRvbyBsYXJnZS4nLCBzdGF0cyk7XG4gICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLk5PVF9GT1VORCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpY29uID0gYXdhaXQgZnMucmVhZEZpbGUoZmF2aWNvblBhdGgpO1xuICAgICAgICB9XG4gICAgICAgIGN0eC5zZXQoJ0NhY2hlLUNvbnRyb2wnLCBjYWNoZUNvbnRyb2wpO1xuICAgICAgICBjdHgudHlwZSA9ICdpbWFnZS94LWljb24nO1xuICAgICAgICBjdHguYm9keSA9IGljb247XG4gICAgfTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gZmF2aWNvbjsiXX0=
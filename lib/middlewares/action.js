"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const _ = Util._;

const {
  InvalidConfiguration
} = require('../Errors');

const Literal = require('../enum/Literal');

const path = require('path');

module.exports = (controllerAction, app) => {
  if (typeof controllerAction !== 'string') {
    throw new InvalidConfiguration('Invalid action syntax.', app);
  }

  let pos = controllerAction.lastIndexOf('.');

  if (pos < 0) {
    throw new InvalidConfiguration(`Unrecognized controller & action syntax: ${controllerAction}.`, app);
  }

  let controller = controllerAction.substr(0, pos);
  let action = controllerAction.substr(pos + 1);
  let controllerBasePath = path.join(app.backendPath, Literal.CONTROLLERS_PATH);
  let controllerPath = path.resolve(controllerBasePath, controller + '.js');

  let ctrl = require(controllerPath);

  let actioner = ctrl[action];

  if (Array.isArray(actioner)) {
    let actionFunction = actioner.concat().pop();

    if (typeof actionFunction !== 'function') {
      throw new InvalidConfiguration(`${controllerAction} does not contain a valid action in returned middleware chain.`, app);
    }

    return actioner.concat(app.wrapAction(actionFunction));
  }

  if (typeof actioner !== 'function') {
    throw new InvalidConfiguration(`${controllerAction} is not a valid action.`, app);
  }

  return app.wrapAction(actioner);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlcy9hY3Rpb24uanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJMaXRlcmFsIiwicGF0aCIsIm1vZHVsZSIsImV4cG9ydHMiLCJjb250cm9sbGVyQWN0aW9uIiwiYXBwIiwicG9zIiwibGFzdEluZGV4T2YiLCJjb250cm9sbGVyIiwic3Vic3RyIiwiYWN0aW9uIiwiY29udHJvbGxlckJhc2VQYXRoIiwiam9pbiIsImJhY2tlbmRQYXRoIiwiQ09OVFJPTExFUlNfUEFUSCIsImNvbnRyb2xsZXJQYXRoIiwicmVzb2x2ZSIsImN0cmwiLCJhY3Rpb25lciIsIkFycmF5IiwiaXNBcnJheSIsImFjdGlvbkZ1bmN0aW9uIiwiY29uY2F0IiwicG9wIiwid3JhcEFjdGlvbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU1DLENBQUMsR0FBR0YsSUFBSSxDQUFDRSxDQUFmOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQkYsT0FBTyxDQUFDLFdBQUQsQ0FBeEM7O0FBQ0EsTUFBTUcsT0FBTyxHQUFHSCxPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBRUEsTUFBTUksSUFBSSxHQUFHSixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFPQUssTUFBTSxDQUFDQyxPQUFQLEdBQWlCLENBQUNDLGdCQUFELEVBQW1CQyxHQUFuQixLQUEyQjtBQUN4QyxNQUFJLE9BQU9ELGdCQUFQLEtBQTRCLFFBQWhDLEVBQTBDO0FBQ3RDLFVBQU0sSUFBSUwsb0JBQUosQ0FBeUIsd0JBQXpCLEVBQW1ETSxHQUFuRCxDQUFOO0FBQ0g7O0FBRUQsTUFBSUMsR0FBRyxHQUFHRixnQkFBZ0IsQ0FBQ0csV0FBakIsQ0FBNkIsR0FBN0IsQ0FBVjs7QUFDQSxNQUFJRCxHQUFHLEdBQUcsQ0FBVixFQUFhO0FBQ1QsVUFBTSxJQUFJUCxvQkFBSixDQUEwQiw0Q0FBMkNLLGdCQUFpQixHQUF0RixFQUEwRkMsR0FBMUYsQ0FBTjtBQUNIOztBQUVELE1BQUlHLFVBQVUsR0FBR0osZ0JBQWdCLENBQUNLLE1BQWpCLENBQXdCLENBQXhCLEVBQTJCSCxHQUEzQixDQUFqQjtBQUNBLE1BQUlJLE1BQU0sR0FBR04sZ0JBQWdCLENBQUNLLE1BQWpCLENBQXdCSCxHQUFHLEdBQUcsQ0FBOUIsQ0FBYjtBQUNBLE1BQUlLLGtCQUFrQixHQUFHVixJQUFJLENBQUNXLElBQUwsQ0FBVVAsR0FBRyxDQUFDUSxXQUFkLEVBQTJCYixPQUFPLENBQUNjLGdCQUFuQyxDQUF6QjtBQUVBLE1BQUlDLGNBQWMsR0FBR2QsSUFBSSxDQUFDZSxPQUFMLENBQWFMLGtCQUFiLEVBQWlDSCxVQUFVLEdBQUcsS0FBOUMsQ0FBckI7O0FBQ0EsTUFBSVMsSUFBSSxHQUFHcEIsT0FBTyxDQUFDa0IsY0FBRCxDQUFsQjs7QUFFQSxNQUFJRyxRQUFRLEdBQUdELElBQUksQ0FBQ1AsTUFBRCxDQUFuQjs7QUFFQSxNQUFJUyxLQUFLLENBQUNDLE9BQU4sQ0FBY0YsUUFBZCxDQUFKLEVBQTZCO0FBQ3pCLFFBQUlHLGNBQWMsR0FBR0gsUUFBUSxDQUFDSSxNQUFULEdBQWtCQyxHQUFsQixFQUFyQjs7QUFDQSxRQUFJLE9BQU9GLGNBQVAsS0FBMEIsVUFBOUIsRUFBMEM7QUFDdEMsWUFBTSxJQUFJdEIsb0JBQUosQ0FBMEIsR0FBRUssZ0JBQWlCLGdFQUE3QyxFQUE4R0MsR0FBOUcsQ0FBTjtBQUNIOztBQUVELFdBQU9hLFFBQVEsQ0FBQ0ksTUFBVCxDQUFnQmpCLEdBQUcsQ0FBQ21CLFVBQUosQ0FBZUgsY0FBZixDQUFoQixDQUFQO0FBQ0g7O0FBRUQsTUFBSSxPQUFPSCxRQUFQLEtBQW9CLFVBQXhCLEVBQW9DO0FBQ2hDLFVBQU0sSUFBSW5CLG9CQUFKLENBQTBCLEdBQUVLLGdCQUFpQix5QkFBN0MsRUFBdUVDLEdBQXZFLENBQU47QUFDSDs7QUFFRCxTQUFPQSxHQUFHLENBQUNtQixVQUFKLENBQWVOLFFBQWYsQ0FBUDtBQUNILENBakNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogUmVzcG9uc2UgYWN0aW9uIGFzIG1pZGRsZXdhcmVcbiAqIEBtb2R1bGUgTWlkZGxld2FyZV9BY3Rpb25cbiAqL1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IF8gPSBVdGlsLl87XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuLi9lbnVtL0xpdGVyYWwnKTtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuLyoqXG4gKiBBY3Rpb24gbWlkZGxld2FyZSBjcmVhdG9yXG4gKiBAcGFyYW0ge3N0cmluZ30gY29udHJvbGxlckFjdGlvbiBcbiAqIEBwYXJhbSB7Um91dGFibGV9IGFwcCBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoY29udHJvbGxlckFjdGlvbiwgYXBwKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBjb250cm9sbGVyQWN0aW9uICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oJ0ludmFsaWQgYWN0aW9uIHN5bnRheC4nLCBhcHApO1xuICAgIH1cblxuICAgIGxldCBwb3MgPSBjb250cm9sbGVyQWN0aW9uLmxhc3RJbmRleE9mKCcuJyk7XG4gICAgaWYgKHBvcyA8IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKGBVbnJlY29nbml6ZWQgY29udHJvbGxlciAmIGFjdGlvbiBzeW50YXg6ICR7Y29udHJvbGxlckFjdGlvbn0uYCwgYXBwKTtcbiAgICB9XG5cbiAgICBsZXQgY29udHJvbGxlciA9IGNvbnRyb2xsZXJBY3Rpb24uc3Vic3RyKDAsIHBvcyk7XG4gICAgbGV0IGFjdGlvbiA9IGNvbnRyb2xsZXJBY3Rpb24uc3Vic3RyKHBvcyArIDEpO1xuICAgIGxldCBjb250cm9sbGVyQmFzZVBhdGggPSBwYXRoLmpvaW4oYXBwLmJhY2tlbmRQYXRoLCBMaXRlcmFsLkNPTlRST0xMRVJTX1BBVEgpO1xuXG4gICAgbGV0IGNvbnRyb2xsZXJQYXRoID0gcGF0aC5yZXNvbHZlKGNvbnRyb2xsZXJCYXNlUGF0aCwgY29udHJvbGxlciArICcuanMnKTtcbiAgICBsZXQgY3RybCA9IHJlcXVpcmUoY29udHJvbGxlclBhdGgpOyAgICBcblxuICAgIGxldCBhY3Rpb25lciA9IGN0cmxbYWN0aW9uXTsgICBcblxuICAgIGlmIChBcnJheS5pc0FycmF5KGFjdGlvbmVyKSkge1xuICAgICAgICBsZXQgYWN0aW9uRnVuY3Rpb24gPSBhY3Rpb25lci5jb25jYXQoKS5wb3AoKTtcbiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb25GdW5jdGlvbiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKGAke2NvbnRyb2xsZXJBY3Rpb259IGRvZXMgbm90IGNvbnRhaW4gYSB2YWxpZCBhY3Rpb24gaW4gcmV0dXJuZWQgbWlkZGxld2FyZSBjaGFpbi5gLCBhcHApO1xuICAgICAgICB9ICAgIFxuXG4gICAgICAgIHJldHVybiBhY3Rpb25lci5jb25jYXQoYXBwLndyYXBBY3Rpb24oYWN0aW9uRnVuY3Rpb24pKTtcbiAgICB9IFxuXG4gICAgaWYgKHR5cGVvZiBhY3Rpb25lciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oYCR7Y29udHJvbGxlckFjdGlvbn0gaXMgbm90IGEgdmFsaWQgYWN0aW9uLmAsIGFwcCk7XG4gICAgfSAgICBcblxuICAgIHJldHVybiBhcHAud3JhcEFjdGlvbihhY3Rpb25lcik7XG59OyJdfQ==
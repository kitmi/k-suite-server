"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

const {
  ServiceContainer
} = require('@k-suite/app');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);

        await this.startContainer();
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !this.argv[name]) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && opts.nonInquireFilter) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }

      if (name in this.argv && opts.onReady) {
        await opts.onReady(this.argv[name]);
      }
    });
  }

  async startContainer() {
    let configFile = this.option('config');
    let configFullPath = this.app.toAbsolutePath(configFile);

    if (!(await fs.exists(configFullPath))) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('OolongContainer', {
      workingPath: this.app.workingPath,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'loggers', 'mailer', 'settings', 'timezone', 'version']
    });
    this.container.logger = this.app.logger;
    return this.container.start_();
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  getSchemasInConfig() {
    let schemas = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');
    return Object.keys(schemas);
  }

  async getDataset_() {
    let scriptSourcePath = this.app.toAbsolutePath(Util.getValueByPath(this.oolongConfig, 'oolong.scriptSourceDir'));
    let schema = this.option('schema');

    if (!schema) {
      throw new Error(`Schema argument is required for listing dataset.`);
    }

    return this.api.dataset_({
      logger: this.app.logger,
      scriptSourcePath,
      schemaDeployment: this.schemaDeployment
    }, schema);
  }

  get oolongConfig() {
    return this.container.config;
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        ...options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource, {});

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvS3NDb3JlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsImZzIiwiaW5xdWlyZXIiLCJwYXRoIiwiQ29tbWFuZHMiLCJPb2xvbmdBcGkiLCJtYWtlRGF0YVNvdXJjZU5hbWUiLCJTdXBwb3J0ZWREcml2ZXJzIiwiU2VydmljZUNvbnRhaW5lciIsIk9vbG9uZ0NvcmUiLCJjb25zdHJ1Y3RvciIsImFwcCIsImFwaSIsImluaXRpYWxpemVfIiwidXNhZ2VPcHRpb25zIiwiY2xvbmVEZWVwIiwiY29uZmlnIiwiY29tbWFuZExpbmVPcHRpb25zIiwiZmVhdHVyZXMiLCJzaG93VXNhZ2UiLCJlcnIiLCJpbmplY3RzIiwiYWZ0ZXJCYW5uZXIiLCJtZXNzYWdlIiwiY29tbWFuZCIsImFmdGVyQ29tbWFuZExpbmUiLCJjb21tYW5kcyIsInJlZHVjZSIsInJlc3VsdCIsImRlc2MiLCJjbWQiLCJjb25zb2xlIiwibG9nIiwiZ2V0VXNhZ2UiLCJhcmd2IiwiY2FtZWxDYXNlIiwidW5kZWZpbmVkIiwiYWN0aW9uXyIsImNvbW1hbmRPcHRpb25zIiwib3B0aW9ucyIsIk9iamVjdCIsImFzc2lnbiIsInBhcnNlQXJndiIsIm9wdGlvbiIsImlucXVpcmVfIiwiX2ZpbGxDb21tYW5kRGVmYXVsdHMiLCJzdGFydENvbnRhaW5lciIsIl92YWxpZGF0ZUFyZ3YiLCJuYW1lIiwiZXhlY3V0ZV8iLCJkb0lucXVpcmUiLCJpdGVtIiwicHJvbXB0IiwidGhlbiIsImFuc3dlcnMiLCJmb3JPd24iLCJhbnMiLCJvcHRzIiwiYWxpYXMiLCJlYWNoIiwiYSIsImVhY2hBc3luY18iLCJpbnF1aXJlIiwidHlwZSIsInEiLCJwcm9tcHRNZXNzYWdlIiwicHJvbXB0VHlwZSIsImNob2ljZXNQcm92aWRlciIsIkVycm9yIiwiY2hvaWNlcyIsImJvb2wiLCJwcm9tcHREZWZhdWx0IiwiZGVmYXVsdCIsImFmdGVySW5xdWlyZSIsIm5vbklucXVpcmVGaWx0ZXIiLCJvblJlYWR5IiwiY29uZmlnRmlsZSIsImNvbmZpZ0Z1bGxQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJleGlzdHMiLCJleHROYW1lIiwiZXh0bmFtZSIsImNvbmZpZ05hbWUiLCJiYXNlbmFtZSIsImNvbmZpZ1BhdGgiLCJkaXJuYW1lIiwiZW52QXdhcmUiLCJlbmRzV2l0aCIsInN1YnN0ciIsImxlbmd0aCIsImNvbnRhaW5lciIsIndvcmtpbmdQYXRoIiwiZGlzYWJsZUVudkF3YXJlQ29uZmlnIiwiYWxsb3dlZEZlYXR1cmVzIiwibG9nZ2VyIiwic3RhcnRfIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvb2xvbmdDb25maWciLCJmb3JFYWNoIiwiZHJpdmVyIiwiY29ubmVjdG9ycyIsImNvbm5lY3Rvck9wdGlvbnMiLCJjb25uZWN0b3JOYW1lIiwiY29ubmVjdGlvbiIsImdldFNjaGVtYXNJbkNvbmZpZyIsInNjaGVtYXMiLCJnZXRWYWx1ZUJ5UGF0aCIsImtleXMiLCJnZXREYXRhc2V0XyIsInNjcmlwdFNvdXJjZVBhdGgiLCJzY2hlbWEiLCJkYXRhc2V0XyIsInNjaGVtYURlcGxveW1lbnQiLCJtb2RlbE1hcHBpbmciLCJpc0VtcHR5IiwibWFwVmFsdWVzIiwibWFwcGluZyIsInNjaGVtYU5hbWUiLCJkYXRhU291cmNlIiwib3RoZXJzIiwiY29ubmVjdGlvblN0cmluZyIsImdldFJldmVyc2VPdXRwdXREaXIiLCJiYXNlRGlyIiwicHJlZml4Iiwib3ZlcnJpZGUiLCJub3ciLCJEYXRlIiwiZm9sZGVyIiwiZ2V0RnVsbFllYXIiLCJnZXRNb250aCIsImdldERhdGUiLCJvdXRwdXREaXIiLCJqb2luIiwibnVtIiwiZXhpc3RzU3luYyIsImZvbGRlcjIiLCJ0b1N0cmluZyIsInZhbGlkIiwicmVxdWlyZWQiLCJlcnJvciIsImluZm8iLCJoYXNPd25Qcm9wZXJ0eSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILElBQWxCOztBQUNBLE1BQU1JLFFBQVEsR0FBR0gsT0FBTyxDQUFDLFVBQUQsQ0FBeEI7O0FBQ0EsTUFBTUksSUFBSSxHQUFHSixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNSyxRQUFRLEdBQUdMLE9BQU8sQ0FBQyxZQUFELENBQXhCOztBQUNBLE1BQU1NLFNBQVMsR0FBR04sT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBQ0EsTUFBTTtBQUFFTyxFQUFBQSxrQkFBRjtBQUFzQkMsRUFBQUE7QUFBdEIsSUFBMkNSLE9BQU8sQ0FBQyxlQUFELENBQXhEOztBQUNBLE1BQU07QUFBRVMsRUFBQUE7QUFBRixJQUF1QlQsT0FBTyxDQUFDLGNBQUQsQ0FBcEM7O0FBTUEsTUFBTVUsVUFBTixDQUFpQjtBQUNiQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBTTtBQUNiLFNBQUtBLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLEdBQUwsR0FBV1AsU0FBWDtBQUNIOztBQUtELFFBQU1RLFdBQU4sR0FBb0I7QUFDaEIsU0FBS0MsWUFBTCxHQUFvQmQsQ0FBQyxDQUFDZSxTQUFGLENBQVksS0FBS0osR0FBTCxDQUFTSyxNQUFULENBQWdCQyxrQkFBNUIsQ0FBcEI7QUFDQSxRQUFJQSxrQkFBa0IsR0FBRyxLQUFLTixHQUFMLENBQVNPLFFBQVQsQ0FBa0Isb0JBQWxCLENBQXpCOztBQUVBLFNBQUtDLFNBQUwsR0FBa0JDLEdBQUQsSUFBUztBQUN0QixVQUFJQyxPQUFPLEdBQUcsRUFBZDs7QUFFQSxVQUFJRCxHQUFKLEVBQVM7QUFDTEMsUUFBQUEsT0FBTyxDQUFDQyxXQUFSLEdBQXNCLE1BQU0sQ0FBQ0YsR0FBRyxDQUFDRyxPQUFKLElBQWVILEdBQWhCLElBQXVCLE1BQW5EO0FBQ0g7O0FBRUQsVUFBSSxLQUFLSSxPQUFMLElBQWdCLEtBQUtBLE9BQUwsS0FBaUIsTUFBckMsRUFBNkM7QUFDekNILFFBQUFBLE9BQU8sQ0FBQ0ksZ0JBQVIsR0FBMkIsTUFBTyxZQUFXLEtBQUtELE9BQVEsS0FBekIsR0FBZ0NwQixRQUFRLENBQUNzQixRQUFULENBQWtCLEtBQUtGLE9BQXZCLENBQWhDLEdBQWlFLE1BQWxHO0FBQ0gsT0FGRCxNQUVPO0FBQ0hILFFBQUFBLE9BQU8sQ0FBQ0ksZ0JBQVIsR0FBMkIsTUFBTSwwQkFBMEJ6QixDQUFDLENBQUMyQixNQUFGLENBQVN2QixRQUFRLENBQUNzQixRQUFsQixFQUE0QixDQUFDRSxNQUFELEVBQVNDLElBQVQsRUFBZUMsR0FBZixLQUF1QkYsTUFBTSxHQUFJLEtBQUlFLEdBQUksS0FBSUQsSUFBSyxJQUE5RSxFQUFtRixFQUFuRixDQUExQixHQUFtSCxJQUFwSjtBQUNIOztBQUVERSxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWYsa0JBQWtCLENBQUNnQixRQUFuQixDQUE0QixLQUFLdEIsR0FBakMsRUFBc0MsS0FBS0csWUFBM0MsRUFBeURPLE9BQXpELENBQVo7QUFDSCxLQWREOztBQWlCQSxRQUFJRyxPQUFPLEdBQUcsS0FBS2IsR0FBTCxDQUFTdUIsSUFBVCxDQUFjbEMsQ0FBZCxDQUFnQixDQUFoQixDQUFkO0FBRUEsU0FBS3dCLE9BQUwsR0FBZXhCLENBQUMsQ0FBQ21DLFNBQUYsQ0FBWVgsT0FBWixDQUFmOztBQUVBLFFBQUksS0FBS0EsT0FBTCxLQUFpQixVQUFqQixJQUErQixLQUFLQSxPQUFMLEtBQWlCLFNBQXBELEVBQStEO0FBQzNELFdBQUtBLE9BQUwsR0FBZVksU0FBZjtBQUNBLGFBQU8sS0FBUDtBQUNIOztBQUVELFNBQUtDLE9BQUwsR0FBZWpDLFFBQVEsQ0FBQyxLQUFLb0IsT0FBTixDQUF2Qjs7QUFFQSxRQUFJLE9BQU8sS0FBS2EsT0FBWixLQUF3QixVQUE1QixFQUF3QztBQUNwQyxXQUFLYixPQUFMLEdBQWVZLFNBQWY7QUFDQSxhQUFPLEtBQVA7QUFDSDs7QUFFRCxRQUFJRSxjQUFjLEdBQUdsQyxRQUFRLENBQUNtQyxPQUFULENBQWlCLElBQWpCLENBQXJCO0FBQ0FDLElBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEtBQUszQixZQUFMLENBQWtCeUIsT0FBaEMsRUFBeUNELGNBQXpDO0FBR0EsU0FBS0osSUFBTCxHQUFZakIsa0JBQWtCLENBQUN5QixTQUFuQixDQUE2QixLQUFLNUIsWUFBTCxDQUFrQnlCLE9BQS9DLENBQVo7O0FBRUEsUUFBSSxLQUFLZixPQUFMLEtBQWlCLE1BQWpCLElBQTJCLENBQUMsS0FBS21CLE1BQUwsQ0FBWSxHQUFaLENBQWhDLEVBQWtEO0FBQzlDLFVBQUksQ0FBQyxLQUFLQSxNQUFMLENBQVksR0FBWixDQUFMLEVBQXVCO0FBQ25CLGNBQU0sS0FBS0MsUUFBTCxFQUFOO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsYUFBS0Msb0JBQUwsQ0FBMEJQLGNBQTFCOztBQUNBLGNBQU0sS0FBS1EsY0FBTCxFQUFOO0FBQ0g7O0FBRUQsVUFBSSxDQUFDLEtBQUtDLGFBQUwsRUFBTCxFQUEyQjtBQUN2QixlQUFPLEtBQVA7QUFDSDtBQUNKOztBQUVELFdBQU8sSUFBUDtBQUNIOztBQUVESixFQUFBQSxNQUFNLENBQUNLLElBQUQsRUFBTztBQUNULFdBQU8sS0FBS2QsSUFBTCxDQUFVYyxJQUFWLENBQVA7QUFDSDs7QUFFRCxRQUFNQyxRQUFOLEdBQWlCO0FBQ2IsUUFBSSxLQUFLTixNQUFMLENBQVksR0FBWixDQUFKLEVBQXNCO0FBQ2xCLFdBQUt4QixTQUFMO0FBQ0gsS0FGRCxNQUVPO0FBQ0gsYUFBTyxLQUFLa0IsT0FBTCxDQUFhLElBQWIsQ0FBUDtBQUNIO0FBQ0o7O0FBRUQsUUFBTU8sUUFBTixHQUFpQjtBQUNiLFFBQUlNLFNBQVMsR0FBR0MsSUFBSSxJQUFJakQsUUFBUSxDQUFDa0QsTUFBVCxDQUFnQixDQUFDRCxJQUFELENBQWhCLEVBQXdCRSxJQUF4QixDQUE2QkMsT0FBTyxJQUFJO0FBQzVEdEQsTUFBQUEsQ0FBQyxDQUFDdUQsTUFBRixDQUFTRCxPQUFULEVBQWtCLENBQUNFLEdBQUQsRUFBTVIsSUFBTixLQUFlO0FBQzdCLGFBQUtkLElBQUwsQ0FBVWMsSUFBVixJQUFrQlEsR0FBbEI7QUFDQSxZQUFJQyxJQUFJLEdBQUcsS0FBSzNDLFlBQUwsQ0FBa0J5QixPQUFsQixDQUEwQlMsSUFBMUIsQ0FBWDs7QUFDQSxZQUFJUyxJQUFJLENBQUNDLEtBQVQsRUFBZ0I7QUFDWjFELFVBQUFBLENBQUMsQ0FBQzJELElBQUYsQ0FBT0YsSUFBSSxDQUFDQyxLQUFaLEVBQW1CRSxDQUFDLElBQUk7QUFBRSxpQkFBSzFCLElBQUwsQ0FBVTBCLENBQVYsSUFBZUosR0FBZjtBQUFxQixXQUEvQztBQUNIO0FBQ0osT0FORDtBQU9ILEtBUnVCLENBQXhCOztBQVVBLFdBQU8xRCxJQUFJLENBQUMrRCxVQUFMLENBQWdCLEtBQUsvQyxZQUFMLENBQWtCeUIsT0FBbEMsRUFBMkMsT0FBT2tCLElBQVAsRUFBYVQsSUFBYixLQUFzQjtBQUNwRSxVQUFLLGFBQWFTLElBQWQsSUFBdUIsQ0FBQyxLQUFLdkIsSUFBTCxDQUFVYyxJQUFWLENBQTVCLEVBQTZDO0FBQ3pDLFlBQUljLE9BQU8sR0FBR0wsSUFBSSxDQUFDSyxPQUFuQjs7QUFFQSxZQUFJLE9BQU9MLElBQUksQ0FBQ0ssT0FBWixLQUF3QixVQUE1QixFQUF3QztBQUNwQ0EsVUFBQUEsT0FBTyxHQUFHLE1BQU1MLElBQUksQ0FBQ0ssT0FBTCxFQUFoQjtBQUNIOztBQUVELFlBQUlBLE9BQUosRUFBYTtBQUNULGNBQUlDLElBQUo7QUFDQSxjQUFJQyxDQUFDLEdBQUc7QUFBRWhCLFlBQUFBLElBQUksRUFBRUEsSUFBUjtBQUFjekIsWUFBQUEsT0FBTyxFQUFFa0MsSUFBSSxDQUFDUSxhQUFMLElBQXNCUixJQUFJLENBQUM1QjtBQUFsRCxXQUFSOztBQUVBLGNBQUk0QixJQUFJLENBQUNTLFVBQVQsRUFBcUI7QUFDakJILFlBQUFBLElBQUksR0FBR04sSUFBSSxDQUFDUyxVQUFaOztBQUNBLGdCQUFJSCxJQUFJLEtBQUssTUFBVCxJQUFtQkEsSUFBSSxLQUFNLFNBQTdCLElBQTBDQSxJQUFJLEtBQUssVUFBbkQsSUFBaUVBLElBQUksS0FBSyxRQUE5RSxFQUF3RjtBQUNwRixrQkFBSSxDQUFDTixJQUFJLENBQUNVLGVBQVYsRUFBMkI7QUFDdkIsc0JBQU0sSUFBSUMsS0FBSixDQUFVLDJCQUFWLENBQU47QUFDSDs7QUFFREosY0FBQUEsQ0FBQyxDQUFDSyxPQUFGLEdBQVksTUFBTVosSUFBSSxDQUFDVSxlQUFMLEVBQWxCO0FBQ0g7QUFDSixXQVRELE1BU08sSUFBSVYsSUFBSSxDQUFDYSxJQUFULEVBQWU7QUFDbEJQLFlBQUFBLElBQUksR0FBRyxTQUFQO0FBQ0gsV0FGTSxNQUVBO0FBQ0hBLFlBQUFBLElBQUksR0FBRyxPQUFQO0FBQ0g7O0FBRURDLFVBQUFBLENBQUMsQ0FBQ0QsSUFBRixHQUFTQSxJQUFUOztBQUVBLGNBQUksbUJBQW1CTixJQUF2QixFQUE2QjtBQUN6QixnQkFBSSxPQUFPQSxJQUFJLENBQUNjLGFBQVosS0FBOEIsVUFBbEMsRUFBOEM7QUFDMUNQLGNBQUFBLENBQUMsQ0FBQ1EsT0FBRixHQUFZLE1BQU1mLElBQUksQ0FBQ2MsYUFBTCxFQUFsQjtBQUNILGFBRkQsTUFFTztBQUNIUCxjQUFBQSxDQUFDLENBQUNRLE9BQUYsR0FBWWYsSUFBSSxDQUFDYyxhQUFqQjtBQUNIO0FBQ0o7O0FBRUQsZ0JBQU1yQixTQUFTLENBQUNjLENBQUQsQ0FBZjs7QUFFQSxjQUFJUCxJQUFJLENBQUNnQixZQUFULEVBQXVCO0FBQ25CLGtCQUFNaEIsSUFBSSxDQUFDZ0IsWUFBTCxFQUFOO0FBQ0g7O0FBRUQxQyxVQUFBQSxPQUFPLENBQUNDLEdBQVI7QUFDSDtBQUNKLE9BNUNELE1BNENPLElBQUlnQixJQUFJLElBQUksS0FBS2QsSUFBYixJQUFxQnVCLElBQUksQ0FBQ2lCLGdCQUE5QixFQUFnRDtBQUNuRCxhQUFLeEMsSUFBTCxDQUFVYyxJQUFWLElBQWtCLE1BQU1TLElBQUksQ0FBQ2lCLGdCQUFMLENBQXNCLEtBQUt4QyxJQUFMLENBQVVjLElBQVYsQ0FBdEIsQ0FBeEI7QUFDSDs7QUFFRCxVQUFJQSxJQUFJLElBQUksS0FBS2QsSUFBYixJQUFxQnVCLElBQUksQ0FBQ2tCLE9BQTlCLEVBQXVDO0FBQ25DLGNBQU1sQixJQUFJLENBQUNrQixPQUFMLENBQWEsS0FBS3pDLElBQUwsQ0FBVWMsSUFBVixDQUFiLENBQU47QUFDSDtBQUNKLEtBcERNLENBQVA7QUFxREg7O0FBRUQsUUFBTUYsY0FBTixHQUF1QjtBQUNuQixRQUFJOEIsVUFBVSxHQUFHLEtBQUtqQyxNQUFMLENBQVksUUFBWixDQUFqQjtBQUVBLFFBQUlrQyxjQUFjLEdBQUcsS0FBS2xFLEdBQUwsQ0FBU21FLGNBQVQsQ0FBd0JGLFVBQXhCLENBQXJCOztBQUVBLFFBQUksRUFBRSxNQUFNM0UsRUFBRSxDQUFDOEUsTUFBSCxDQUFVRixjQUFWLENBQVIsQ0FBSixFQUF3QztBQUNwQyxZQUFNLElBQUlULEtBQUosQ0FBVyxXQUFVUSxVQUFXLGNBQWhDLENBQU47QUFDSDs7QUFFRCxRQUFJSSxPQUFPLEdBQUc3RSxJQUFJLENBQUM4RSxPQUFMLENBQWFKLGNBQWIsQ0FBZDs7QUFDQSxRQUFJRyxPQUFPLEtBQUssT0FBaEIsRUFBeUI7QUFDckIsWUFBTSxJQUFJWixLQUFKLENBQVUsNEJBQVYsQ0FBTjtBQUNIOztBQUVELFFBQUljLFVBQVUsR0FBRy9FLElBQUksQ0FBQ2dGLFFBQUwsQ0FBY04sY0FBZCxFQUE4QkcsT0FBOUIsQ0FBakI7QUFDQSxRQUFJSSxVQUFVLEdBQUdqRixJQUFJLENBQUNrRixPQUFMLENBQWFSLGNBQWIsQ0FBakI7QUFDQSxRQUFJUyxRQUFRLEdBQUcsS0FBZjs7QUFFQSxRQUFJSixVQUFVLENBQUNLLFFBQVgsQ0FBb0IsVUFBcEIsQ0FBSixFQUFxQztBQUNqQ0QsTUFBQUEsUUFBUSxHQUFHLElBQVg7QUFDQUosTUFBQUEsVUFBVSxHQUFHQSxVQUFVLENBQUNNLE1BQVgsQ0FBa0IsQ0FBbEIsRUFBcUJOLFVBQVUsQ0FBQ08sTUFBWCxHQUFvQixDQUF6QyxDQUFiO0FBQ0g7O0FBRUQsU0FBS0MsU0FBTCxHQUFpQixJQUFJbEYsZ0JBQUosQ0FBcUIsaUJBQXJCLEVBQXdDO0FBQ3JEbUYsTUFBQUEsV0FBVyxFQUFFLEtBQUtoRixHQUFMLENBQVNnRixXQUQrQjtBQUVyRFAsTUFBQUEsVUFGcUQ7QUFHckRGLE1BQUFBLFVBSHFEO0FBSXJEVSxNQUFBQSxxQkFBcUIsRUFBRSxDQUFDTixRQUo2QjtBQUtyRE8sTUFBQUEsZUFBZSxFQUFFLENBQ2Isa0JBRGEsRUFFYixvQkFGYSxFQUdiLFNBSGEsRUFJYixRQUphLEVBS2IsVUFMYSxFQU1iLFVBTmEsRUFPYixTQVBhO0FBTG9DLEtBQXhDLENBQWpCO0FBZ0JBLFNBQUtILFNBQUwsQ0FBZUksTUFBZixHQUF3QixLQUFLbkYsR0FBTCxDQUFTbUYsTUFBakM7QUFFQSxXQUFPLEtBQUtKLFNBQUwsQ0FBZUssTUFBZixFQUFQO0FBQ0g7O0FBT0RDLEVBQUFBLG9CQUFvQixHQUFHO0FBQ25CLFFBQUloRixNQUFNLEdBQUcsS0FBS2lGLFlBQWxCO0FBQ0EsUUFBSXJFLE1BQU0sR0FBRyxFQUFiO0FBRUFyQixJQUFBQSxnQkFBZ0IsQ0FBQzJGLE9BQWpCLENBQXlCQyxNQUFNLElBQUk7QUFDL0IsVUFBSUMsVUFBVSxHQUFHcEYsTUFBTSxDQUFDbUYsTUFBRCxDQUF2Qjs7QUFFQSxVQUFJQyxVQUFKLEVBQWdCO0FBQ1pwRyxRQUFBQSxDQUFDLENBQUN1RCxNQUFGLENBQVM2QyxVQUFULEVBQXFCLENBQUNDLGdCQUFELEVBQW1CQyxhQUFuQixLQUFxQztBQUN0RDFFLFVBQUFBLE1BQU0sQ0FBQ3RCLGtCQUFrQixDQUFDNkYsTUFBRCxFQUFTRyxhQUFULENBQW5CLENBQU4sR0FBb0RELGdCQUFnQixDQUFDRSxVQUFyRTtBQUNILFNBRkQ7QUFHSDtBQUNKLEtBUkQ7QUFVQSxXQUFPM0UsTUFBUDtBQUNIOztBQUVENEUsRUFBQUEsa0JBQWtCLEdBQUc7QUFDakIsUUFBSUMsT0FBTyxHQUFHM0csSUFBSSxDQUFDNEcsY0FBTCxDQUFvQixLQUFLVCxZQUF6QixFQUF1Qyx5QkFBdkMsQ0FBZDtBQUNBLFdBQU96RCxNQUFNLENBQUNtRSxJQUFQLENBQVlGLE9BQVosQ0FBUDtBQUNIOztBQUVELFFBQU1HLFdBQU4sR0FBb0I7QUFDaEIsUUFBSUMsZ0JBQWdCLEdBQUcsS0FBS2xHLEdBQUwsQ0FBU21FLGNBQVQsQ0FBd0JoRixJQUFJLENBQUM0RyxjQUFMLENBQW9CLEtBQUtULFlBQXpCLEVBQXVDLHdCQUF2QyxDQUF4QixDQUF2QjtBQUVBLFFBQUlhLE1BQU0sR0FBRyxLQUFLbkUsTUFBTCxDQUFZLFFBQVosQ0FBYjs7QUFDQSxRQUFJLENBQUNtRSxNQUFMLEVBQWE7QUFDVCxZQUFNLElBQUkxQyxLQUFKLENBQVcsa0RBQVgsQ0FBTjtBQUNIOztBQUVELFdBQU8sS0FBS3hELEdBQUwsQ0FBU21HLFFBQVQsQ0FDSDtBQUNJakIsTUFBQUEsTUFBTSxFQUFFLEtBQUtuRixHQUFMLENBQVNtRixNQURyQjtBQUVJZSxNQUFBQSxnQkFGSjtBQUdJRyxNQUFBQSxnQkFBZ0IsRUFBRSxLQUFLQTtBQUgzQixLQURHLEVBTUhGLE1BTkcsQ0FBUDtBQVFIOztBQUVELE1BQUliLFlBQUosR0FBbUI7QUFDZixXQUFPLEtBQUtQLFNBQUwsQ0FBZTFFLE1BQXRCO0FBQ0g7O0FBRUQsTUFBSWdHLGdCQUFKLEdBQXVCO0FBQ25CLFFBQUlDLFlBQVksR0FBR25ILElBQUksQ0FBQzRHLGNBQUwsQ0FBb0IsS0FBS1QsWUFBekIsRUFBdUMseUJBQXZDLENBQW5COztBQUVBLFFBQUlqRyxDQUFDLENBQUNrSCxPQUFGLENBQVVELFlBQVYsQ0FBSixFQUE2QjtBQUN6QixZQUFNLElBQUk3QyxLQUFKLENBQVUsOEJBQVYsQ0FBTjtBQUNIOztBQUVELFdBQU9wRSxDQUFDLENBQUNtSCxTQUFGLENBQVlGLFlBQVosRUFBMEIsQ0FBQ0csT0FBRCxFQUFVQyxVQUFWLEtBQXlCO0FBQ3RELFVBQUk7QUFBRUMsUUFBQUEsVUFBRjtBQUFjLFdBQUdDO0FBQWpCLFVBQTRCSCxPQUFoQzs7QUFFQSxVQUFJLENBQUNFLFVBQUwsRUFBaUI7QUFDYixjQUFNLElBQUlsRCxLQUFKLENBQVcsd0NBQXVDaUQsVUFBVyx5QkFBN0QsQ0FBTjtBQUNIOztBQUVELFVBQUk7QUFBRWQsUUFBQUEsVUFBRjtBQUFjLFdBQUdoRTtBQUFqQixVQUE2QnpDLElBQUksQ0FBQzRHLGNBQUwsQ0FBb0IsS0FBS1QsWUFBekIsRUFBdUMsZ0JBQWdCcUIsVUFBdkQsRUFBbUUsRUFBbkUsQ0FBakM7O0FBQ0EsVUFBSSxDQUFDZixVQUFMLEVBQWlCO0FBQ2IsY0FBTSxJQUFJbkMsS0FBSixDQUFXLHFDQUFvQ2tELFVBQVcsY0FBMUQsQ0FBTjtBQUNIOztBQUVELGFBQU87QUFBRUEsUUFBQUEsVUFBRjtBQUFjRSxRQUFBQSxnQkFBZ0IsRUFBRWpCLFVBQWhDO0FBQTRDaEUsUUFBQUEsT0FBNUM7QUFBcUQsV0FBR2dGO0FBQXhELE9BQVA7QUFDSCxLQWJNLENBQVA7QUFjSDs7QUFRREUsRUFBQUEsbUJBQW1CLENBQUNDLE9BQUQsRUFBVUMsTUFBTSxHQUFHLEVBQW5CLEVBQXVCQyxRQUFRLEdBQUcsS0FBbEMsRUFBeUM7QUFDeEQsUUFBSUMsR0FBRyxHQUFHLElBQUlDLElBQUosRUFBVjtBQUNBLFFBQUlDLE1BQU0sR0FBSSxHQUFFSixNQUFPLEdBQUVFLEdBQUcsQ0FBQ0csV0FBSixFQUFrQixJQUFHSCxHQUFHLENBQUNJLFFBQUosS0FBZSxDQUFFLElBQUdKLEdBQUcsQ0FBQ0ssT0FBSixFQUFjLEVBQWhGO0FBQ0EsUUFBSUMsU0FBUyxHQUFHaEksSUFBSSxDQUFDaUksSUFBTCxDQUFVVixPQUFWLEVBQW1CSyxNQUFuQixDQUFoQjtBQUVBLFFBQUlILFFBQUosRUFBYyxPQUFPTyxTQUFQO0FBRWQsUUFBSUUsR0FBRyxHQUFHLENBQVY7O0FBRUEsV0FBT3BJLEVBQUUsQ0FBQ3FJLFVBQUgsQ0FBY0gsU0FBZCxDQUFQLEVBQWlDO0FBQzdCLFVBQUlJLE9BQU8sR0FBR1IsTUFBTSxHQUFHLEdBQVQsR0FBZSxDQUFDLEVBQUVNLEdBQUgsRUFBUUcsUUFBUixFQUE3QjtBQUNBTCxNQUFBQSxTQUFTLEdBQUdoSSxJQUFJLENBQUNpSSxJQUFMLENBQVVWLE9BQVYsRUFBbUJhLE9BQW5CLENBQVo7QUFDSDs7QUFFRCxXQUFPSixTQUFQO0FBQ0g7O0FBR0RwRixFQUFBQSxhQUFhLEdBQUc7QUFDWixRQUFJMEYsS0FBSyxHQUFHLElBQVo7O0FBRUF6SSxJQUFBQSxDQUFDLENBQUN1RCxNQUFGLENBQVMsS0FBS3pDLFlBQUwsQ0FBa0J5QixPQUEzQixFQUFvQyxDQUFDa0IsSUFBRCxFQUFPVCxJQUFQLEtBQWdCO0FBQ2hELFVBQUkwRixRQUFRLEdBQUdqRixJQUFJLENBQUNpRixRQUFwQjs7QUFFQSxVQUFJLE9BQU9BLFFBQVAsS0FBb0IsVUFBeEIsRUFBb0M7QUFDaENBLFFBQUFBLFFBQVEsR0FBR0EsUUFBUSxFQUFuQjtBQUNIOztBQUVELFVBQUlBLFFBQVEsSUFBSSxFQUFFMUYsSUFBSSxJQUFJLEtBQUtkLElBQWYsQ0FBaEIsRUFBc0M7QUFDbENILFFBQUFBLE9BQU8sQ0FBQzRHLEtBQVIsQ0FBZSxhQUFZM0YsSUFBSyxnQkFBaEM7QUFDQXlGLFFBQUFBLEtBQUssR0FBRyxLQUFSO0FBQ0g7QUFDSixLQVhEOztBQWFBLFdBQU9BLEtBQVA7QUFDSDs7QUFHRDVGLEVBQUFBLG9CQUFvQixDQUFDUCxjQUFELEVBQWlCO0FBQ2pDdEMsSUFBQUEsQ0FBQyxDQUFDdUQsTUFBRixDQUFTakIsY0FBVCxFQUF5QixDQUFDc0csSUFBRCxFQUFPakcsTUFBUCxLQUFrQjtBQUN2QyxVQUFJLENBQUMsS0FBS1QsSUFBTCxDQUFVMkcsY0FBVixDQUF5QmxHLE1BQXpCLENBQUQsSUFBcUNpRyxJQUFJLENBQUNDLGNBQUwsQ0FBb0IsZUFBcEIsQ0FBekMsRUFBK0U7QUFDM0UsYUFBSzNHLElBQUwsQ0FBVVMsTUFBVixJQUFvQmlHLElBQUksQ0FBQ3JFLGFBQXpCO0FBQ0g7QUFDSixLQUpEO0FBS0g7O0FBeFRZOztBQTJUakJ1RSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ0SSxVQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpOyBcbmNvbnN0IHsgXywgZnMgfSA9IFV0aWw7XG5jb25zdCBpbnF1aXJlciA9IHJlcXVpcmUoJ2lucXVpcmVyJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgQ29tbWFuZHMgPSByZXF1aXJlKCcuL2NvbW1hbmRzJyk7XG5jb25zdCBPb2xvbmdBcGkgPSByZXF1aXJlKCcuLi9sYW5nL2FwaScpO1xuY29uc3QgeyBtYWtlRGF0YVNvdXJjZU5hbWUsIFN1cHBvcnRlZERyaXZlcnMgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcbmNvbnN0IHsgU2VydmljZUNvbnRhaW5lciB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwJyk7XG5cbi8qKlxuICogT29sb25nIGNvbW1hbmQgbGluZSBoZWxwZXIgY29yZSBjbGFzcy5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBPb2xvbmdDb3JlIHtcbiAgICBjb25zdHJ1Y3RvcihhcHApIHtcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMuYXBpID0gT29sb25nQXBpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBSZXBhcnNlIGNvbW1hbmQgbGluZSBhcmd1bWVudHMgd2l0aCBjb21tYW5kIHNwZWNpZmljIG9wdGlvbnMuXG4gICAgICovXG4gICAgYXN5bmMgaW5pdGlhbGl6ZV8oKSB7ICAgICAgICBcbiAgICAgICAgdGhpcy51c2FnZU9wdGlvbnMgPSBfLmNsb25lRGVlcCh0aGlzLmFwcC5jb25maWcuY29tbWFuZExpbmVPcHRpb25zKTtcbiAgICAgICAgbGV0IGNvbW1hbmRMaW5lT3B0aW9ucyA9IHRoaXMuYXBwLmZlYXR1cmVzWydjb21tYW5kTGluZU9wdGlvbnMnXTtcblxuICAgICAgICB0aGlzLnNob3dVc2FnZSA9IChlcnIpID0+IHtcbiAgICAgICAgICAgIGxldCBpbmplY3RzID0ge307XG5cbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQmFubmVyID0gKCkgPT4gKGVyci5tZXNzYWdlIHx8IGVycikgKyAnXFxuXFxuJztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuY29tbWFuZCAmJiB0aGlzLmNvbW1hbmQgIT09ICdtYWluJykge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJDb21tYW5kTGluZSA9ICgpID0+IGBDb21tYW5kIFwiJHt0aGlzLmNvbW1hbmR9XCI6IGAgKyBDb21tYW5kcy5jb21tYW5kc1t0aGlzLmNvbW1hbmRdICsnXFxuXFxuJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckNvbW1hbmRMaW5lID0gKCkgPT4gJ0F2YWlsYWJsZSBjb21tYW5kczpcXG4nICsgXy5yZWR1Y2UoQ29tbWFuZHMuY29tbWFuZHMsIChyZXN1bHQsIGRlc2MsIGNtZCkgPT4gcmVzdWx0ICsgYCAgJHtjbWR9OiAke2Rlc2N9XFxuYCwgJycpICsgJ1xcbidcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgY29uc29sZS5sb2coY29tbWFuZExpbmVPcHRpb25zLmdldFVzYWdlKHRoaXMuYXBwLCB0aGlzLnVzYWdlT3B0aW9ucywgaW5qZWN0cykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9leHRyYWN0IG1vZHVsZSBhbmQgY29tbWFuZFxuICAgICAgICBsZXQgY29tbWFuZCA9IHRoaXMuYXBwLmFyZ3YuX1swXTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuY29tbWFuZCA9IF8uY2FtZWxDYXNlKGNvbW1hbmQpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgPT09ICdjb21tYW5kcycgfHwgdGhpcy5jb21tYW5kID09PSAnb3B0aW9ucycpIHtcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuYWN0aW9uXyA9IENvbW1hbmRzW3RoaXMuY29tbWFuZF07XG5cbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmFjdGlvbl8gIT09ICdmdW5jdGlvbicpIHsgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDsgICBcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb21tYW5kT3B0aW9ucyA9IENvbW1hbmRzLm9wdGlvbnModGhpcyk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgY29tbWFuZE9wdGlvbnMpO1xuXG4gICAgICAgIC8vcmUtcGFyc2UgYXJndW1lbnRzIGFjY29yZGluZyB0byBzZXR0aW5nc1xuICAgICAgICB0aGlzLmFyZ3YgPSBjb21tYW5kTGluZU9wdGlvbnMucGFyc2VBcmd2KHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKHRoaXMuY29tbWFuZCAhPT0gJ21haW4nICYmICF0aGlzLm9wdGlvbignPycpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9uKCdzJykpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmlucXVpcmVfKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZpbGxDb21tYW5kRGVmYXVsdHMoY29tbWFuZE9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRDb250YWluZXIoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZUFyZ3YoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIG9wdGlvbihuYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyZ3ZbbmFtZV07XG4gICAgfSAgICBcblxuICAgIGFzeW5jIGV4ZWN1dGVfKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRpb24oJz8nKSkge1xuICAgICAgICAgICAgdGhpcy5zaG93VXNhZ2UoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFjdGlvbl8odGhpcyk7XG4gICAgICAgIH1cbiAgICB9ICAgIFxuXG4gICAgYXN5bmMgaW5xdWlyZV8oKSB7XG4gICAgICAgIGxldCBkb0lucXVpcmUgPSBpdGVtID0+IGlucXVpcmVyLnByb21wdChbaXRlbV0pLnRoZW4oYW5zd2VycyA9PiB7XG4gICAgICAgICAgICBfLmZvck93bihhbnN3ZXJzLCAoYW5zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W25hbWVdID0gYW5zO1xuICAgICAgICAgICAgICAgIGxldCBvcHRzID0gdGhpcy51c2FnZU9wdGlvbnMub3B0aW9uc1tuYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICBfLmVhY2gob3B0cy5hbGlhcywgYSA9PiB7IHRoaXMuYXJndlthXSA9IGFuczsgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7IFxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIFV0aWwuZWFjaEFzeW5jXyh0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zLCBhc3luYyAob3B0cywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKCgnaW5xdWlyZScgaW4gb3B0cykgJiYgIXRoaXMuYXJndltuYW1lXSkge1xuICAgICAgICAgICAgICAgIGxldCBpbnF1aXJlID0gb3B0cy5pbnF1aXJlO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5pbnF1aXJlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlucXVpcmUgPSBhd2FpdCBvcHRzLmlucXVpcmUoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5xdWlyZSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgdHlwZTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHEgPSB7IG5hbWU6IG5hbWUsIG1lc3NhZ2U6IG9wdHMucHJvbXB0TWVzc2FnZSB8fCBvcHRzLmRlc2MgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5wcm9tcHRUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gb3B0cy5wcm9tcHRUeXBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdsaXN0JyB8fCB0eXBlICA9PT0gJ3Jhd0xpc3QnIHx8IHR5cGUgPT09ICdjaGVja2JveCcgfHwgdHlwZSA9PT0gJ2V4cGFuZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdHMuY2hvaWNlc1Byb3ZpZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBjaG9pY2VzIHByb3ZpZGVyIScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuY2hvaWNlcyA9IGF3YWl0IG9wdHMuY2hvaWNlc1Byb3ZpZGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0cy5ib29sKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ2NvbmZpcm0nO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdpbnB1dCdcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHEudHlwZSA9IHR5cGU7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCdwcm9tcHREZWZhdWx0JyBpbiBvcHRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdHMucHJvbXB0RGVmYXVsdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuZGVmYXVsdCA9IGF3YWl0IG9wdHMucHJvbXB0RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxLmRlZmF1bHQgPSBvcHRzLnByb21wdERlZmF1bHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkb0lucXVpcmUocSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuYWZ0ZXJJbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBvcHRzLmFmdGVySW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgaW4gdGhpcy5hcmd2ICYmIG9wdHMubm9uSW5xdWlyZUZpbHRlcikge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltuYW1lXSA9IGF3YWl0IG9wdHMubm9uSW5xdWlyZUZpbHRlcih0aGlzLmFyZ3ZbbmFtZV0pO1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5hcmd2ICYmIG9wdHMub25SZWFkeSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9wdHMub25SZWFkeSh0aGlzLmFyZ3ZbbmFtZV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydENvbnRhaW5lcigpIHtcbiAgICAgICAgbGV0IGNvbmZpZ0ZpbGUgPSB0aGlzLm9wdGlvbignY29uZmlnJyk7XG4gICAgICAgIFxuICAgICAgICBsZXQgY29uZmlnRnVsbFBhdGggPSB0aGlzLmFwcC50b0Fic29sdXRlUGF0aChjb25maWdGaWxlKTtcblxuICAgICAgICBpZiAoIShhd2FpdCBmcy5leGlzdHMoY29uZmlnRnVsbFBhdGgpKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgXCIke2NvbmZpZ0ZpbGV9XCIgbm90IGZvdW5kIWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGV4dE5hbWUgPSBwYXRoLmV4dG5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBpZiAoZXh0TmFtZSAhPT0gJy5qc29uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IHN1cHBvcnRzIEpTT04gY29uZmlnLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbmZpZ05hbWUgPSBwYXRoLmJhc2VuYW1lKGNvbmZpZ0Z1bGxQYXRoLCBleHROYW1lKTtcbiAgICAgICAgbGV0IGNvbmZpZ1BhdGggPSBwYXRoLmRpcm5hbWUoY29uZmlnRnVsbFBhdGgpO1xuICAgICAgICBsZXQgZW52QXdhcmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAoY29uZmlnTmFtZS5lbmRzV2l0aCgnLmRlZmF1bHQnKSkge1xuICAgICAgICAgICAgZW52QXdhcmUgPSB0cnVlO1xuICAgICAgICAgICAgY29uZmlnTmFtZSA9IGNvbmZpZ05hbWUuc3Vic3RyKDAsIGNvbmZpZ05hbWUubGVuZ3RoIC0gOCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG5ldyBTZXJ2aWNlQ29udGFpbmVyKCdPb2xvbmdDb250YWluZXInLCB7XG4gICAgICAgICAgICB3b3JraW5nUGF0aDogdGhpcy5hcHAud29ya2luZ1BhdGgsXG4gICAgICAgICAgICBjb25maWdQYXRoLFxuICAgICAgICAgICAgY29uZmlnTmFtZSxcbiAgICAgICAgICAgIGRpc2FibGVFbnZBd2FyZUNvbmZpZzogIWVudkF3YXJlLFxuICAgICAgICAgICAgYWxsb3dlZEZlYXR1cmVzOiBbXG4gICAgICAgICAgICAgICAgJ2NvbmZpZ0J5SG9zdG5hbWUnLCAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2RldkNvbmZpZ0J5R2l0VXNlcicsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdsb2dnZXJzJyxcbiAgICAgICAgICAgICAgICAnbWFpbGVyJywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ3NldHRpbmdzJyxcbiAgICAgICAgICAgICAgICAndGltZXpvbmUnLFxuICAgICAgICAgICAgICAgICd2ZXJzaW9uJ1xuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5sb2dnZXIgPSB0aGlzLmFwcC5sb2dnZXI7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGFpbmVyLnN0YXJ0XygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBjb25uZWN0aW9uIHN0cmluZ3MgZnJvbSBhIGNvbmZpZyBmaWxlLlxuICAgICAqIEBwYXJhbSB7Kn0gY29uZiAtIE9vb2xvbmcgY29uZmlnIGZpbGUuXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXRDb25uZWN0aW9uU3RyaW5ncygpIHtcbiAgICAgICAgbGV0IGNvbmZpZyA9IHRoaXMub29sb25nQ29uZmlnO1xuICAgICAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgICAgIFxuICAgICAgICBTdXBwb3J0ZWREcml2ZXJzLmZvckVhY2goZHJpdmVyID0+IHtcbiAgICAgICAgICAgIGxldCBjb25uZWN0b3JzID0gY29uZmlnW2RyaXZlcl07XG5cbiAgICAgICAgICAgIGlmIChjb25uZWN0b3JzKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JPd24oY29ubmVjdG9ycywgKGNvbm5lY3Rvck9wdGlvbnMsIGNvbm5lY3Rvck5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W21ha2VEYXRhU291cmNlTmFtZShkcml2ZXIsIGNvbm5lY3Rvck5hbWUpXSA9IGNvbm5lY3Rvck9wdGlvbnMuY29ubmVjdGlvbjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRTY2hlbWFzSW5Db25maWcoKSB7XG4gICAgICAgIGxldCBzY2hlbWFzID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY2hlbWFEZXBsb3ltZW50Jyk7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhzY2hlbWFzKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXREYXRhc2V0XygpIHtcbiAgICAgICAgbGV0IHNjcmlwdFNvdXJjZVBhdGggPSB0aGlzLmFwcC50b0Fic29sdXRlUGF0aChVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdFNvdXJjZURpcicpKTtcblxuICAgICAgICBsZXQgc2NoZW1hID0gdGhpcy5vcHRpb24oJ3NjaGVtYScpOyBcbiAgICAgICAgaWYgKCFzY2hlbWEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2NoZW1hIGFyZ3VtZW50IGlzIHJlcXVpcmVkIGZvciBsaXN0aW5nIGRhdGFzZXQuYCk7XG4gICAgICAgIH0gIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmFwaS5kYXRhc2V0XyhcbiAgICAgICAgICAgIHsgXG4gICAgICAgICAgICAgICAgbG9nZ2VyOiB0aGlzLmFwcC5sb2dnZXIsXG4gICAgICAgICAgICAgICAgc2NyaXB0U291cmNlUGF0aCwgXG4gICAgICAgICAgICAgICAgc2NoZW1hRGVwbG95bWVudDogdGhpcy5zY2hlbWFEZXBsb3ltZW50IFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNjaGVtYVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGdldCBvb2xvbmdDb25maWcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lci5jb25maWc7XG4gICAgfVxuXG4gICAgZ2V0IHNjaGVtYURlcGxveW1lbnQoKSB7XG4gICAgICAgIGxldCBtb2RlbE1hcHBpbmcgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnb29sb25nLnNjaGVtYURlcGxveW1lbnQnKTtcblxuICAgICAgICBpZiAoXy5pc0VtcHR5KG1vZGVsTWFwcGluZykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignXCJzY2hlbWFEZXBsb3ltZW50XCIgaXMgZW1wdHkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gXy5tYXBWYWx1ZXMobW9kZWxNYXBwaW5nLCAobWFwcGluZywgc2NoZW1hTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHsgZGF0YVNvdXJjZSwgLi4ub3RoZXJzIH0gPSBtYXBwaW5nO1xuICAgIFxuICAgICAgICAgICAgaWYgKCFkYXRhU291cmNlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWd1cmF0aW9uIGl0ZW0gXCJzY2hlbWFEZXBsb3ltZW50LiR7c2NoZW1hTmFtZX0uZGF0YVNvdXJjZVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIGxldCB7IGNvbm5lY3Rpb24sIC4uLm9wdGlvbnMgfSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBkYXRhU291cmNlLCB7fSk7XG4gICAgICAgICAgICBpZiAoIWNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbm5lY3Rpb24gc3RyaW5nIG9mIGRhdGEgc291cmNlIFwiJHtkYXRhU291cmNlfVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIHJldHVybiB7IGRhdGFTb3VyY2UsIGNvbm5lY3Rpb25TdHJpbmc6IGNvbm5lY3Rpb24sIG9wdGlvbnMsIC4uLm90aGVycyB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgZGVmYXVsdCBvb2xvbmcgb3V0cHV0IHBhdGguXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHByZWZpeCBcbiAgICAgKiBAcGFyYW0ge2Jvb2x9IG92ZXJyaWRlIFxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE91dHB1dCBwYXRoIG9mIG9vbG9uZyBnZW5lcmF0ZWQgZmlsZXMuXG4gICAgICovXG4gICAgZ2V0UmV2ZXJzZU91dHB1dERpcihiYXNlRGlyLCBwcmVmaXggPSAnJywgb3ZlcnJpZGUgPSBmYWxzZSkge1xuICAgICAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgICAgbGV0IGZvbGRlciA9IGAke3ByZWZpeH0ke25vdy5nZXRGdWxsWWVhcigpfS0ke25vdy5nZXRNb250aCgpKzF9LSR7bm93LmdldERhdGUoKX1gO1xuICAgICAgICBsZXQgb3V0cHV0RGlyID0gcGF0aC5qb2luKGJhc2VEaXIsIGZvbGRlcik7XG5cbiAgICAgICAgaWYgKG92ZXJyaWRlKSByZXR1cm4gb3V0cHV0RGlyO1xuXG4gICAgICAgIGxldCBudW0gPSAxO1xuXG4gICAgICAgIHdoaWxlIChmcy5leGlzdHNTeW5jKG91dHB1dERpcikpIHtcbiAgICAgICAgICAgIGxldCBmb2xkZXIyID0gZm9sZGVyICsgJ18nICsgKCsrbnVtKS50b1N0cmluZygpO1xuICAgICAgICAgICAgb3V0cHV0RGlyID0gcGF0aC5qb2luKGJhc2VEaXIsIGZvbGRlcjIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG91dHB1dERpcjtcbiAgICB9XG5cbiAgICAvLyB2YWxpZGF0ZSBwYXJzZWQgYW5kIGZpbGxlZCBhcmd1bWVudCBvcHRpb25zLlxuICAgIF92YWxpZGF0ZUFyZ3YoKSB7XG4gICAgICAgIGxldCB2YWxpZCA9IHRydWU7XG5cbiAgICAgICAgXy5mb3JPd24odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgKG9wdHMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCByZXF1aXJlZCA9IG9wdHMucmVxdWlyZWQ7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWlyZWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICByZXF1aXJlZCA9IHJlcXVpcmVkKCk7XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBpZiAocmVxdWlyZWQgJiYgIShuYW1lIGluIHRoaXMuYXJndikpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBcmd1bWVudCBcIiR7bmFtZX1cIiBpcyByZXF1aXJlZC5gKTtcbiAgICAgICAgICAgICAgICB2YWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdmFsaWQ7XG4gICAgfVxuXG4gICAgLy8gZmlsbCB0aGUgYXJndiB3aXRoIGNvbW1hbmQgc3BlY2lmaWMgcHJvbXB0IGRlZmF1bHRzXG4gICAgX2ZpbGxDb21tYW5kRGVmYXVsdHMoY29tbWFuZE9wdGlvbnMpIHtcbiAgICAgICAgXy5mb3JPd24oY29tbWFuZE9wdGlvbnMsIChpbmZvLCBvcHRpb24pID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5hcmd2Lmhhc093blByb3BlcnR5KG9wdGlvbikgJiYgaW5mby5oYXNPd25Qcm9wZXJ0eSgncHJvbXB0RGVmYXVsdCcpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W29wdGlvbl0gPSBpbmZvLnByb21wdERlZmF1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBPb2xvbmdDb3JlOyJdfQ==
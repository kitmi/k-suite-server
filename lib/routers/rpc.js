"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

function mergeQuery(query, extra) {
  return query && query.$query ? {
    $query: { ...query.$query,
      ...extra
    }
  } : { ...query,
    ...extra
  };
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.rpc.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.rpc.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];

    _.forOwn(entityModels, (methods, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      _.forOwn(methods, (methodInfo, methodName) => {
        let params = Object.values(methodInfo.params).reduce((result, v) => {
          result[v.name] = _.omit(v, ['name']);
          return result;
        }, {});
        list.push({
          method: methodInfo.httpMethod,
          url: urlJoin(baseRoute, entityNameInUrl, methodName),
          desc: methodInfo.desc,
          params
        });
      });
    });

    ctx.body = list;
  });
  ['get', 'post'].forEach(method => {
    app.addRoute(router, method, '/:entity/:method', async ctx => {
      let db = ctx.appModule.db(options.schemaName);

      let entityName = _.camelCase(ctx.params.entity);

      let methodName = _.camelCase(ctx.params.method);

      let apiInfo = entityModels[entityName];
      apiInfo = apiInfo && apiInfo[methodName];

      if (!apiInfo || apiInfo.httpMethod.toUpperCase() !== ctx.method) {
        console.log(apiInfo);
        console.log(ctx.params, ctx.method);
        throw new BadRequest('API endpoint not found.');
      }

      let args = [ctx];

      if (apiInfo.params) {
        apiInfo.params.forEach(param => {
          let argName = param.name;
          let value = ctx.query[argName] || ctx.request.body[argName];

          if (_.isNil(value) && !param.optional) {
            throw new BadRequest(`Required argument "${argName}" is not given.`);
          }

          args.push(value);
        });
      }

      let EntityModel = db.model(entityName);
      ctx.body = await EntityModel[methodName + '_'](...args);
    });
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3JwYy5qcyJdLCJuYW1lcyI6WyJfIiwiZnMiLCJlYWNoQXN5bmNfIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsIm1lcmdlUXVlcnkiLCJxdWVyeSIsImV4dHJhIiwiJHF1ZXJ5IiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJzY2hlbWFOYW1lIiwiZW50aXR5TW9kZWxzIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsInJlc3RBcGlXcmFwcGVyIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImFwaUxpc3RFbmRwb2ludCIsInJlYWRKc29uU3luYyIsInRvQWJzb2x1dGVQYXRoIiwiYWRkUm91dGUiLCJjdHgiLCJsaXN0IiwiZm9yT3duIiwibWV0aG9kcyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJtZXRob2RJbmZvIiwibWV0aG9kTmFtZSIsInBhcmFtcyIsIk9iamVjdCIsInZhbHVlcyIsInJlZHVjZSIsInJlc3VsdCIsInYiLCJuYW1lIiwib21pdCIsInB1c2giLCJtZXRob2QiLCJodHRwTWV0aG9kIiwidXJsIiwiZGVzYyIsImJvZHkiLCJmb3JFYWNoIiwiZGIiLCJhcHBNb2R1bGUiLCJjYW1lbENhc2UiLCJlbnRpdHkiLCJhcGlJbmZvIiwidG9VcHBlckNhc2UiLCJjb25zb2xlIiwibG9nIiwiYXJncyIsInBhcmFtIiwiYXJnTmFtZSIsInZhbHVlIiwicmVxdWVzdCIsImlzTmlsIiwib3B0aW9uYWwiLCJFbnRpdHlNb2RlbCIsIm1vZGVsIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFL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QixJQUEvQixDQUFqQjtBQUNILEtBL0JEO0FBZ0NILEdBakNEO0FBbUNBL0MsRUFBQUEsR0FBRyxDQUFDd0QsU0FBSixDQUFjbkQsTUFBZDtBQUNILENBekZEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgZnMsIGVhY2hBc3luY18sIHVybEpvaW4sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgna29hLXJvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCwgTWV0aG9kTm90QWxsb3dlZCB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuIGZ1bmN0aW9uIG1lcmdlUXVlcnkocXVlcnksIGV4dHJhKSB7XG4gICAgcmV0dXJuIChxdWVyeSAmJiBxdWVyeS4kcXVlcnkpID8geyAkcXVlcnk6IHsgLi4ucXVlcnkuJHF1ZXJ5LCAuLi5leHRyYSB9IH0gOiB7IC4uLnF1ZXJ5LCAuLi5leHRyYSB9O1xuIH1cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIHJwYzogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOm1vZGVsLzptZXRob2QgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgbW9kZWwubWV0aG9kIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LnJwYy5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0ucnBjLmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGVudGl0eU1vZGVscywgKG1ldGhvZHMsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpOyAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIF8uZm9yT3duKG1ldGhvZHMsIChtZXRob2RJbmZvLCBtZXRob2ROYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHBhcmFtcyA9IE9iamVjdC52YWx1ZXMobWV0aG9kSW5mby5wYXJhbXMpLnJlZHVjZSgocmVzdWx0LCB2KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFt2Lm5hbWVdID0gXy5vbWl0KHYsIFsnbmFtZSddKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9LCB7fSk7XG5cbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyBtZXRob2Q6IG1ldGhvZEluZm8uaHR0cE1ldGhvZCwgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBtZXRob2ROYW1lKSwgZGVzYzogbWV0aG9kSW5mby5kZXNjLCBwYXJhbXMgfSk7XG4gICAgICAgICAgICB9KTsgICAgICAgIFxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBbJ2dldCcsICdwb3N0J10uZm9yRWFjaChtZXRob2QgPT4geyAgICAgICAgIFxuICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCBtZXRob2QsICcvOmVudGl0eS86bWV0aG9kJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBtZXRob2ROYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5tZXRob2QpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBhcGlJbmZvID0gYXBpSW5mbyAmJiBhcGlJbmZvW21ldGhvZE5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhcGlJbmZvIHx8IGFwaUluZm8uaHR0cE1ldGhvZC50b1VwcGVyQ2FzZSgpICE9PSBjdHgubWV0aG9kKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYXBpSW5mbyk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coY3R4LnBhcmFtcywgY3R4Lm1ldGhvZCk7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnQVBJIGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGFyZ3MgPSBbIGN0eCBdO1xuXG4gICAgICAgICAgICBpZiAoYXBpSW5mby5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICBhcGlJbmZvLnBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ05hbWUgPSBwYXJhbS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBjdHgucXVlcnlbYXJnTmFtZV0gfHwgY3R4LnJlcXVlc3QuYm9keVthcmdOYW1lXTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc05pbCh2YWx1ZSkgJiYgIXBhcmFtLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgUmVxdWlyZWQgYXJndW1lbnQgXCIke2FyZ05hbWV9XCIgaXMgbm90IGdpdmVuLmApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7IFxuICAgICAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbFttZXRob2ROYW1lKydfJ10oLi4uYXJncyk7XG4gICAgICAgIH0pO1xuICAgIH0pOyAgICBcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19
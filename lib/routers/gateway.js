"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo, meta) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];
  let assocs = [];
  let {
    $orderBy,
    $offset,
    $limit,
    $returnTotal,
    $exist,
    $notExist
  } = ctx.query;

  if ($exist) {
    $exist = _.castArray($exist);
    $exist.map(item => queries.push({
      [item]: {
        $ne: null
      }
    }));
  }

  if ($notExist) {
    $notExist = _.castArray($notExist);
    $notExist.map(item => queries.push({
      [item]: {
        $eq: null
      }
    }));
  }

  if ($orderBy) {
    let orderBy;

    if (meta) {
      orderBy = {};

      let rawOrderBy = _.castArray($orderBy);

      rawOrderBy.forEach(byField => {
        let ascend = true;

        if (byField.startsWith('>')) {
          ascend = false;
          byField = byField.substr(1);
        } else if (byField.startsWith('<')) {
          byField = byField.substr(1);
        }

        if (byField.startsWith(':')) {
          byField = byField.substr(1);
        } else if (!(byField in meta.fields)) {
          throw new BadRequest(`Unknown orderBy field "${byField}".`);
        }

        orderBy[byField] = ascend;
      });
    } else {
      orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }
    }

    condition.$orderBy = orderBy;
  } else if (apiInfo.orderBy && apiInfo.orderBy['$default']) {
    condition.$orderBy = apiInfo.orderBy['$default'];
  }

  if ($offset) {
    condition.$offset = ensureInt('$offset', $offset);
  }

  if ($limit) {
    condition.$limit = ensureInt('$limit', $limit);
  }

  if ($returnTotal) {
    if ($returnTotal === '1' || $returnTotal === 'true') {
      condition.$totalCount = true;
    } else {
      condition.$totalCount = $returnTotal;
    }
  }

  if (!_.isEmpty(apiInfo.query)) {
    _.forOwn(apiInfo.query, (info, param) => {
      if (param in ctx.query) {
        queries.push(info.where);
      }
    });
  } else if (meta) {
    _.forOwn(ctx.query, (value, key) => {
      if (key.startsWith('$')) return;

      if (key.startsWith(':')) {
        let assoc = key.substr(1);

        if (_.isNil(value) || value !== '0') {
          assocs.push(assoc);
        }
      } else if (key.indexOf('.') > 0 || key in meta.fields) {
        queries.push({
          [key]: value
        });
      } else {
        throw new BadRequest(`Unknown query field "${key}".`);
      }
    });
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  if (assocs.length > 0) {
    condition.$association = assocs;
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions, EntityModel;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo, EntityModel.meta),
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions, keyField;
    let keyValue = ctx.params.id;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: keyValue,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      keyField = EntityModel.meta.keyField;
      let assocs = [];

      _.forOwn(ctx.query, (value, key) => {
        if (key.startsWith(':') && (_.isNil(value) || value !== '0')) {
          assocs.push(key.substr(1));
        }
      });

      queryOptions = {
        $query: {
          [keyField]: keyValue
        },
        $unboxing: true
      };

      if (assocs.length > 0) {
        queryOptions.$association = assocs;
      }
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.NOT_FOUND, `"${EntityModel.meta.name}" with [${keyField}=${keyValue}] not found.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let {
      where,
      data
    } = ctx.request.body;
    let model = await EntityModel.updateOne_(data, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.updateOne_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.deleteOne_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwibWV0YSIsImNvbmRpdGlvbiIsInF1ZXJpZXMiLCJ3aGVyZSIsImFzc29jcyIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRyZXR1cm5Ub3RhbCIsIiRleGlzdCIsIiRub3RFeGlzdCIsInF1ZXJ5IiwiY2FzdEFycmF5IiwibWFwIiwiaXRlbSIsInB1c2giLCIkbmUiLCIkZXEiLCJvcmRlckJ5IiwicmF3T3JkZXJCeSIsImZvckVhY2giLCJieUZpZWxkIiwiYXNjZW5kIiwic3RhcnRzV2l0aCIsInN1YnN0ciIsImZpZWxkcyIsIiR0b3RhbENvdW50IiwiaXNFbXB0eSIsImZvck93biIsImluZm8iLCJwYXJhbSIsImtleSIsImFzc29jIiwiaXNOaWwiLCJpbmRleE9mIiwibCIsImxlbmd0aCIsIiRxdWVyeSIsIiRhbmQiLCIkYXNzb2NpYXRpb24iLCJtb2R1bGUiLCJleHBvcnRzIiwiYXBwIiwiYmFzZVJvdXRlIiwib3B0aW9ucyIsInNjaGVtYU5hbWUiLCJlbnRpdHlNb2RlbHMiLCJyb3V0ZXIiLCJwcmVmaXgiLCJ1c2VNaWRkbGV3YXJlIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwiYXBpTGlzdEVuZHBvaW50IiwibWV0YWRhdGFFbmRwb2ludCIsImRlc2NFbmRwb2ludCIsInJlYWRKc29uU3luYyIsInRvQWJzb2x1dGVQYXRoIiwiYWRkUm91dGUiLCJsaXN0IiwiZGIiLCJhcHBNb2R1bGUiLCJjb25maWciLCJlbnRpdHlOYW1lIiwiZW50aXR5TmFtZUluVXJsIiwia2ViYWJDYXNlIiwia2V5RmllbGROYW1lIiwidHlwZSIsIm1vZGVsIiwic2VsZWN0RnJvbSIsImtleUZpZWxkIiwic2luZ2xlVXJsIiwiYmF0Y2hVcmwiLCJkZXNjVXJsIiwidG9XZWJQYXRoIiwibWV0aG9kIiwidXJsIiwiYXBpRGVzYyIsInJlYWRPbmx5IiwiYm9keSIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsIkVudGl0eU1vZGVsIiwiam9pbldpdGgiLCJhc3NvY2lhdGlvbnMiLCJtYXBWYWx1ZXMiLCJkZXNjIiwiZGlzcGxheU5hbWUiLCJlbnYiLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwicXVlcnlPcHRpb25zIiwiJHVuYm94aW5nIiwiJHZhcmlhYmxlcyIsInNlc3Npb24iLCJzZXNzaW9uVmFyaWFibGVzIiwiZmluZEFsbF8iLCJrZXlWYWx1ZSIsImlkIiwiZmluZE9uZV8iLCJOT1RfRk9VTkQiLCJjcmVhdGVfIiwicmVxdWVzdCIsIiRyZXRyaWV2ZUNyZWF0ZWQiLCJkYXRhIiwidXBkYXRlT25lXyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJkZWxldGVkIiwiZGVsZXRlT25lXyIsInN0YXR1cyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxPQUFUO0FBQWtCQyxFQUFBQTtBQUFsQixJQUFxQ0MsT0FBTyxDQUFDLFVBQUQsQ0FBbEQ7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsWUFBRCxDQUF0Qjs7QUFDQSxNQUFNRSxRQUFRLEdBQUdGLE9BQU8sQ0FBQyxtQkFBRCxDQUF4Qjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG9CQUFGO0FBQXdCQyxFQUFBQSxVQUF4QjtB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QUFDbkYsSUFBWixDQUFpQnNFLFFBQWxCLEdBQTZCeEUsR0FBRyxDQUFDbUYsTUFBSixDQUFXb0I7QUFBMUMsS0FBWjtBQUVBLFFBQUlTLE9BQU8sR0FBRyxNQUFNM0IsV0FBVyxDQUFDNEIsVUFBWixDQUF1QjtBQUN2QzFFLE1BQUFBLE1BQU0sRUFBRWxDLEtBRCtCO0FBRXZDNkYsTUFBQUEsVUFBVSxFQUFFO0FBQ1JDLFFBQUFBLE9BQU8sRUFBRW5HLEdBQUcsQ0FBQ29HLGdCQURMO0FBRVJ2RixRQUFBQSxLQUFLLEVBQUViLEdBQUcsQ0FBQ2E7QUFGSDtBQUYyQixLQUF2QixDQUFwQjtBQVFBYixJQUFBQSxHQUFHLENBQUNpRixJQUFKLEdBQVc7QUFBRWlDLE1BQUFBLE1BQU0sRUFBRSxJQUFWO0FBQWdCRixNQUFBQTtBQUFoQixLQUFYO0FBQ0gsR0ExQkQ7QUE0QkFwRSxFQUFBQSxHQUFHLENBQUN1RSxTQUFKLENBQWNsRSxNQUFkO0FBQ0gsQ0FyV0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfLCBmcywgdXJsSm9pbiwgZ2V0VmFsdWVCeVBhdGggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdrb2Etcm91dGVyJyk7XG5jb25zdCBIdHRwQ29kZSA9IHJlcXVpcmUoJ2h0dHAtc3RhdHVzLWNvZGVzJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uLCBCYWRSZXF1ZXN0LCBNZXRob2ROb3RBbGxvd2VkIH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcbmNvbnN0IHZhbGlkYXRvciA9IHJlcXVpcmUoJ3ZhbGlkYXRvcicpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbmZ1bmN0aW9uIGVuc3VyZUludChuYW1lLCB2YWx1ZSkge1xuICAgIGxldCBzYW5pdGl6ZWQgPSBfLmlzSW50ZWdlcih2YWx1ZSkgPyB2YWx1ZSA6IHZhbGlkYXRvci50b0ludCh2YWx1ZSk7XG4gICAgaWYgKGlzTmFOKHNhbml0aXplZCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFwiJHtuYW1lfVwiIHNob3VsZCBiZSBhbiBpbnRlZ2VyLmApO1xuICAgIH1cblxuICAgIHJldHVybiBzYW5pdGl6ZWQ7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NRdWVyeShjdHgsIGFwaUluZm8sIG1ldGEpIHsgICAgXG4gICAgbGV0IGNvbmRpdGlvbiA9IHt9O1xuICAgIGxldCBxdWVyaWVzID0gYXBpSW5mby53aGVyZSA/IFsgYXBpSW5mby53aGVyZSBdIDogW107XG4gICAgbGV0IGFzc29jcyA9IFtdO1xuXG4gICAgbGV0IHsgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHJldHVyblRvdGFsLCAkZXhpc3QsICRub3RFeGlzdCB9ID0gY3R4LnF1ZXJ5O1xuXG4gICAgaWYgKCRleGlzdCkge1xuICAgICAgICAkZXhpc3QgPSBfLmNhc3RBcnJheSgkZXhpc3QpO1xuICAgICAgICAkZXhpc3QubWFwKGl0ZW0gPT4gcXVlcmllcy5wdXNoKHtbaXRlbV06IHsgJG5lOiBudWxsIH19KSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBpZiAoJG5vdEV4aXN0KSB7XG4gICAgICAgICRub3RFeGlzdCA9IF8uY2FzdEFycmF5KCRub3RFeGlzdCk7XG4gICAgICAgICRub3RFeGlzdC5tYXAoaXRlbSA9PiBxdWVyaWVzLnB1c2goe1tpdGVtXTogeyAkZXE6IG51bGwgfX0pKTsgICAgICAgIFxuICAgIH1cbiAgICAgICAgXG4gICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgIGxldCBvcmRlckJ5O1xuXG4gICAgICAgIGlmIChtZXRhKSB7XG4gICAgICAgICAgICBvcmRlckJ5ID0ge307XG4gICAgICAgICAgICBsZXQgcmF3T3JkZXJCeSA9IF8uY2FzdEFycmF5KCRvcmRlckJ5KTtcbiAgICAgICAgICAgIHJhd09yZGVyQnkuZm9yRWFjaChieUZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYXNjZW5kID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJz4nKSkge1xuICAgICAgICAgICAgICAgICAgICBhc2NlbmQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYnlGaWVsZCA9IGJ5RmllbGQuc3Vic3RyKDEpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnlGaWVsZC5zdGFydHNXaXRoKCc8JykpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgICAgIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCEoYnlGaWVsZCBpbiBtZXRhLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFVua25vd24gb3JkZXJCeSBmaWVsZCBcIiR7YnlGaWVsZH1cIi5gKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIG9yZGVyQnlbYnlGaWVsZF0gPSBhc2NlbmQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVskb3JkZXJCeV07XG4gICAgICAgICAgICBpZiAoIW9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgT3JkZXIgYnkgXCIke29yZGVyQnl9XCIgaXMgbm90IHN1cHBvcnRlZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IG9yZGVyQnk7XG4gICAgfSBlbHNlIGlmIChhcGlJbmZvLm9yZGVyQnkgJiYgYXBpSW5mby5vcmRlckJ5WyckZGVmYXVsdCddKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVsnJGRlZmF1bHQnXTtcbiAgICB9XG5cbiAgICBpZiAoJG9mZnNldCkgeyAgICAgICAgXG4gICAgICAgIGNvbmRpdGlvbi4kb2Zmc2V0ID0gZW5zdXJlSW50KCckb2Zmc2V0JywgJG9mZnNldCk7XG4gICAgfVxuXG4gICAgaWYgKCRsaW1pdCkge1xuICAgICAgICBjb25kaXRpb24uJGxpbWl0ID0gZW5zdXJlSW50KCckbGltaXQnLCAkbGltaXQpO1xuICAgIH0gICAgXG5cbiAgICBpZiAoJHJldHVyblRvdGFsKSB7ICAgXG4gICAgICAgIGlmICgkcmV0dXJuVG90YWwgPT09ICcxJyB8fCAkcmV0dXJuVG90YWwgPT09ICd0cnVlJykge1xuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHsgICAgICAgIFxuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gJHJldHVyblRvdGFsO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIGlmICghXy5pc0VtcHR5KGFwaUluZm8ucXVlcnkpKSB7XG4gICAgICAgIF8uZm9yT3duKGFwaUluZm8ucXVlcnksIChpbmZvLCBwYXJhbSkgPT4ge1xuICAgICAgICAgICAgaWYgKHBhcmFtIGluIGN0eC5xdWVyeSkge1xuICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaChpbmZvLndoZXJlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChtZXRhKSB7XG4gICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnJCcpKSByZXR1cm47XG5cbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnOicpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFzc29jID0ga2V5LnN1YnN0cigxKTtcbiAgICAgICAgICAgICAgICBpZiAoXy5pc05pbCh2YWx1ZSkgfHwgdmFsdWUgIT09ICcwJykge1xuICAgICAgICAgICAgICAgICAgICBhc3NvY3MucHVzaChhc3NvYyk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmluZGV4T2YoJy4nKSA+IDAgfHwgKGtleSBpbiBtZXRhLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICBxdWVyaWVzLnB1c2goeyBba2V5XTogdmFsdWUgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBVbmtub3duIHF1ZXJ5IGZpZWxkIFwiJHtrZXl9XCIuYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGxldCBsID0gcXVlcmllcy5sZW5ndGg7XG4gICAgaWYgKGwgPiAwKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kcXVlcnkgPSBsID4gMSA/IHsgJGFuZDogcXVlcmllcyB9IDogcXVlcmllc1swXTtcbiAgICB9XG5cbiAgICBpZiAoYXNzb2NzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uZGl0aW9uLiRhc3NvY2lhdGlvbiA9IGFzc29jcztcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZGl0aW9uO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2F0ZXdheTogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnLFxuICogICAgICAgICAgbWV0YWRhdGFFbmRwb2ludDogJy9fbWV0YSdcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBxdWVyeVxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZGV0YWlsXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICByZW1vdmUgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgaWYgKCFvcHRpb25zLnNjaGVtYU5hbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgc2NoZW1hIG5hbWUgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5lbnRpdHlNb2RlbHNgXG4gICAgICAgICk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KCdqc29uRXJyb3InKSgpLCAnanNvbkVycm9yJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG4gICAgbGV0IGRlc2NFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19kZXNjJztcblxuICAgIGxldCBlbnRpdHlNb2RlbHMgPSBvcHRpb25zLmVudGl0eU1vZGVscztcblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbnRpdHlNb2RlbHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGVudGl0eU1vZGVscyA9IGZzLnJlYWRKc29uU3luYyhhcHAudG9BYnNvbHV0ZVBhdGgob3B0aW9ucy5lbnRpdHlNb2RlbHMpKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuXG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGVudGl0eU1vZGVscywgKGNvbmZpZywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgLy90b2RvOiBmaWx0ZXIgZW50aXR5IG9yIG1ldGhvZHMgYnkgY29uZmlnXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZUluVXJsID0gXy5rZWJhYkNhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQga2V5RmllbGROYW1lOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGNvbmZpZy5rZXkgfHwgZGIubW9kZWwoY29uZmlnLnNlbGVjdEZyb20pLm1ldGEua2V5RmllbGQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBkYi5tb2RlbChlbnRpdHlOYW1lKS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfSAgICAgICAgICBcblxuICAgICAgICAgICAga2V5RmllbGROYW1lID0gJzonICsga2V5RmllbGROYW1lO1xuXG4gICAgICAgICAgICBsZXQgc2luZ2xlVXJsID0gdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKTtcbiAgICAgICAgICAgIGxldCBiYXRjaFVybCA9IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpO1xuICAgICAgICAgICAgbGV0IGRlc2NVcmwgPSBhcHAudG9XZWJQYXRoKHVybEpvaW4oYmFzZVJvdXRlLCAnX2Rlc2MnLCBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKSkpO1xuXG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnbGlzdCcsIG1ldGhvZDogJ2dldCcsIHVybDogYmF0Y2hVcmwsIGFwaURlc2M6IGRlc2NVcmwgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGV0YWlsJywgbWV0aG9kOiAnZ2V0JywgdXJsOiBzaW5nbGVVcmwgfSk7XG5cbiAgICAgICAgICAgIGlmICghY29uZmlnLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2NyZWF0ZScsIG1ldGhvZDogJ3Bvc3QnLCB1cmw6IGJhdGNoVXJsIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICd1cGRhdGUnLCBtZXRob2Q6ICdwdXQnLCB1cmw6IHNpbmdsZVVybCB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGVsZXRlJywgbWV0aG9kOiAnZGVsJywgdXJsOiBzaW5nbGVVcmwgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKGRlc2NFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdDsgICAgICAgIFxuXG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBjb25maWcgPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGxldCBFbnRpdHlNb2RlbDtcblxuICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgbGlzdCA9IHtcbiAgICAgICAgICAgICAgICAndHlwZSc6ICd2aWV3JyxcbiAgICAgICAgICAgICAgICAnbWFpbkVudGl0eSc6IGNvbmZpZy5zZWxlY3RGcm9tICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5qb2luV2l0aCkge1xuICAgICAgICAgICAgICAgIGxpc3QuYXNzb2NpYXRpb25zID0gY29uZmlnLmpvaW5XaXRoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLndoZXJlKSB7XG4gICAgICAgICAgICAgICAgbGlzdC53aGVyZSA9IGNvbmZpZy53aGVyZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5rZXkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LmtleSA9IGNvbmZpZy5rZXk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoY29uZmlnLnNlbGVjdEZyb20pO1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnLnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5xdWVyeSA9IF8ubWFwVmFsdWVzKGNvbmZpZy5xdWVyeSwgKGluZm8pID0+IGluZm8uZGVzYyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcub3JkZXJCeSkge1xuICAgICAgICAgICAgICAgIGxpc3Qub3JkZXJCeSA9IGNvbmZpZy5vcmRlckJ5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGlzdCA9IHtcbiAgICAgICAgICAgICAgICAndHlwZSc6ICdlbnRpdHknLFxuICAgICAgICAgICAgICAgICdlbnRpdHknOiBlbnRpdHlOYW1lICAgIFxuICAgICAgICAgICAgfTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxpc3QucXVlcnkgPSBfLm1hcFZhbHVlcyhFbnRpdHlNb2RlbC5tZXRhLmZpZWxkcywgKGluZm8pID0+IGluZm8uZGlzcGxheU5hbWUpO1xuICAgICAgICB9ICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgaWYgKGFwcC5lbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4obWV0YWRhdGFFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbCgoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSA/IGFwaUluZm8uc2VsZWN0RnJvbSA6IGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGluZm8gPSBFbnRpdHlNb2RlbC5tZXRhO1xuXG4gICAgICAgICAgICBpZiAoY3R4LnF1ZXJ5LmZpbHRlcikge1xuICAgICAgICAgICAgICAgIGluZm8gPSBnZXRWYWx1ZUJ5UGF0aChpbmZvLCBjdHgucXVlcnkuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgRW1wdHkgY29udGVudC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gaW5mbztcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgLy9nZXQgbGlzdCAgICBcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucywgRW50aXR5TW9kZWw7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcblxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5wcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvKSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5wcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvLCBFbnRpdHlNb2RlbC5tZXRhKSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBxdWVyeU9wdGlvbnMuJHZhcmlhYmxlcyA9IHsgXG4gICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgfTtcblxuICAgICAgICBjdHguYm9keSA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRBbGxfKHF1ZXJ5T3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICAvL2dldCBkZXRhaWxcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCwgcXVlcnlPcHRpb25zLCBrZXlGaWVsZDtcbiAgICAgICAgbGV0IGtleVZhbHVlID0gY3R4LnBhcmFtcy5pZDsgICAgICAgIFxuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAga2V5RmllbGQgPSBhcGlJbmZvLmtleSB8fCBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBrZXlWYWx1ZSwgLi4uYXBpSW5mby53aGVyZSB9LFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAga2V5RmllbGQgPSBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICBsZXQgYXNzb2NzID0gW107XG5cbiAgICAgICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJzonKSAmJiAoXy5pc05pbCh2YWx1ZSkgfHwgdmFsdWUgIT09ICcwJykpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzb2NzLnB1c2goa2V5LnN1YnN0cigxKSk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBrZXlWYWx1ZSB9LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChhc3NvY3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy4kYXNzb2NpYXRpb24gPSBhc3NvY3M7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0geyBcbiAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRPbmVfKHF1ZXJ5T3B0aW9ucyk7ICAgICAgICBcbiAgICAgICAgaWYgKCFtb2RlbCkge1xuICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLk5PVF9GT1VORCwgYFwiJHtFbnRpdHlNb2RlbC5tZXRhLm5hbWV9XCIgd2l0aCBbJHtrZXlGaWVsZH09JHtrZXlWYWx1ZX1dIG5vdCBmb3VuZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IHsgXG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHsgd2hlcmUsIGRhdGEgfSA9IGN0eC5yZXF1ZXN0LmJvZHk7XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlT25lXyhkYXRhLCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlT25lXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2RlbGV0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IGRlbGV0ZWQgPSBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVPbmVfKHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snLCBkZWxldGVkIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo, meta) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];
  let assocs = [];
  let {
    $orderBy,
    $offset,
    $limit,
    $returnTotal
  } = ctx.query;

  if ($orderBy) {
    let orderBy;

    if (meta) {
      orderBy = {};

      let rawOrderBy = _.castArray($orderBy);

      rawOrderBy.forEach(byField => {
        let ascend = true;

        if (byField.startsWith('>')) {
          ascend = false;
          byField = byField.substr(1);
        } else if (byField.startsWith('<')) {
          byField = byField.substr(1);
        }

        if (byField.startsWith(':')) {
          byField = byField.substr(1);
        } else if (!(byField in meta.fields)) {
          throw new BadRequest(`Unknown orderBy field "${byField}".`);
        }

        orderBy[byField] = ascend;
      });
    } else {
      orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }
    }

    condition.$orderBy = orderBy;
  } else if (apiInfo.orderBy && apiInfo.orderBy['$default']) {
    condition.$orderBy = apiInfo.orderBy['$default'];
  }

  if ($offset) {
    condition.$offset = ensureInt('$offset', $offset);
  }

  if ($limit) {
    condition.$limit = ensureInt('$limit', $limit);
  }

  if ($returnTotal) {
    if ($returnTotal === '1' || $returnTotal === 'true') {
      condition.$totalCount = true;
    } else {
      condition.$totalCount = $returnTotal;
    }
  }

  if (!_.isEmpty(apiInfo.query)) {
    _.forOwn(apiInfo.query, (info, param) => {
      if (param in ctx.query) {
        queries.push(info.where);
      }
    });
  } else if (meta) {
    _.forOwn(ctx.query, (value, key) => {
      if (key.startsWith('$')) return;

      if (key.startsWith(':') && value) {
        assocs.push(key.substr(1));
      } else if (key in meta.fields) {
        queries.push({
          [key]: value
        });
      } else {
        throw new BadRequest(`Unknown query field "${key}".`);
      }
    });
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  if (assocs.length > 0) {
    condition.$association = assocs;
  }

  console.log(condition);
  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions, EntityModel;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo, EntityModel.meta),
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions, keyField;
    let keyValue = ctx.params.id;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: keyValue,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      keyField = EntityModel.meta.keyField;
      let assocs = [];

      _.forOwn(ctx.query, (value, key) => {
        if (key.startsWith(':') && value) {
          assocs.push(key.substr(1));
        }
      });

      queryOptions = {
        $query: {
          [keyField]: keyValue
        },
        $unboxing: true
      };

      if (assocs.length > 0) {
        queryOptions.$association = assocs;
      }
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.NOT_FOUND, `"${EntityModel.meta.name}" with [${keyField}=${keyValue}] not found.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let {
      where,
      data
    } = ctx.request.body;
    let model = await EntityModel.update_(data, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwibWV0YSIsImNvbmRpdGlvbiIsInF1ZXJpZXMiLCJ3aGVyZSIsImFzc29jcyIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRyZXR1cm5Ub3RhbCIsInF1ZXJ5Iiwib3JkZXJCeSIsInJhd09yZGVyQnkiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiYnlGaWVsZCIsImFzY2VuZCIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiLCJmaWVsZHMiLCIkdG90YWxDb3VudCIsImlzRW1wdHkiLCJmb3JPd24iLCJpbmZvIiwicGFyYW0iLCJwdXNoIiwia2V5IiwibCIsImxlbmd0aCIsIiRxdWVyeSIsIiRhbmQiLCIkYXNzb2NpYXRpb24iLCJjb25zb2xlIiwibG9nIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJzY2hlbWFOYW1lIiwiZW50aXR5TW9kZWxzIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsInJlc3RBcGlXcmFwcGVyIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImFwaUxpc3RFbmRwb2ludCIsIm1ldGFkYXRhRW5kcG9pbnQiLCJkZXNjRW5kcG9pbnQiLCJyZWFkSnNvblN5bmMiLCJ0b0Fic29sdXRlUGF0aCIsImFkZFJvdXRlIiwibGlzdCIsImRiIiwiYXBwTW9kdWxlIiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsImtleUZpZWxkTmFtZSIsInR5cGUiLCJtb2RlbCIsInNlbGVjdEZyb20iLCJrZXlGaWVsZCIsInNpbmdsZVVybCIsImJhdGNoVXJsIiwiZGVzY1VybCIsInRvV2ViUGF0aCIsIm1ldGhvZCIsInVybCIsImFwaURlc2MiLCJyZWFkT25seSIsImJvZHkiLCJjYW1lbENhc2UiLCJwYXJhbXMiLCJlbnRpdHkiLCJFbnRpdHlNb2RlbCIsImpvaW5XaXRoIiwiYXNzb2NpYXRpb25zIiwibWFwVmFsdWVzIiwiZGVzYyIsImRpc3BsYXlOYW1lIiwiZW52IiwiZmlsdGVyIiwidGhyb3ciLCJCQURfUkVRVUVTVCIsImV4cG9zZSIsInF1ZXJ5T3B0aW9ucyIsIiR1bmJveGluZyIsIiR2YXJpYWJsZXMiLCJzZXNzaW9uIiwic2Vzc2lvblZhcmlhYmxlcyIsImZpbmRBbGxfIiwia2V5VmFsdWUiLCJpZCIsImZpbmRPbmVfIiwiTk9UX0ZPVU5EIiwiY3JlYXRlXyIsInJlcXVlc3QiLCIkcmV0cmlldmVDcmVhdGVkIiwiZGF0YSIsInVwZGF0ZV8iLCIkcmV0cmlldmVVcGRhdGVkIiwiZGVsZXRlZCIsImRlbGV0ZV8iLCJzdGF0dXMiLCJhZGRSb3V0ZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsT0FBVDtBQUFrQkMsRUFBQUE7QUFBbEIsSUFBcUNDLE9BQU8sQ0FBQyxVQUFELENBQWxEOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBdEI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FBeEI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxvQkFBRjtBQUF3QkMsRUFBQUEsVUFBeEI7QUFBb0NDLEVBQUFBO0FBQXBDLElBQXlETCxPQUFPLENBQUMsV0FBRCxDQUF0RTs7QUFDQSxNQUFNTSxTQUFTLEdBQUdO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Q0FBTjtBQUNIOztBQUVELFFBQUlZLE9BQU8sQ0FBQ3dFLFFBQVosRUFBc0I7QUFDbEIsWUFBTSxJQUFJbkYsZ0JBQUosQ0FBcUIsMEJBQXJCLENBQU47QUFDSDs7QUFFRCxRQUFJd0YsV0FBVyxHQUFHdkIsRUFBRSxDQUFDUSxLQUFILENBQVNMLFVBQVQsQ0FBbEI7QUFFQSxRQUFJckQsS0FBSyxHQUFHO0FBQUUsT0FBQ3lFLFdBQVcsQ0FBQzVFLElBQVosQ0FBaUIrRCxRQUFsQixHQUE2QmpFLEdBQUcsQ0FBQzRFLE1BQUosQ0FBV29CO0FBQTFDLEtBQVo7QUFFQSxRQUFJUyxPQUFPLEdBQUcsTUFBTTNCLFdBQVcsQ0FBQzRCLE9BQVosQ0FBb0I7QUFDcEM1RSxNQUFBQSxNQUFNLEVBQUV6QixLQUQ0QjtBQUVwQ3NGLE1BQUFBLFVBQVUsRUFBRTtBQUNSQyxRQUFBQSxPQUFPLEVBQUU1RixHQUFHLENBQUM2RixnQkFETDtBQUVSbEYsUUFBQUEsS0FBSyxFQUFFWCxHQUFHLENBQUNXO0FBRkg7QUFGd0IsS0FBcEIsQ0FBcEI7QUFRQVgsSUFBQUEsR0FBRyxDQUFDMEUsSUFBSixHQUFXO0FBQUVpQyxNQUFBQSxNQUFNLEVBQUUsSUFBVjtBQUFnQkYsTUFBQUE7QUFBaEIsS0FBWDtBQUNILEdBMUJEO0FBNEJBcEUsRUFBQUEsR0FBRyxDQUFDdUUsU0FBSixDQUFjbEUsTUFBZDtBQUNILENBcldEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgZnMsIHVybEpvaW4sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgna29hLXJvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCwgTWV0aG9kTm90QWxsb3dlZCB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3InKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG5mdW5jdGlvbiBlbnN1cmVJbnQobmFtZSwgdmFsdWUpIHtcbiAgICBsZXQgc2FuaXRpemVkID0gXy5pc0ludGVnZXIodmFsdWUpID8gdmFsdWUgOiB2YWxpZGF0b3IudG9JbnQodmFsdWUpO1xuICAgIGlmIChpc05hTihzYW5pdGl6ZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBcIiR7bmFtZX1cIiBzaG91bGQgYmUgYW4gaW50ZWdlci5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2FuaXRpemVkO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvLCBtZXRhKSB7ICAgIFxuICAgIGxldCBjb25kaXRpb24gPSB7fTtcbiAgICBsZXQgcXVlcmllcyA9IGFwaUluZm8ud2hlcmUgPyBbIGFwaUluZm8ud2hlcmUgXSA6IFtdO1xuICAgIGxldCBhc3NvY3MgPSBbXTtcblxuICAgIGxldCB7ICRvcmRlckJ5LCAkb2Zmc2V0LCAkbGltaXQsICRyZXR1cm5Ub3RhbCB9ID0gY3R4LnF1ZXJ5O1xuICAgICAgICBcbiAgICBpZiAoJG9yZGVyQnkpIHtcbiAgICAgICAgbGV0IG9yZGVyQnk7XG5cbiAgICAgICAgaWYgKG1ldGEpIHtcbiAgICAgICAgICAgIG9yZGVyQnkgPSB7fTtcbiAgICAgICAgICAgIGxldCByYXdPcmRlckJ5ID0gXy5jYXN0QXJyYXkoJG9yZGVyQnkpO1xuICAgICAgICAgICAgcmF3T3JkZXJCeS5mb3JFYWNoKGJ5RmllbGQgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBhc2NlbmQgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgaWYgKGJ5RmllbGQuc3RhcnRzV2l0aCgnPicpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzY2VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJzwnKSkgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGJ5RmllbGQgPSBieUZpZWxkLnN1YnN0cigxKTtcbiAgICAgICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICAgICAgaWYgKGJ5RmllbGQuc3RhcnRzV2l0aCgnOicpKSB7XG4gICAgICAgICAgICAgICAgICAgIGJ5RmllbGQgPSBieUZpZWxkLnN1YnN0cigxKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIShieUZpZWxkIGluIG1ldGEuZmllbGRzKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgVW5rbm93biBvcmRlckJ5IGZpZWxkIFwiJHtieUZpZWxkfVwiLmApXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgb3JkZXJCeVtieUZpZWxkXSA9IGFzY2VuZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvcmRlckJ5ID0gYXBpSW5mby5vcmRlckJ5WyRvcmRlckJ5XTtcbiAgICAgICAgICAgIGlmICghb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBPcmRlciBieSBcIiR7b3JkZXJCeX1cIiBpcyBub3Qgc3VwcG9ydGVkLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uZGl0aW9uLiRvcmRlckJ5ID0gb3JkZXJCeTtcbiAgICB9IGVsc2UgaWYgKGFwaUluZm8ub3JkZXJCeSAmJiBhcGlJbmZvLm9yZGVyQnlbJyRkZWZhdWx0J10pIHtcbiAgICAgICAgY29uZGl0aW9uLiRvcmRlckJ5ID0gYXBpSW5mby5vcmRlckJ5WyckZGVmYXVsdCddO1xuICAgIH1cblxuICAgIGlmICgkb2Zmc2V0KSB7ICAgICAgICBcbiAgICAgICAgY29uZGl0aW9uLiRvZmZzZXQgPSBlbnN1cmVJbnQoJyRvZmZzZXQnLCAkb2Zmc2V0KTtcbiAgICB9XG5cbiAgICBpZiAoJGxpbWl0KSB7XG4gICAgICAgIGNvbmRpdGlvbi4kbGltaXQgPSBlbnN1cmVJbnQoJyRsaW1pdCcsICRsaW1pdCk7XG4gICAgfSAgICBcblxuICAgIGlmICgkcmV0dXJuVG90YWwpIHsgICBcbiAgICAgICAgaWYgKCRyZXR1cm5Ub3RhbCA9PT0gJzEnIHx8ICRyZXR1cm5Ub3RhbCA9PT0gJ3RydWUnKSB7XG4gICAgICAgICAgICBjb25kaXRpb24uJHRvdGFsQ291bnQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgeyAgICAgICAgXG4gICAgICAgICAgICBjb25kaXRpb24uJHRvdGFsQ291bnQgPSAkcmV0dXJuVG90YWw7XG4gICAgICAgIH1cbiAgICB9ICAgIFxuXG4gICAgaWYgKCFfLmlzRW1wdHkoYXBpSW5mby5xdWVyeSkpIHtcbiAgICAgICAgXy5mb3JPd24oYXBpSW5mby5xdWVyeSwgKGluZm8sIHBhcmFtKSA9PiB7XG4gICAgICAgICAgICBpZiAocGFyYW0gaW4gY3R4LnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgcXVlcmllcy5wdXNoKGluZm8ud2hlcmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKG1ldGEpIHtcbiAgICAgICAgXy5mb3JPd24oY3R4LnF1ZXJ5LCAodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCckJykpIHJldHVybjtcblxuICAgICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCc6JykgJiYgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3MucHVzaChrZXkuc3Vic3RyKDEpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5IGluIG1ldGEuZmllbGRzKSB7XG4gICAgICAgICAgICAgICAgcXVlcmllcy5wdXNoKHsgW2tleV06IHZhbHVlIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgVW5rbm93biBxdWVyeSBmaWVsZCBcIiR7a2V5fVwiLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBsZXQgbCA9IHF1ZXJpZXMubGVuZ3RoO1xuICAgIGlmIChsID4gMCkge1xuICAgICAgICBjb25kaXRpb24uJHF1ZXJ5ID0gbCA+IDEgPyB7ICRhbmQ6IHF1ZXJpZXMgfSA6IHF1ZXJpZXNbMF07XG4gICAgfVxuXG4gICAgaWYgKGFzc29jcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kYXNzb2NpYXRpb24gPSBhc3NvY3M7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coY29uZGl0aW9uKTtcblxuICAgIHJldHVybiBjb25kaXRpb247XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG4gICAgbGV0IGRlc2NFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19kZXNjJztcblxuICAgIGxldCBlbnRpdHlNb2RlbHMgPSBvcHRpb25zLmVudGl0eU1vZGVscztcblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbnRpdHlNb2RlbHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGVudGl0eU1vZGVscyA9IGZzLnJlYWRKc29uU3luYyhhcHAudG9BYnNvbHV0ZVBhdGgob3B0aW9ucy5lbnRpdHlNb2RlbHMpKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuXG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGVudGl0eU1vZGVscywgKGNvbmZpZywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgLy90b2RvOiBmaWx0ZXIgZW50aXR5IG9yIG1ldGhvZHMgYnkgY29uZmlnXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZUluVXJsID0gXy5rZWJhYkNhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQga2V5RmllbGROYW1lOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGNvbmZpZy5rZXkgfHwgZGIubW9kZWwoY29uZmlnLnNlbGVjdEZyb20pLm1ldGEua2V5RmllbGQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBkYi5tb2RlbChlbnRpdHlOYW1lKS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfSAgICAgICAgICBcblxuICAgICAgICAgICAga2V5RmllbGROYW1lID0gJzonICsga2V5RmllbGROYW1lO1xuXG4gICAgICAgICAgICBsZXQgc2luZ2xlVXJsID0gdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKTtcbiAgICAgICAgICAgIGxldCBiYXRjaFVybCA9IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpO1xuICAgICAgICAgICAgbGV0IGRlc2NVcmwgPSBhcHAudG9XZWJQYXRoKHVybEpvaW4oYmFzZVJvdXRlLCAnX2Rlc2MnLCBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKSkpO1xuXG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnbGlzdCcsIG1ldGhvZDogJ2dldCcsIHVybDogYmF0Y2hVcmwsIGFwaURlc2M6IGRlc2NVcmwgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGV0YWlsJywgbWV0aG9kOiAnZ2V0JywgdXJsOiBzaW5nbGVVcmwgfSk7XG5cbiAgICAgICAgICAgIGlmICghY29uZmlnLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2NyZWF0ZScsIG1ldGhvZDogJ3Bvc3QnLCB1cmw6IGJhdGNoVXJsIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICd1cGRhdGUnLCBtZXRob2Q6ICdwdXQnLCB1cmw6IHNpbmdsZVVybCB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGVsZXRlJywgbWV0aG9kOiAnZGVsJywgdXJsOiBzaW5nbGVVcmwgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKGRlc2NFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdDsgICAgICAgIFxuXG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBjb25maWcgPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGxldCBFbnRpdHlNb2RlbDtcblxuICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgbGlzdCA9IHtcbiAgICAgICAgICAgICAgICAndHlwZSc6ICd2aWV3JyxcbiAgICAgICAgICAgICAgICAnbWFpbkVudGl0eSc6IGNvbmZpZy5zZWxlY3RGcm9tICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5qb2luV2l0aCkge1xuICAgICAgICAgICAgICAgIGxpc3QuYXNzb2NpYXRpb25zID0gY29uZmlnLmpvaW5XaXRoO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLndoZXJlKSB7XG4gICAgICAgICAgICAgICAgbGlzdC53aGVyZSA9IGNvbmZpZy53aGVyZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5rZXkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LmtleSA9IGNvbmZpZy5rZXk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoY29uZmlnLnNlbGVjdEZyb20pO1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnLnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5xdWVyeSA9IF8ubWFwVmFsdWVzKGNvbmZpZy5xdWVyeSwgKGluZm8pID0+IGluZm8uZGVzYyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcub3JkZXJCeSkge1xuICAgICAgICAgICAgICAgIGxpc3Qub3JkZXJCeSA9IGNvbmZpZy5vcmRlckJ5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGlzdCA9IHtcbiAgICAgICAgICAgICAgICAndHlwZSc6ICdlbnRpdHknLFxuICAgICAgICAgICAgICAgICdlbnRpdHknOiBlbnRpdHlOYW1lICAgIFxuICAgICAgICAgICAgfTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxpc3QucXVlcnkgPSBfLm1hcFZhbHVlcyhFbnRpdHlNb2RlbC5tZXRhLmZpZWxkcywgKGluZm8pID0+IGluZm8uZGlzcGxheU5hbWUpO1xuICAgICAgICB9ICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgaWYgKGFwcC5lbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4obWV0YWRhdGFFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbCgoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSA/IGFwaUluZm8uc2VsZWN0RnJvbSA6IGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGluZm8gPSBFbnRpdHlNb2RlbC5tZXRhO1xuXG4gICAgICAgICAgICBpZiAoY3R4LnF1ZXJ5LmZpbHRlcikge1xuICAgICAgICAgICAgICAgIGluZm8gPSBnZXRWYWx1ZUJ5UGF0aChpbmZvLCBjdHgucXVlcnkuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgRW1wdHkgY29udGVudC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gaW5mbztcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgLy9nZXQgbGlzdCAgICBcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucywgRW50aXR5TW9kZWw7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcblxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5wcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvKSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5wcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvLCBFbnRpdHlNb2RlbC5tZXRhKSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBxdWVyeU9wdGlvbnMuJHZhcmlhYmxlcyA9IHsgXG4gICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgfTtcblxuICAgICAgICBjdHguYm9keSA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRBbGxfKHF1ZXJ5T3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICAvL2dldCBkZXRhaWxcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCwgcXVlcnlPcHRpb25zLCBrZXlGaWVsZDtcbiAgICAgICAgbGV0IGtleVZhbHVlID0gY3R4LnBhcmFtcy5pZDsgICAgICAgIFxuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAga2V5RmllbGQgPSBhcGlJbmZvLmtleSB8fCBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBrZXlWYWx1ZSwgLi4uYXBpSW5mby53aGVyZSB9LFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAga2V5RmllbGQgPSBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICBsZXQgYXNzb2NzID0gW107XG5cbiAgICAgICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJzonKSAmJiB2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NvY3MucHVzaChrZXkuc3Vic3RyKDEpKTtcbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtrZXlGaWVsZF06IGtleVZhbHVlIH0sIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGFzc29jcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLiRhc3NvY2lhdGlvbiA9IGFzc29jcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuTk9UX0ZPVU5ELCBgXCIke0VudGl0eU1vZGVsLm1ldGEubmFtZX1cIiB3aXRoIFske2tleUZpZWxkfT0ke2tleVZhbHVlfV0gbm90IGZvdW5kLmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcmV0cmlldmVDcmVhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgeyB3aGVyZSwgZGF0YSB9ID0gY3R4LnJlcXVlc3QuYm9keTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVfKGRhdGEsIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vZGVsZXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgZGVsZXRlZCA9IGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZV8oeyBcbiAgICAgICAgICAgICRxdWVyeTogd2hlcmUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0geyBzdGF0dXM6ICdPSycsIGRlbGV0ZWQgfTtcbiAgICB9KTsgICBcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19
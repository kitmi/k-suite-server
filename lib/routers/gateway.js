"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];

  if (ctx.query) {
    let {
      $orderBy,
      $offset,
      $limit,
      $returnTotal
    } = ctx.query;

    if ($orderBy) {
      let orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }

      condition.$orderBy = orderBy;
    }

    if ($offset) {
      condition.$offset = ensureInt('$offset', $offset);
    }

    if ($limit) {
      condition.$limit = ensureInt('$limit', $limit);
    }

    if ($returnTotal) {
      if ($returnTotal === '1' || $returnTotal === 'true') {
        condition.$totalCount = true;
      } else {
        condition.$totalCount = $returnTotal;
      }
    }

    if (!_.isEmpty(apiInfo.query)) {
      _.forOwn(apiInfo.query, (info, param) => {
        if (param in ctx.query) {
          queries.push(info.where);
        }
      });
    }
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwiY29uZGl0aW9uIiwicXVlcmllcyIsIndoZXJlIiwicXVlcnkiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcmV0dXJuVG90YWwiLCJvcmRlckJ5IiwiJHRvdGFsQ291bnQiLCJpc0VtcHR5IiwiZm9yT3duIiwiaW5mbyIsInBhcmFtIiwicHVzaCIsImwiLCJsZW5ndGgiLCIkcXVlcnkiLCIkYW5kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJzY2hlbWFOYW1lIiwiZW50aXR5TW9kZWxzIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsInJlc3RBcGlXcmFwcGVyIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImFwaUxpc3RFbmRwb2ludCIsIm1ldGFkYXRhRW5kcG9pbnQiLCJkZXNjRW5kcG9pbnQiLCJyZWFkSnNvblN5bmMiLCJ0b0Fic29sdXRlUGF0aCIsImFkZFJvdXRlIiwibGlzdCIsImRiIiwiYXBwTW9kdWxlIiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsImtleUZpZWxkTmFtZSIsInR5cGUiLCJrZXkiLCJtb2RlbCIsInNlbGVjdEZyb20iLCJtZXRhIiwia2V5RmllbGQiLCJzaW5nbGVVcmwiLCJiYXRjaFVybCIsImRlc2NVcmwiLCJ0b1dlYlBhdGgiLCJtZXRob2QiLCJ1cmwiLCJhcGlEZXNjIiwicmVhZE9ubHkiLCJib2R5IiwiY2FtZWxDYXNlIiwicGFyYW1zIiwiZW50aXR5IiwiRW50aXR5TW9kZWwiLCJqb2luV2l0aCIsImFzc29jaWF0aW9ucyIsIm1hcFZhbHVlcyIsImRlc2MiLCJmaWVsZHMiLCJkaXNwbGF5TmFtZSIsImVudiIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJxdWVyeU9wdGlvbnMiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCIkdmFyaWFibGVzIiwic2Vzc2lvbiIsInNlc3Npb25WYXJpYWJsZXMiLCJmaW5kQWxsXyIsImlkIiwiZmluZE9uZV8iLCJjcmVhdGVfIiwicmVxdWVzdCIsIiRyZXRyaWV2ZUNyZWF0ZWQiLCJ1cGRhdGVfIiwiJHJldHJpZXZlVXBkYXRlZCIsImRlbGV0ZWQiLCJkZWxldGVfIiwic3RhdHVzIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLE9BQVQ7QUFBa0JDLEVBQUFBO0FBQWxCLElBQXFDQyxPQUFPLENBQUMsVUFBRCxDQUFsRDs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxZQUFELENBQXRCOztBQUNBLE1BQU1FLFFBQVEsR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBQXhCOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsb0JBQUY7QUFBd0JDLEVBQUFBLFVBQXhCO0FBQW9DQyxFQUFBQTtBQUFwQyxJQUF5REwsT0FBTyxDQUFDLFdBQUQsQ0FBdEU7O0FBQ0EsTUFBTU0sU0FBUyxHQUFHTixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFPQSxTQUFTTyxTQUFULENBQW1CQyxJQUFuQixFQUF5QkMsS0FBekIsRUFBZ0M7QUFDNUIsTUFBSUMsU0FBUyxHQUFHZCxDQUFDLENBQUNlLFNBQUYsQ0FBWUYsS0FBWixJQUFxQkEsS0FB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O0FBUUFMLElBQUFBLEdBQUcsQ0FBQzhELElBQUosR0FBVztBQUFFZ0MsTUFBQUEsTUFBTSxFQUFFLElBQVY7QUFBZ0JGLE1BQUFBO0FBQWhCLEtBQVg7QUFDSCxHQTFCRDtBQTRCQXJFLEVBQUFBLEdBQUcsQ0FBQ3dFLFNBQUosQ0FBY25FLE1BQWQ7QUFDSCxDQXRURCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QsIE1ldGhvZE5vdEFsbG93ZWQgfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuY29uc3QgdmFsaWRhdG9yID0gcmVxdWlyZSgndmFsaWRhdG9yJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuZnVuY3Rpb24gZW5zdXJlSW50KG5hbWUsIHZhbHVlKSB7XG4gICAgbGV0IHNhbml0aXplZCA9IF8uaXNJbnRlZ2VyKHZhbHVlKSA/IHZhbHVlIDogdmFsaWRhdG9yLnRvSW50KHZhbHVlKTtcbiAgICBpZiAoaXNOYU4oc2FuaXRpemVkKSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgXCIke25hbWV9XCIgc2hvdWxkIGJlIGFuIGludGVnZXIuYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNhbml0aXplZDtcbn1cblxuZnVuY3Rpb24gcHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbykgeyAgICBcbiAgICBsZXQgY29uZGl0aW9uID0ge307XG4gICAgbGV0IHF1ZXJpZXMgPSBhcGlJbmZvLndoZXJlID8gWyBhcGlJbmZvLndoZXJlIF0gOiBbXTtcblxuICAgIGlmIChjdHgucXVlcnkpIHtcbiAgICAgICAgbGV0IHsgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHJldHVyblRvdGFsIH0gPSBjdHgucXVlcnk7XG5cbiAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICBsZXQgb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVskb3JkZXJCeV07XG4gICAgICAgICAgICBpZiAoIW9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgT3JkZXIgYnkgXCIke29yZGVyQnl9XCIgaXMgbm90IHN1cHBvcnRlZC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uZGl0aW9uLiRvcmRlckJ5ID0gb3JkZXJCeTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgkb2Zmc2V0KSB7ICAgICAgICBcbiAgICAgICAgICAgIGNvbmRpdGlvbi4kb2Zmc2V0ID0gZW5zdXJlSW50KCckb2Zmc2V0JywgJG9mZnNldCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoJGxpbWl0KSB7XG4gICAgICAgICAgICBjb25kaXRpb24uJGxpbWl0ID0gZW5zdXJlSW50KCckbGltaXQnLCAkbGltaXQpO1xuICAgICAgICB9ICAgIFxuXG4gICAgICAgIGlmICgkcmV0dXJuVG90YWwpIHsgICBcbiAgICAgICAgICAgIGlmICgkcmV0dXJuVG90YWwgPT09ICcxJyB8fCAkcmV0dXJuVG90YWwgPT09ICd0cnVlJykge1xuICAgICAgICAgICAgICAgIGNvbmRpdGlvbi4kdG90YWxDb3VudCA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gJHJldHVyblRvdGFsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICAgIFxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGFwaUluZm8ucXVlcnkpKSB7XG4gICAgICAgICAgICBfLmZvck93bihhcGlJbmZvLnF1ZXJ5LCAoaW5mbywgcGFyYW0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW0gaW4gY3R4LnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaChpbmZvLndoZXJlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSAgICBcbiAgICB9XG5cbiAgICBsZXQgbCA9IHF1ZXJpZXMubGVuZ3RoO1xuICAgIGlmIChsID4gMCkge1xuICAgICAgICBjb25kaXRpb24uJHF1ZXJ5ID0gbCA+IDEgPyB7ICRhbmQ6IHF1ZXJpZXMgfSA6IHF1ZXJpZXNbMF07XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmRpdGlvbjtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIGdhdGV3YXk6IHsgICAgICAgICAgXG4gKiAgICAgICAgICBtaWRkbGV3YXJlczoge30sXG4gKiAgICAgICAgICBzY2hlbWFOYW1lOiAnJyxcbiAqICAgICAgICAgIGVudGl0eU1vZGVsczoge318PGNvbmZpZyBwYXRoPiwgIFxuICogICAgICAgICAgYXBpTGlzdEVuZHBvaW50OiAnL19saXN0JyxcbiAqICAgICAgICAgIG1ldGFkYXRhRW5kcG9pbnQ6ICcvX21ldGEnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuc2NoZW1hTmFtZWBcbiAgICAgICAgKTtcbiAgICB9ICAgIFxuXG4gICAgaWYgKCFvcHRpb25zLmVudGl0eU1vZGVscykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBlbnRpdHkgbW9kZWxzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuZW50aXR5TW9kZWxzYFxuICAgICAgICApOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5yZXN0QXBpV3JhcHBlcigpLCAncmVzdEFwaVdyYXBwZXInKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCBhcGlMaXN0RW5kcG9pbnQgPSBvcHRpb25zLmFwaUxpc3RFbmRwb2ludCB8fCAnL19saXN0JztcbiAgICBsZXQgbWV0YWRhdGFFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19pbmZvJztcbiAgICBsZXQgZGVzY0VuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2Rlc2MnO1xuXG4gICAgbGV0IGVudGl0eU1vZGVscyA9IG9wdGlvbnMuZW50aXR5TW9kZWxzO1xuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmVudGl0eU1vZGVscyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZW50aXR5TW9kZWxzID0gZnMucmVhZEpzb25TeW5jKGFwcC50b0Fic29sdXRlUGF0aChvcHRpb25zLmVudGl0eU1vZGVscykpOyBcbiAgICB9XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYXBpTGlzdEVuZHBvaW50LCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBsaXN0ID0gW107XG5cbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oZW50aXR5TW9kZWxzLCAoY29uZmlnLCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICAvL3RvZG86IGZpbHRlciBlbnRpdHkgb3IgbWV0aG9kcyBieSBjb25maWdcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lSW5VcmwgPSBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZE5hbWU7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gY29uZmlnLmtleSB8fCBkYi5tb2RlbChjb25maWcuc2VsZWN0RnJvbSkubWV0YS5rZXlGaWVsZDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGRiLm1vZGVsKGVudGl0eU5hbWUpLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9ICAgICAgICAgIFxuXG4gICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSAnOicgKyBrZXlGaWVsZE5hbWU7XG5cbiAgICAgICAgICAgIGxldCBzaW5nbGVVcmwgPSB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpO1xuICAgICAgICAgICAgbGV0IGJhdGNoVXJsID0gdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCk7XG4gICAgICAgICAgICBsZXQgZGVzY1VybCA9IGFwcC50b1dlYlBhdGgodXJsSm9pbihiYXNlUm91dGUsICdfZGVzYycsIF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpKSk7XG5cbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdsaXN0JywgbWV0aG9kOiAnZ2V0JywgdXJsOiBiYXRjaFVybCwgYXBpRGVzYzogZGVzY1VybCB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZXRhaWwnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHNpbmdsZVVybCB9KTtcblxuICAgICAgICAgICAgaWYgKCFjb25maWcucmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnY3JlYXRlJywgbWV0aG9kOiAncG9zdCcsIHVybDogYmF0Y2hVcmwgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ3VwZGF0ZScsIG1ldGhvZDogJ3B1dCcsIHVybDogc2luZ2xlVXJsIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZWxldGUnLCBtZXRob2Q6ICdkZWwnLCB1cmw6IHNpbmdsZVVybCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4oZGVzY0VuZHBvaW50LCAnOmVudGl0eScpLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBsaXN0OyAgICAgICAgXG5cbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGNvbmZpZyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgbGV0IEVudGl0eU1vZGVsO1xuXG4gICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBsaXN0ID0ge1xuICAgICAgICAgICAgICAgICd0eXBlJzogJ3ZpZXcnLFxuICAgICAgICAgICAgICAgICdtYWluRW50aXR5JzogY29uZmlnLnNlbGVjdEZyb20gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnLmpvaW5XaXRoKSB7XG4gICAgICAgICAgICAgICAgbGlzdC5hc3NvY2lhdGlvbnMgPSBjb25maWcuam9pbldpdGg7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcud2hlcmUpIHtcbiAgICAgICAgICAgICAgICBsaXN0LndoZXJlID0gY29uZmlnLndoZXJlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLmtleSkge1xuICAgICAgICAgICAgICAgIGxpc3Qua2V5ID0gY29uZmlnLmtleTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChjb25maWcuc2VsZWN0RnJvbSk7XG5cbiAgICAgICAgICAgIGlmIChjb25maWcucXVlcnkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnF1ZXJ5ID0gXy5tYXBWYWx1ZXMoY29uZmlnLnF1ZXJ5LCAoaW5mbykgPT4gaW5mby5kZXNjKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5vcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5vcmRlckJ5ID0gY29uZmlnLm9yZGVyQnk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsaXN0ID0ge1xuICAgICAgICAgICAgICAgICd0eXBlJzogJ2VudGl0eScsXG4gICAgICAgICAgICAgICAgJ2VudGl0eSc6IGVudGl0eU5hbWUgICAgXG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsaXN0LnF1ZXJ5ID0gXy5tYXBWYWx1ZXMoRW50aXR5TW9kZWwubWV0YS5maWVsZHMsIChpbmZvKSA9PiBpbmZvLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfSAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3JykgPyBhcGlJbmZvLnNlbGVjdEZyb20gOiBlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnM7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5wcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvKSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5jdHgucXVlcnksIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0geyBcbiAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICB9O1xuXG4gICAgICAgIGN0eC5ib2R5ID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZEFsbF8ocXVlcnlPcHRpb25zKTtcbiAgICB9KTtcblxuICAgIC8vZ2V0IGRldGFpbFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsLCBxdWVyeU9wdGlvbnM7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQga2V5RmllbGQgPSBhcGlJbmZvLmtleSB8fCBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtrZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQsIC4uLmFwaUluZm8ud2hlcmUgfSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0geyBcbiAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRPbmVfKHF1ZXJ5T3B0aW9ucyk7ICAgICAgICBcbiAgICAgICAgaWYgKCFtb2RlbCkge1xuICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgSW52YWxpZCBcIiR7Y3R4LnBhcmFtcy5lbnRpdHl9XCIgaWQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgIH0gXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vY3JlYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7ICAgICAgIFxuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmNyZWF0ZV8oY3R4LnJlcXVlc3QuYm9keSwgeyBcbiAgICAgICAgICAgICRyZXRyaWV2ZUNyZWF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy91cGRhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLnVwZGF0ZV8oY3R4LnJlcXVlc3QuYm9keSwgeyBcbiAgICAgICAgICAgICRxdWVyeTogd2hlcmUsIFxuICAgICAgICAgICAgJHJldHJpZXZlVXBkYXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IHsgXG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICAgICAgfSBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9kZWxldGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZGVsJywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGxldCBkZWxldGVkID0gYXdhaXQgRW50aXR5TW9kZWwuZGVsZXRlXyh7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IHsgXG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSB7IHN0YXR1czogJ09LJywgZGVsZXRlZCB9O1xuICAgIH0pOyAgIFxuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=
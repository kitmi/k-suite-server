"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest
} = require('../Errors');

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(options.entityModels);
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    await eachAsync_(entityModels, async (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'create',
        method: 'post',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'update',
        method: 'put',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'delete',
        method: 'del',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
    });
    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      if (!(entityName in entityModels)) {
        throw new BadRequest('Invalid entity endpoint.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  function extractQueryOptionFromBody(body) {
    return _.mapKeys(_.pick(body, ['association', 'projection', 'groupBy', 'orderBy', 'offset', 'limit']), (v, k) => '$' + k);
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let queryOptions = {
      $query: ctx.query,
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let queryOptions = {
      $query: {
        [EntityModel.meta.keyField]: ctx.params.id
      },
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwiYWRkUm91dGUiLCJjdHgiLCJsaXN0IiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsInB1c2giLCJ0eXBlIiwibWV0aG9kIiwidXJsIiwiYm9keSIsImVudiIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsImRiIiwiYXBwTW9kdWxlIiwiRW50aXR5TW9kZWwiLCJtb2RlbCIsImluZm8iLCJtZXRhIiwicXVlcnkiLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwiZXh0cmFjdFF1ZXJ5T3B0aW9uRnJvbUJvZHkiLCJtYXBLZXlzIiwicGljayIsInYiLCJrIiwicXVlcnlPcHRpb25zIiwiJHF1ZXJ5IiwiJHVuYm94aW5nIiwicmVxdWVzdCIsImZpbmRBbGxfIiwia2V5RmllbGQiLCJpZCIsImZpbmRPbmVfIiwiY3JlYXRlXyIsIiRyZXRyaWV2ZUNyZWF0ZWQiLCJ3aGVyZSIsInVwZGF0ZV8iLCIkcmV0cmlldmVVcGRhdGVkIiwiZGVsZXRlXyIsInN0YXR1cyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxN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Q2dCLFNBQUosQ0FBY0QsRUFBZCxDQUFpQjVCLE9BQU8sQ0FBQ0MsVUFBekIsQ0FBVDs7QUFFQSxRQUFJZSxVQUFVLEdBQUc5QixDQUFDLENBQUN1QyxTQUFGLENBQVlaLEdBQUcsQ0FBQ2EsTUFBSixDQUFXQyxNQUF2QixDQUFqQjs7QUFDQSxRQUFJLEVBQUVYLFVBQVUsSUFBSWQsWUFBaEIsQ0FBSixFQUFtQztBQUMvQixZQUFNLElBQUlQLFVBQUosQ0FBZSw0QkFBZixDQUFOO0FBQ0g7O0FBRUQsUUFBSW1DLFdBQVcsR0FBR0YsRUFBRSxDQUFDRyxLQUFILENBQVNmLFVBQVQsQ0FBbEI7QUFFQSxRQUFJc0MsS0FBSyxHQUFHO0FBQUUsT0FBQ3hCLFdBQVcsQ0FBQ0csSUFBWixDQUFpQmdCLFFBQWxCLEdBQTZCcEMsR0FBRyxDQUFDYSxNQUFKLENBQVd3QjtBQUExQyxLQUFaO0FBRUEsVUFBTXBCLFdBQVcsQ0FBQzJCLE9BQVosQ0FBb0I7QUFBRVosTUFBQUEsTUFBTSxFQUFFUztBQUFWLEtBQXBCLENBQU47QUFFQXpDLElBQUFBLEdBQUcsQ0FBQ1UsSUFBSixHQUFXO0FBQUVtQyxNQUFBQSxNQUFNLEVBQUU7QUFBVixLQUFYO0FBQ0gsR0FmRDtBQWlCQTVELEVBQUFBLEdBQUcsQ0FBQzZELFNBQUosQ0FBY3hELE1BQWQ7QUFDSCxDQXRMRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QgfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMob3B0aW9ucy5lbnRpdHlNb2RlbHMpOyBcbiAgICB9XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYXBpTGlzdEVuZHBvaW50LCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBsaXN0ID0gW107XG4gICAgICAgIFxuICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGVudGl0eU1vZGVscywgYXN5bmMgKGNvbmZpZywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgLy90b2RvOiBmaWx0ZXIgZW50aXR5IG9yIG1ldGhvZHMgYnkgY29uZmlnXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZUluVXJsID0gXy5rZWJhYkNhc2UoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdsaXN0JywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKSB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZXRhaWwnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsICc6aWQnKSB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdjcmVhdGUnLCBtZXRob2Q6ICdwb3N0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKSB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICd1cGRhdGUnLCBtZXRob2Q6ICdwdXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsICc6aWQnKSB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZWxldGUnLCBtZXRob2Q6ICdkZWwnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsICc6aWQnKSB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgaWYgKGFwcC5lbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4obWV0YWRhdGFFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnSW52YWxpZCBlbnRpdHkgZW5kcG9pbnQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGluZm8gPSBFbnRpdHlNb2RlbC5tZXRhO1xuXG4gICAgICAgICAgICBpZiAoY3R4LnF1ZXJ5LmZpbHRlcikge1xuICAgICAgICAgICAgICAgIGluZm8gPSBnZXRWYWx1ZUJ5UGF0aChpbmZvLCBjdHgucXVlcnkuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgRW1wdHkgY29udGVudC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gaW5mbztcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBleHRyYWN0UXVlcnlPcHRpb25Gcm9tQm9keShib2R5KSB7XG4gICAgICAgIHJldHVybiBfLm1hcEtleXMoXy5waWNrKGJvZHksIFtcbiAgICAgICAgICAgICdhc3NvY2lhdGlvbicsXG4gICAgICAgICAgICAncHJvamVjdGlvbicsXG4gICAgICAgICAgICAnZ3JvdXBCeScsXG4gICAgICAgICAgICAnb3JkZXJCeScsXG4gICAgICAgICAgICAnb2Zmc2V0JyxcbiAgICAgICAgICAgICdsaW1pdCcsXG4gICAgICAgIF0pLCAodiwgaykgPT4gJyQnK2spO1xuICAgIH1cblxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAkcXVlcnk6IGN0eC5xdWVyeSwgXG4gICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgLi4uZXh0cmFjdFF1ZXJ5T3B0aW9uRnJvbUJvZHkoY3R4LnJlcXVlc3QuYm9keSlcbiAgICAgICAgfTtcblxuICAgICAgICBjdHguYm9keSA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRBbGxfKHF1ZXJ5T3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICAvL2dldCBkZXRhaWxcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAkcXVlcnk6IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH0sIFxuICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgIC4uLmV4dHJhY3RRdWVyeU9wdGlvbkZyb21Cb2R5KGN0eC5yZXF1ZXN0LmJvZHkpXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBJbnZhbGlkIFwiJHtjdHgucGFyYW1zLmVudGl0eX1cIiBpZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7ICAgICAgIFxuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmNyZWF0ZV8oY3R4LnJlcXVlc3QuYm9keSwgeyAkcmV0cmlldmVDcmVhdGVkOiB0cnVlIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgaWYgKCEoZW50aXR5TmFtZSBpbiBlbnRpdHlNb2RlbHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7ICRxdWVyeTogd2hlcmUsICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9kZWxldGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZGVsJywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVfKHsgJHF1ZXJ5OiB3aGVyZSB9KTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSB7IHN0YXR1czogJ09LJyB9O1xuICAgIH0pOyAgIFxuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=
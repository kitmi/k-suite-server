"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../utils/Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processKeyValuePair(meta, assocs, queries, key, value) {
  let lastDot = key.lastIndexOf('.');

  if (lastDot > 0) {
    let lastPart = key.substr(lastDot + 1);
    let leftPart = key.substr(0, lastDot);

    if (lastPart.startsWith('$')) {
      value = {
        [lastPart]: value
      };
      return processKeyValuePair(meta, assocs, queries, leftPart, value);
    }

    assocs.add(leftPart);
    queries.push({
      [key]: value
    });
  } else if (key in meta.fields) {
    queries.push({
      [key]: value
    });
  } else {
    throw new BadRequest(`Unknown query field "${key}".`);
  }
}

function processQuery(ctx, apiInfo, meta) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];
  let assocs = new Set();
  let {
    $orderBy,
    $offset,
    $limit,
    $returnTotal,
    $exist,
    $notExist
  } = ctx.query;

  if ($exist) {
    $exist = _.castArray($exist);
    $exist.map(item => queries.push({
      [item]: {
        $ne: null
      }
    }));
  }

  if ($notExist) {
    $notExist = _.castArray($notExist);
    $notExist.map(item => queries.push({
      [item]: {
        $eq: null
      }
    }));
  }

  if ($orderBy) {
    let orderBy;

    if (meta) {
      orderBy = {};

      let rawOrderBy = _.castArray($orderBy);

      rawOrderBy.forEach(byField => {
        let ascend = true;

        if (byField.startsWith('>')) {
          ascend = false;
          byField = byField.substr(1);
        } else if (byField.startsWith('<')) {
          byField = byField.substr(1);
        }

        if (byField.startsWith(':')) {
          byField = byField.substr(1);
        } else if (!(byField in meta.fields)) {
          throw new BadRequest(`Unknown orderBy field "${byField}".`);
        }

        orderBy[byField] = ascend;
      });
    } else {
      orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }
    }

    condition.$orderBy = orderBy;
  } else if (apiInfo.orderBy && apiInfo.orderBy['$default']) {
    condition.$orderBy = apiInfo.orderBy['$default'];
  }

  if ($offset) {
    condition.$offset = ensureInt('$offset', $offset);
  }

  if ($limit) {
    condition.$limit = ensureInt('$limit', $limit);
  }

  if ($returnTotal) {
    if ($returnTotal === '1' || $returnTotal === 'true') {
      condition.$totalCount = true;
    } else {
      condition.$totalCount = $returnTotal;
    }
  }

  if (!_.isEmpty(apiInfo.query)) {
    _.forOwn(apiInfo.query, (info, param) => {
      if (param in ctx.query) {
        queries.push(info.where);
      }
    });
  } else if (meta) {
    _.forOwn(ctx.query, (value, key) => {
      if (key.startsWith('$')) return;

      if (key.startsWith(':')) {
        let assoc = key.substr(1);

        if (_.isNil(value) || value !== '0') {
          assocs.add(assoc);
        }
      } else {
        processKeyValuePair(meta, assocs, queries, key, value);
      }
    });
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  if (assocs.size > 0) {
    condition.$association = Array.from(assocs);
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions, EntityModel;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo, EntityModel.meta),
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions, keyField;
    let keyValue = ctx.params.id;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: keyValue,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      keyField = EntityModel.meta.keyField;
      let assocs = [];

      _.forOwn(ctx.query, (value, key) => {
        if (key.startsWith(':') && (_.isNil(value) || value !== '0')) {
          assocs.push(key.substr(1));
        }
      });

      queryOptions = {
        $query: {
          [keyField]: keyValue
        },
        $unboxing: true
      };

      if (assocs.length > 0) {
        queryOptions.$association = assocs;
      }
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.NOT_FOUND, `"${EntityModel.meta.name}" with [${keyField}=${keyValue}] not found.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let {
      where,
      data
    } = ctx.request.body;
    let model = await EntityModel.updateOne_(data, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.updateOne_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.deleteOne_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzS2V5VmFsdWVQYWlyIiwibWV0YSIsImFzc29jcyIsInF1ZXJpZXMiLCJrZXkiLCJsYXN0RG90IiwibGFzdEluZGV4T2YiLCJsYXN0UGFydCIsInN1YnN0ciIsImxlZnRQYXJ0Iiwic3RhcnRzV2l0aCIsImFkZCIsInB1c2giLCJmaWVsZHMiLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwiY29uZGl0aW9uIiwid2hlcmUiLCJTZXQiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcmV0dXJuVG90YWwiLCIkZXhpc3QiLCIkbm90RXhpc3QiLCJxdWVyeSIsImNhc3RBcnJheSIsIm1hcCIsIml0ZW0iLCIkbmUiLCIkZXEiLCJvcmRlckJ5IiwicmF3T3JkZXJCeSIsImZvckVhY2giLCJieUZpZWxkIiwiYXNjZW5kIiwiJHRvdGFsQ291bnQiLCJpc0VtcHR5IiwiZm9yT3duIiwiaW5mbyIsInBhcmFtIiwiYXNzb2MiLCJpc05pbCIsImwiLCJsZW5ndGgiLCIkcXVlcnkiLCIkYW5kIiwic2l6ZSIsIiRhc3NvY2lhdGlvbiIsIkFycmF5IiwiZnJvbSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwiZGVzY0VuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImxpc3QiLCJkYiIsImFwcE1vZHVsZSIsImNvbmZpZyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJrZXlGaWVsZE5hbWUiLCJ0eXBlIiwibW9kZWwiLCJzZWxlY3RGcm9tIiwia2V5RmllbGQiLCJzaW5nbGVVcmwiLCJiYXRjaFVybCIsImRlc2NVcmwiLCJ0b1dlYlBhdGgiLCJtZXRob2QiLCJ1cmwiLCJhcGlEZXNjIiwicmVhZE9ubHkiLCJib2R5IiwiY2FtZWxDYXNlIiwicGFyYW1zIiwiZW50aXR5IiwiRW50aXR5TW9kZWwiLCJqb2luV2l0aCIsImFzc29jaWF0aW9ucyIsIm1hcFZhbHVlcyIsImRlc2MiLCJkaXNwbGF5TmFtZSIsImVudiIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJxdWVyeU9wdGlvbnMiLCIkdW5ib3hpbmciLCIkdmFyaWFibGVzIiwic2Vzc2lvbiIsInNlc3Npb25WYXJpYWJsZXMiLCJmaW5kQWxsXyIsImtleVZhbHVlIiwiaWQiLCJmaW5kT25lXyIsIk5PVF9GT1VORCIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsImRhdGEiLCJ1cGRhdGVPbmVfIiwiJHJldHJpZXZlVXBkYXRlZCIsImRlbGV0ZWQiLCJkZWxldGVPbmVfIiwic3RhdHVzIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLE9BQVQ7QUFBa0JDLEVBQUFBO0FBQWxCLElBQXFDQyxPQUFPLENBQUMsVUFBRCxDQUFsRDs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxZQUFELENBQXRCOztB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T0FBTyxHQUFHLE1BQU0zQixXQUFXLENBQUM0QixVQUFaLENBQXVCO0FBQ3ZDN0UsTUFBQUEsTUFBTSxFQUFFNUIsS0FEK0I7QUFFdkMwRixNQUFBQSxVQUFVLEVBQUU7QUFDUkMsUUFBQUEsT0FBTyxFQUFFOUYsR0FBRyxDQUFDK0YsZ0JBREw7QUFFUnBGLFFBQUFBLEtBQUssRUFBRVgsR0FBRyxDQUFDVztBQUZIO0FBRjJCLEtBQXZCLENBQXBCO0FBUUFYLElBQUFBLEdBQUcsQ0FBQzRFLElBQUosR0FBVztBQUFFaUMsTUFBQUEsTUFBTSxFQUFFLElBQVY7QUFBZ0JGLE1BQUFBO0FBQWhCLEtBQVg7QUFDSCxHQTFCRDtBQTRCQXBFLEVBQUFBLEdBQUcsQ0FBQ3VFLFNBQUosQ0FBY2xFLE1BQWQ7QUFDSCxDQXJXRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QsIE1ldGhvZE5vdEFsbG93ZWQgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgdmFsaWRhdG9yID0gcmVxdWlyZSgndmFsaWRhdG9yJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuZnVuY3Rpb24gZW5zdXJlSW50KG5hbWUsIHZhbHVlKSB7XG4gICAgbGV0IHNhbml0aXplZCA9IF8uaXNJbnRlZ2VyKHZhbHVlKSA/IHZhbHVlIDogdmFsaWRhdG9yLnRvSW50KHZhbHVlKTtcbiAgICBpZiAoaXNOYU4oc2FuaXRpemVkKSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgXCIke25hbWV9XCIgc2hvdWxkIGJlIGFuIGludGVnZXIuYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNhbml0aXplZDtcbn1cblxuZnVuY3Rpb24gcHJvY2Vzc0tleVZhbHVlUGFpcihtZXRhLCBhc3NvY3MsIHF1ZXJpZXMsIGtleSwgdmFsdWUpIHtcbiAgICBsZXQgbGFzdERvdCA9IGtleS5sYXN0SW5kZXhPZignLicpO1xuXG4gICAgaWYgKGxhc3REb3QgPiAwKSB7XG4gICAgICAgIGxldCBsYXN0UGFydCA9IGtleS5zdWJzdHIobGFzdERvdCsxKTtcbiAgICAgICAgbGV0IGxlZnRQYXJ0ID0ga2V5LnN1YnN0cigwLCBsYXN0RG90KTtcbiAgICAgICAgXG4gICAgICAgIGlmIChsYXN0UGFydC5zdGFydHNXaXRoKCckJykpIHtcbiAgICAgICAgICAgIHZhbHVlID0geyBbbGFzdFBhcnRdOiB2YWx1ZSB9O1xuXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0tleVZhbHVlUGFpcihtZXRhLCBhc3NvY3MsIHF1ZXJpZXMsIGxlZnRQYXJ0LCB2YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBhc3NvY3MuYWRkKGxlZnRQYXJ0KTtcbiAgICAgICAgcXVlcmllcy5wdXNoKHsgW2tleV06IHZhbHVlIH0pO1xuICAgIH0gZWxzZSBpZiAoKGtleSBpbiBtZXRhLmZpZWxkcykpIHtcbiAgICAgICAgcXVlcmllcy5wdXNoKHsgW2tleV06IHZhbHVlIH0pOyAgICAgICAgICAgICBcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgVW5rbm93biBxdWVyeSBmaWVsZCBcIiR7a2V5fVwiLmApO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbywgbWV0YSkgeyAgICBcbiAgICBsZXQgY29uZGl0aW9uID0ge307XG4gICAgbGV0IHF1ZXJpZXMgPSBhcGlJbmZvLndoZXJlID8gWyBhcGlJbmZvLndoZXJlIF0gOiBbXTtcbiAgICBsZXQgYXNzb2NzID0gbmV3IFNldCgpO1xuXG4gICAgbGV0IHsgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHJldHVyblRvdGFsLCAkZXhpc3QsICRub3RFeGlzdCB9ID0gY3R4LnF1ZXJ5O1xuXG4gICAgaWYgKCRleGlzdCkge1xuICAgICAgICAkZXhpc3QgPSBfLmNhc3RBcnJheSgkZXhpc3QpO1xuICAgICAgICAkZXhpc3QubWFwKGl0ZW0gPT4gcXVlcmllcy5wdXNoKHtbaXRlbV06IHsgJG5lOiBudWxsIH19KSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBpZiAoJG5vdEV4aXN0KSB7XG4gICAgICAgICRub3RFeGlzdCA9IF8uY2FzdEFycmF5KCRub3RFeGlzdCk7XG4gICAgICAgICRub3RFeGlzdC5tYXAoaXRlbSA9PiBxdWVyaWVzLnB1c2goe1tpdGVtXTogeyAkZXE6IG51bGwgfX0pKTsgICAgICAgIFxuICAgIH1cbiAgICAgICAgXG4gICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgIGxldCBvcmRlckJ5O1xuXG4gICAgICAgIGlmIChtZXRhKSB7XG4gICAgICAgICAgICBvcmRlckJ5ID0ge307XG4gICAgICAgICAgICBsZXQgcmF3T3JkZXJCeSA9IF8uY2FzdEFycmF5KCRvcmRlckJ5KTtcbiAgICAgICAgICAgIHJhd09yZGVyQnkuZm9yRWFjaChieUZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYXNjZW5kID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJz4nKSkge1xuICAgICAgICAgICAgICAgICAgICBhc2NlbmQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYnlGaWVsZCA9IGJ5RmllbGQuc3Vic3RyKDEpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnlGaWVsZC5zdGFydHNXaXRoKCc8JykpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgICAgIGlmIChieUZpZWxkLnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgICAgICBieUZpZWxkID0gYnlGaWVsZC5zdWJzdHIoMSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCEoYnlGaWVsZCBpbiBtZXRhLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFVua25vd24gb3JkZXJCeSBmaWVsZCBcIiR7YnlGaWVsZH1cIi5gKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIG9yZGVyQnlbYnlGaWVsZF0gPSBhc2NlbmQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVskb3JkZXJCeV07XG4gICAgICAgICAgICBpZiAoIW9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgT3JkZXIgYnkgXCIke29yZGVyQnl9XCIgaXMgbm90IHN1cHBvcnRlZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IG9yZGVyQnk7XG4gICAgfSBlbHNlIGlmIChhcGlJbmZvLm9yZGVyQnkgJiYgYXBpSW5mby5vcmRlckJ5WyckZGVmYXVsdCddKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVsnJGRlZmF1bHQnXTtcbiAgICB9XG5cbiAgICBpZiAoJG9mZnNldCkgeyAgICAgICAgXG4gICAgICAgIGNvbmRpdGlvbi4kb2Zmc2V0ID0gZW5zdXJlSW50KCckb2Zmc2V0JywgJG9mZnNldCk7XG4gICAgfVxuXG4gICAgaWYgKCRsaW1pdCkge1xuICAgICAgICBjb25kaXRpb24uJGxpbWl0ID0gZW5zdXJlSW50KCckbGltaXQnLCAkbGltaXQpO1xuICAgIH0gICAgXG5cbiAgICBpZiAoJHJldHVyblRvdGFsKSB7ICAgXG4gICAgICAgIGlmICgkcmV0dXJuVG90YWwgPT09ICcxJyB8fCAkcmV0dXJuVG90YWwgPT09ICd0cnVlJykge1xuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHsgICAgICAgIFxuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gJHJldHVyblRvdGFsO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIGlmICghXy5pc0VtcHR5KGFwaUluZm8ucXVlcnkpKSB7XG4gICAgICAgIF8uZm9yT3duKGFwaUluZm8ucXVlcnksIChpbmZvLCBwYXJhbSkgPT4ge1xuICAgICAgICAgICAgaWYgKHBhcmFtIGluIGN0eC5xdWVyeSkge1xuICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaChpbmZvLndoZXJlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChtZXRhKSB7XG4gICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnJCcpKSByZXR1cm47IFxuXG4gICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgIGxldCBhc3NvYyA9IGtleS5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwodmFsdWUpIHx8IHZhbHVlICE9PSAnMCcpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzb2NzLmFkZChhc3NvYyk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzc0tleVZhbHVlUGFpcihtZXRhLCBhc3NvY3MsIHF1ZXJpZXMsIGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBsZXQgbCA9IHF1ZXJpZXMubGVuZ3RoO1xuICAgIGlmIChsID4gMCkge1xuICAgICAgICBjb25kaXRpb24uJHF1ZXJ5ID0gbCA+IDEgPyB7ICRhbmQ6IHF1ZXJpZXMgfSA6IHF1ZXJpZXNbMF07XG4gICAgfVxuXG4gICAgaWYgKGFzc29jcy5zaXplID4gMCkge1xuICAgICAgICBjb25kaXRpb24uJGFzc29jaWF0aW9uID0gQXJyYXkuZnJvbShhc3NvY3MpO1xuICAgIH1cblxuICAgIHJldHVybiBjb25kaXRpb247XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAuZ2V0TWlkZGxld2FyZUZhY3RvcnkoJ2pzb25FcnJvcicpKCksICdqc29uRXJyb3InKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCBhcGlMaXN0RW5kcG9pbnQgPSBvcHRpb25zLmFwaUxpc3RFbmRwb2ludCB8fCAnL19saXN0JztcbiAgICBsZXQgbWV0YWRhdGFFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19pbmZvJztcbiAgICBsZXQgZGVzY0VuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2Rlc2MnO1xuXG4gICAgbGV0IGVudGl0eU1vZGVscyA9IG9wdGlvbnMuZW50aXR5TW9kZWxzO1xuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmVudGl0eU1vZGVscyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZW50aXR5TW9kZWxzID0gZnMucmVhZEpzb25TeW5jKGFwcC50b0Fic29sdXRlUGF0aChvcHRpb25zLmVudGl0eU1vZGVscykpOyBcbiAgICB9XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYXBpTGlzdEVuZHBvaW50LCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBsaXN0ID0gW107XG5cbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oZW50aXR5TW9kZWxzLCAoY29uZmlnLCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICAvL3RvZG86IGZpbHRlciBlbnRpdHkgb3IgbWV0aG9kcyBieSBjb25maWdcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lSW5VcmwgPSBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZE5hbWU7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gY29uZmlnLmtleSB8fCBkYi5tb2RlbChjb25maWcuc2VsZWN0RnJvbSkubWV0YS5rZXlGaWVsZDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGRiLm1vZGVsKGVudGl0eU5hbWUpLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9ICAgICAgICAgIFxuXG4gICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSAnOicgKyBrZXlGaWVsZE5hbWU7XG5cbiAgICAgICAgICAgIGxldCBzaW5nbGVVcmwgPSB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpO1xuICAgICAgICAgICAgbGV0IGJhdGNoVXJsID0gdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCk7XG4gICAgICAgICAgICBsZXQgZGVzY1VybCA9IGFwcC50b1dlYlBhdGgodXJsSm9pbihiYXNlUm91dGUsICdfZGVzYycsIF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpKSk7XG5cbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdsaXN0JywgbWV0aG9kOiAnZ2V0JywgdXJsOiBiYXRjaFVybCwgYXBpRGVzYzogZGVzY1VybCB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZXRhaWwnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHNpbmdsZVVybCB9KTtcblxuICAgICAgICAgICAgaWYgKCFjb25maWcucmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnY3JlYXRlJywgbWV0aG9kOiAncG9zdCcsIHVybDogYmF0Y2hVcmwgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ3VwZGF0ZScsIG1ldGhvZDogJ3B1dCcsIHVybDogc2luZ2xlVXJsIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZWxldGUnLCBtZXRob2Q6ICdkZWwnLCB1cmw6IHNpbmdsZVVybCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4oZGVzY0VuZHBvaW50LCAnOmVudGl0eScpLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBsaXN0OyAgICAgICAgXG5cbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGNvbmZpZyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgbGV0IEVudGl0eU1vZGVsO1xuXG4gICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBsaXN0ID0ge1xuICAgICAgICAgICAgICAgICd0eXBlJzogJ3ZpZXcnLFxuICAgICAgICAgICAgICAgICdtYWluRW50aXR5JzogY29uZmlnLnNlbGVjdEZyb20gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnLmpvaW5XaXRoKSB7XG4gICAgICAgICAgICAgICAgbGlzdC5hc3NvY2lhdGlvbnMgPSBjb25maWcuam9pbldpdGg7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcud2hlcmUpIHtcbiAgICAgICAgICAgICAgICBsaXN0LndoZXJlID0gY29uZmlnLndoZXJlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLmtleSkge1xuICAgICAgICAgICAgICAgIGxpc3Qua2V5ID0gY29uZmlnLmtleTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChjb25maWcuc2VsZWN0RnJvbSk7XG5cbiAgICAgICAgICAgIGlmIChjb25maWcucXVlcnkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnF1ZXJ5ID0gXy5tYXBWYWx1ZXMoY29uZmlnLnF1ZXJ5LCAoaW5mbykgPT4gaW5mby5kZXNjKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5vcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5vcmRlckJ5ID0gY29uZmlnLm9yZGVyQnk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsaXN0ID0ge1xuICAgICAgICAgICAgICAgICd0eXBlJzogJ2VudGl0eScsXG4gICAgICAgICAgICAgICAgJ2VudGl0eSc6IGVudGl0eU5hbWUgICAgXG4gICAgICAgICAgICB9OyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGlzdC5xdWVyeSA9IF8ubWFwVmFsdWVzKEVudGl0eU1vZGVsLm1ldGEuZmllbGRzLCAoaW5mbykgPT4gaW5mby5kaXNwbGF5TmFtZSk7XG4gICAgICAgIH0gICBcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBpZiAoYXBwLmVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihtZXRhZGF0YUVuZHBvaW50LCAnOmVudGl0eScpLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpID8gYXBpSW5mby5zZWxlY3RGcm9tIDogZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQgaW5mbyA9IEVudGl0eU1vZGVsLm1ldGE7XG5cbiAgICAgICAgICAgIGlmIChjdHgucXVlcnkuZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgaW5mbyA9IGdldFZhbHVlQnlQYXRoKGluZm8sIGN0eC5xdWVyeS5maWx0ZXIpO1xuICAgICAgICAgICAgICAgIGlmICghaW5mbykge1xuICAgICAgICAgICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBFbXB0eSBjb250ZW50LmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3R4LmJvZHkgPSBpbmZvO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICAvL2dldCBsaXN0ICAgIFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcXVlcnlPcHRpb25zLCBFbnRpdHlNb2RlbDtcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgIC4uLnByb2Nlc3NRdWVyeShjdHgsIGFwaUluZm8pLFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgIC4uLnByb2Nlc3NRdWVyeShjdHgsIGFwaUluZm8sIEVudGl0eU1vZGVsLm1ldGEpLFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0geyBcbiAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICB9O1xuXG4gICAgICAgIGN0eC5ib2R5ID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZEFsbF8ocXVlcnlPcHRpb25zKTtcbiAgICB9KTtcblxuICAgIC8vZ2V0IGRldGFpbFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsLCBxdWVyeU9wdGlvbnMsIGtleUZpZWxkO1xuICAgICAgICBsZXQga2V5VmFsdWUgPSBjdHgucGFyYW1zLmlkOyAgICAgICAgXG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBrZXlGaWVsZCA9IGFwaUluZm8ua2V5IHx8IEVudGl0eU1vZGVsLm1ldGEua2V5RmllbGQ7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtrZXlGaWVsZF06IGtleVZhbHVlLCAuLi5hcGlJbmZvLndoZXJlIH0sXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBrZXlGaWVsZCA9IEVudGl0eU1vZGVsLm1ldGEua2V5RmllbGQ7XG5cbiAgICAgICAgICAgIGxldCBhc3NvY3MgPSBbXTtcblxuICAgICAgICAgICAgXy5mb3JPd24oY3R4LnF1ZXJ5LCAodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnOicpICYmIChfLmlzTmlsKHZhbHVlKSB8fCB2YWx1ZSAhPT0gJzAnKSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NvY3MucHVzaChrZXkuc3Vic3RyKDEpKTtcbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtrZXlGaWVsZF06IGtleVZhbHVlIH0sIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGFzc29jcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLiRhc3NvY2lhdGlvbiA9IGFzc29jcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuTk9UX0ZPVU5ELCBgXCIke0VudGl0eU1vZGVsLm1ldGEubmFtZX1cIiB3aXRoIFske2tleUZpZWxkfT0ke2tleVZhbHVlfV0gbm90IGZvdW5kLmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcmV0cmlldmVDcmVhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgeyB3aGVyZSwgZGF0YSB9ID0gY3R4LnJlcXVlc3QuYm9keTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVPbmVfKGRhdGEsIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVPbmVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vZGVsZXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgZGVsZXRlZCA9IGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZU9uZV8oeyBcbiAgICAgICAgICAgICRxdWVyeTogd2hlcmUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0geyBzdGF0dXM6ICdPSycsIGRlbGV0ZWQgfTtcbiAgICB9KTsgICBcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19
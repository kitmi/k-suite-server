"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo, meta) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];
  let assocs = [];
  let {
    $orderBy,
    $offset,
    $limit,
    $returnTotal
  } = ctx.query;

  if ($orderBy) {
    let orderBy = apiInfo.orderBy[$orderBy];

    if (!orderBy) {
      throw new BadRequest(`Order by "${orderBy}" is not supported.`);
    }

    condition.$orderBy = orderBy;
  } else if (apiInfo.orderBy && apiInfo.orderBy['$default']) {
    condition.$orderBy = apiInfo.orderBy['$default'];
  }

  if ($offset) {
    condition.$offset = ensureInt('$offset', $offset);
  }

  if ($limit) {
    condition.$limit = ensureInt('$limit', $limit);
  }

  if ($returnTotal) {
    if ($returnTotal === '1' || $returnTotal === 'true') {
      condition.$totalCount = true;
    } else {
      condition.$totalCount = $returnTotal;
    }
  }

  if (!_.isEmpty(apiInfo.query)) {
    _.forOwn(apiInfo.query, (info, param) => {
      if (param in ctx.query) {
        queries.push(info.where);
      }
    });
  } else if (meta) {
    _.forOwn(ctx.query, (value, key) => {
      if (key.startsWith(':') && value) {
        assocs.push(key.substr(1));
      } else if (key in meta.fields) {
        queries.push({
          [key]: value
        });
      }
    });
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  if (assocs.length > 0) {
    condition.$association = assocs;
  }

  console.log(condition);
  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions, EntityModel;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo, EntityModel.meta),
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let {
      where,
      data
    } = ctx.request.body;
    let model = await EntityModel.update_(data, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwibWV0YSIsImNvbmRpdGlvbiIsInF1ZXJpZXMiLCJ3aGVyZSIsImFzc29jcyIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRyZXR1cm5Ub3RhbCIsInF1ZXJ5Iiwib3JkZXJCeSIsIiR0b3RhbENvdW50IiwiaXNFbXB0eSIsImZvck93biIsImluZm8iLCJwYXJhbSIsInB1c2giLCJrZXkiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiZmllbGRzIiwibCIsImxlbmd0aCIsIiRxdWVyeSIsIiRhbmQiLCIkYXNzb2NpYXRpb24iLCJjb25zb2xlIiwibG9nIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJzY2hlbWFOYW1lIiwiZW50aXR5TW9kZWxzIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsInJlc3RBcGlXcmFwcGVyIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImFwaUxpc3RFbmRwb2ludCIsIm1ldGFkYXRhRW5kcG9pbnQiLCJkZXNjRW5kcG9pbnQiLCJyZWFkSnNvblN5bmMiLCJ0b0Fic29sdXRlUGF0aCIsImFkZFJvdXRlIiwibGlzdCIsImRiIiwiYXBwTW9kdWxlIiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsImtleUZpZWxkTmFtZSIsInR5cGUiLCJtb2RlbCIsInNlbGVjdEZyb20iLCJrZXlGaWVsZCIsInNpbmdsZVVybCIsImJhdGNoVXJsIiwiZGVzY1VybCIsInRvV2ViUGF0aCIsIm1ldGhvZCIsInVybCIsImFwaURlc2MiLCJyZWFkT25seSIsImJvZHkiLCJjYW1lbENhc2UiLCJwYXJhbXMiLCJlbnRpdHkiLCJFbnRpdHlNb2RlbCIsImpvaW5XaXRoIiwiYXNzb2NpYXRpb25zIiwibWFwVmFsdWVzIiwiZGVzYyIsImRpc3BsYXlOYW1lIiwiZW52IiwiZmlsdGVyIiwidGhyb3ciLCJCQURfUkVRVUVTVCIsImV4cG9zZSIsInF1ZXJ5T3B0aW9ucyIsIiR1bmJveGluZyIsIiR2YXJpYWJsZXMiLCJzZXNzaW9uIiwic2Vzc2lvblZhcmlhYmxlcyIsImZpbmRBbGxfIiwiaWQiLCJmaW5kT25lXyIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsImRhdGEiLCJ1cGRhdGVfIiwiJHJldHJpZXZlVXBkYXRlZCIsImRlbGV0ZWQiLCJkZWxldGVfIiwic3RhdHVzIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLE9BQVQ7QUFBa0JDLEVBQUFBO0FBQWxCLElBQXFDQyxPQUFPLENBQUMsVUFBRCxDQUFsRDs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxZQUFELENBQXRCOztBQUNBLE1BQU1FLFFBQVEsR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBQXhCOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsb0JBQUY7QUFBd0JDLEVBQUFBLFVBQXhCO0FBQW9DQyxFQUFBQTtBQUFwQyxJQUF5REwsT0FBTyxDQUFDLFdBQUQsQ0FBdEU7O0FBQ0EsTUFBTU0sU0FBUyxHQUFHTixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFPQSxTQUFTTyxTQUFULENBQW1CQyxJQUFuQixFQUF5QkMsS0FBekIsRUFBZ0M7QUFDNUIs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QUFXO0FBQUUrQixNQUFBQSxNQUFNLEVBQUUsSUFBVjtBQUFnQkYsTUFBQUE7QUFBaEIsS0FBWDtBQUNILEdBMUJEO0FBNEJBbEUsRUFBQUEsR0FBRyxDQUFDcUUsU0FBSixDQUFjaEUsTUFBZDtBQUNILENBdFZEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgZnMsIHVybEpvaW4sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgna29hLXJvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCwgTWV0aG9kTm90QWxsb3dlZCB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3InKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG5mdW5jdGlvbiBlbnN1cmVJbnQobmFtZSwgdmFsdWUpIHtcbiAgICBsZXQgc2FuaXRpemVkID0gXy5pc0ludGVnZXIodmFsdWUpID8gdmFsdWUgOiB2YWxpZGF0b3IudG9JbnQodmFsdWUpO1xuICAgIGlmIChpc05hTihzYW5pdGl6ZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBcIiR7bmFtZX1cIiBzaG91bGQgYmUgYW4gaW50ZWdlci5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2FuaXRpemVkO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvLCBtZXRhKSB7ICAgIFxuICAgIGxldCBjb25kaXRpb24gPSB7fTtcbiAgICBsZXQgcXVlcmllcyA9IGFwaUluZm8ud2hlcmUgPyBbIGFwaUluZm8ud2hlcmUgXSA6IFtdO1xuICAgIGxldCBhc3NvY3MgPSBbXTtcblxuICAgIGxldCB7ICRvcmRlckJ5LCAkb2Zmc2V0LCAkbGltaXQsICRyZXR1cm5Ub3RhbCB9ID0gY3R4LnF1ZXJ5O1xuICAgICAgICBcbiAgICBpZiAoJG9yZGVyQnkpIHtcbiAgICAgICAgbGV0IG9yZGVyQnkgPSBhcGlJbmZvLm9yZGVyQnlbJG9yZGVyQnldO1xuICAgICAgICBpZiAoIW9yZGVyQnkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBPcmRlciBieSBcIiR7b3JkZXJCeX1cIiBpcyBub3Qgc3VwcG9ydGVkLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uZGl0aW9uLiRvcmRlckJ5ID0gb3JkZXJCeTtcbiAgICB9IGVsc2UgaWYgKGFwaUluZm8ub3JkZXJCeSAmJiBhcGlJbmZvLm9yZGVyQnlbJyRkZWZhdWx0J10pIHtcbiAgICAgICAgY29uZGl0aW9uLiRvcmRlckJ5ID0gYXBpSW5mby5vcmRlckJ5WyckZGVmYXVsdCddO1xuICAgIH1cblxuICAgIGlmICgkb2Zmc2V0KSB7ICAgICAgICBcbiAgICAgICAgY29uZGl0aW9uLiRvZmZzZXQgPSBlbnN1cmVJbnQoJyRvZmZzZXQnLCAkb2Zmc2V0KTtcbiAgICB9XG5cbiAgICBpZiAoJGxpbWl0KSB7XG4gICAgICAgIGNvbmRpdGlvbi4kbGltaXQgPSBlbnN1cmVJbnQoJyRsaW1pdCcsICRsaW1pdCk7XG4gICAgfSAgICBcblxuICAgIGlmICgkcmV0dXJuVG90YWwpIHsgICBcbiAgICAgICAgaWYgKCRyZXR1cm5Ub3RhbCA9PT0gJzEnIHx8ICRyZXR1cm5Ub3RhbCA9PT0gJ3RydWUnKSB7XG4gICAgICAgICAgICBjb25kaXRpb24uJHRvdGFsQ291bnQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgeyAgICAgICAgXG4gICAgICAgICAgICBjb25kaXRpb24uJHRvdGFsQ291bnQgPSAkcmV0dXJuVG90YWw7XG4gICAgICAgIH1cbiAgICB9ICAgIFxuXG4gICAgaWYgKCFfLmlzRW1wdHkoYXBpSW5mby5xdWVyeSkpIHtcbiAgICAgICAgXy5mb3JPd24oYXBpSW5mby5xdWVyeSwgKGluZm8sIHBhcmFtKSA9PiB7XG4gICAgICAgICAgICBpZiAocGFyYW0gaW4gY3R4LnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgcXVlcmllcy5wdXNoKGluZm8ud2hlcmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKG1ldGEpIHtcbiAgICAgICAgXy5mb3JPd24oY3R4LnF1ZXJ5LCAodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCc6JykgJiYgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3MucHVzaChrZXkuc3Vic3RyKDEpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5IGluIG1ldGEuZmllbGRzKSB7XG4gICAgICAgICAgICAgICAgcXVlcmllcy5wdXNoKHsgW2tleV06IHZhbHVlIH0pO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgbGV0IGwgPSBxdWVyaWVzLmxlbmd0aDtcbiAgICBpZiAobCA+IDApIHtcbiAgICAgICAgY29uZGl0aW9uLiRxdWVyeSA9IGwgPiAxID8geyAkYW5kOiBxdWVyaWVzIH0gOiBxdWVyaWVzWzBdO1xuICAgIH1cblxuICAgIGlmIChhc3NvY3MubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25kaXRpb24uJGFzc29jaWF0aW9uID0gYXNzb2NzO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGNvbmRpdGlvbik7XG5cbiAgICByZXR1cm4gY29uZGl0aW9uO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2F0ZXdheTogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnLFxuICogICAgICAgICAgbWV0YWRhdGFFbmRwb2ludDogJy9fbWV0YSdcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBxdWVyeVxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZGV0YWlsXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICByZW1vdmUgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgaWYgKCFvcHRpb25zLnNjaGVtYU5hbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgc2NoZW1hIG5hbWUgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5lbnRpdHlNb2RlbHNgXG4gICAgICAgICk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLnJlc3RBcGlXcmFwcGVyKCksICdyZXN0QXBpV3JhcHBlcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IGFwaUxpc3RFbmRwb2ludCA9IG9wdGlvbnMuYXBpTGlzdEVuZHBvaW50IHx8ICcvX2xpc3QnO1xuICAgIGxldCBtZXRhZGF0YUVuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2luZm8nO1xuICAgIGxldCBkZXNjRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9fZGVzYyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihlbnRpdHlNb2RlbHMsIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkTmFtZTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBjb25maWcua2V5IHx8IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKS5tZXRhLmtleUZpZWxkOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gZGIubW9kZWwoZW50aXR5TmFtZSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gICAgICAgICAgXG5cbiAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9ICc6JyArIGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgbGV0IHNpbmdsZVVybCA9IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSk7XG4gICAgICAgICAgICBsZXQgYmF0Y2hVcmwgPSB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKTtcbiAgICAgICAgICAgIGxldCBkZXNjVXJsID0gYXBwLnRvV2ViUGF0aCh1cmxKb2luKGJhc2VSb3V0ZSwgJ19kZXNjJywgXy5rZWJhYkNhc2UoZW50aXR5TmFtZSkpKTtcblxuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2xpc3QnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IGJhdGNoVXJsLCBhcGlEZXNjOiBkZXNjVXJsIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RldGFpbCcsIG1ldGhvZDogJ2dldCcsIHVybDogc2luZ2xlVXJsIH0pO1xuXG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5yZWFkT25seSkge1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdjcmVhdGUnLCBtZXRob2Q6ICdwb3N0JywgdXJsOiBiYXRjaFVybCB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiBzaW5nbGVVcmwgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RlbGV0ZScsIG1ldGhvZDogJ2RlbCcsIHVybDogc2luZ2xlVXJsIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihkZXNjRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3Q7ICAgICAgICBcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgY29uZmlnID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWw7XG5cbiAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGxpc3QgPSB7XG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAndmlldycsXG4gICAgICAgICAgICAgICAgJ21haW5FbnRpdHknOiBjb25maWcuc2VsZWN0RnJvbSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChjb25maWcuam9pbldpdGgpIHtcbiAgICAgICAgICAgICAgICBsaXN0LmFzc29jaWF0aW9ucyA9IGNvbmZpZy5qb2luV2l0aDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy53aGVyZSkge1xuICAgICAgICAgICAgICAgIGxpc3Qud2hlcmUgPSBjb25maWcud2hlcmU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcua2V5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5rZXkgPSBjb25maWcua2V5O1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5xdWVyeSkge1xuICAgICAgICAgICAgICAgIGxpc3QucXVlcnkgPSBfLm1hcFZhbHVlcyhjb25maWcucXVlcnksIChpbmZvKSA9PiBpbmZvLmRlc2MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLm9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICBsaXN0Lm9yZGVyQnkgPSBjb25maWcub3JkZXJCeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxpc3QgPSB7XG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAnZW50aXR5JyxcbiAgICAgICAgICAgICAgICAnZW50aXR5JzogZW50aXR5TmFtZSAgICBcbiAgICAgICAgICAgIH07ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsaXN0LnF1ZXJ5ID0gXy5tYXBWYWx1ZXMoRW50aXR5TW9kZWwubWV0YS5maWVsZHMsIChpbmZvKSA9PiBpbmZvLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfSAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3JykgPyBhcGlJbmZvLnNlbGVjdEZyb20gOiBlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMsIEVudGl0eU1vZGVsO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ucHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbyksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ucHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbywgRW50aXR5TW9kZWwubWV0YSksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kQWxsXyhxdWVyeU9wdGlvbnMpO1xuICAgIH0pO1xuXG4gICAgLy9nZXQgZGV0YWlsXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwsIHF1ZXJ5T3B0aW9ucztcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZCA9IGFwaUluZm8ua2V5IHx8IEVudGl0eU1vZGVsLm1ldGEua2V5RmllbGRcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW2tleUZpZWxkXTogY3R4LnBhcmFtcy5pZCwgLi4uYXBpSW5mby53aGVyZSB9LFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH0sIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBJbnZhbGlkIFwiJHtjdHgucGFyYW1zLmVudGl0eX1cIiBpZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IHsgXG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHsgd2hlcmUsIGRhdGEgfSA9IGN0eC5yZXF1ZXN0LmJvZHk7XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhkYXRhLCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2RlbGV0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IGRlbGV0ZWQgPSBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVfKHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snLCBkZWxldGVkIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
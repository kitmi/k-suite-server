"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];

  if (ctx.query) {
    let {
      $orderBy,
      $offset,
      $limit,
      $returnTotal
    } = ctx.query;

    if ($orderBy) {
      let orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }

      condition.$orderBy = orderBy;
    }

    if ($offset) {
      condition.$offset = ensureInt('$offset', $offset);
    }

    if ($limit) {
      condition.$limit = ensureInt('$limit', $limit);
    }

    if ($returnTotal) {
      if ($returnTotal === '1' || $returnTotal === 'true') {
        condition.$totalCount = true;
      } else {
        condition.$totalCount = $returnTotal;
      }
    }

    if (!_.isEmpty(apiInfo.query)) {
      _.forOwn(apiInfo.query, (info, param) => {
        if (param in ctx.query) {
          queries.push(info.where);
        }
      });
    }
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: urlJoin(baseRoute, entityNameInUrl)
        });
        list.push({
          type: 'update',
          method: 'put',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
      }
    });

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwiY29uZGl0aW9uIiwicXVlcmllcyIsIndoZXJlIiwicXVlcnkiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcmV0dXJuVG90YWwiLCJvcmRlckJ5IiwiJHRvdGFsQ291bnQiLCJpc0VtcHR5IiwiZm9yT3duIiwiaW5mbyIsInBhcmFtIiwicHVzaCIsImwiLCJsZW5ndGgiLCIkcXVlcnkiLCIkYW5kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJzY2hlbWFOYW1lIiwiZW50aXR5TW9kZWxzIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsInJlc3RBcGlXcmFwcGVyIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImFwaUxpc3RFbmRwb2ludCIsIm1ldGFkYXRhRW5kcG9pbnQiLCJyZWFkSnNvblN5bmMiLCJ0b0Fic29sdXRlUGF0aCIsImFkZFJvdXRlIiwibGlzdCIsImRiIiwiYXBwTW9kdWxlIiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsImtleUZpZWxkTmFtZSIsInR5cGUiLCJrZXkiLCJtb2RlbCIsInNlbGVjdEZyb20iLCJtZXRhIiwia2V5RmllbGQiLCJtZXRob2QiLCJ1cmwiLCJyZWFkT25seSIsImJvZHkiLCJlbnYiLCJjYW1lbENhc2UiLCJwYXJhbXMiLCJlbnRpdHkiLCJFbnRpdHlNb2RlbCIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJxdWVyeU9wdGlvbnMiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCJqb2luV2l0aCIsIiR2YXJpYWJsZXMiLCJzZXNzaW9uIiwic2Vzc2lvblZhcmlhYmxlcyIsImZpbmRBbGxfIiwiaWQiLCJmaW5kT25lXyIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsInVwZGF0ZV8iLCIkcmV0cmlldmVVcGRhdGVkIiwiZGVsZXRlZCIsImRlbGV0ZV8iLCJzdGF0dXMiLCJhZGRSb3V0ZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsT0FBVDtBQUFrQkMsRUFBQUE7QUFBbEIsSUFBcUNDLE9BQU8sQ0FBQyxVQUFELENBQWxEOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBdEI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FBeEI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxvQkFBRjtBQUF3QkMsRUFBQUEsVUFBeEI7QUFBb0NDLEVBQUFBO0FBQXBDLElBQXlETCxPQUFPLENBQUMsV0FBRCxDQUF0RTs7QUFDQSxNQUFNTSxTQUFTLEdBQUdOLE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQU9BLFNBQVNPLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCQyxLQUF6QixFQUFnQztBQUM1QixNQUFJQyxTQUFTLEdBQUdkLENBQUMsQ0FBQ2UsU0FBRixDQUFZRixLQUFaLElBQXFCQSxLQUFyQixHQUE2QkgsU0FBUyxDQUFDTSxLQUFWLENBQWdCSCxLQUFoQixDQUE3Qzs7QUFDQSxNQUFJSSxLQUFLLENBQUNILFNBQUQsQ0FBVCxFQUFzQjtBQUNsQixVQUFNLElBQUlOLFVBQUosQ0FBZ0IsSUFBR0ksSUFBSyx5QkFB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QUFHLENBQUN3RSxnQkFETDtBQUVSbkUsUUFBQUEsS0FBSyxFQUFFTCxHQUFHLENBQUNLO0FBRkg7QUFGd0IsS0FBcEIsQ0FBcEI7QUFRQUwsSUFBQUEsR0FBRyxDQUFDd0QsSUFBSixHQUFXO0FBQUUyQixNQUFBQSxNQUFNLEVBQUUsSUFBVjtBQUFnQkYsTUFBQUE7QUFBaEIsS0FBWDtBQUNILEdBMUJEO0FBNEJBMUQsRUFBQUEsR0FBRyxDQUFDNkQsU0FBSixDQUFjeEQsTUFBZDtBQUNILENBalFEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgZnMsIHVybEpvaW4sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgna29hLXJvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCwgTWV0aG9kTm90QWxsb3dlZCB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCd2YWxpZGF0b3InKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG5mdW5jdGlvbiBlbnN1cmVJbnQobmFtZSwgdmFsdWUpIHtcbiAgICBsZXQgc2FuaXRpemVkID0gXy5pc0ludGVnZXIodmFsdWUpID8gdmFsdWUgOiB2YWxpZGF0b3IudG9JbnQodmFsdWUpO1xuICAgIGlmIChpc05hTihzYW5pdGl6ZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBcIiR7bmFtZX1cIiBzaG91bGQgYmUgYW4gaW50ZWdlci5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2FuaXRpemVkO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzUXVlcnkoY3R4LCBhcGlJbmZvKSB7ICAgIFxuICAgIGxldCBjb25kaXRpb24gPSB7fTtcbiAgICBsZXQgcXVlcmllcyA9IGFwaUluZm8ud2hlcmUgPyBbIGFwaUluZm8ud2hlcmUgXSA6IFtdO1xuXG4gICAgaWYgKGN0eC5xdWVyeSkge1xuICAgICAgICBsZXQgeyAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcmV0dXJuVG90YWwgfSA9IGN0eC5xdWVyeTtcblxuICAgICAgICBpZiAoJG9yZGVyQnkpIHtcbiAgICAgICAgICAgIGxldCBvcmRlckJ5ID0gYXBpSW5mby5vcmRlckJ5WyRvcmRlckJ5XTtcbiAgICAgICAgICAgIGlmICghb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KGBPcmRlciBieSBcIiR7b3JkZXJCeX1cIiBpcyBub3Qgc3VwcG9ydGVkLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25kaXRpb24uJG9yZGVyQnkgPSBvcmRlckJ5O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCRvZmZzZXQpIHsgICAgICAgIFxuICAgICAgICAgICAgY29uZGl0aW9uLiRvZmZzZXQgPSBlbnN1cmVJbnQoJyRvZmZzZXQnLCAkb2Zmc2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgkbGltaXQpIHtcbiAgICAgICAgICAgIGNvbmRpdGlvbi4kbGltaXQgPSBlbnN1cmVJbnQoJyRsaW1pdCcsICRsaW1pdCk7XG4gICAgICAgIH0gICAgXG5cbiAgICAgICAgaWYgKCRyZXR1cm5Ub3RhbCkgeyAgIFxuICAgICAgICAgICAgaWYgKCRyZXR1cm5Ub3RhbCA9PT0gJzEnIHx8ICRyZXR1cm5Ub3RhbCA9PT0gJ3RydWUnKSB7XG4gICAgICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7ICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25kaXRpb24uJHRvdGFsQ291bnQgPSAkcmV0dXJuVG90YWw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gICAgXG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoYXBpSW5mby5xdWVyeSkpIHtcbiAgICAgICAgICAgIF8uZm9yT3duKGFwaUluZm8ucXVlcnksIChpbmZvLCBwYXJhbSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwYXJhbSBpbiBjdHgucXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcmllcy5wdXNoKGluZm8ud2hlcmUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9ICAgIFxuICAgIH1cblxuICAgIGxldCBsID0gcXVlcmllcy5sZW5ndGg7XG4gICAgaWYgKGwgPiAwKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kcXVlcnkgPSBsID4gMSA/IHsgJGFuZDogcXVlcmllcyB9IDogcXVlcmllc1swXTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZGl0aW9uO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2F0ZXdheTogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnLFxuICogICAgICAgICAgbWV0YWRhdGFFbmRwb2ludDogJy9fbWV0YSdcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBxdWVyeVxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZGV0YWlsXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICByZW1vdmUgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgaWYgKCFvcHRpb25zLnNjaGVtYU5hbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgc2NoZW1hIG5hbWUgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5lbnRpdHlNb2RlbHNgXG4gICAgICAgICk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLnJlc3RBcGlXcmFwcGVyKCksICdyZXN0QXBpV3JhcHBlcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IGFwaUxpc3RFbmRwb2ludCA9IG9wdGlvbnMuYXBpTGlzdEVuZHBvaW50IHx8ICcvX2xpc3QnO1xuICAgIGxldCBtZXRhZGF0YUVuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2luZm8nO1xuXG4gICAgbGV0IGVudGl0eU1vZGVscyA9IG9wdGlvbnMuZW50aXR5TW9kZWxzO1xuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmVudGl0eU1vZGVscyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZW50aXR5TW9kZWxzID0gZnMucmVhZEpzb25TeW5jKGFwcC50b0Fic29sdXRlUGF0aChvcHRpb25zLmVudGl0eU1vZGVscykpOyBcbiAgICB9XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYXBpTGlzdEVuZHBvaW50LCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBsaXN0ID0gW107XG5cbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oZW50aXR5TW9kZWxzLCAoY29uZmlnLCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICAvL3RvZG86IGZpbHRlciBlbnRpdHkgb3IgbWV0aG9kcyBieSBjb25maWdcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lSW5VcmwgPSBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZE5hbWU7XG5cbiAgICAgICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gY29uZmlnLmtleSB8fCBkYi5tb2RlbChjb25maWcuc2VsZWN0RnJvbSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gZGIubW9kZWwoZW50aXR5TmFtZSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gICAgICAgICAgXG5cbiAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9ICc6JyArIGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2xpc3QnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RldGFpbCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKSB9KTtcblxuICAgICAgICAgICAgaWYgKCFjb25maWcucmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnY3JlYXRlJywgbWV0aG9kOiAncG9zdCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ3VwZGF0ZScsIG1ldGhvZDogJ3B1dCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKSB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGVsZXRlJywgbWV0aG9kOiAnZGVsJywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBpZiAoYXBwLmVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihtZXRhZGF0YUVuZHBvaW50LCAnOmVudGl0eScpLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpID8gYXBpSW5mby5zZWxlY3RGcm9tIDogZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQgaW5mbyA9IEVudGl0eU1vZGVsLm1ldGE7XG5cbiAgICAgICAgICAgIGlmIChjdHgucXVlcnkuZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgaW5mbyA9IGdldFZhbHVlQnlQYXRoKGluZm8sIGN0eC5xdWVyeS5maWx0ZXIpO1xuICAgICAgICAgICAgICAgIGlmICghaW5mbykge1xuICAgICAgICAgICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBFbXB0eSBjb250ZW50LmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3R4LmJvZHkgPSBpbmZvO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICAvL2dldCBsaXN0ICAgIFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcXVlcnlPcHRpb25zO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ucHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbyksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4uY3R4LnF1ZXJ5LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBxdWVyeU9wdGlvbnMuJHZhcmlhYmxlcyA9IHsgXG4gICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgfTtcblxuICAgICAgICBjdHguYm9keSA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRBbGxfKHF1ZXJ5T3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICAvL2dldCBkZXRhaWxcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCwgcXVlcnlPcHRpb25zO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkID0gYXBpSW5mby5rZXkgfHwgRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZFxuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBjdHgucGFyYW1zLmlkLCAuLi5hcGlJbmZvLndoZXJlIH0sXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfSwgXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBxdWVyeU9wdGlvbnMuJHZhcmlhYmxlcyA9IHsgXG4gICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kT25lXyhxdWVyeU9wdGlvbnMpOyAgICAgICAgXG4gICAgICAgIGlmICghbW9kZWwpIHtcbiAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEludmFsaWQgXCIke2N0eC5wYXJhbXMuZW50aXR5fVwiIGlkLmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcmV0cmlldmVDcmVhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vZGVsZXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgZGVsZXRlZCA9IGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZV8oeyBcbiAgICAgICAgICAgICRxdWVyeTogd2hlcmUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiB7IFxuICAgICAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBjdHgucXVlcnlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0geyBzdGF0dXM6ICdPSycsIGRlbGV0ZWQgfTtcbiAgICB9KTsgICBcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19
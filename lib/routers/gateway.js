"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];

  if (ctx.query) {
    let {
      $orderBy,
      $offset,
      $limit,
      $returnTotal
    } = ctx.query;

    if ($orderBy) {
      let orderBy = apiInfo.orderBy[$orderBy];

      if (!orderBy) {
        throw new BadRequest(`Order by "${orderBy}" is not supported.`);
      }

      condition.$orderBy = orderBy;
    }

    if ($offset) {
      condition.$offset = ensureInt('$offset', $offset);
    }

    if ($limit) {
      condition.$limit = ensureInt('$limit', $limit);
    }

    if ($returnTotal) {
      condition.$totalCount = true;
    }

    if (!_.isEmpty(apiInfo.query)) {
      _.forOwn(apiInfo.query, (info, param) => {
        if (param in ctx.query) {
          queries.push(info);
        }
      });
    }
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: urlJoin(baseRoute, entityNameInUrl)
        });
        list.push({
          type: 'update',
          method: 'put',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
      }
    });

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwiY29uZGl0aW9uIiwicXVlcmllcyIsIndoZXJlIiwicXVlcnkiLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcmV0dXJuVG90YWwiLCJvcmRlckJ5IiwiJHRvdGFsQ291bnQiLCJpc0VtcHR5IiwiZm9yT3duIiwiaW5mbyIsInBhcmFtIiwicHVzaCIsImwiLCJsZW5ndGgiLCIkcXVlcnkiLCIkYW5kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJzY2hlbWFOYW1lIiwiZW50aXR5TW9kZWxzIiwicm91dGVyIiwicHJlZml4IiwidXNlTWlkZGxld2FyZSIsInJlc3RBcGlXcmFwcGVyIiwibWlkZGxld2FyZXMiLCJ1c2VNaWRkbGV3YXJlcyIsImFwaUxpc3RFbmRwb2ludCIsIm1ldGFkYXRhRW5kcG9pbnQiLCJyZWFkSnNvblN5bmMiLCJ0b0Fic29sdXRlUGF0aCIsImFkZFJvdXRlIiwibGlzdCIsImRiIiwiYXBwTW9kdWxlIiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsImtleUZpZWxkTmFtZSIsInR5cGUiLCJrZXkiLCJtb2RlbCIsInNlbGVjdEZyb20iLCJtZXRhIiwia2V5RmllbGQiLCJtZXRob2QiLCJ1cmwiLCJyZWFkT25seSIsImJvZHkiLCJlbnYiLCJjYW1lbENhc2UiLCJwYXJhbXMiLCJlbnRpdHkiLCJFbnRpdHlNb2RlbCIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJxdWVyeU9wdGlvbnMiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCJqb2luV2l0aCIsIiR2YXJpYWJsZXMiLCJzZXNzaW9uIiwic2Vzc2lvblZhcmlhYmxlcyIsImZpbmRBbGxfIiwiaWQiLCJmaW5kT25lXyIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsInVwZGF0ZV8iLCIkcmV0cmlldmVVcGRhdGVkIiwiZGVsZXRlZCIsImRlbGV0ZV8iLCJzdGF0dXMiLCJhZGRSb3V0ZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsT0FBVDtBQUFrQkMsRUFBQUE7QUFBbEIsSUFBcUNDLE9BQU8sQ0FBQyxVQUFELENBQWxEOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBdEI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FBeEI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxvQkFBRjtBQUF3QkMsRUFBQUEsVUFBeEI7QUFBb0NDLEVBQUFBO0FBQXBDLElBQXlETCxPQUFPLENBQUMsV0FBRCxDQUF0RTs7QUFDQSxNQUFNTSxTQUFTLEdBQUdOLE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQU9BLFNBQVNPLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCQyxLQUF6QixFQUFnQztBQUM1QixNQUFJQyxTQUFTLEdBQUdkLENBQUMsQ0FBQ2UsU0FBRixDQUFZRixLQUFaLElBQXFCQSxLQUFyQixHQUE2QkgsU0FBUyxDQUFDTSxLQUFWLENBQWdCSCxLQUFoQixDQUE3Qzs7QUFDQSxNQUFJSSxLQUFLLENBQUNILFNBQUQsQ0FBVCxFQUFzQjtBQUNsQixVQUFNLElBQUlOLFVBQUosQ0FBZ0IsSUFBR0ksSUFBSyx5QkFB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RSxJQUFWO0FBQWdCRixNQUFBQTtBQUFoQixLQUFYO0FBQ0gsR0ExQkQ7QUE0QkExRCxFQUFBQSxHQUFHLENBQUM2RCxTQUFKLENBQWN4RCxNQUFkO0FBQ0gsQ0FqUUQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfLCBmcywgdXJsSm9pbiwgZ2V0VmFsdWVCeVBhdGggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdrb2Etcm91dGVyJyk7XG5jb25zdCBIdHRwQ29kZSA9IHJlcXVpcmUoJ2h0dHAtc3RhdHVzLWNvZGVzJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uLCBCYWRSZXF1ZXN0LCBNZXRob2ROb3RBbGxvd2VkIH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcbmNvbnN0IHZhbGlkYXRvciA9IHJlcXVpcmUoJ3ZhbGlkYXRvcicpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbmZ1bmN0aW9uIGVuc3VyZUludChuYW1lLCB2YWx1ZSkge1xuICAgIGxldCBzYW5pdGl6ZWQgPSBfLmlzSW50ZWdlcih2YWx1ZSkgPyB2YWx1ZSA6IHZhbGlkYXRvci50b0ludCh2YWx1ZSk7XG4gICAgaWYgKGlzTmFOKHNhbml0aXplZCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFwiJHtuYW1lfVwiIHNob3VsZCBiZSBhbiBpbnRlZ2VyLmApO1xuICAgIH1cblxuICAgIHJldHVybiBzYW5pdGl6ZWQ7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NRdWVyeShjdHgsIGFwaUluZm8pIHsgICAgXG4gICAgbGV0IGNvbmRpdGlvbiA9IHt9O1xuICAgIGxldCBxdWVyaWVzID0gYXBpSW5mby53aGVyZSA/IFsgYXBpSW5mby53aGVyZSBdIDogW107XG5cbiAgICBpZiAoY3R4LnF1ZXJ5KSB7XG4gICAgICAgIGxldCB7ICRvcmRlckJ5LCAkb2Zmc2V0LCAkbGltaXQsICRyZXR1cm5Ub3RhbCB9ID0gY3R4LnF1ZXJ5O1xuXG4gICAgICAgIGlmICgkb3JkZXJCeSkge1xuICAgICAgICAgICAgbGV0IG9yZGVyQnkgPSBhcGlJbmZvLm9yZGVyQnlbJG9yZGVyQnldO1xuICAgICAgICAgICAgaWYgKCFvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYE9yZGVyIGJ5IFwiJHtvcmRlckJ5fVwiIGlzIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IG9yZGVyQnk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoJG9mZnNldCkgeyAgICAgICAgXG4gICAgICAgICAgICBjb25kaXRpb24uJG9mZnNldCA9IGVuc3VyZUludCgnJG9mZnNldCcsICRvZmZzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgY29uZGl0aW9uLiRsaW1pdCA9IGVuc3VyZUludCgnJGxpbWl0JywgJGxpbWl0KTtcbiAgICAgICAgfSAgICBcblxuICAgICAgICBpZiAoJHJldHVyblRvdGFsKSB7XG4gICAgICAgICAgICBjb25kaXRpb24uJHRvdGFsQ291bnQgPSB0cnVlO1xuICAgICAgICB9ICAgIFxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGFwaUluZm8ucXVlcnkpKSB7XG4gICAgICAgICAgICBfLmZvck93bihhcGlJbmZvLnF1ZXJ5LCAoaW5mbywgcGFyYW0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW0gaW4gY3R4LnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaChpbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSAgICBcbiAgICB9XG5cbiAgICBsZXQgbCA9IHF1ZXJpZXMubGVuZ3RoO1xuICAgIGlmIChsID4gMCkge1xuICAgICAgICBjb25kaXRpb24uJHF1ZXJ5ID0gbCA+IDEgPyB7ICRhbmQ6IHF1ZXJpZXMgfSA6IHF1ZXJpZXNbMF07XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmRpdGlvbjtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIGdhdGV3YXk6IHsgICAgICAgICAgXG4gKiAgICAgICAgICBtaWRkbGV3YXJlczoge30sXG4gKiAgICAgICAgICBzY2hlbWFOYW1lOiAnJyxcbiAqICAgICAgICAgIGVudGl0eU1vZGVsczoge318PGNvbmZpZyBwYXRoPiwgIFxuICogICAgICAgICAgYXBpTGlzdEVuZHBvaW50OiAnL19saXN0JyxcbiAqICAgICAgICAgIG1ldGFkYXRhRW5kcG9pbnQ6ICcvX21ldGEnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuc2NoZW1hTmFtZWBcbiAgICAgICAgKTtcbiAgICB9ICAgIFxuXG4gICAgaWYgKCFvcHRpb25zLmVudGl0eU1vZGVscykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBlbnRpdHkgbW9kZWxzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuZW50aXR5TW9kZWxzYFxuICAgICAgICApOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5yZXN0QXBpV3JhcHBlcigpLCAncmVzdEFwaVdyYXBwZXInKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCBhcGlMaXN0RW5kcG9pbnQgPSBvcHRpb25zLmFwaUxpc3RFbmRwb2ludCB8fCAnL19saXN0JztcbiAgICBsZXQgbWV0YWRhdGFFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19pbmZvJztcblxuICAgIGxldCBlbnRpdHlNb2RlbHMgPSBvcHRpb25zLmVudGl0eU1vZGVscztcblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbnRpdHlNb2RlbHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGVudGl0eU1vZGVscyA9IGZzLnJlYWRKc29uU3luYyhhcHAudG9BYnNvbHV0ZVBhdGgob3B0aW9ucy5lbnRpdHlNb2RlbHMpKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuXG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGVudGl0eU1vZGVscywgKGNvbmZpZywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgLy90b2RvOiBmaWx0ZXIgZW50aXR5IG9yIG1ldGhvZHMgYnkgY29uZmlnXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZUluVXJsID0gXy5rZWJhYkNhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQga2V5RmllbGROYW1lO1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGNvbmZpZy5rZXkgfHwgZGIubW9kZWwoY29uZmlnLnNlbGVjdEZyb20pLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGRiLm1vZGVsKGVudGl0eU5hbWUpLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9ICAgICAgICAgIFxuXG4gICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSAnOicgKyBrZXlGaWVsZE5hbWU7XG5cbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdsaXN0JywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKSB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZXRhaWwnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSkgfSk7XG5cbiAgICAgICAgICAgIGlmICghY29uZmlnLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2NyZWF0ZScsIG1ldGhvZDogJ3Bvc3QnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICd1cGRhdGUnLCBtZXRob2Q6ICdwdXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSkgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RlbGV0ZScsIG1ldGhvZDogJ2RlbCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgaWYgKGFwcC5lbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4obWV0YWRhdGFFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbCgoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSA/IGFwaUluZm8uc2VsZWN0RnJvbSA6IGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGluZm8gPSBFbnRpdHlNb2RlbC5tZXRhO1xuXG4gICAgICAgICAgICBpZiAoY3R4LnF1ZXJ5LmZpbHRlcikge1xuICAgICAgICAgICAgICAgIGluZm8gPSBnZXRWYWx1ZUJ5UGF0aChpbmZvLCBjdHgucXVlcnkuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgRW1wdHkgY29udGVudC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gaW5mbztcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgLy9nZXQgbGlzdCAgICBcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucztcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgIC4uLnByb2Nlc3NRdWVyeShjdHgsIGFwaUluZm8pLFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgIC4uLmN0eC5xdWVyeSwgXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kQWxsXyhxdWVyeU9wdGlvbnMpO1xuICAgIH0pO1xuXG4gICAgLy9nZXQgZGV0YWlsXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwsIHF1ZXJ5T3B0aW9ucztcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZCA9IGFwaUluZm8ua2V5IHx8IEVudGl0eU1vZGVsLm1ldGEua2V5RmllbGRcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW2tleUZpZWxkXTogY3R4LnBhcmFtcy5pZCwgLi4uYXBpSW5mby53aGVyZSB9LFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH0sIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBJbnZhbGlkIFwiJHtjdHgucGFyYW1zLmVudGl0eX1cIiBpZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IHsgXG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2RlbGV0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IGRlbGV0ZWQgPSBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVfKHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snLCBkZWxldGVkIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest
} = require('../Errors');

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    await eachAsync_(entityModels, async (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'create',
        method: 'post',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'update',
        method: 'put',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'delete',
        method: 'del',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
    });
    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      if (!(entityName in entityModels)) {
        throw new BadRequest('Invalid entity endpoint.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  function extractQueryOptionFromBody(body) {
    return _.mapKeys(_.pick(body, ['association', 'projection', 'groupBy', 'orderBy', 'offset', 'limit']), (v, k) => '$' + k);
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let queryOptions = {
      $query: ctx.query,
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let queryOptions = {
      $query: {
        [EntityModel.meta.keyField]: ctx.params.id
      },
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImN0eCIsImxpc3QiLCJjb25maWciLCJlbnRpdHlOYW1lIiwiZW50aXR5TmFtZUluVXJsIiwia2ViYWJDYXNlIiwicHVzaCIsInR5cGUiLCJtZXRob2QiLCJ1cmwiLCJib2R5IiwiZW52IiwiY2FtZWxDYXNlIiwicGFyYW1zIiwiZW50aXR5IiwiZGIiLCJhcHBNb2R1bGUiLCJFbnRpdHlNb2RlbCIsIm1vZGVsIiwiaW5mbyIsIm1ldGEiLCJxdWVyeSIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJleHRyYWN0UXVlcnlPcHRpb25Gcm9tQm9keSIsIm1hcEtleXMiLCJwaWNrIiwidiIsImsiLCJxdWVyeU9wdGlvbnMiLCIkcXVlcnkiLCIkdW5ib3hpbmciLCJyZXF1ZXN0IiwiZmluZEFsbF8iLCJrZXlGaWVsZCIsImlkIiwiZmluZE9uZV8iLCJjcmVhdGVfIiwiJHJldHJpZXZlQ3JlYXRlZCIsIndoZXJlIiwidXBkYXRlXyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJkZWxldGVfIiwic3RhdHVzIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdz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NEMsTUFBT1csR0FBUCxJQUFlO0FBQ3ZELFFBQUllLEVBQUUsR0FBR2YsR0FBRyxDQUFDZ0IsU0FBSixDQUFjRCxFQUFkLENBQWlCN0IsT0FBTyxDQUFDQyxVQUF6QixDQUFUOztBQUVBLFFBQUlnQixVQUFVLEdBQUcvQixDQUFDLENBQUN3QyxTQUFGLENBQVlaLEdBQUcsQ0FBQ2EsTUFBSixDQUFXQyxNQUF2QixDQUFqQjs7QUFDQSxRQUFJLEVBQUVYLFVBQVUsSUFBSWYsWUFBaEIsQ0FBSixFQUFtQztBQUMvQixZQUFNLElBQUlQLFVBQUosQ0FBZSw0QkFBZixDQUFOO0FBQ0g7O0FBRUQsUUFBSW9DLFdBQVcsR0FBR0YsRUFBRSxDQUFDRyxLQUFILENBQVNmLFVBQVQsQ0FBbEI7QUFFQSxRQUFJc0MsS0FBSyxHQUFHO0FBQUUsT0FBQ3hCLFdBQVcsQ0FBQ0csSUFBWixDQUFpQmdCLFFBQWxCLEdBQTZCcEMsR0FBRyxDQUFDYSxNQUFKLENBQVd3QjtBQUExQyxLQUFaO0FBRUEsVUFBTXBCLFdBQVcsQ0FBQzJCLE9BQVosQ0FBb0I7QUFBRVosTUFBQUEsTUFBTSxFQUFFUztBQUFWLEtBQXBCLENBQU47QUFFQXpDLElBQUFBLEdBQUcsQ0FBQ1UsSUFBSixHQUFXO0FBQUVtQyxNQUFBQSxNQUFNLEVBQUU7QUFBVixLQUFYO0FBQ0gsR0FmRDtBQWlCQTdELEVBQUFBLEdBQUcsQ0FBQzhELFNBQUosQ0FBY3pELE1BQWQ7QUFDSCxDQXRMRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QgfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IGVhY2hBc3luY18oZW50aXR5TW9kZWxzLCBhc3luYyAoY29uZmlnLCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICAvL3RvZG86IGZpbHRlciBlbnRpdHkgb3IgbWV0aG9kcyBieSBjb25maWdcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lSW5VcmwgPSBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKTtcblxuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2xpc3QnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RldGFpbCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwgJzppZCcpIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2NyZWF0ZScsIG1ldGhvZDogJ3Bvc3QnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ3VwZGF0ZScsIG1ldGhvZDogJ3B1dCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwgJzppZCcpIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RlbGV0ZScsIG1ldGhvZDogJ2RlbCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwgJzppZCcpIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBpZiAoYXBwLmVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihtZXRhZGF0YUVuZHBvaW50LCAnOmVudGl0eScpLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgICAgIGlmICghKGVudGl0eU5hbWUgaW4gZW50aXR5TW9kZWxzKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdJbnZhbGlkIGVudGl0eSBlbmRwb2ludC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQgaW5mbyA9IEVudGl0eU1vZGVsLm1ldGE7XG5cbiAgICAgICAgICAgIGlmIChjdHgucXVlcnkuZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgaW5mbyA9IGdldFZhbHVlQnlQYXRoKGluZm8sIGN0eC5xdWVyeS5maWx0ZXIpO1xuICAgICAgICAgICAgICAgIGlmICghaW5mbykge1xuICAgICAgICAgICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBFbXB0eSBjb250ZW50LmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3R4LmJvZHkgPSBpbmZvO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGV4dHJhY3RRdWVyeU9wdGlvbkZyb21Cb2R5KGJvZHkpIHtcbiAgICAgICAgcmV0dXJuIF8ubWFwS2V5cyhfLnBpY2soYm9keSwgW1xuICAgICAgICAgICAgJ2Fzc29jaWF0aW9uJyxcbiAgICAgICAgICAgICdwcm9qZWN0aW9uJyxcbiAgICAgICAgICAgICdncm91cEJ5JyxcbiAgICAgICAgICAgICdvcmRlckJ5JyxcbiAgICAgICAgICAgICdvZmZzZXQnLFxuICAgICAgICAgICAgJ2xpbWl0JyxcbiAgICAgICAgXSksICh2LCBrKSA9PiAnJCcrayk7XG4gICAgfVxuXG4gICAgLy9nZXQgbGlzdCAgICBcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGlmICghKGVudGl0eU5hbWUgaW4gZW50aXR5TW9kZWxzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICRxdWVyeTogY3R4LnF1ZXJ5LCBcbiAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAuLi5leHRyYWN0UXVlcnlPcHRpb25Gcm9tQm9keShjdHgucmVxdWVzdC5ib2R5KVxuICAgICAgICB9O1xuXG4gICAgICAgIGN0eC5ib2R5ID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZEFsbF8ocXVlcnlPcHRpb25zKTtcbiAgICB9KTtcblxuICAgIC8vZ2V0IGRldGFpbFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGlmICghKGVudGl0eU5hbWUgaW4gZW50aXR5TW9kZWxzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICRxdWVyeTogeyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfSwgXG4gICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgLi4uZXh0cmFjdFF1ZXJ5T3B0aW9uRnJvbUJvZHkoY3R4LnJlcXVlc3QuYm9keSlcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kT25lXyhxdWVyeU9wdGlvbnMpOyAgICAgICAgXG4gICAgICAgIGlmICghbW9kZWwpIHtcbiAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEludmFsaWQgXCIke2N0eC5wYXJhbXMuZW50aXR5fVwiIGlkLmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGlmICghKGVudGl0eU5hbWUgaW4gZW50aXR5TW9kZWxzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7ICRyZXRyaWV2ZUNyZWF0ZWQ6IHRydWUgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy91cGRhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgJHF1ZXJ5OiB3aGVyZSwgJHJldHJpZXZlVXBkYXRlZDogdHJ1ZSB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2RlbGV0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGlmICghKGVudGl0eU5hbWUgaW4gZW50aXR5TW9kZWxzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZV8oeyAkcXVlcnk6IHdoZXJlIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
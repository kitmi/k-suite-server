"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest
} = require('../Errors');

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(options.entityModels);
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    await eachAsync_(entityModels, async (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'create',
        method: 'post',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'update',
        method: 'put',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'delete',
        method: 'del',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
    });
    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = ctx.params.entity;

      if (!(entityName in entityModels)) {
        throw new BadRequest('Invalid entity endpoint.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  function extractQueryOptionFromBody(body) {
    return _.mapKeys(_.pick(body, ['association', 'projection', 'groupBy', 'orderBy', 'offset', 'limit']), (v, k) => '$' + k);
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);
    let EntityModel = db.model(ctx.params.entity);
    let queryOptions = {
      $query: ctx.query,
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);
    let EntityModel = db.model(ctx.params.entity);
    let queryOptions = {
      $query: {
        [EntityModel.meta.keyField]: ctx.params.id
      },
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);
    let EntityModel = db.model(ctx.params.entity);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);
    let EntityModel = db.model(ctx.params.entity);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);
    let EntityModel = db.model(ctx.params.entity);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwiYWRkUm91dGUiLCJjdHgiLCJsaXN0IiwiY29uZmlnIiwiZW50aXR5TmFtZSIsImVudGl0eU5hbWVJblVybCIsImtlYmFiQ2FzZSIsInB1c2giLCJ0eXBlIiwibWV0aG9kIiwidXJsIiwiYm9keSIsImVudiIsInBhcmFtcyIsImVudGl0eSIsImRiIiwiYXBwTW9kdWxlIiwiRW50aXR5TW9kZWwiLCJtb2RlbCIsImluZm8iLCJtZXRhIiwicXVlcnkiLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwiZXh0cmFjdFF1ZXJ5T3B0aW9uRnJvbUJvZHkiLCJtYXBLZXlzIiwicGljayIsInYiLCJrIiwicXVlcnlPcHRpb25zIiwiJHF1ZXJ5IiwiJHVuYm94aW5nIiwicmVxdWVzdCIsImZpbmRBbGxfIiwia2V5RmllbGQiLCJpZCIsImZpbmRPbmVfIiwiY3JlYXRlXyIsIiRyZXRyaWV2ZUNyZWF0ZWQiLCJ3aGVyZSIsInVwZGF0ZV8iLCIkcmV0cmlldmVVcGRhdGVkIiwiZGVsZXRlXyIsInN0YXR1cyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVB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T0FBSixDQUFZdkIsSUFBaEMsRUFBc0M7QUFBRXFCLE1BQUFBLE1BQU0sRUFBRVMsS0FBVjtBQUFpQkUsTUFBQUEsZ0JBQWdCLEVBQUU7QUFBbkMsS0FBdEMsQ0FBbEI7QUFFQTFDLElBQUFBLEdBQUcsQ0FBQ1UsSUFBSixHQUFXTyxLQUFYO0FBQ0gsR0FURDtBQVlBaEMsRUFBQUEsR0FBRyxDQUFDYyxRQUFKLENBQWFULE1BQWIsRUFBcUIsS0FBckIsRUFBNEIsY0FBNUIsRUFBNEMsTUFBT1UsR0FBUCxJQUFlO0FBQ3ZELFFBQUljLEVBQUUsR0FBR2QsR0FBRyxDQUFDZSxTQUFKLENBQWNELEVBQWQsQ0FBaUIzQixPQUFPLENBQUNDLFVBQXpCLENBQVQ7QUFDQSxRQUFJNEIsV0FBVyxHQUFHRixFQUFFLENBQUNHLEtBQUgsQ0FBU2pCLEdBQUcsQ0FBQ1ksTUFBSixDQUFXQyxNQUFwQixDQUFsQjtBQUVBLFFBQUkyQixLQUFLLEdBQUc7QUFBRSxPQUFDeEIsV0FBVyxDQUFDRyxJQUFaLENBQWlCZ0IsUUFBbEIsR0FBNkJuQyxHQUFHLENBQUNZLE1BQUosQ0FBV3dCO0FBQTFDLEtBQVo7QUFFQSxVQUFNcEIsV0FBVyxDQUFDMkIsT0FBWixDQUFvQjtBQUFFWixNQUFBQSxNQUFNLEVBQUVTO0FBQVYsS0FBcEIsQ0FBTjtBQUVBeEMsSUFBQUEsR0FBRyxDQUFDVSxJQUFKLEdBQVc7QUFBRWtDLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQVg7QUFDSCxHQVREO0FBV0EzRCxFQUFBQSxHQUFHLENBQUM0RCxTQUFKLENBQWN2RCxNQUFkO0FBQ0gsQ0F4SkQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfLCBmcywgZWFjaEFzeW5jXywgdXJsSm9pbiwgZ2V0VmFsdWVCeVBhdGggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdrb2Etcm91dGVyJyk7XG5jb25zdCBIdHRwQ29kZSA9IHJlcXVpcmUoJ2h0dHAtc3RhdHVzLWNvZGVzJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uLCBCYWRSZXF1ZXN0IH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2F0ZXdheTogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnLFxuICogICAgICAgICAgbWV0YWRhdGFFbmRwb2ludDogJy9fbWV0YSdcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBxdWVyeVxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZGV0YWlsXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICByZW1vdmUgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgaWYgKCFvcHRpb25zLnNjaGVtYU5hbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgc2NoZW1hIG5hbWUgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5lbnRpdHlNb2RlbHNgXG4gICAgICAgICk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLnJlc3RBcGlXcmFwcGVyKCksICdyZXN0QXBpV3JhcHBlcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IGFwaUxpc3RFbmRwb2ludCA9IG9wdGlvbnMuYXBpTGlzdEVuZHBvaW50IHx8ICcvX2xpc3QnO1xuICAgIGxldCBtZXRhZGF0YUVuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2luZm8nO1xuXG4gICAgbGV0IGVudGl0eU1vZGVscyA9IG9wdGlvbnMuZW50aXR5TW9kZWxzO1xuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmVudGl0eU1vZGVscyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZW50aXR5TW9kZWxzID0gZnMucmVhZEpzb25TeW5jKG9wdGlvbnMuZW50aXR5TW9kZWxzKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyhlbnRpdHlNb2RlbHMsIGFzeW5jIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuXG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnbGlzdCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGV0YWlsJywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCAnOmlkJykgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnY3JlYXRlJywgbWV0aG9kOiAncG9zdCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCAnOmlkJykgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGVsZXRlJywgbWV0aG9kOiAnZGVsJywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCAnOmlkJykgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gY3R4LnBhcmFtcy5lbnRpdHk7XG4gICAgICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnSW52YWxpZCBlbnRpdHkgZW5kcG9pbnQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGluZm8gPSBFbnRpdHlNb2RlbC5tZXRhO1xuXG4gICAgICAgICAgICBpZiAoY3R4LnF1ZXJ5LmZpbHRlcikge1xuICAgICAgICAgICAgICAgIGluZm8gPSBnZXRWYWx1ZUJ5UGF0aChpbmZvLCBjdHgucXVlcnkuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgRW1wdHkgY29udGVudC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gaW5mbztcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBleHRyYWN0UXVlcnlPcHRpb25Gcm9tQm9keShib2R5KSB7XG4gICAgICAgIHJldHVybiBfLm1hcEtleXMoXy5waWNrKGJvZHksIFtcbiAgICAgICAgICAgICdhc3NvY2lhdGlvbicsXG4gICAgICAgICAgICAncHJvamVjdGlvbicsXG4gICAgICAgICAgICAnZ3JvdXBCeScsXG4gICAgICAgICAgICAnb3JkZXJCeScsXG4gICAgICAgICAgICAnb2Zmc2V0JyxcbiAgICAgICAgICAgICdsaW1pdCcsXG4gICAgICAgIF0pLCAodiwgaykgPT4gJyQnK2spO1xuICAgIH1cblxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChjdHgucGFyYW1zLmVudGl0eSk7XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAkcXVlcnk6IGN0eC5xdWVyeSwgXG4gICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgLi4uZXh0cmFjdFF1ZXJ5T3B0aW9uRnJvbUJvZHkoY3R4LnJlcXVlc3QuYm9keSlcbiAgICAgICAgfTtcblxuICAgICAgICBjdHguYm9keSA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRBbGxfKHF1ZXJ5T3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICAvL2dldCBkZXRhaWxcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChjdHgucGFyYW1zLmVudGl0eSk7XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAkcXVlcnk6IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH0sIFxuICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgIC4uLmV4dHJhY3RRdWVyeU9wdGlvbkZyb21Cb2R5KGN0eC5yZXF1ZXN0LmJvZHkpXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBJbnZhbGlkIFwiJHtjdHgucGFyYW1zLmVudGl0eX1cIiBpZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChjdHgucGFyYW1zLmVudGl0eSk7ICAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGN0eC5wYXJhbXMuZW50aXR5KTsgICAgICAgIFxuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7ICRxdWVyeTogd2hlcmUsICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9kZWxldGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZGVsJywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChjdHgucGFyYW1zLmVudGl0eSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVfKHsgJHF1ZXJ5OiB3aGVyZSB9KTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSB7IHN0YXR1czogJ09LJyB9O1xuICAgIH0pOyAgIFxuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=
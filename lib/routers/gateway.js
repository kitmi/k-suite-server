"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest
} = require('../Errors');

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    await eachAsync_(entityModels, async (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'create',
        method: 'post',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'update',
        method: 'put',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
      list.push({
        type: 'delete',
        method: 'del',
        url: urlJoin(baseRoute, entityNameInUrl, ':id')
      });
    });
    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      if (!(entityName in entityModels)) {
        throw new BadRequest('Invalid entity endpoint.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  function extractQueryOptionFromBody(body) {
    return _.mapKeys(_.pick(body, ['association', 'projection', 'groupBy', 'orderBy', 'offset', 'limit']), (v, k) => '$' + k);
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    console.log(entityModels);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = {
        $query: { ...ctx.query,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = {
        $query: ctx.query,
        $unboxing: true,
        ...extractQueryOptionFromBody(ctx.request.body)
      };
    }

    let EntityModel = db.model(entityName);
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let queryOptions = {
      $query: {
        [EntityModel.meta.keyField]: ctx.params.id
      },
      $unboxing: true,
      ...extractQueryOptionFromBody(ctx.request.body)
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    if (!(entityName in entityModels)) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImN0eCIsImxpc3QiLCJjb25maWciLCJlbnRpdHlOYW1lIiwiZW50aXR5TmFtZUluVXJsIiwia2ViYWJDYXNlIiwicHVzaCIsInR5cGUiLCJtZXRob2QiLCJ1cmwiLCJib2R5IiwiZW52IiwiY2FtZWxDYXNlIiwicGFyYW1zIiwiZW50aXR5IiwiZGIiLCJhcHBNb2R1bGUiLCJFbnRpdHlNb2RlbCIsIm1vZGVsIiwiaW5mbyIsIm1ldGEiLCJxdWVyeSIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJleHRyYWN0UXVlcnlPcHRpb25Gcm9tQm9keSIsIm1hcEtleXMiLCJwaWNrIiwidiIsImsiLCJhcGlJbmZvIiwicXVlcnlPcHRpb25zIiwidHlwIiwic2VsZWN0RnJvbSIsIiRxdWVyeSIsIndoZXJlIiwiJHVuYm94aW5nIiwiJGFzc29jaWF0aW9uIiwiam9pbldpdGgiLCJyZXF1ZXN0IiwiZmluZEFsbF8iLCJrZXlGaWVsZCIsImlkIiwiZmluZE9uZV8iLCJjcmVhdGVfIiwiJHJldHJpZXZlQ3JlYXRlZCIsInVwZGF0ZV8iLCIkcmV0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LEVBQUVDO0FBQVYsS0FBcEIsQ0FBTjtBQUVBcEMsSUFBQUEsR0FBRyxDQUFDVSxJQUFKLEdBQVc7QUFBRXdDLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQVg7QUFDSCxHQWZEO0FBaUJBbEUsRUFBQUEsR0FBRyxDQUFDbUUsU0FBSixDQUFjOUQsTUFBZDtBQUNILENBcE1EIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgZnMsIGVhY2hBc3luY18sIHVybEpvaW4sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgna29hLXJvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIGdhdGV3YXk6IHsgICAgICAgICAgXG4gKiAgICAgICAgICBtaWRkbGV3YXJlczoge30sXG4gKiAgICAgICAgICBzY2hlbWFOYW1lOiAnJyxcbiAqICAgICAgICAgIGVudGl0eU1vZGVsczoge318PGNvbmZpZyBwYXRoPiwgIFxuICogICAgICAgICAgYXBpTGlzdEVuZHBvaW50OiAnL19saXN0JyxcbiAqICAgICAgICAgIG1ldGFkYXRhRW5kcG9pbnQ6ICcvX21ldGEnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuc2NoZW1hTmFtZWBcbiAgICAgICAgKTtcbiAgICB9ICAgIFxuXG4gICAgaWYgKCFvcHRpb25zLmVudGl0eU1vZGVscykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBlbnRpdHkgbW9kZWxzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuZW50aXR5TW9kZWxzYFxuICAgICAgICApOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5yZXN0QXBpV3JhcHBlcigpLCAncmVzdEFwaVdyYXBwZXInKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCBhcGlMaXN0RW5kcG9pbnQgPSBvcHRpb25zLmFwaUxpc3RFbmRwb2ludCB8fCAnL19saXN0JztcbiAgICBsZXQgbWV0YWRhdGFFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19pbmZvJztcblxuICAgIGxldCBlbnRpdHlNb2RlbHMgPSBvcHRpb25zLmVudGl0eU1vZGVscztcblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbnRpdHlNb2RlbHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGVudGl0eU1vZGVscyA9IGZzLnJlYWRKc29uU3luYyhhcHAudG9BYnNvbHV0ZVBhdGgob3B0aW9ucy5lbnRpdHlNb2RlbHMpKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyhlbnRpdHlNb2RlbHMsIGFzeW5jIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuXG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnbGlzdCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGV0YWlsJywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCAnOmlkJykgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnY3JlYXRlJywgbWV0aG9kOiAncG9zdCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCAnOmlkJykgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGVsZXRlJywgbWV0aG9kOiAnZGVsJywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCAnOmlkJykgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgaWYgKCEoZW50aXR5TmFtZSBpbiBlbnRpdHlNb2RlbHMpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0ludmFsaWQgZW50aXR5IGVuZHBvaW50LicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZXh0cmFjdFF1ZXJ5T3B0aW9uRnJvbUJvZHkoYm9keSkge1xuICAgICAgICByZXR1cm4gXy5tYXBLZXlzKF8ucGljayhib2R5LCBbXG4gICAgICAgICAgICAnYXNzb2NpYXRpb24nLFxuICAgICAgICAgICAgJ3Byb2plY3Rpb24nLFxuICAgICAgICAgICAgJ2dyb3VwQnknLFxuICAgICAgICAgICAgJ29yZGVyQnknLFxuICAgICAgICAgICAgJ29mZnNldCcsXG4gICAgICAgICAgICAnbGltaXQnLFxuICAgICAgICBdKSwgKHYsIGspID0+ICckJytrKTtcbiAgICB9XG5cbiAgICAvL2dldCBsaXN0ICAgIFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcXVlcnlPcHRpb25zO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXAgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgLi4uY3R4LnF1ZXJ5LCAuLi5hcGlJbmZvLndoZXJlIH0sIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogY3R4LnF1ZXJ5LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgIC4uLmV4dHJhY3RRdWVyeU9wdGlvbkZyb21Cb2R5KGN0eC5yZXF1ZXN0LmJvZHkpXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kQWxsXyhxdWVyeU9wdGlvbnMpO1xuICAgIH0pO1xuXG4gICAgLy9nZXQgZGV0YWlsXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgaWYgKCEoZW50aXR5TmFtZSBpbiBlbnRpdHlNb2RlbHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9LCBcbiAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAuLi5leHRyYWN0UXVlcnlPcHRpb25Gcm9tQm9keShjdHgucmVxdWVzdC5ib2R5KVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRPbmVfKHF1ZXJ5T3B0aW9ucyk7ICAgICAgICBcbiAgICAgICAgaWYgKCFtb2RlbCkge1xuICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgSW52YWxpZCBcIiR7Y3R4LnBhcmFtcy5lbnRpdHl9XCIgaWQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgIH0gXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vY3JlYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgaWYgKCEoZW50aXR5TmFtZSBpbiBlbnRpdHlNb2RlbHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGlmICghKGVudGl0eU5hbWUgaW4gZW50aXR5TW9kZWxzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLnVwZGF0ZV8oY3R4LnJlcXVlc3QuYm9keSwgeyAkcXVlcnk6IHdoZXJlLCAkcmV0cmlldmVVcGRhdGVkOiB0cnVlIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vZGVsZXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgaWYgKCEoZW50aXR5TmFtZSBpbiBlbnRpdHlNb2RlbHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgYXdhaXQgRW50aXR5TW9kZWwuZGVsZXRlXyh7ICRxdWVyeTogd2hlcmUgfSk7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0geyBzdGF0dXM6ICdPSycgfTtcbiAgICB9KTsgICBcblxuICAgIGFwcC5hZGRSb3V0ZXIocm91dGVyKTtcbn07Il19
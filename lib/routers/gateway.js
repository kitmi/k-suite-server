"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

function mergeQuery(query, extra) {
  return query && query.$query ? {
    $query: { ...query.$query,
      ...extra
    }
  } : { ...query,
    ...extra
  };
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: urlJoin(baseRoute, entityNameInUrl)
        });
        list.push({
          type: 'update',
          method: 'put',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
      }
    });

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...mergeQuery(ctx.query, apiInfo.where),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIk1ldGhvZE5vdEFsbG93ZWQiLCJtZXJnZVF1ZXJ5IiwicXVlcnkiLCJleHRyYSIsIiRxdWVyeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImN0eCIsImxpc3QiLCJkYiIsImFwcE1vZHVsZSIsImZvck93biIsImNvbmZpZyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJrZXlGaWVsZE5hbWUiLCJ0eXBlIiwia2V5IiwibW9kZWwiLCJzZWxlY3RGcm9tIiwibWV0YSIsImtleUZpZWxkIiwicHVzaCIsIm1ldGhvZCIsInVybCIsInJlYWRPbmx5IiwiYm9keSIsImVudiIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsImFwaUluZm8iLCJFbnRpdHlNb2RlbCIsImluZm8iLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwicXVlcnlPcHRpb25zIiwid2hlcmUiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCJqb2luV2l0aCIsImZpbmRBbGxfIiwiaWQiLCJmaW5kT25lXyIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsInVwZGF0ZV8iLCIkcmV0cmlldmVVcGRhdGVkIiwiZGVsZXRlXyIsInN0YXR1cyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxVQUFUO0FBQXFCQyxFQUFBQSxPQUFyQjtBQUE4QkMsRUFBQUE7QUFBOUIsSUFBaURDLE9BQU8sQ0FBQyxVQUFELENBQTlEOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBdEI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FBeEI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxvQkFBRjtBQUF3QkMsRUFBQUEsVUFBeEI7QUFBb0NDLEVBQUFBO0FBQXBDLElBQXlETCxPQUFPLENBQUMsV0FBRCxDQUF0RTs7QUFPQyxTQUFTTSxVQUFULENBQW9CQyxLQUFwQixFQUEyQkMsS0FBM0IsRUFBa0M7QUFDL0IsU0FBUUQsS0FBSyxJQUFJQSxLQUFLLENBQUNFLE1BQWhCLEdBQTBCO0FBQUVBLElBQUFBLE1BQU0sRUFBRSxFQUFFLEdBQUdGLEtBQUssQ0FBQ0UsTUFBWDtBQUFtQixTQUFHRDtBQUF0QjtBQUFWLEdBQTFCLEdBQXNFLEVBQUUsR0FBR0QsS0FBTDtBQUFZLE9BQUdDO0FBQWYsR0FBN0U7QUFDRjs7QUEyQkZFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixDQUFDQyxHQUFELEVBQU1DLFNBQU4sRUFBaUJDLE9BQWpCLEtBQTZCO0FBQzFDLE1BQUksQ0FBQ0EsT0FBTyxDQUFDQyxVQUFiLEVBQXlCO0FBQ3JCLFVBQU0sSUFBSVosb0JBQUosQ0FDRiw2QkFERSxFQUVGUyxHQUZFLEVBR0QsV0FBVUMsU0FBVSxxQkFIbkIsQ0FBTjtBQUtIOztBQUVELE1BQUksQ0FBQ0MsT0FBTyxDQUFDRSxZQUFiLEVBQTJCO0FBQ3ZCLFVBQU0sSUFBSWIsb0JBQUosQ0FDRiwrQkFERSxFQUVGUyxHQUZFLEVBR0QsV0FB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UUFBSUMsT0FBTyxHQUFHckMsWUFBWSxDQUFDa0IsVUFBRCxDQUExQjs7QUFDQSxRQUFJLENBQUNtQixPQUFMLEVBQWM7QUFDVixZQUFNLElBQUlqRCxVQUFKLENBQWUsNEJBQWYsQ0FBTjtBQUNIOztBQUVELFFBQUlpRCxPQUFPLENBQUNOLFFBQVosRUFBc0I7QUFDbEIsWUFBTSxJQUFJMUMsZ0JBQUosQ0FBcUIsMEJBQXJCLENBQU47QUFDSDs7QUFFRCxRQUFJaUQsV0FBVyxHQUFHeEIsRUFBRSxDQUFDVSxLQUFILENBQVNOLFVBQVQsQ0FBbEI7QUFFQSxRQUFJMkIsS0FBSyxHQUFHO0FBQUUsT0FBQ1AsV0FBVyxDQUFDWixJQUFaLENBQWlCQyxRQUFsQixHQUE2QmYsR0FBRyxDQUFDdUIsTUFBSixDQUFXZTtBQUExQyxLQUFaO0FBRUEsVUFBTVosV0FBVyxDQUFDbUIsT0FBWixDQUFvQjtBQUFFaEUsTUFBQUEsTUFBTSxFQUFFb0Q7QUFBVixLQUFwQixDQUFOO0FBRUFqQyxJQUFBQSxHQUFHLENBQUNvQixJQUFKLEdBQVc7QUFBRTBCLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQVg7QUFDSCxHQXBCRDtBQXNCQTlELEVBQUFBLEdBQUcsQ0FBQytELFNBQUosQ0FBYzFELE1BQWQ7QUFDSCxDQXBPRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QsIE1ldGhvZE5vdEFsbG93ZWQgfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbiBmdW5jdGlvbiBtZXJnZVF1ZXJ5KHF1ZXJ5LCBleHRyYSkge1xuICAgIHJldHVybiAocXVlcnkgJiYgcXVlcnkuJHF1ZXJ5KSA/IHsgJHF1ZXJ5OiB7IC4uLnF1ZXJ5LiRxdWVyeSwgLi4uZXh0cmEgfSB9IDogeyAuLi5xdWVyeSwgLi4uZXh0cmEgfTtcbiB9XG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihlbnRpdHlNb2RlbHMsIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBjb25maWcua2V5IHx8IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBkYi5tb2RlbChlbnRpdHlOYW1lKS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfSAgICAgICAgICBcblxuICAgICAgICAgICAga2V5RmllbGROYW1lID0gJzonICsga2V5RmllbGROYW1lO1xuXG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnbGlzdCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGV0YWlsJywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpIH0pO1xuXG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5yZWFkT25seSkge1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdjcmVhdGUnLCBtZXRob2Q6ICdwb3N0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKSB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZWxldGUnLCBtZXRob2Q6ICdkZWwnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSkgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3JykgPyBhcGlJbmZvLnNlbGVjdEZyb20gOiBlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnM7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5tZXJnZVF1ZXJ5KGN0eC5xdWVyeSwgYXBpSW5mby53aGVyZSksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4uY3R4LnF1ZXJ5LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBjdHguYm9keSA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRBbGxfKHF1ZXJ5T3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICAvL2dldCBkZXRhaWxcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCwgcXVlcnlPcHRpb25zO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkID0gYXBpSW5mby5rZXkgfHwgRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZFxuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBjdHgucGFyYW1zLmlkLCAuLi5hcGlJbmZvLndoZXJlIH0sXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfSwgXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kT25lXyhxdWVyeU9wdGlvbnMpOyAgICAgICAgXG4gICAgICAgIGlmICghbW9kZWwpIHtcbiAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEludmFsaWQgXCIke2N0eC5wYXJhbXMuZW50aXR5fVwiIGlkLmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7ICRxdWVyeTogd2hlcmUsICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9kZWxldGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZGVsJywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZV8oeyAkcXVlcnk6IHdoZXJlIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
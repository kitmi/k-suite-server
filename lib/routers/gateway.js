"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

function mergeQuery(query, extra) {
  return query && query.$query ? {
    $query: { ...query.$query,
      ...extra
    }
  } : { ...query,
    $query: extra
  };
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: urlJoin(baseRoute, entityNameInUrl)
        });
        list.push({
          type: 'update',
          method: 'put',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
      }
    });

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...mergeQuery(ctx.query, apiInfo.where),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    queryOptions.$variables = ctx.sessionVariables;
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    queryOptions.$variables = ctx.sessionVariables;
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: ctx.sessionVariables
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: ctx.sessionVariables
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: ctx.sessionVariables
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIk1ldGhvZE5vdEFsbG93ZWQiLCJtZXJnZVF1ZXJ5IiwicXVlcnkiLCJleHRyYSIsIiRxdWVyeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImN0eCIsImxpc3QiLCJkYiIsImFwcE1vZHVsZSIsImZvck93biIsImNvbmZpZyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJrZXlGaWVsZE5hbWUiLCJ0eXBlIiwia2V5IiwibW9kZWwiLCJzZWxlY3RGcm9tIiwibWV0YSIsImtleUZpZWxkIiwicHVzaCIsIm1ldGhvZCIsInVybCIsInJlYWRPbmx5IiwiYm9keSIsImVudiIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsImFwaUluZm8iLCJFbnRpdHlNb2RlbCIsImluZm8iLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwicXVlcnlPcHRpb25zIiwid2hlcmUiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCJqb2luV2l0aCIsIiR2YXJpYWJsZXMiLCJzZXNzaW9uVmFyaWFibGVzIiwiZmluZEFsbF8iLCJpZCIsImZpbmRPbmVfIiwiY3JlYXRlXyIsInJlcXVlc3QiLCIkcmV0cmlldmVDcmVhdGVkIiwidXBkYXRlXyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJkZWxldGVkIiwiZGVsZXRlXyIsInN0YXR1cyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxVQUFUO0FBQXFCQyxFQUFBQSxPQUFyQjtBQUE4QkMsRUFBQUE7QUFBOUIsSUFBaURDLE9BQU8sQ0FBQyxVQUFELENBQTlEOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBdEI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FBeEI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxvQkFBRjtBQUF3QkMsRUFBQUEsVUFBeEI7QUFBb0NDLEVBQUFBO0FBQXBDLElBQXlETCxPQUFPLENBQUMsV0FBRCxDQUF0RTs7QUFPQyxTQUFTTSxVQUFULENBQW9CQyxLQUFwQixFQUEyQkMsS0FBM0IsRUFBa0M7QUFDL0IsU0FBUUQsS0FBSyxJQUFJQSxLQUFLLENBQUNFLE1BQWhCLEdBQTBCO0FBQUVBLElBQUFBLE1BQU0sRUFBRSxFQUFFLEdBQUdGLEtBQUssQ0FBQ0UsTUFBWDtBQUFtQixTQUFHRDtBQUF0QjtBQUFWLEdBQTFCLEdBQXNFLEVBQUUsR0FBR0QsS0FBTDtBQUFZRSxJQUFBQSxNQUFNLEVBQUVEO0FBQXBCLEdBQTdFO0FBQ0Y7O0FBMkJGRSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCQyxPQUFqQixLQUE2QjtBQUMxQyxNQUFJLENBQUNBLE9BQU8sQ0FBQ0MsVUFBYixFQUF5QjtBQUNyQixVQUFNLElBQUlaLG9CQUFKLENBQ0YsNkJBREUsRUFFRlMsR0FGRSxFQUdELFdBQVVDLFNBQVUscUJBSG5CLENBQU47QUFLSDs7QUFFRCxNQUFJLENBQUNDLE9BQU8sQ0FBQ0UsWUFBYixFQUEy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Q0FsUEQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfLCBmcywgZWFjaEFzeW5jXywgdXJsSm9pbiwgZ2V0VmFsdWVCeVBhdGggfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdrb2Etcm91dGVyJyk7XG5jb25zdCBIdHRwQ29kZSA9IHJlcXVpcmUoJ2h0dHAtc3RhdHVzLWNvZGVzJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uLCBCYWRSZXF1ZXN0LCBNZXRob2ROb3RBbGxvd2VkIH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBSRVNUZnVsIHJvdXRlci5cbiAqIEBtb2R1bGUgUm91dGVyX1Jlc3RcbiAqL1xuXG4gZnVuY3Rpb24gbWVyZ2VRdWVyeShxdWVyeSwgZXh0cmEpIHtcbiAgICByZXR1cm4gKHF1ZXJ5ICYmIHF1ZXJ5LiRxdWVyeSkgPyB7ICRxdWVyeTogeyAuLi5xdWVyeS4kcXVlcnksIC4uLmV4dHJhIH0gfSA6IHsgLi4ucXVlcnksICRxdWVyeTogZXh0cmEgfTtcbiB9XG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihlbnRpdHlNb2RlbHMsIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBjb25maWcua2V5IHx8IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBkYi5tb2RlbChlbnRpdHlOYW1lKS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfSAgICAgICAgICBcblxuICAgICAgICAgICAga2V5RmllbGROYW1lID0gJzonICsga2V5RmllbGROYW1lO1xuXG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnbGlzdCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGV0YWlsJywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpIH0pO1xuXG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5yZWFkT25seSkge1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdjcmVhdGUnLCBtZXRob2Q6ICdwb3N0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKSB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZWxldGUnLCBtZXRob2Q6ICdkZWwnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSkgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3JykgPyBhcGlJbmZvLnNlbGVjdEZyb20gOiBlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnM7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5tZXJnZVF1ZXJ5KGN0eC5xdWVyeSwgYXBpSW5mby53aGVyZSksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4uY3R4LnF1ZXJ5LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBxdWVyeU9wdGlvbnMuJHZhcmlhYmxlcyA9IGN0eC5zZXNzaW9uVmFyaWFibGVzO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZEFsbF8ocXVlcnlPcHRpb25zKTtcbiAgICB9KTtcblxuICAgIC8vZ2V0IGRldGFpbFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsLCBxdWVyeU9wdGlvbnM7XG5cbiAgICAgICAgaWYgKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgZW50aXR5TmFtZSA9IGFwaUluZm8uc2VsZWN0RnJvbTtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQga2V5RmllbGQgPSBhcGlJbmZvLmtleSB8fCBFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtrZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQsIC4uLmFwaUluZm8ud2hlcmUgfSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0gY3R4LnNlc3Npb25WYXJpYWJsZXM7XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBJbnZhbGlkIFwiJHtjdHgucGFyYW1zLmVudGl0eX1cIiBpZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IGN0eC5zZXNzaW9uVmFyaWFibGVzXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vdXBkYXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3B1dCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC51cGRhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLCBcbiAgICAgICAgICAgICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUsXG4gICAgICAgICAgICAkdmFyaWFibGVzOiBjdHguc2Vzc2lvblZhcmlhYmxlcyBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9kZWxldGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZGVsJywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGxldCBkZWxldGVkID0gYXdhaXQgRW50aXR5TW9kZWwuZGVsZXRlXyh7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IGN0eC5zZXNzaW9uVmFyaWFibGVzXG4gICAgICAgIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snLCBkZWxldGVkIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
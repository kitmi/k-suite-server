"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

function mergeQuery(query, extra) {
  return query && query.$query ? {
    $query: { ...query.$query,
      ...extra
    }
  } : { ...query,
    ...extra
  };
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);
    await eachAsync_(entityModels, async (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: urlJoin(baseRoute, entityNameInUrl)
        });
        list.push({
          type: 'update',
          method: 'put',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
      }
    });
    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...mergeQuery(ctx.query, apiInfo.where),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIk1ldGhvZE5vdEFsbG93ZWQiLCJtZXJnZVF1ZXJ5IiwicXVlcnkiLCJleHRyYSIsIiRxdWVyeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImN0eCIsImxpc3QiLCJkYiIsImFwcE1vZHVsZSIsImNvbmZpZyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJrZXlGaWVsZE5hbWUiLCJ0eXBlIiwia2V5IiwibW9kZWwiLCJzZWxlY3RGcm9tIiwibWV0YSIsImtleUZpZWxkIiwicHVzaCIsIm1ldGhvZCIsInVybCIsInJlYWRPbmx5IiwiYm9keSIsImVudiIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsImFwaUluZm8iLCJFbnRpdHlNb2RlbCIsImluZm8iLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwicXVlcnlPcHRpb25zIiwid2hlcmUiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCJqb2luV2l0aCIsImZpbmRBbGxfIiwiaWQiLCJmaW5kT25lXyIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsInVw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QUFZLENBQUNpQixVQUFELENBQTFCOztBQUNBLFFBQUksQ0FBQ21CLE9BQUwsRUFBYztBQUNWLFlBQU0sSUFBSWhELFVBQUosQ0FBZSw0QkFBZixDQUFOO0FBQ0g7O0FBRUQsUUFBSWdELE9BQU8sQ0FBQ04sUUFBWixFQUFzQjtBQUNsQixZQUFNLElBQUl6QyxnQkFBSixDQUFxQiwwQkFBckIsQ0FBTjtBQUNIOztBQUVELFFBQUlnRCxXQUFXLEdBQUd2QixFQUFFLENBQUNTLEtBQUgsQ0FBU04sVUFBVCxDQUFsQjtBQUVBLFFBQUkyQixLQUFLLEdBQUc7QUFBRSxPQUFDUCxXQUFXLENBQUNaLElBQVosQ0FBaUJDLFFBQWxCLEdBQTZCZCxHQUFHLENBQUNzQixNQUFKLENBQVdlO0FBQTFDLEtBQVo7QUFFQSxVQUFNWixXQUFXLENBQUNtQixPQUFaLENBQW9CO0FBQUUvRCxNQUFBQSxNQUFNLEVBQUVtRDtBQUFWLEtBQXBCLENBQU47QUFFQWhDLElBQUFBLEdBQUcsQ0FBQ21CLElBQUosR0FBVztBQUFFMEIsTUFBQUEsTUFBTSxFQUFFO0FBQVYsS0FBWDtBQUNILEdBcEJEO0FBc0JBN0QsRUFBQUEsR0FBRyxDQUFDOEQsU0FBSixDQUFjekQsTUFBZDtBQUNILENBcE9EIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgZnMsIGVhY2hBc3luY18sIHVybEpvaW4sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgUm91dGVyID0gcmVxdWlyZSgna29hLXJvdXRlcicpO1xuY29uc3QgSHR0cENvZGUgPSByZXF1aXJlKCdodHRwLXN0YXR1cy1jb2RlcycpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiwgQmFkUmVxdWVzdCwgTWV0aG9kTm90QWxsb3dlZCB9ID0gcmVxdWlyZSgnLi4vRXJyb3JzJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuIGZ1bmN0aW9uIG1lcmdlUXVlcnkocXVlcnksIGV4dHJhKSB7XG4gICAgcmV0dXJuIChxdWVyeSAmJiBxdWVyeS4kcXVlcnkpID8geyAkcXVlcnk6IHsgLi4ucXVlcnkuJHF1ZXJ5LCAuLi5leHRyYSB9IH0gOiB7IC4uLnF1ZXJ5LCAuLi5leHRyYSB9O1xuIH1cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIGdhdGV3YXk6IHsgICAgICAgICAgXG4gKiAgICAgICAgICBtaWRkbGV3YXJlczoge30sXG4gKiAgICAgICAgICBzY2hlbWFOYW1lOiAnJyxcbiAqICAgICAgICAgIGVudGl0eU1vZGVsczoge318PGNvbmZpZyBwYXRoPiwgIFxuICogICAgICAgICAgYXBpTGlzdEVuZHBvaW50OiAnL19saXN0JyxcbiAqICAgICAgICAgIG1ldGFkYXRhRW5kcG9pbnQ6ICcvX21ldGEnXG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGlmICghb3B0aW9ucy5zY2hlbWFOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIHNjaGVtYSBuYW1lIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuc2NoZW1hTmFtZWBcbiAgICAgICAgKTtcbiAgICB9ICAgIFxuXG4gICAgaWYgKCFvcHRpb25zLmVudGl0eU1vZGVscykge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBlbnRpdHkgbW9kZWxzIGNvbmZpZy4nLFxuICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgYHJvdXRpbmcuJHtiYXNlUm91dGV9LmdhdGV3YXkuZW50aXR5TW9kZWxzYFxuICAgICAgICApOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGxldCByb3V0ZXIgPSBiYXNlUm91dGUgPT09ICcvJyA/IG5ldyBSb3V0ZXIoKSA6IG5ldyBSb3V0ZXIoe3ByZWZpeDogYmFzZVJvdXRlfSk7XG5cbiAgICBhcHAudXNlTWlkZGxld2FyZShyb3V0ZXIsIGFwcC5yZXN0QXBpV3JhcHBlcigpLCAncmVzdEFwaVdyYXBwZXInKTtcblxuICAgIGlmIChvcHRpb25zLm1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGFwcC51c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG9wdGlvbnMubWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIGxldCBhcGlMaXN0RW5kcG9pbnQgPSBvcHRpb25zLmFwaUxpc3RFbmRwb2ludCB8fCAnL19saXN0JztcbiAgICBsZXQgbWV0YWRhdGFFbmRwb2ludCA9IG9wdGlvbnMubWV0YWRhdGFFbmRwb2ludCB8fCAnL19pbmZvJztcblxuICAgIGxldCBlbnRpdHlNb2RlbHMgPSBvcHRpb25zLmVudGl0eU1vZGVscztcblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbnRpdHlNb2RlbHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGVudGl0eU1vZGVscyA9IGZzLnJlYWRKc29uU3luYyhhcHAudG9BYnNvbHV0ZVBhdGgob3B0aW9ucy5lbnRpdHlNb2RlbHMpKTsgXG4gICAgfVxuXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIGFwaUxpc3RFbmRwb2ludCwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgbGlzdCA9IFtdO1xuXG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IGVhY2hBc3luY18oZW50aXR5TW9kZWxzLCBhc3luYyAoY29uZmlnLCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICAvL3RvZG86IGZpbHRlciBlbnRpdHkgb3IgbWV0aG9kcyBieSBjb25maWdcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lSW5VcmwgPSBfLmtlYmFiQ2FzZShlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZE5hbWU7XG5cbiAgICAgICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gY29uZmlnLmtleSB8fCBkYi5tb2RlbChjb25maWcuc2VsZWN0RnJvbSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gZGIubW9kZWwoZW50aXR5TmFtZSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gICAgICAgICAgXG5cbiAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9ICc6JyArIGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2xpc3QnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RldGFpbCcsIG1ldGhvZDogJ2dldCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKSB9KTtcblxuICAgICAgICAgICAgaWYgKCFjb25maWcucmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnY3JlYXRlJywgbWV0aG9kOiAncG9zdCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCkgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ3VwZGF0ZScsIG1ldGhvZDogJ3B1dCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKSB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAnZGVsZXRlJywgbWV0aG9kOiAnZGVsJywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsLCBrZXlGaWVsZE5hbWUpIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBpZiAoYXBwLmVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihtZXRhZGF0YUVuZHBvaW50LCAnOmVudGl0eScpLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpID8gYXBpSW5mby5zZWxlY3RGcm9tIDogZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQgaW5mbyA9IEVudGl0eU1vZGVsLm1ldGE7XG5cbiAgICAgICAgICAgIGlmIChjdHgucXVlcnkuZmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgaW5mbyA9IGdldFZhbHVlQnlQYXRoKGluZm8sIGN0eC5xdWVyeS5maWx0ZXIpO1xuICAgICAgICAgICAgICAgIGlmICghaW5mbykge1xuICAgICAgICAgICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBFbXB0eSBjb250ZW50LmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3R4LmJvZHkgPSBpbmZvO1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICAvL2dldCBsaXN0ICAgIFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcXVlcnlPcHRpb25zO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ubWVyZ2VRdWVyeShjdHgucXVlcnksIGFwaUluZm8ud2hlcmUpLFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgIC4uLmN0eC5xdWVyeSwgXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kQWxsXyhxdWVyeU9wdGlvbnMpO1xuICAgIH0pO1xuXG4gICAgLy9nZXQgZGV0YWlsXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwsIHF1ZXJ5T3B0aW9ucztcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBrZXlGaWVsZCA9IGFwaUluZm8ua2V5IHx8IEVudGl0eU1vZGVsLm1ldGEua2V5RmllbGRcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW2tleUZpZWxkXTogY3R4LnBhcmFtcy5pZCwgLi4uYXBpSW5mby53aGVyZSB9LFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgJGFzc29jaWF0aW9uOiBhcGlJbmZvLmpvaW5XaXRoXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH0sIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZE9uZV8ocXVlcnlPcHRpb25zKTsgICAgICAgIFxuICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICBjdHgudGhyb3coSHR0cENvZGUuQkFEX1JFUVVFU1QsIGBJbnZhbGlkIFwiJHtjdHgucGFyYW1zLmVudGl0eX1cIiBpZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7ICRyZXRyaWV2ZUNyZWF0ZWQ6IHRydWUgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy91cGRhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0JywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLnVwZGF0ZV8oY3R4LnJlcXVlc3QuYm9keSwgeyAkcXVlcnk6IHdoZXJlLCAkcmV0cmlldmVVcGRhdGVkOiB0cnVlIH0pOyAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSBtb2RlbDtcbiAgICB9KTtcblxuICAgIC8vZGVsZXRlXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHdoZXJlID0geyBbRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZF06IGN0eC5wYXJhbXMuaWQgfTtcblxuICAgICAgICBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVfKHsgJHF1ZXJ5OiB3aGVyZSB9KTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgY3R4LmJvZHkgPSB7IHN0YXR1czogJ09LJyB9O1xuICAgIH0pOyAgIFxuXG4gICAgYXBwLmFkZFJvdXRlcihyb3V0ZXIpO1xufTsiXX0=
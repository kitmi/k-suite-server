"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

const validator = require('validator');

function ensureInt(name, value) {
  let sanitized = _.isInteger(value) ? value : validator.toInt(value);

  if (isNaN(sanitized)) {
    throw new BadRequest(`"${name}" should be an integer.`);
  }

  return sanitized;
}

function processQuery(ctx, apiInfo, meta) {
  let condition = {};
  let queries = apiInfo.where ? [apiInfo.where] : [];
  let assocs = [];
  let {
    $orderBy,
    $offset,
    $limit,
    $returnTotal
  } = ctx.query;

  if ($orderBy) {
    let orderBy = apiInfo.orderBy[$orderBy];

    if (!orderBy) {
      throw new BadRequest(`Order by "${orderBy}" is not supported.`);
    }

    condition.$orderBy = orderBy;
  } else if (apiInfo.orderBy && apiInfo.orderBy['$default']) {
    condition.$orderBy = apiInfo.orderBy['$default'];
  }

  if ($offset) {
    condition.$offset = ensureInt('$offset', $offset);
  }

  if ($limit) {
    condition.$limit = ensureInt('$limit', $limit);
  }

  if ($returnTotal) {
    if ($returnTotal === '1' || $returnTotal === 'true') {
      condition.$totalCount = true;
    } else {
      condition.$totalCount = $returnTotal;
    }
  }

  if (!_.isEmpty(apiInfo.query)) {
    _.forOwn(apiInfo.query, (info, param) => {
      if (param in ctx.query) {
        queries.push(info.where);
      }
    });
  } else if (meta) {
    _.forOwn(ctx.query, (value, key) => {
      if (key.startsWith(':') && value) {
        assocs.push(key.substr(1));
      } else if (key in meta.fields) {
        queries.push({
          [key]: value
        });
      }
    });
  }

  let l = queries.length;

  if (l > 0) {
    condition.$query = l > 1 ? {
      $and: queries
    } : queries[0];
  }

  if (assocs.length > 0) {
    condition.$association = assocs;
  }

  return condition;
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let descEndpoint = options.metadataEndpoint || '/_desc';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);

    _.forOwn(entityModels, (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      let singleUrl = urlJoin(baseRoute, entityNameInUrl, keyFieldName);
      let batchUrl = urlJoin(baseRoute, entityNameInUrl);
      let descUrl = app.toWebPath(urlJoin(baseRoute, '_desc', _.kebabCase(entityName)));
      list.push({
        type: 'list',
        method: 'get',
        url: batchUrl,
        apiDesc: descUrl
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: singleUrl
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: batchUrl
        });
        list.push({
          type: 'update',
          method: 'put',
          url: singleUrl
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: singleUrl
        });
      }
    });

    ctx.body = list;
  });
  app.addRoute(router, 'get', urlJoin(descEndpoint, ':entity'), async ctx => {
    let list;
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let config = entityModels[entityName];
    let EntityModel;

    if (config.type === 'view') {
      list = {
        'type': 'view',
        'mainEntity': config.selectFrom
      };

      if (config.joinWith) {
        list.associations = config.joinWith;
      }

      if (config.where) {
        list.where = config.where;
      }

      if (config.key) {
        list.key = config.key;
      }

      EntityModel = db.model(config.selectFrom);

      if (config.query) {
        list.query = _.mapValues(config.query, info => info.desc);
      }

      if (config.orderBy) {
        list.orderBy = config.orderBy;
      }
    } else {
      list = {
        'type': 'entity',
        'entity': entityName
      };
      EntityModel = db.model(entityName);
      list.query = _.mapValues(EntityModel.meta.fields, info => info.displayName);
    }

    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      let apiInfo = entityModels[entityName];

      if (!apiInfo) {
        throw new BadRequest('Entity endpoint not found.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(apiInfo.type && apiInfo.type === 'view' ? apiInfo.selectFrom : entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions, EntityModel;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      queryOptions = { ...processQuery(ctx, apiInfo, EntityModel.meta),
        $unboxing: true
      };
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let EntityModel, queryOptions, keyField;
    let keyValue = ctx.params.id;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      EntityModel = db.model(entityName);
      keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: keyValue,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      EntityModel = db.model(entityName);
      keyField = EntityModel.meta.keyField;
      let assocs = [];

      _.forOwn(ctx.query, (value, key) => {
        if (key.startsWith(':') && value) {
          assocs.push(key.substr(1));
        }
      });

      queryOptions = {
        $query: {
          [keyField]: keyValue
        },
        $unboxing: true
      };

      if (assocs.length > 0) {
        queryOptions.$association = assocs;
      }
    }

    queryOptions.$variables = {
      session: ctx.sessionVariables,
      query: ctx.query
    };
    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.NOT_FOUND, `"${EntityModel.meta.name}" with [${keyField}=${keyValue}] not found.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let {
      where,
      data
    } = ctx.request.body;
    let model = await EntityModel.update_(data, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let deleted = await EntityModel.delete_({
      $query: where,
      $variables: {
        session: ctx.sessionVariables,
        query: ctx.query
      }
    });
    ctx.body = {
      status: 'OK',
      deleted
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwidXJsSm9pbiIsImdldFZhbHVlQnlQYXRoIiwicmVxdWlyZSIsIlJvdXRlciIsIkh0dHBDb2RlIiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJCYWRSZXF1ZXN0IiwiTWV0aG9kTm90QWxsb3dlZCIsInZhbGlkYXRvciIsImVuc3VyZUludCIsIm5hbWUiLCJ2YWx1ZSIsInNhbml0aXplZCIsImlzSW50ZWdlciIsInRvSW50IiwiaXNOYU4iLCJwcm9jZXNzUXVlcnkiLCJjdHgiLCJhcGlJbmZvIiwibWV0YSIsImNvbmRpdGlvbiIsInF1ZXJpZXMiLCJ3aGVyZSIsImFzc29jcyIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRyZXR1cm5Ub3RhbCIsInF1ZXJ5Iiwib3JkZXJCeSIsIiR0b3RhbENvdW50IiwiaXNFbXB0eSIsImZvck93biIsImluZm8iLCJwYXJhbSIsInB1c2giLCJrZXkiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiZmllbGRzIiwibCIsImxlbmd0aCIsIiRxdWVyeSIsIiRhbmQiLCIkYXNzb2NpYXRpb24iLCJtb2R1bGUiLCJleHBvcnRzIiwiYXBwIiwiYmFzZVJvdXRlIiwib3B0aW9ucyIsInNjaGVtYU5hbWUiLCJlbnRpdHlNb2RlbHMiLCJyb3V0ZXIiLCJwcmVmaXgiLCJ1c2VNaWRkbGV3YXJlIiwicmVzdEFwaVdyYXBwZXIiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwiYXBpTGlzdEVuZHBvaW50IiwibWV0YWRhdGFFbmRwb2ludCIsImRlc2NFbmRwb2ludCIsInJlYWRKc29uU3luYyIsInRvQWJzb2x1dGVQYXRoIiwiYWRkUm91dGUiLCJsaXN0IiwiZGIiLCJhcHBNb2R1bGUiLCJjb25maWciLCJlbnRpdHlOYW1lIiwiZW50aXR5TmFtZUluVXJsIiwia2ViYWJDYXNlIiwia2V5RmllbGROYW1lIiwidHlwZSIsIm1vZGVsIiwic2VsZWN0RnJvbSIsImtleUZpZWxkIiwic2luZ2xlVXJsIiwiYmF0Y2hVcmwiLCJkZXNjVXJsIiwidG9XZWJQYXRoIiwibWV0aG9kIiwidXJsIiwiYXBpRGVzYyIsInJlYWRPbmx5IiwiYm9keSIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsIkVudGl0eU1vZGVsIiwiam9pbldpdGgiLCJhc3NvY2lhdGlvbnMiLCJtYXBWYWx1ZXMiLCJkZXNjIiwiZGlzcGxheU5hbWUiLCJlbnYiLCJmaWx0ZXIiLCJ0aHJvdyIsIkJBRF9SRVFVRVNUIiwiZXhwb3NlIiwicXVlcnlPcHRpb25zIiwiJHVuYm94aW5nIiwiJHZhcmlhYmxlcyIsInNlc3Npb24iLCJzZXNzaW9uVmFyaWFibGVzIiwiZmluZEFsbF8iLCJrZXlWYWx1ZSIsImlkIiwiZmluZE9uZV8iLCJOT1RfRk9VTkQiLCJjcmVhdGVfIiwicmVxdWVzdCIsIiRyZXRyaWV2ZUNyZWF0ZWQiLCJkYXRhIiwidXBkYXRlXyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJkZWxldGVkIiwiZGVsZXRlXyIsInN0YXR1cyIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxPQUFUO0FBQWtCQyxFQUFBQTtBQUFsQixJQUFxQ0MsT0FBTyxDQUFDLFVBQUQsQ0FBbEQ7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsWUFBRCxDQUF0Qjs7QUFDQSxNQUFNRSxRQUFRLEdBQUdGLE9BQU8sQ0FBQyxtQkFBRCxDQUF4Qjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG9CQUFGO0FBQXdCQyxFQUFBQSxVQUF4QjtBQUFvQ0MsRUFBQUE7QUFBcEMsSUFBeURMLE9BQU8sQ0FBQyxXQUFELENBQXRFOztBQUNBLE1BQU1NLFNBQVMsR0FBR04sT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBT0EsU0FBU08sU0FBVCxDQUFtQkMsSUFBbkIsRUFBeUJDLEtBQXpCLEVBQWdD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LFdBQVcsR0FBR3ZCLEVBQUUsQ0FBQ1EsS0FBSCxDQUFTTCxVQUFULENBQWxCO0FBRUEsUUFBSTlDLEtBQUssR0FBRztBQUFFLE9BQUNrRSxXQUFXLENBQUNyRSxJQUFaLENBQWlCd0QsUUFBbEIsR0FBNkIxRCxHQUFHLENBQUNxRSxNQUFKLENBQVdvQjtBQUExQyxLQUFaO0FBRUEsUUFBSVMsT0FBTyxHQUFHLE1BQU0zQixXQUFXLENBQUM0QixPQUFaLENBQW9CO0FBQ3BDMUUsTUFBQUEsTUFBTSxFQUFFcEIsS0FENEI7QUFFcEMrRSxNQUFBQSxVQUFVLEVBQUU7QUFDUkMsUUFBQUEsT0FBTyxFQUFFckYsR0FBRyxDQUFDc0YsZ0JBREw7QUFFUjNFLFFBQUFBLEtBQUssRUFBRVgsR0FBRyxDQUFDVztBQUZIO0FBRndCLEtBQXBCLENBQXBCO0FBUUFYLElBQUFBLEdBQUcsQ0FBQ21FLElBQUosR0FBVztBQUFFaUMsTUFBQUEsTUFBTSxFQUFFLElBQVY7QUFBZ0JGLE1BQUFBO0FBQWhCLEtBQVg7QUFDSCxHQTFCRDtBQTRCQXBFLEVBQUFBLEdBQUcsQ0FBQ3VFLFNBQUosQ0FBY2xFLE1BQWQ7QUFDSCxDQXJXRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QsIE1ldGhvZE5vdEFsbG93ZWQgfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuY29uc3QgdmFsaWRhdG9yID0gcmVxdWlyZSgndmFsaWRhdG9yJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuZnVuY3Rpb24gZW5zdXJlSW50KG5hbWUsIHZhbHVlKSB7XG4gICAgbGV0IHNhbml0aXplZCA9IF8uaXNJbnRlZ2VyKHZhbHVlKSA/IHZhbHVlIDogdmFsaWRhdG9yLnRvSW50KHZhbHVlKTtcbiAgICBpZiAoaXNOYU4oc2FuaXRpemVkKSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgXCIke25hbWV9XCIgc2hvdWxkIGJlIGFuIGludGVnZXIuYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNhbml0aXplZDtcbn1cblxuZnVuY3Rpb24gcHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbywgbWV0YSkgeyAgICBcbiAgICBsZXQgY29uZGl0aW9uID0ge307XG4gICAgbGV0IHF1ZXJpZXMgPSBhcGlJbmZvLndoZXJlID8gWyBhcGlJbmZvLndoZXJlIF0gOiBbXTtcbiAgICBsZXQgYXNzb2NzID0gW107XG5cbiAgICBsZXQgeyAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcmV0dXJuVG90YWwgfSA9IGN0eC5xdWVyeTtcbiAgICAgICAgXG4gICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgIGxldCBvcmRlckJ5ID0gYXBpSW5mby5vcmRlckJ5WyRvcmRlckJ5XTtcbiAgICAgICAgaWYgKCFvcmRlckJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdChgT3JkZXIgYnkgXCIke29yZGVyQnl9XCIgaXMgbm90IHN1cHBvcnRlZC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IG9yZGVyQnk7XG4gICAgfSBlbHNlIGlmIChhcGlJbmZvLm9yZGVyQnkgJiYgYXBpSW5mby5vcmRlckJ5WyckZGVmYXVsdCddKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kb3JkZXJCeSA9IGFwaUluZm8ub3JkZXJCeVsnJGRlZmF1bHQnXTtcbiAgICB9XG5cbiAgICBpZiAoJG9mZnNldCkgeyAgICAgICAgXG4gICAgICAgIGNvbmRpdGlvbi4kb2Zmc2V0ID0gZW5zdXJlSW50KCckb2Zmc2V0JywgJG9mZnNldCk7XG4gICAgfVxuXG4gICAgaWYgKCRsaW1pdCkge1xuICAgICAgICBjb25kaXRpb24uJGxpbWl0ID0gZW5zdXJlSW50KCckbGltaXQnLCAkbGltaXQpO1xuICAgIH0gICAgXG5cbiAgICBpZiAoJHJldHVyblRvdGFsKSB7ICAgXG4gICAgICAgIGlmICgkcmV0dXJuVG90YWwgPT09ICcxJyB8fCAkcmV0dXJuVG90YWwgPT09ICd0cnVlJykge1xuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHsgICAgICAgIFxuICAgICAgICAgICAgY29uZGl0aW9uLiR0b3RhbENvdW50ID0gJHJldHVyblRvdGFsO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIGlmICghXy5pc0VtcHR5KGFwaUluZm8ucXVlcnkpKSB7XG4gICAgICAgIF8uZm9yT3duKGFwaUluZm8ucXVlcnksIChpbmZvLCBwYXJhbSkgPT4ge1xuICAgICAgICAgICAgaWYgKHBhcmFtIGluIGN0eC5xdWVyeSkge1xuICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaChpbmZvLndoZXJlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChtZXRhKSB7XG4gICAgICAgIF8uZm9yT3duKGN0eC5xdWVyeSwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnOicpICYmIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NzLnB1c2goa2V5LnN1YnN0cigxKSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGtleSBpbiBtZXRhLmZpZWxkcykge1xuICAgICAgICAgICAgICAgIHF1ZXJpZXMucHVzaCh7IFtrZXldOiB2YWx1ZSB9KTtcbiAgICAgICAgICAgIH0gXG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGxldCBsID0gcXVlcmllcy5sZW5ndGg7XG4gICAgaWYgKGwgPiAwKSB7XG4gICAgICAgIGNvbmRpdGlvbi4kcXVlcnkgPSBsID4gMSA/IHsgJGFuZDogcXVlcmllcyB9IDogcXVlcmllc1swXTtcbiAgICB9XG5cbiAgICBpZiAoYXNzb2NzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uZGl0aW9uLiRhc3NvY2lhdGlvbiA9IGFzc29jcztcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZGl0aW9uO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIFJFU1RmdWwgcm91dGVyLlxuICogQHBhcmFtIHsqfSBhcHAgXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZVJvdXRlIFxuICogQHBhcmFtIHtvYmplY3RzfSBvcHRpb25zIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnJlc291cmNlc1BhdGhdXG4gKiBAcHJvcGVydHkge29iamVjdHxhcnJheX0gW29wdGlvbnMubWlkZGxld2FyZXNdXG4gKiBAZXhhbXBsZVxuICogICc8YmFzZSBwYXRoPic6IHtcbiAqICAgICAgZ2F0ZXdheTogeyAgICAgICAgICBcbiAqICAgICAgICAgIG1pZGRsZXdhcmVzOiB7fSxcbiAqICAgICAgICAgIHNjaGVtYU5hbWU6ICcnLFxuICogICAgICAgICAgZW50aXR5TW9kZWxzOiB7fXw8Y29uZmlnIHBhdGg+LCAgXG4gKiAgICAgICAgICBhcGlMaXN0RW5kcG9pbnQ6ICcvX2xpc3QnLFxuICogICAgICAgICAgbWV0YWRhdGFFbmRwb2ludDogJy9fbWV0YSdcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBxdWVyeVxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZGV0YWlsXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICByZW1vdmUgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgaWYgKCFvcHRpb25zLnNjaGVtYU5hbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3Npbmcgc2NoZW1hIG5hbWUgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5zY2hlbWFOYW1lYFxuICAgICAgICApO1xuICAgIH0gICAgXG5cbiAgICBpZiAoIW9wdGlvbnMuZW50aXR5TW9kZWxzKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgICdNaXNzaW5nIGVudGl0eSBtb2RlbHMgY29uZmlnLicsXG4gICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICBgcm91dGluZy4ke2Jhc2VSb3V0ZX0uZ2F0ZXdheS5lbnRpdHlNb2RlbHNgXG4gICAgICAgICk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLnJlc3RBcGlXcmFwcGVyKCksICdyZXN0QXBpV3JhcHBlcicpO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgbGV0IGFwaUxpc3RFbmRwb2ludCA9IG9wdGlvbnMuYXBpTGlzdEVuZHBvaW50IHx8ICcvX2xpc3QnO1xuICAgIGxldCBtZXRhZGF0YUVuZHBvaW50ID0gb3B0aW9ucy5tZXRhZGF0YUVuZHBvaW50IHx8ICcvX2luZm8nO1xuICAgIGxldCBkZXNjRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9fZGVzYyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihlbnRpdHlNb2RlbHMsIChjb25maWcsIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIC8vdG9kbzogZmlsdGVyIGVudGl0eSBvciBtZXRob2RzIGJ5IGNvbmZpZ1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWVJblVybCA9IF8ua2ViYWJDYXNlKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkTmFtZTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSBjb25maWcua2V5IHx8IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKS5tZXRhLmtleUZpZWxkOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga2V5RmllbGROYW1lID0gZGIubW9kZWwoZW50aXR5TmFtZSkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH0gICAgICAgICAgXG5cbiAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9ICc6JyArIGtleUZpZWxkTmFtZTtcblxuICAgICAgICAgICAgbGV0IHNpbmdsZVVybCA9IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSk7XG4gICAgICAgICAgICBsZXQgYmF0Y2hVcmwgPSB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKTtcbiAgICAgICAgICAgIGxldCBkZXNjVXJsID0gYXBwLnRvV2ViUGF0aCh1cmxKb2luKGJhc2VSb3V0ZSwgJ19kZXNjJywgXy5rZWJhYkNhc2UoZW50aXR5TmFtZSkpKTtcblxuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2xpc3QnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IGJhdGNoVXJsLCBhcGlEZXNjOiBkZXNjVXJsIH0pO1xuICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RldGFpbCcsIG1ldGhvZDogJ2dldCcsIHVybDogc2luZ2xlVXJsIH0pO1xuXG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5yZWFkT25seSkge1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdjcmVhdGUnLCBtZXRob2Q6ICdwb3N0JywgdXJsOiBiYXRjaFVybCB9KTtcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goeyB0eXBlOiAndXBkYXRlJywgbWV0aG9kOiAncHV0JywgdXJsOiBzaW5nbGVVcmwgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RlbGV0ZScsIG1ldGhvZDogJ2RlbCcsIHVybDogc2luZ2xlVXJsIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjdHguYm9keSA9IGxpc3Q7XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgdXJsSm9pbihkZXNjRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3Q7ICAgICAgICBcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgY29uZmlnID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBsZXQgRW50aXR5TW9kZWw7XG5cbiAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGxpc3QgPSB7XG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAndmlldycsXG4gICAgICAgICAgICAgICAgJ21haW5FbnRpdHknOiBjb25maWcuc2VsZWN0RnJvbSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChjb25maWcuam9pbldpdGgpIHtcbiAgICAgICAgICAgICAgICBsaXN0LmFzc29jaWF0aW9ucyA9IGNvbmZpZy5qb2luV2l0aDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy53aGVyZSkge1xuICAgICAgICAgICAgICAgIGxpc3Qud2hlcmUgPSBjb25maWcud2hlcmU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25maWcua2V5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5rZXkgPSBjb25maWcua2V5O1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGNvbmZpZy5zZWxlY3RGcm9tKTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5xdWVyeSkge1xuICAgICAgICAgICAgICAgIGxpc3QucXVlcnkgPSBfLm1hcFZhbHVlcyhjb25maWcucXVlcnksIChpbmZvKSA9PiBpbmZvLmRlc2MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZmlnLm9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICBsaXN0Lm9yZGVyQnkgPSBjb25maWcub3JkZXJCeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxpc3QgPSB7XG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAnZW50aXR5JyxcbiAgICAgICAgICAgICAgICAnZW50aXR5JzogZW50aXR5TmFtZSAgICBcbiAgICAgICAgICAgIH07ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsaXN0LnF1ZXJ5ID0gXy5tYXBWYWx1ZXMoRW50aXR5TW9kZWwubWV0YS5maWVsZHMsIChpbmZvKSA9PiBpbmZvLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfSAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbGlzdDtcbiAgICB9KTtcblxuICAgIGlmIChhcHAuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCB1cmxKb2luKG1ldGFkYXRhRW5kcG9pbnQsICc6ZW50aXR5JyksIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuICAgICAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoKGFwaUluZm8udHlwZSAmJiBhcGlJbmZvLnR5cGUgPT09ICd2aWV3JykgPyBhcGlJbmZvLnNlbGVjdEZyb20gOiBlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGxldCBpbmZvID0gRW50aXR5TW9kZWwubWV0YTtcblxuICAgICAgICAgICAgaWYgKGN0eC5xdWVyeS5maWx0ZXIpIHtcbiAgICAgICAgICAgICAgICBpbmZvID0gZ2V0VmFsdWVCeVBhdGgoaW5mbywgY3R4LnF1ZXJ5LmZpbHRlcik7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEVtcHR5IGNvbnRlbnQuYCwgeyBleHBvc2U6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdHguYm9keSA9IGluZm87XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8vZ2V0IGxpc3QgICAgXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBxdWVyeU9wdGlvbnMsIEVudGl0eU1vZGVsO1xuXG4gICAgICAgIGlmIChhcGlJbmZvLnR5cGUgJiYgYXBpSW5mby50eXBlID09PSAndmlldycpIHtcbiAgICAgICAgICAgIGVudGl0eU5hbWUgPSBhcGlJbmZvLnNlbGVjdEZyb207XG5cbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ucHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbyksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgLi4ucHJvY2Vzc1F1ZXJ5KGN0eCwgYXBpSW5mbywgRW50aXR5TW9kZWwubWV0YSksXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcXVlcnlPcHRpb25zLiR2YXJpYWJsZXMgPSB7IFxuICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgIH07XG5cbiAgICAgICAgY3R4LmJvZHkgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kQWxsXyhxdWVyeU9wdGlvbnMpO1xuICAgIH0pO1xuXG4gICAgLy9nZXQgZGV0YWlsXG4gICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsICcvOmVudGl0eS86aWQnLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwsIHF1ZXJ5T3B0aW9ucywga2V5RmllbGQ7XG4gICAgICAgIGxldCBrZXlWYWx1ZSA9IGN0eC5wYXJhbXMuaWQ7ICAgICAgICBcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGtleUZpZWxkID0gYXBpSW5mby5rZXkgfHwgRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZDtcblxuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IHsgW2tleUZpZWxkXToga2V5VmFsdWUsIC4uLmFwaUluZm8ud2hlcmUgfSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgIGtleUZpZWxkID0gRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZDtcblxuICAgICAgICAgICAgbGV0IGFzc29jcyA9IFtdO1xuXG4gICAgICAgICAgICBfLmZvck93bihjdHgucXVlcnksICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCc6JykgJiYgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzb2NzLnB1c2goa2V5LnN1YnN0cigxKSk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBrZXlWYWx1ZSB9LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChhc3NvY3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy4kYXNzb2NpYXRpb24gPSBhc3NvY3M7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHF1ZXJ5T3B0aW9ucy4kdmFyaWFibGVzID0geyBcbiAgICAgICAgICAgIHNlc3Npb246IGN0eC5zZXNzaW9uVmFyaWFibGVzLFxuICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBtb2RlbCA9IGF3YWl0IEVudGl0eU1vZGVsLmZpbmRPbmVfKHF1ZXJ5T3B0aW9ucyk7ICAgICAgICBcbiAgICAgICAgaWYgKCFtb2RlbCkge1xuICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLk5PVF9GT1VORCwgYFwiJHtFbnRpdHlNb2RlbC5tZXRhLm5hbWV9XCIgd2l0aCBbJHtrZXlGaWVsZH09JHtrZXlWYWx1ZX1dIG5vdCBmb3VuZC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgfSBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9jcmVhdGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncG9zdCcsICcvOmVudGl0eScsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTsgICAgICAgXG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwuY3JlYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgICAgICR2YXJpYWJsZXM6IHsgXG4gICAgICAgICAgICAgICAgc2Vzc2lvbjogY3R4LnNlc3Npb25WYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgcXVlcnk6IGN0eC5xdWVyeVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHknLCBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZSA9IF8uY2FtZWxDYXNlKGN0eC5wYXJhbXMuZW50aXR5KTtcbiAgICAgICAgbGV0IGFwaUluZm8gPSBlbnRpdHlNb2RlbHNbZW50aXR5TmFtZV07XG4gICAgICAgIGlmICghYXBpSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoJ0VudGl0eSBlbmRwb2ludCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXBpSW5mby5yZWFkT25seSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGhvZE5vdEFsbG93ZWQoJ1RoaXMgaXMgYSByZWFkLW9ubHkgQVBJLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IEVudGl0eU1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7XG5cbiAgICAgICAgbGV0IHsgd2hlcmUsIGRhdGEgfSA9IGN0eC5yZXF1ZXN0LmJvZHk7XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhkYXRhLCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7IFxuICAgICAgICAgICAgJHF1ZXJ5OiB3aGVyZSwgXG4gICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2RlbGV0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdkZWwnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IGRlbGV0ZWQgPSBhd2FpdCBFbnRpdHlNb2RlbC5kZWxldGVfKHsgXG4gICAgICAgICAgICAkcXVlcnk6IHdoZXJlLFxuICAgICAgICAgICAgJHZhcmlhYmxlczogeyBcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBjdHguc2Vzc2lvblZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICBxdWVyeTogY3R4LnF1ZXJ5XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snLCBkZWxldGVkIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
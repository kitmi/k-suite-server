"use strict";

require("source-map-support/register");

const {
  _,
  fs,
  eachAsync_,
  urlJoin,
  getValueByPath
} = require('rk-utils');

const Router = require('koa-router');

const HttpCode = require('http-status-codes');

const {
  InvalidConfiguration,
  BadRequest,
  MethodNotAllowed
} = require('../Errors');

function mergeQuery(query, extra) {
  return query && query.$query ? {
    $query: { ...query.$query,
      ...extra
    }
  } : { ...query,
    ...extra
  };
}

module.exports = (app, baseRoute, options) => {
  if (!options.schemaName) {
    throw new InvalidConfiguration('Missing schema name config.', app, `routing.${baseRoute}.gateway.schemaName`);
  }

  if (!options.entityModels) {
    throw new InvalidConfiguration('Missing entity models config.', app, `routing.${baseRoute}.gateway.entityModels`);
  }

  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.restApiWrapper(), 'restApiWrapper');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let apiListEndpoint = options.apiListEndpoint || '/_list';
  let metadataEndpoint = options.metadataEndpoint || '/_info';
  let entityModels = options.entityModels;

  if (typeof options.entityModels === 'string') {
    entityModels = fs.readJsonSync(app.toAbsolutePath(options.entityModels));
  }

  app.addRoute(router, 'get', apiListEndpoint, async ctx => {
    let list = [];
    let db = ctx.appModule.db(options.schemaName);
    await eachAsync_(entityModels, async (config, entityName) => {
      let entityNameInUrl = _.kebabCase(entityName);

      let keyFieldName;

      if (config.type === 'view') {
        keyFieldName = config.key || db.model(config.selectFrom).meta.keyField;
      } else {
        keyFieldName = db.model(entityName).meta.keyField;
      }

      keyFieldName = ':' + keyFieldName;
      list.push({
        type: 'list',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl)
      });
      list.push({
        type: 'detail',
        method: 'get',
        url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
      });

      if (!config.readOnly) {
        list.push({
          type: 'create',
          method: 'post',
          url: urlJoin(baseRoute, entityNameInUrl)
        });
        list.push({
          type: 'update',
          method: 'put',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
        list.push({
          type: 'delete',
          method: 'del',
          url: urlJoin(baseRoute, entityNameInUrl, keyFieldName)
        });
      }
    });
    ctx.body = list;
  });

  if (app.env === 'development') {
    app.addRoute(router, 'get', urlJoin(metadataEndpoint, ':entity'), async ctx => {
      let entityName = _.camelCase(ctx.params.entity);

      if (!(entityName in entityModels)) {
        throw new BadRequest('Invalid entity endpoint.');
      }

      let db = ctx.appModule.db(options.schemaName);
      let EntityModel = db.model(entityName);
      let info = EntityModel.meta;

      if (ctx.query.filter) {
        info = getValueByPath(info, ctx.query.filter);

        if (!info) {
          ctx.throw(HttpCode.BAD_REQUEST, `Empty content.`, {
            expose: true
          });
        }
      }

      ctx.body = info;
    });
  }

  app.addRoute(router, 'get', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      queryOptions = { ...mergeQuery(ctx.query, apiInfo.where),
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = { ...ctx.query,
        $unboxing: true
      };
    }

    let EntityModel = db.model(entityName);
    ctx.body = await EntityModel.findAll_(queryOptions);
  });
  app.addRoute(router, 'get', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    let queryOptions;

    if (apiInfo.type && apiInfo.type === 'view') {
      entityName = apiInfo.selectFrom;
      let keyField = apiInfo.key || EntityModel.meta.keyField;
      queryOptions = {
        $query: {
          [keyField]: ctx.params.id,
          ...apiInfo.where
        },
        $unboxing: true,
        $association: apiInfo.joinWith
      };
    } else {
      queryOptions = {
        $query: {
          [EntityModel.meta.keyField]: ctx.params.id
        },
        $unboxing: true
      };
    }

    let model = await EntityModel.findOne_(queryOptions);

    if (!model) {
      ctx.throw(HttpCode.BAD_REQUEST, `Invalid "${ctx.params.entity}" id.`, {
        expose: true
      });
    }

    ctx.body = model;
  });
  app.addRoute(router, 'post', '/:entity', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let model = await EntityModel.create_(ctx.request.body, {
      $retrieveCreated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'put', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    let model = await EntityModel.update_(ctx.request.body, {
      $query: where,
      $retrieveUpdated: true
    });
    ctx.body = model;
  });
  app.addRoute(router, 'del', '/:entity/:id', async ctx => {
    let db = ctx.appModule.db(options.schemaName);

    let entityName = _.camelCase(ctx.params.entity);

    let apiInfo = entityModels[entityName];

    if (!apiInfo) {
      throw new BadRequest('Entity endpoint not found.');
    }

    if (apiInfo.readOnly) {
      throw new MethodNotAllowed('This is a read-only API.');
    }

    let EntityModel = db.model(entityName);
    let where = {
      [EntityModel.meta.keyField]: ctx.params.id
    };
    await EntityModel.delete_({
      $query: where
    });
    ctx.body = {
      status: 'OK'
    };
  });
  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL2dhdGV3YXkuanMiXSwibmFtZXMiOlsiXyIsImZzIiwiZWFjaEFzeW5jXyIsInVybEpvaW4iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJSb3V0ZXIiLCJIdHRwQ29kZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiQmFkUmVxdWVzdCIsIk1ldGhvZE5vdEFsbG93ZWQiLCJtZXJnZVF1ZXJ5IiwicXVlcnkiLCJleHRyYSIsIiRxdWVyeSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJiYXNlUm91dGUiLCJvcHRpb25zIiwic2NoZW1hTmFtZSIsImVudGl0eU1vZGVscyIsInJvdXRlciIsInByZWZpeCIsInVzZU1pZGRsZXdhcmUiLCJyZXN0QXBpV3JhcHBlciIsIm1pZGRsZXdhcmVzIiwidXNlTWlkZGxld2FyZXMiLCJhcGlMaXN0RW5kcG9pbnQiLCJtZXRhZGF0YUVuZHBvaW50IiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJhZGRSb3V0ZSIsImN0eCIsImxpc3QiLCJkYiIsImFwcE1vZHVsZSIsImNvbmZpZyIsImVudGl0eU5hbWUiLCJlbnRpdHlOYW1lSW5VcmwiLCJrZWJhYkNhc2UiLCJrZXlGaWVsZE5hbWUiLCJ0eXBlIiwia2V5IiwibW9kZWwiLCJzZWxlY3RGcm9tIiwibWV0YSIsImtleUZpZWxkIiwicHVzaCIsIm1ldGhvZCIsInVybCIsInJlYWRPbmx5IiwiYm9keSIsImVudiIsImNhbWVsQ2FzZSIsInBhcmFtcyIsImVudGl0eSIsIkVudGl0eU1vZGVsIiwiaW5mbyIsImZpbHRlciIsInRocm93IiwiQkFEX1JFUVVFU1QiLCJleHBvc2UiLCJhcGlJbmZvIiwicXVlcnlPcHRpb25zIiwid2hlcmUiLCIkdW5ib3hpbmciLCIkYXNzb2NpYXRpb24iLCJqb2luV2l0aCIsImZpbmRBbGxfIiwiaWQiLCJmaW5kT25lXyIsImNyZWF0ZV8iLCJyZXF1ZXN0IiwiJHJldHJpZXZlQ3JlYXRlZCIsInVw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Q0FBbEI7QUFFQSxRQUFJMkIsS0FBSyxHQUFHO0FBQUUsT0FBQ1IsV0FBVyxDQUFDWCxJQUFaLENBQWlCQyxRQUFsQixHQUE2QmQsR0FBRyxDQUFDc0IsTUFBSixDQUFXZTtBQUExQyxLQUFaO0FBRUEsVUFBTWIsV0FBVyxDQUFDb0IsT0FBWixDQUFvQjtBQUFFL0QsTUFBQUEsTUFBTSxFQUFFbUQ7QUFBVixLQUFwQixDQUFOO0FBRUFoQyxJQUFBQSxHQUFHLENBQUNtQixJQUFKLEdBQVc7QUFBRTBCLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQVg7QUFDSCxHQXBCRDtBQXNCQTdELEVBQUFBLEdBQUcsQ0FBQzhELFNBQUosQ0FBY3pELE1BQWQ7QUFDSCxDQWpPRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCB1cmxKb2luLCBnZXRWYWx1ZUJ5UGF0aCB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IEh0dHBDb2RlID0gcmVxdWlyZSgnaHR0cC1zdGF0dXMtY29kZXMnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24sIEJhZFJlcXVlc3QsIE1ldGhvZE5vdEFsbG93ZWQgfSA9IHJlcXVpcmUoJy4uL0Vycm9ycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbiBmdW5jdGlvbiBtZXJnZVF1ZXJ5KHF1ZXJ5LCBleHRyYSkge1xuICAgIHJldHVybiAocXVlcnkgJiYgcXVlcnkuJHF1ZXJ5KSA/IHsgJHF1ZXJ5OiB7IC4uLnF1ZXJ5LiRxdWVyeSwgLi4uZXh0cmEgfSB9IDogeyAuLi5xdWVyeSwgLi4uZXh0cmEgfTtcbiB9XG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICBnYXRld2F5OiB7ICAgICAgICAgIFxuICogICAgICAgICAgbWlkZGxld2FyZXM6IHt9LFxuICogICAgICAgICAgc2NoZW1hTmFtZTogJycsXG4gKiAgICAgICAgICBlbnRpdHlNb2RlbHM6IHt9fDxjb25maWcgcGF0aD4sICBcbiAqICAgICAgICAgIGFwaUxpc3RFbmRwb2ludDogJy9fbGlzdCcsXG4gKiAgICAgICAgICBtZXRhZGF0YUVuZHBvaW50OiAnL19tZXRhJ1xuICogICAgICB9XG4gKiAgfVxuICogIFxuICogIHJvdXRlICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwIG1ldGhvZCAgICBmdW5jdGlvbiBvZiBjdHJsXG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIHF1ZXJ5XG4gKiAgLzpyZXNvdXJjZSAgICAgICAgICAgICAgICAgICAgIHBvc3QgICAgICAgICAgIGNyZWF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBkZXRhaWxcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgcHV0ICAgICAgICAgICAgdXBkYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGRlbGV0ZSAgICAgICAgIHJlbW92ZSBcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoYXBwLCBiYXNlUm91dGUsIG9wdGlvbnMpID0+IHtcbiAgICBpZiAoIW9wdGlvbnMuc2NoZW1hTmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICAnTWlzc2luZyBzY2hlbWEgbmFtZSBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LnNjaGVtYU5hbWVgXG4gICAgICAgICk7XG4gICAgfSAgICBcblxuICAgIGlmICghb3B0aW9ucy5lbnRpdHlNb2RlbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgJ01pc3NpbmcgZW50aXR5IG1vZGVscyBjb25maWcuJyxcbiAgICAgICAgICAgIGFwcCxcbiAgICAgICAgICAgIGByb3V0aW5nLiR7YmFzZVJvdXRlfS5nYXRld2F5LmVudGl0eU1vZGVsc2BcbiAgICAgICAgKTsgICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgYXBwLnVzZU1pZGRsZXdhcmUocm91dGVyLCBhcHAucmVzdEFwaVdyYXBwZXIoKSwgJ3Jlc3RBcGlXcmFwcGVyJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgYXBpTGlzdEVuZHBvaW50ID0gb3B0aW9ucy5hcGlMaXN0RW5kcG9pbnQgfHwgJy9fbGlzdCc7XG4gICAgbGV0IG1ldGFkYXRhRW5kcG9pbnQgPSBvcHRpb25zLm1ldGFkYXRhRW5kcG9pbnQgfHwgJy9faW5mbyc7XG5cbiAgICBsZXQgZW50aXR5TW9kZWxzID0gb3B0aW9ucy5lbnRpdHlNb2RlbHM7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZW50aXR5TW9kZWxzID09PSAnc3RyaW5nJykge1xuICAgICAgICBlbnRpdHlNb2RlbHMgPSBmcy5yZWFkSnNvblN5bmMoYXBwLnRvQWJzb2x1dGVQYXRoKG9wdGlvbnMuZW50aXR5TW9kZWxzKSk7IFxuICAgIH1cblxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBhcGlMaXN0RW5kcG9pbnQsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGxpc3QgPSBbXTtcblxuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG4gICAgICAgIFxuICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGVudGl0eU1vZGVscywgYXN5bmMgKGNvbmZpZywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgLy90b2RvOiBmaWx0ZXIgZW50aXR5IG9yIG1ldGhvZHMgYnkgY29uZmlnXG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZUluVXJsID0gXy5rZWJhYkNhc2UoZW50aXR5TmFtZSk7XG4gICAgICAgICAgICBsZXQga2V5RmllbGROYW1lO1xuXG4gICAgICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09ICd2aWV3Jykge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGNvbmZpZy5rZXkgfHwgZGIubW9kZWwoY29uZmlnLnNlbGVjdEZyb20pLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGtleUZpZWxkTmFtZSA9IGRiLm1vZGVsKGVudGl0eU5hbWUpLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9ICAgICAgICAgIFxuXG4gICAgICAgICAgICBrZXlGaWVsZE5hbWUgPSAnOicgKyBrZXlGaWVsZE5hbWU7XG5cbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdsaXN0JywgbWV0aG9kOiAnZ2V0JywgdXJsOiB1cmxKb2luKGJhc2VSb3V0ZSwgZW50aXR5TmFtZUluVXJsKSB9KTtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICdkZXRhaWwnLCBtZXRob2Q6ICdnZXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSkgfSk7XG5cbiAgICAgICAgICAgIGlmICghY29uZmlnLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2NyZWF0ZScsIG1ldGhvZDogJ3Bvc3QnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwpIH0pO1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaCh7IHR5cGU6ICd1cGRhdGUnLCBtZXRob2Q6ICdwdXQnLCB1cmw6IHVybEpvaW4oYmFzZVJvdXRlLCBlbnRpdHlOYW1lSW5VcmwsIGtleUZpZWxkTmFtZSkgfSk7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHsgdHlwZTogJ2RlbGV0ZScsIG1ldGhvZDogJ2RlbCcsIHVybDogdXJsSm9pbihiYXNlUm91dGUsIGVudGl0eU5hbWVJblVybCwga2V5RmllbGROYW1lKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LmJvZHkgPSBsaXN0O1xuICAgIH0pO1xuXG4gICAgaWYgKGFwcC5lbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2dldCcsIHVybEpvaW4obWV0YWRhdGFFbmRwb2ludCwgJzplbnRpdHknKSwgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgICAgICBpZiAoIShlbnRpdHlOYW1lIGluIGVudGl0eU1vZGVscykpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnSW52YWxpZCBlbnRpdHkgZW5kcG9pbnQuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkYiA9IGN0eC5hcHBNb2R1bGUuZGIob3B0aW9ucy5zY2hlbWFOYW1lKTtcbiAgICAgICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuICAgICAgICAgICAgbGV0IGluZm8gPSBFbnRpdHlNb2RlbC5tZXRhO1xuXG4gICAgICAgICAgICBpZiAoY3R4LnF1ZXJ5LmZpbHRlcikge1xuICAgICAgICAgICAgICAgIGluZm8gPSBnZXRWYWx1ZUJ5UGF0aChpbmZvLCBjdHgucXVlcnkuZmlsdGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4LnRocm93KEh0dHBDb2RlLkJBRF9SRVFVRVNULCBgRW1wdHkgY29udGVudC5gLCB7IGV4cG9zZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGN0eC5ib2R5ID0gaW5mbztcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgLy9nZXQgbGlzdCAgICBcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucztcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgIC4uLm1lcmdlUXVlcnkoY3R4LnF1ZXJ5LCBhcGlJbmZvLndoZXJlKSxcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWUsIFxuICAgICAgICAgICAgICAgICRhc3NvY2lhdGlvbjogYXBpSW5mby5qb2luV2l0aFxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcXVlcnlPcHRpb25zID0geyBcbiAgICAgICAgICAgICAgICAuLi5jdHgucXVlcnksIFxuICAgICAgICAgICAgICAgICR1bmJveGluZzogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGN0eC5ib2R5ID0gYXdhaXQgRW50aXR5TW9kZWwuZmluZEFsbF8ocXVlcnlPcHRpb25zKTtcbiAgICB9KTtcblxuICAgIC8vZ2V0IGRldGFpbFxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucztcblxuICAgICAgICBpZiAoYXBpSW5mby50eXBlICYmIGFwaUluZm8udHlwZSA9PT0gJ3ZpZXcnKSB7XG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gYXBpSW5mby5zZWxlY3RGcm9tO1xuICAgICAgICAgICAgbGV0IGtleUZpZWxkID0gYXBpSW5mby5rZXkgfHwgRW50aXR5TW9kZWwubWV0YS5rZXlGaWVsZFxuXG4gICAgICAgICAgICBxdWVyeU9wdGlvbnMgPSB7IFxuICAgICAgICAgICAgICAgICRxdWVyeTogeyBba2V5RmllbGRdOiBjdHgucGFyYW1zLmlkLCAuLi5hcGlJbmZvLndoZXJlIH0sXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiB0cnVlLCBcbiAgICAgICAgICAgICAgICAkYXNzb2NpYXRpb246IGFwaUluZm8uam9pbldpdGhcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucyA9IHsgXG4gICAgICAgICAgICAgICAgJHF1ZXJ5OiB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9LCBcbiAgICAgICAgICAgICAgICAkdW5ib3hpbmc6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5maW5kT25lXyhxdWVyeU9wdGlvbnMpOyAgICAgICAgXG4gICAgICAgIGlmICghbW9kZWwpIHtcbiAgICAgICAgICAgIGN0eC50aHJvdyhIdHRwQ29kZS5CQURfUkVRVUVTVCwgYEludmFsaWQgXCIke2N0eC5wYXJhbXMuZW50aXR5fVwiIGlkLmAsIHsgZXhwb3NlOiB0cnVlIH0pO1xuICAgICAgICB9IFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL2NyZWF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwb3N0JywgJy86ZW50aXR5JywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICBcblxuICAgICAgICBsZXQgbW9kZWwgPSBhd2FpdCBFbnRpdHlNb2RlbC5jcmVhdGVfKGN0eC5yZXF1ZXN0LmJvZHksIHsgJHJldHJpZXZlQ3JlYXRlZDogdHJ1ZSB9KTsgICAgICAgIFxuXG4gICAgICAgIGN0eC5ib2R5ID0gbW9kZWw7XG4gICAgfSk7XG5cbiAgICAvL3VwZGF0ZVxuICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdwdXQnLCAnLzplbnRpdHkvOmlkJywgYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICBsZXQgZGIgPSBjdHguYXBwTW9kdWxlLmRiKG9wdGlvbnMuc2NoZW1hTmFtZSk7XG5cbiAgICAgICAgbGV0IGVudGl0eU5hbWUgPSBfLmNhbWVsQ2FzZShjdHgucGFyYW1zLmVudGl0eSk7XG4gICAgICAgIGxldCBhcGlJbmZvID0gZW50aXR5TW9kZWxzW2VudGl0eU5hbWVdO1xuICAgICAgICBpZiAoIWFwaUluZm8pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0KCdFbnRpdHkgZW5kcG9pbnQgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBNZXRob2ROb3RBbGxvd2VkKCdUaGlzIGlzIGEgcmVhZC1vbmx5IEFQSS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBFbnRpdHlNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGxldCB3aGVyZSA9IHsgW0VudGl0eU1vZGVsLm1ldGEua2V5RmllbGRdOiBjdHgucGFyYW1zLmlkIH07XG5cbiAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgRW50aXR5TW9kZWwudXBkYXRlXyhjdHgucmVxdWVzdC5ib2R5LCB7ICRxdWVyeTogd2hlcmUsICRyZXRyaWV2ZVVwZGF0ZWQ6IHRydWUgfSk7ICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgLy9kZWxldGVcbiAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZGVsJywgJy86ZW50aXR5LzppZCcsIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgbGV0IGRiID0gY3R4LmFwcE1vZHVsZS5kYihvcHRpb25zLnNjaGVtYU5hbWUpO1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lID0gXy5jYW1lbENhc2UoY3R4LnBhcmFtcy5lbnRpdHkpO1xuICAgICAgICBsZXQgYXBpSW5mbyA9IGVudGl0eU1vZGVsc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgaWYgKCFhcGlJbmZvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdCgnRW50aXR5IGVuZHBvaW50IG5vdCBmb3VuZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhcGlJbmZvLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWV0aG9kTm90QWxsb3dlZCgnVGhpcyBpcyBhIHJlYWQtb25seSBBUEkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgRW50aXR5TW9kZWwgPSBkYi5tb2RlbChlbnRpdHlOYW1lKTtcblxuICAgICAgICBsZXQgd2hlcmUgPSB7IFtFbnRpdHlNb2RlbC5tZXRhLmtleUZpZWxkXTogY3R4LnBhcmFtcy5pZCB9O1xuXG4gICAgICAgIGF3YWl0IEVudGl0eU1vZGVsLmRlbGV0ZV8oeyAkcXVlcnk6IHdoZXJlIH0pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICBjdHguYm9keSA9IHsgc3RhdHVzOiAnT0snIH07XG4gICAgfSk7ICAgXG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const Literal = require('../enum/Literal');

const Router = require('koa-router');

const Controller = require('../patterns/Controller');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const {
  hasMethod
} = require('../utils/Helpers');

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });
  app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(), 'jsonError');

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPath = path.relative(resourcePath, file);
    let batchUrl = Util.ensureLeftSlash(relPath.substring(0, relPath.length - 3).split(path.sep).map(p => _.kebabCase(p)).join('/'));
    let singleUrl = batchUrl + '/:id';

    let controller = require(file);

    let isObj = false;

    if (controller.prototype instanceof Controller) {
      controller = new controller(app);
      isObj = true;
    }

    if (hasMethod(controller, 'query')) {
      app.addRoute(router, 'get', batchUrl, isObj ? controller.query.bind(controller) : controller.query);
    }

    if (hasMethod(controller, 'create')) {
      app.addRoute(router, 'post', batchUrl, isObj ? controller.create.bind(controller) : controller.create);
    }

    if (hasMethod(controller, 'detail')) {
      app.addRoute(router, 'get', singleUrl, isObj ? controller.detail.bind(controller) : controller.detail);
    }

    if (hasMethod(controller, 'update')) {
      app.addRoute(router, 'put', singleUrl, isObj ? controller.update.bind(controller) : controller.update);
    }

    if (hasMethod(controller, 'remove')) {
      app.addRoute(router, 'del', singleUrl, isObj ? controller.remove.bind(controller) : controller.remove);
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3Jlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJMaXRlcmFsIiwiUm91dGVyIiwiQ29udHJvbGxlciIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiaGFzTWV0aG9kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJyZXNvdXJjZVBhdGgiLCJyZXNvbHZlIiwiYmFja2VuZFBhdGgiLCJyZXNvdXJjZXNQYXRoIiwiUkVTT1VSQ0VTX1BBVEgiLCJyb3V0ZXIiLCJwcmVmaXgiLCJ1c2VNaWRkbGV3YXJlIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwiam9pbiIsImZpbGVzIiwiZ2xvYiIsInN5bmMiLCJub2RpciIsImVhY2giLCJmaWxlIiwicmVsUGF0aCIsInJlbGF0aXZlIiwiYmF0Y2hVcmwiLCJlbnN1cmVMZWZ0U2xhc2giLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJzcGxpdCIsInNlcCIsIm1hcCIsInAiLCJrZWJhYkNhc2UiLCJzaW5nbGVVcmwiLCJjb250cm9sbGVyIiwiaXNPYmoiLCJwcm90b3R5cGUiLCJhZGRSb3V0ZSIsInF1ZXJ5IiwiYmluZCIsImNyZWF0ZSIsImRldGFpbCIsInVwZGF0ZSIsInJlbW92ZSIsImFkZFJvdXRlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsQ0FBQyxHQUFHRCxJQUFJLENBQUNDLENBQWY7QUFDQSxNQUFNQyxPQUFPLEdBQUdGLElBQUksQ0FBQ0UsT0FBckI7O0FBQ0EsTUFBTUMsT0FBTyxHQUFHSixPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsTUFBTUssTUFBTSxH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cmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgXyA9IFV0aWwuXztcbmNvbnN0IFByb21pc2UgPSBVdGlsLlByb21pc2U7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKCdrb2Etcm91dGVyJyk7XG5jb25zdCBDb250cm9sbGVyID0gcmVxdWlyZSgnLi4vcGF0dGVybnMvQ29udHJvbGxlcicpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5jb25zdCB7IGhhc01ldGhvZCB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIFJFU1RmdWwgcm91dGVyLlxuICogQG1vZHVsZSBSb3V0ZXJfUmVzdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgUkVTVGZ1bCByb3V0ZXIuXG4gKiBAcGFyYW0geyp9IGFwcCBcbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUm91dGUgXG4gKiBAcGFyYW0ge29iamVjdHN9IG9wdGlvbnMgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucmVzb3VyY2VzUGF0aF1cbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fGFycmF5fSBbb3B0aW9ucy5taWRkbGV3YXJlc11cbiAqIEBleGFtcGxlXG4gKiAgJzxiYXNlIHBhdGg+Jzoge1xuICogICAgICByZXN0OiB7XG4gKiAgICAgICAgICByZXNvdXJjZXNQYXRoOlxuICogICAgICAgICAgbWlkZGxld2FyZXM6XG4gKiAgICAgIH1cbiAqICB9XG4gKiAgXG4gKiAgcm91dGUgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAgbWV0aG9kICAgIGZ1bmN0aW9uIG9mIGN0cmxcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgcXVlcnlcbiAqICAvOnJlc291cmNlICAgICAgICAgICAgICAgICAgICAgcG9zdCAgICAgICAgICAgY3JlYXRlXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIGdldCAgICAgICAgICAgIGRldGFpbFxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBwdXQgICAgICAgICAgICB1cGRhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZGVsZXRlICAgICAgICAgcmVtb3ZlIFxuICovXG5tb2R1bGUuZXhwb3J0cyA9IChhcHAsIGJhc2VSb3V0ZSwgb3B0aW9ucykgPT4ge1xuICAgIGxldCByZXNvdXJjZVBhdGggPSBwYXRoLnJlc29sdmUoYXBwLmJhY2tlbmRQYXRoLCBvcHRpb25zLnJlc291cmNlc1BhdGggfHwgTGl0ZXJhbC5SRVNPVVJDRVNfUEFUSCk7XG4gICAgXG4gICAgbGV0IHJvdXRlciA9IGJhc2VSb3V0ZSA9PT0gJy8nID8gbmV3IFJvdXRlcigpIDogbmV3IFJvdXRlcih7cHJlZml4OiBiYXNlUm91dGV9KTtcblxuICAgIGFwcC51c2VNaWRkbGV3YXJlKHJvdXRlciwgYXBwLmdldE1pZGRsZXdhcmVGYWN0b3J5KCdqc29uRXJyb3InKSgpLCAnanNvbkVycm9yJyk7XG5cbiAgICBpZiAob3B0aW9ucy5taWRkbGV3YXJlcykge1xuICAgICAgICBhcHAudXNlTWlkZGxld2FyZXMocm91dGVyLCBvcHRpb25zLm1pZGRsZXdhcmVzKTtcbiAgICB9XG5cbiAgICBsZXQgcmVzb3VyY2VzUGF0aCA9IHBhdGguam9pbihyZXNvdXJjZVBhdGgsIFwiKipcIiwgXCIqLmpzXCIpO1xuICAgIGxldCBmaWxlcyA9IFV0aWwuZ2xvYi5zeW5jKHJlc291cmNlc1BhdGgsIHtub2RpcjogdHJ1ZX0pO1xuXG4gICAgXy5lYWNoKGZpbGVzLCBmaWxlID0+IHtcbiAgICAgICAgbGV0IHJlbFBhdGggPSBwYXRoLnJlbGF0aXZlKHJlc291cmNlUGF0aCwgZmlsZSk7ICAgICAgICAgIFxuICAgICAgICBsZXQgYmF0Y2hVcmwgPSBVdGlsLmVuc3VyZUxlZnRTbGFzaChyZWxQYXRoLnN1YnN0cmluZygwLCByZWxQYXRoLmxlbmd0aCAtIDMpLnNwbGl0KHBhdGguc2VwKS5tYXAocCA9PiBfLmtlYmFiQ2FzZShwKSkuam9pbignLycpKTtcbiAgICAgICAgbGV0IHNpbmdsZVVybCA9IGJhdGNoVXJsICsgJy86aWQnOyBcbiAgICAgICAgXG4gICAgICAgIGxldCBjb250cm9sbGVyID0gcmVxdWlyZShmaWxlKTtcbiAgICAgICAgbGV0IGlzT2JqID0gZmFsc2U7XG4gICAgXG4gICAgICAgIGlmIChjb250cm9sbGVyLnByb3RvdHlwZSBpbnN0YW5jZW9mIENvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBuZXcgY29udHJvbGxlcihhcHApO1xuICAgICAgICAgICAgaXNPYmogPSB0cnVlO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdxdWVyeScpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmF0Y2hVcmwsIGlzT2JqID8gY29udHJvbGxlci5xdWVyeS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5xdWVyeSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdjcmVhdGUnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCBiYXRjaFVybCwgaXNPYmogPyBjb250cm9sbGVyLmNyZWF0ZS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5jcmVhdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZGV0YWlsJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBzaW5nbGVVcmwsIGlzT2JqID8gY29udHJvbGxlci5kZXRhaWwuYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuZGV0YWlsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ3VwZGF0ZScpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0Jywgc2luZ2xlVXJsLCBpc09iaiA/IGNvbnRyb2xsZXIudXBkYXRlLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLnVwZGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdyZW1vdmUnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsIHNpbmdsZVVybCwgaXNPYmogPyBjb250cm9sbGVyLnJlbW92ZS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5yZW1vdmUpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const _ = Util._;
const Promise = Util.Promise;

const Literal = require('../enum/Literal');

const Router = require('koa-router');

const Controller = require('../patterns/Controller');

const {
  InvalidConfiguration
} = require('../Errors');

const {
  hasMethod
} = require('../utils/Helpers');

module.exports = (app, baseRoute, options) => {
  let resourcePath = path.resolve(app.backendPath, options.resourcesPath || Literal.RESOURCES_PATH);
  let router = baseRoute === '/' ? new Router() : new Router({
    prefix: baseRoute
  });

  if (options.middlewares) {
    app.useMiddlewares(router, options.middlewares);
  }

  router.use((ctx, next) => {
    ctx.type = 'application/json';
    return next();
  });
  let resourcesPath = path.join(resourcePath, "**", "*.js");
  let files = Util.glob.sync(resourcesPath, {
    nodir: true
  });

  _.each(files, file => {
    let relPath = path.relative(resourcePath, file);
    let batchUrl = Util.ensureLeftSlash(relPath.substring(0, relPath.length - 3).split(path.sep).map(p => _.kebabCase(p)).join('/'));
    let singleUrl = batchUrl + '/:id';

    let controller = require(file);

    let isObj = false;

    if (controller.prototype instanceof Controller) {
      controller = new controller(app);
      isObj = true;
    }

    if (hasMethod(controller, 'query')) {
      app.addRoute(router, 'get', batchUrl, isObj ? controller.query.bind(controller) : controller.query);
    }

    if (hasMethod(controller, 'create')) {
      app.addRoute(router, 'post', batchUrl, isObj ? controller.create.bind(controller) : controller.create);
    }

    if (hasMethod(controller, 'detail')) {
      app.addRoute(router, 'get', singleUrl, isObj ? controller.detail.bind(controller) : controller.detail);
    }

    if (hasMethod(controller, 'update')) {
      app.addRoute(router, 'put', singleUrl, isObj ? controller.update.bind(controller) : controller.update);
    }

    if (hasMethod(controller, 'remove')) {
      app.addRoute(router, 'del', singleUrl, isObj ? controller.remove.bind(controller) : controller.remove);
    }
  });

  app.addRouter(router);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL3Jlc3QuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJVdGlsIiwiXyIsIlByb21pc2UiLCJMaXRlcmFsIiwiUm91dGVyIiwiQ29udHJvbGxlciIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiaGFzTWV0aG9kIiwibW9kdWxlIiwiZXhwb3J0cyIsImFwcCIsImJhc2VSb3V0ZSIsIm9wdGlvbnMiLCJyZXNvdXJjZVBhdGgiLCJyZXNvbHZlIiwiYmFja2VuZFBhdGgiLCJyZXNvdXJjZXNQYXRoIiwiUkVTT1VSQ0VTX1BBVEgiLCJyb3V0ZXIiLCJwcmVmaXgiLCJtaWRkbGV3YXJlcyIsInVzZU1pZGRsZXdhcmVzIiwidXNlIiwiY3R4IiwibmV4dCIsInR5cGUiLCJqb2luIiwiZmlsZXMiLCJnbG9iIiwic3luYyIsIm5vZGlyIiwiZWFjaCIsImZpbGUiLCJyZWxQYXRoIiwicmVsYXRpdmUiLCJiYXRjaFVybCIsImVuc3VyZUxlZnRTbGFzaCIsInN1YnN0cmluZyIsImxlbmd0aCIsInNwbGl0Iiwic2VwIiwibWFwIiwicCIsImtlYmFiQ2FzZSIsInNpbmdsZVVybCIsImNvbnRyb2xsZXIiLCJpc09iaiIsInByb3RvdHlwZSIsImFkZFJvdXRlIiwicXVlcnkiLCJiaW5kIiwiY3JlYXRlIiwiZGV0YWlsIiwidXBkYXRlIiwicmVtb3ZlIiwiYWRkUm91dGVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxDQUFDLEdBQUdELElBQUksQ0FBQ0MsQ0FBZjtBQUNBLE1BQU1DLE9BQU8sR0FBR0YsSUFBSSxDQUFDRSxPQUFyQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdKLE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNSyxNQUFNLEdBQUdMLE9BQU8sQ0FB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dFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBfID0gVXRpbC5fO1xuY29uc3QgUHJvbWlzZSA9IFV0aWwuUHJvbWlzZTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuLi9lbnVtL0xpdGVyYWwnKTtcbmNvbnN0IFJvdXRlciA9IHJlcXVpcmUoJ2tvYS1yb3V0ZXInKTtcbmNvbnN0IENvbnRyb2xsZXIgPSByZXF1aXJlKCcuLi9wYXR0ZXJucy9Db250cm9sbGVyJyk7XG5jb25zdCB7IEludmFsaWRDb25maWd1cmF0aW9uIH0gPSByZXF1aXJlKCcuLi9FcnJvcnMnKTtcbmNvbnN0IHsgaGFzTWV0aG9kIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5cbi8qKlxuICogUkVTVGZ1bCByb3V0ZXIuXG4gKiBAbW9kdWxlIFJvdXRlcl9SZXN0XG4gKi9cblxuLyoqXG4gKiBDcmVhdGUgYSBSRVNUZnVsIHJvdXRlci5cbiAqIEBwYXJhbSB7Kn0gYXBwIFxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2VSb3V0ZSBcbiAqIEBwYXJhbSB7b2JqZWN0c30gb3B0aW9ucyBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5yZXNvdXJjZXNQYXRoXVxuICogQHByb3BlcnR5IHtvYmplY3R8YXJyYXl9IFtvcHRpb25zLm1pZGRsZXdhcmVzXVxuICogQGV4YW1wbGVcbiAqICAnPGJhc2UgcGF0aD4nOiB7XG4gKiAgICAgIHJlc3Q6IHtcbiAqICAgICAgICAgIHJlc291cmNlc1BhdGg6XG4gKiAgICAgICAgICBtaWRkbGV3YXJlczpcbiAqICAgICAgfVxuICogIH1cbiAqICBcbiAqICByb3V0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cCBtZXRob2QgICAgZnVuY3Rpb24gb2YgY3RybFxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBnZXQgICAgICAgICAgICBxdWVyeVxuICogIC86cmVzb3VyY2UgICAgICAgICAgICAgICAgICAgICBwb3N0ICAgICAgICAgICBjcmVhdGVcbiAqICAvOnJlc291cmNlLzppZCAgICAgICAgICAgICAgICAgZ2V0ICAgICAgICAgICAgZGV0YWlsXG4gKiAgLzpyZXNvdXJjZS86aWQgICAgICAgICAgICAgICAgIHB1dCAgICAgICAgICAgIHVwZGF0ZVxuICogIC86cmVzb3VyY2UvOmlkICAgICAgICAgICAgICAgICBkZWxldGUgICAgICAgICByZW1vdmUgXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gKGFwcCwgYmFzZVJvdXRlLCBvcHRpb25zKSA9PiB7XG4gICAgbGV0IHJlc291cmNlUGF0aCA9IHBhdGgucmVzb2x2ZShhcHAuYmFja2VuZFBhdGgsIG9wdGlvbnMucmVzb3VyY2VzUGF0aCB8fCBMaXRlcmFsLlJFU09VUkNFU19QQVRIKTtcbiAgICBcbiAgICBsZXQgcm91dGVyID0gYmFzZVJvdXRlID09PSAnLycgPyBuZXcgUm91dGVyKCkgOiBuZXcgUm91dGVyKHtwcmVmaXg6IGJhc2VSb3V0ZX0pO1xuXG4gICAgaWYgKG9wdGlvbnMubWlkZGxld2FyZXMpIHtcbiAgICAgICAgYXBwLnVzZU1pZGRsZXdhcmVzKHJvdXRlciwgb3B0aW9ucy5taWRkbGV3YXJlcyk7XG4gICAgfVxuXG4gICAgcm91dGVyLnVzZSgoY3R4LCBuZXh0KSA9PiB7IGN0eC50eXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOyByZXR1cm4gbmV4dCgpOyB9KTtcblxuICAgIGxldCByZXNvdXJjZXNQYXRoID0gcGF0aC5qb2luKHJlc291cmNlUGF0aCwgXCIqKlwiLCBcIiouanNcIik7XG4gICAgbGV0IGZpbGVzID0gVXRpbC5nbG9iLnN5bmMocmVzb3VyY2VzUGF0aCwge25vZGlyOiB0cnVlfSk7XG5cbiAgICBfLmVhY2goZmlsZXMsIGZpbGUgPT4ge1xuICAgICAgICBsZXQgcmVsUGF0aCA9IHBhdGgucmVsYXRpdmUocmVzb3VyY2VQYXRoLCBmaWxlKTsgICAgICAgICAgXG4gICAgICAgIGxldCBiYXRjaFVybCA9IFV0aWwuZW5zdXJlTGVmdFNsYXNoKHJlbFBhdGguc3Vic3RyaW5nKDAsIHJlbFBhdGgubGVuZ3RoIC0gMykuc3BsaXQocGF0aC5zZXApLm1hcChwID0+IF8ua2ViYWJDYXNlKHApKS5qb2luKCcvJykpO1xuICAgICAgICBsZXQgc2luZ2xlVXJsID0gYmF0Y2hVcmwgKyAnLzppZCc7IFxuICAgICAgICBcbiAgICAgICAgbGV0IGNvbnRyb2xsZXIgPSByZXF1aXJlKGZpbGUpO1xuICAgICAgICBsZXQgaXNPYmogPSBmYWxzZTtcbiAgICBcbiAgICAgICAgaWYgKGNvbnRyb2xsZXIucHJvdG90eXBlIGluc3RhbmNlb2YgQ29udHJvbGxlcikge1xuICAgICAgICAgICAgY29udHJvbGxlciA9IG5ldyBjb250cm9sbGVyKGFwcCk7XG4gICAgICAgICAgICBpc09iaiA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdxdWVyeScpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAnZ2V0JywgYmF0Y2hVcmwsIGlzT2JqID8gY29udHJvbGxlci5xdWVyeS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5xdWVyeSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdjcmVhdGUnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ3Bvc3QnLCBiYXRjaFVybCwgaXNPYmogPyBjb250cm9sbGVyLmNyZWF0ZS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5jcmVhdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc01ldGhvZChjb250cm9sbGVyLCAnZGV0YWlsJykpIHtcbiAgICAgICAgICAgIGFwcC5hZGRSb3V0ZShyb3V0ZXIsICdnZXQnLCBzaW5nbGVVcmwsIGlzT2JqID8gY29udHJvbGxlci5kZXRhaWwuYmluZChjb250cm9sbGVyKSA6IGNvbnRyb2xsZXIuZGV0YWlsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNNZXRob2QoY29udHJvbGxlciwgJ3VwZGF0ZScpKSB7XG4gICAgICAgICAgICBhcHAuYWRkUm91dGUocm91dGVyLCAncHV0Jywgc2luZ2xlVXJsLCBpc09iaiA/IGNvbnRyb2xsZXIudXBkYXRlLmJpbmQoY29udHJvbGxlcikgOiBjb250cm9sbGVyLnVwZGF0ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaGFzTWV0aG9kKGNvbnRyb2xsZXIsICdyZW1vdmUnKSkge1xuICAgICAgICAgICAgYXBwLmFkZFJvdXRlKHJvdXRlciwgJ2RlbCcsIHNpbmdsZVVybCwgaXNPYmogPyBjb250cm9sbGVyLnJlbW92ZS5iaW5kKGNvbnRyb2xsZXIpIDogY29udHJvbGxlci5yZW1vdmUpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBhcHAuYWRkUm91dGVyKHJvdXRlcik7XG59OyJdfQ==
"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const Errors = require('./utils/Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.backendPath = this.toAbsolutePath(this.options.backendPath || Literal.BACKEND_PATH);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = this.toAbsolutePath(Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else {
          if (!(_.isPlainObject(middlewareEntry) && 'name' in middlewareEntry)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.indexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      ctx.toUrl = (relativePath, ...pathOrQuery) => {
        return ctx.origin + this.toWebPath(relativePath, pathOrQuery);
      };

      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.toUrl(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return (ctx, next) => {
        this.log('debug', `Calling "${name || middleware.name}" ...`);
        return middleware(ctx, next);
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([this.toAbsolutePath(Literal.BACKEND_PATH, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwidXJsQXBwZW5kUXVlcnkiLCJ0cnlSZXF1aXJlIiwiRXJyb3JzIiwiTGl0ZXJhbCIsIktvYSIsIlJvdXRhYmxlIiwiVCIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJiYWNrZW5kUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiQkFDS0VORF9QQVRIIiwiY2xpZW50UGF0aCIsIkNMSUVOVF9TUkNfUEFUSCIsInB1YmxpY1BhdGgiLCJQVUJMSUNfUEFUSCIsInJvdXRlciIsInVzZSIsImN0eCIsIm5leHQiLCJhcHBNb2R1bGUiLCJvbiIsIm1pZGRsZXdhcmVEaXIiLCJNSURETEVXQVJFU19QQVRIIiwiZXhpc3RzU3luYyIsImxvYWRNaWRkbGV3YXJlc0Zyb20iLCJzdGFydF8iLCJtaWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Iiwic3RvcF8iLCJkaXIiLCJmaWxlcyIsInN5bmMiLCJqb2luIiwibm9kaXIiLCJmb3JFYWNoIiwiZmlsZSIsInJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkiLCJiYXNlbmFtZSIsImZhY3RvcnlNZXRob2QiLCJTZXJ2ZXJFcnJvciIsImxvZyIsImdldE1pZGRsZXdhcmVGYWN0b3J5IiwiaGFzT3duUHJvcGVydHkiLCJzZXJ2ZXIiLCJucG1NaWRkbGV3YXJlIiwidXNlTWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmVGYWN0b3J5IiwibWlkZGxld2FyZSIsIm1pZGRsZXdhcmVGdW5jdGlvbnMiLCJpc1BsYWluT2JqZWN0IiwiZm9yT3duIiwicHVzaCIsImNhc3RBcnJheSIsImVhY2giLCJtaWRkbGV3YXJlRW50cnkiLCJ0eXBlIiwidW5kZWZpbmVkIiwiQXJyYXkiLCJpc0FycmF5IiwibSIsInVzZU1pZGRsZXdhcmUiLCJhZGRSb3V0ZSIsIm1ldGhvZCIsInJvdXRlIiwiYWN0aW9ucyIsImhhbmRsZXJzIiwiX3dyYXBNaWRkbGV3YXJlVHJhY2VyIiwibGFzdEluZGV4IiwibGVuZ3RoIiwiYWN0aW9uIiwiaSIsImluZGV4T2YiLCJtaWRkbGV3YXJlSXRlbSIsImVuZHBvaW50Iiwib3B0cyIsInByZWZpeCIsImFkZFJvdXRlciIsIm5lc3RlZFJvdXRlciIsInJvdXRlcyIsImFsbG93ZWRNZXRob2RzIiwidG9XZWJQYXRoIiwicmVsYXRpdmVQYXRoIiwicGF0aE9yUXVlcnkiLCJ1cmwiLCJxdWVyeSIsImlzT2JqZWN0IiwicG9wIiwidW5zaGlmdCIsInJlcGxhY2UiLCJ3cmFwQWN0aW9uIiwidG9VcmwiLCJvcmlnaW4iLCJPYmplY3QiLCJhc3NpZ24iLCJzdGF0ZSIsIl9zZWxmIiwib3JpZ2luYWxVcmwiLCJfXyIsIl9tYWtlUGF0aCIsIl9tYWtlVXJsIiwiY3NyZiIsIl9jc3JmIiwidHJhY2VNaWRkbGV3YXJlcyIsIl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoIiwiY29uY2F0IiwiRkVBVFVSRVNfUEFUSCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxJQUFUO0FBQWVDLEVBQUFBLE9BQWY7QUFBd0JDLEVBQUFBLGVBQXhCO0FBQXlDQyxFQUFBQTtBQUF6QyxJQUE0RE4sT0FBTyxDQUFDLFVBQUQsQ0FBekU7O0FBQ0EsTUFBTTtBQUFFTyxFQUFBQTtBQUFGLElBQWlCUCxPQUFPLENBQUMsZ0NBQUQsQ0FBOUI7O0FBQ0EsTUFBTVEsTUFBTSxHQUFHUixPQUFPLENBQUMsZ0JBQUQsQ0FBdEI7O0FBQ0EsTUFBTVMsT0FBTyxHQUFHVCxPQUFPLENBQUMsZ0JBQUQsQ0FBdkI7O0FBQ0EsTUFBTVUsR0FBRyxHQUFHVixPQUFPLENBQUMsS0FBRCxDQUFu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QyxNQUFELEVBQVNnQyxVQUFULEVBQXFCekMsSUFBckIsRUFBMkI7QUFBQSxVQUM1QixPQUFPeUMsVUFBUCxLQUFzQixVQURNO0FBQUEsc0JBQ01BLFVBRE47QUFBQTs7QUFFcENoQyxJQUFBQSxNQUFNLENBQUNDLEdBQVAsQ0FBVyxLQUFLa0QscUJBQUwsQ0FBMkJuQixVQUEzQixFQUF1Q3pDLElBQXZDLENBQVg7QUFDQSxTQUFLaUMsR0FBTCxDQUFTLFNBQVQsRUFBcUIsd0JBQXVCakMsSUFBSyxJQUFqRDtBQUNIOztBQUVENEQsRUFBQUEscUJBQXFCLENBQUNuQixVQUFELEVBQWF6QyxJQUFiLEVBQW1CO0FBQ3BDLFFBQUksS0FBS0MsT0FBTCxDQUFhK0YsZ0JBQWpCLEVBQW1DO0FBQy9CLGFBQU8sQ0FBQ3JGLEdBQUQsRUFBTUMsSUFBTixLQUFlO0FBQ2xCLGFBQUtxQixHQUFMLENBQVMsT0FBVCxFQUFtQixZQUFXakMsSUFBSSxJQUFJeUMsVUFBVSxDQUFDekMsSUFBSyxPQUF0RDtBQUNBLGVBQU95QyxVQUFVLENBQUM5QixHQUFELEVBQU1DLElBQU4sQ0FBakI7QUFDSCxPQUhEO0FBSUg7O0FBRUQsV0FBTzZCLFVBQVA7QUFDSDs7QUFFRHdELEVBQUFBLHVCQUF1QixHQUFHO0FBQ3RCLFdBQU8sTUFBTUEsdUJBQU4sR0FBZ0NDLE1BQWhDLENBQXVDLENBQUUsS0FBSy9GLGNBQUwsQ0FBb0JSLE9BQU8sQ0FBQ1MsWUFBNUIsRUFBMENULE9BQU8sQ0FBQ3dHLGFBQWxELENBQUYsQ0FBdkMsQ0FBUDtBQUNIOztBQWhVaUMsQ0FBdEM7O0FBbVVBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ4RyxRQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgZ2xvYiwgdXJsSm9pbiwgZW5zdXJlTGVmdFNsYXNoLCB1cmxBcHBlbmRRdWVyeSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBFcnJvcnMgPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBLb2EgPSByZXF1aXJlKCdrb2EnKTtcblxuY29uc3QgUm91dGFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7ICAgIFxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgcm91dGFibGUgaW5zdGFuY2UuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gUm91dGFibGUgb3B0aW9ucyAgICAgICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5iYWNrZW5kUGF0aD0nc2VydmVyJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGJhY2stZW5kIHNlcnZlciBzb3VyY2UgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY2xpZW50UGF0aD0nY2xpZW50J10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBjbGllbnQgc291cmNlIGZpbGVzICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucHVibGljUGF0aD0ncHVibGljJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBzdGF0aWMgZmlsZXMgXG4gICAgICovICAgICAgICAgXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCBvcHRpb25zKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQmFja2VuZCBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5iYWNrZW5kUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmJhY2tlbmRQYXRoIHx8IExpdGVyYWwuQkFDS0VORF9QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc291cmNlIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmNsaWVudFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jbGllbnRQYXRoIHx8IExpdGVyYWwuQ0xJRU5UX1NSQ19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc3RhdGljIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnB1YmxpY1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5wdWJsaWNQYXRoIHx8IExpdGVyYWwuUFVCTElDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFYWNoIGFwcCBoYXMgaXRzIG93biByb3V0ZXIuXG4gICAgICAgICAqIEBtZW1iZXIge0tvYX1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnJvdXRlciA9IG5ldyBLb2EoKTtcblxuICAgICAgICAvL2luamVjdCB0aGUgYXBwTW9kdWxlIGluc3RhbmNlIGluIHRoZSBmaXJzdCBtaWRkbGV3YXJlXG4gICAgICAgIHRoaXMucm91dGVyLnVzZSgoY3R4LCBuZXh0KSA9PiB7IFxuICAgICAgICAgICAgY3R4LmFwcE1vZHVsZSA9IHRoaXM7IFxuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTsgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vbG9hZCBtaWRkbGV3YXJlcyBpZiBleGlzdHMgaW4gc2VydmVyIG9yIGFwcCBwYXRoXG4gICAgICAgICAgICBsZXQgbWlkZGxld2FyZURpciA9IHRoaXMudG9BYnNvbHV0ZVBhdGgoTGl0ZXJhbC5NSURETEVXQVJFU19QQVRIKTtcbiAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKG1pZGRsZXdhcmVEaXIpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkTWlkZGxld2FyZXNGcm9tKG1pZGRsZXdhcmVEaXIpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0XygpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIE1pZGRsZXdhcmUgZmFjdG9yeSByZWdpc3RyeS5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5ID0ge307XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0YXJ0XygpO1xuICAgIH1cblxuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBkZWxldGUgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5O1xuXG4gICAgICAgIHJldHVybiBzdXBlci5zdG9wXygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYW5kIHJlZ3NpdGVyIG1pZGRsZXdhcmUgZmlsZXMgZnJvbSBhIHNwZWNpZmllZCBwYXRoLlxuICAgICAqIEBwYXJhbSBkaXJcbiAgICAgKi9cbiAgICBsb2FkTWlkZGxld2FyZXNGcm9tKGRpcikge1xuICAgICAgICBsZXQgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5qb2luKGRpciwgJyouanMnKSwge25vZGlyOiB0cnVlfSk7XG4gICAgICAgIGZpbGVzLmZvckVhY2goZmlsZSA9PiB0aGlzLnJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkocGF0aC5iYXNlbmFtZShmaWxlLCAnLmpzJyksIHJlcXVpcmUoZmlsZSkpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciB0aGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBuYW1lZCBtaWRkbGV3YXJlLiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgbWlkZGxld2FyZSBcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmYWN0b3J5TWV0aG9kIC0gVGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbWlkZGxld2FyZVxuICAgICAqL1xuICAgIHJlZ2lzdGVyTWlkZGxld2FyZUZhY3RvcnkobmFtZSwgZmFjdG9yeU1ldGhvZCkge1xuICAgICAgICBwcmU6IHR5cGVvZiBmYWN0b3J5TWV0aG9kID09PSAnZnVuY3Rpb24nLCAnSW52YWxpZCBtaWRkbGV3YXJlIGZhY3Rvcnk6ICcgKyBuYW1lO1xuXG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5TZXJ2ZXJFcnJvcignTWlkZGxld2FyZSBcIicrIG5hbWUgKydcIiBhbHJlYWR5IHJlZ2lzdGVyZWQhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnlbbmFtZV0gPSBmYWN0b3J5TWV0aG9kO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSZWdpc3RlcmVkIG5hbWVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlIGZyb20gbW9kdWxlIGhpZXJhcmNoeS4gICAgIFxuICAgICAqIEBwYXJhbSBuYW1lXG4gICAgICogQHJldHVybnMge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIGdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnNlcnZlciAmJiB0aGlzLnNlcnZlciAhPT0gdGhpcykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVyLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG5wbU1pZGRsZXdhcmUgPSB0cnlSZXF1aXJlKG5hbWUpO1xuICAgICAgICBpZiAobnBtTWlkZGxld2FyZSkge1xuICAgICAgICAgICAgcmV0dXJuIG5wbU1pZGRsZXdhcmU7XG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKGBEb24ndCBrbm93IHdoZXJlIHRvIGxvYWQgbWlkZGxld2FyZSBcIiR7bmFtZX1cIi5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVc2UgbWlkZGxld2FyZXNcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gcm91dGVyXG4gICAgICogQHBhcmFtIHsqfSBtaWRkbGV3YXJlcyAtIENhbiBiZSBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIGVudHJpZXMgb3IgYSBrZXktdmFsdWUgbGlzdCBvZiByZWdpc3RlcnJlZCBtaWRkbGV3YXJlc1xuICAgICAqIEByZXR1cm5zIHtSb3V0YWJsZX1cbiAgICAgKi9cbiAgICB1c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRmFjdG9yeSwgbWlkZGxld2FyZTtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGdW5jdGlvbnMgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihtaWRkbGV3YXJlcywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7ICAgXG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWUsIG1pZGRsZXdhcmUgfSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtaWRkbGV3YXJlcyA9IF8uY2FzdEFycmF5KG1pZGRsZXdhcmVzKTsgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKG1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlRW50cnkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIG1pZGRsZXdhcmVFbnRyeTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeSh1bmRlZmluZWQsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkgLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSB8fCAndW5hbWVkIG1pZGRsZXdhcmUnLCBtaWRkbGV3YXJlOiBtaWRkbGV3YXJlRW50cnl9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IF8uaXNQbGFpbk9iamVjdChtaWRkbGV3YXJlRW50cnkpICYmICduYW1lJyBpbiBtaWRkbGV3YXJlRW50cnksICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkub3B0aW9ucywgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeS5uYW1lLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5mb3JFYWNoKCh7IG5hbWUsIG1pZGRsZXdhcmUgfSkgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZSkpIHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlLmZvckVhY2gobSA9PiB0aGlzLnVzZU1pZGRsZXdhcmUocm91dGVyLCBtLCBuYW1lKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudXNlTWlkZGxld2FyZShyb3V0ZXIsIG1pZGRsZXdhcmUsIG5hbWUpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHJvdXRlIHRvIGEgcm91dGVyLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUuICAgICBcbiAgICAgKiBAcGFyYW0gcm91dGVyXG4gICAgICogQHBhcmFtIG1ldGhvZFxuICAgICAqIEBwYXJhbSByb3V0ZVxuICAgICAqIEBwYXJhbSBhY3Rpb25zXG4gICAgICovXG4gICAgYWRkUm91dGUocm91dGVyLCBtZXRob2QsIHJvdXRlLCBhY3Rpb25zKSB7XG4gICAgICAgIGxldCBoYW5kbGVycyA9IFtdLCBtaWRkbGV3YXJlRmFjdG9yeTtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGFjdGlvbnMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpLCBuYW1lKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjdGlvbnMgPSBfLmNhc3RBcnJheShhY3Rpb25zKTtcbiAgICAgICAgICAgIGxldCBsYXN0SW5kZXggPSBhY3Rpb25zLmxlbmd0aCAtIDE7XG5cbiAgICAgICAgICAgIF8uZWFjaChhY3Rpb25zLCAoYWN0aW9uLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0eXBlb2YgYWN0aW9uO1xuXG4gICAgICAgICAgICAgICAgaWYgKGkgPT09IGxhc3RJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBsYXN0IG1pZGRsZXdhcmUgbWF5IGJlIGFuIGFjdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycgJiYgYWN0aW9uLmluZGV4T2YoJy4nKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnYWN0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnb2JqZWN0JztcbiAgICAgICAgICAgICAgICAgICAgfSAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyAnbmFtZWRNaWRkbGV3YXJlJyBdXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24pOyAgIFxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobnVsbCwgdGhpcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy9pbiBjYXNlIGl0J3MgcmVnaXN0ZXIgYnkgdGhlIG1pZGRsZXdhcmVGYWN0b3J5IGZlYXR1cmVcbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUuZm9yRWFjaCgobWlkZGxld2FyZUl0ZW0sIGkpID0+IGhhbmRsZXJzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUl0ZW0sIGAke2FjdGlvbn0tJHtpfWAgKyAobWlkZGxld2FyZS5uYW1lID8gKCctJyArIG1pZGRsZXdhcmUubmFtZSkgOiAnJykpXG4gICAgICAgICAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBhY3Rpb24pKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKGFjdGlvbikpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogYWN0aW9uLmxlbmd0aCA+IDAgJiYgYWN0aW9uLmxlbmd0aCA8PSAyLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uWzBdKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5sZW5ndGggPiAxID8gYWN0aW9uWzFdIDogdW5kZWZpbmVkLCB0aGlzKSkpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzUGxhaW5PYmplY3QoYWN0aW9uKSAmJiAnbmFtZScgaW4gYWN0aW9uLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm5hbWUpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm9wdGlvbnMsIHRoaXMpLCBhY3Rpb24ubmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICByb3V0ZXJbbWV0aG9kXShyb3V0ZSwgLi4uaGFuZGxlcnMpO1xuXG4gICAgICAgIGxldCBlbmRwb2ludCA9IHJvdXRlci5vcHRzLnByZWZpeCA/IHVybEpvaW4odGhpcy5yb3V0ZSwgcm91dGVyLm9wdHMucHJlZml4LCByb3V0ZSkgOiB1cmxKb2luKHRoaXMucm91dGUsIHJvdXRlKTtcblxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSb3V0ZSBcIiR7bWV0aG9kfToke2VuZHBvaW50fVwiIGlzIGFkZGVkIGZyb20gbW9kdWxlIFske3RoaXMubmFtZX1dLmApO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYSByb3V0ZXIgdG8gdGhpcyBhcHAgbW9kdWxlLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUgICAgIFxuICAgICAqIEBwYXJhbSB7Um91dGVyfSBuZXN0ZWRSb3V0ZXJcbiAgICAgKi9cbiAgICBhZGRSb3V0ZXIobmVzdGVkUm91dGVyKSB7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIucm91dGVzKCkpO1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLmFsbG93ZWRNZXRob2RzKCkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYSByZWxhdGl2ZSBwYXRoIGFuZCBxdWVyeSBwYXJhbWV0ZXJzIGlmIGFueSB0byBhIHVybCBwYXRoICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVsYXRpdmVQYXRoIC0gUmVsYXRpdmUgcGF0aFxuICAgICAqIEBwYXJhbSB7Li4uKn0gW3BhdGhPclF1ZXJ5XSAtIFF1ZXJpZXNcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIC4uLnBhdGhPclF1ZXJ5KSB7XG4gICAgICAgIGxldCB1cmwsIHF1ZXJ5O1xuXG4gICAgICAgIGlmIChwYXRoT3JRdWVyeSAmJiBwYXRoT3JRdWVyeS5sZW5ndGggPiAwICYmIChwYXRoT3JRdWVyeS5sZW5ndGggPiAxIHx8IHBhdGhPclF1ZXJ5WzBdICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICBpZiAoXy5pc09iamVjdChwYXRoT3JRdWVyeVtwYXRoT3JRdWVyeS5sZW5ndGggLSAxXSkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeSA9IHBhdGhPclF1ZXJ5LnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGF0aE9yUXVlcnkudW5zaGlmdChyZWxhdGl2ZVBhdGgpO1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCAuLi5wYXRoT3JRdWVyeSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxKb2luKHRoaXMucm91dGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICB1cmwgPSBlbnN1cmVMZWZ0U2xhc2godXJsKTtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxBcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCcvPycsICc/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBQcmVwYXJlIGNvbnRleHQgZm9yIGtvYSBhY3Rpb25cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gY3R4IC0gS29hIHJlcXVlc3QgY29udGV4dFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGFjdGlvbiAtIEFjdGlvbiBmdW5jdGlvblxuICAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIHdyYXBBY3Rpb24oYWN0aW9uKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBjdHgudG9VcmwgPSAocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdHgub3JpZ2luICsgdGhpcy50b1dlYlBhdGgocmVsYXRpdmVQYXRoLCBwYXRoT3JRdWVyeSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGN0eC5zdGF0ZSwge1xuICAgICAgICAgICAgICAgIF9zZWxmOiBjdHgub3JpZ2luYWxVcmwgfHwgdGhpcy50b1dlYlBhdGgoY3R4LnVybCksXG4gICAgICAgICAgICAgICAgX186IGN0eC5fXyxcbiAgICAgICAgICAgICAgICBfbWFrZVBhdGg6IChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSA9PiB0aGlzLnRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSxcbiAgICAgICAgICAgICAgICBfbWFrZVVybDogKHJlbGF0aXZlUGF0aCwgcXVlcnkpID0+IGN0eC50b1VybChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChjdHguY3NyZikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGN0eC5zdGF0ZS5fY3NyZiA9IGN0eC5jc3JmO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gYWN0aW9uKGN0eCk7XG4gICAgICAgIH07ICAgICAgICBcbiAgICB9ICAgXG5cbiAgICB1c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSwgbmFtZSkgeyAgICAgICAgICBcbiAgICAgICAgYXNzZXJ0OiB0eXBlb2YgbWlkZGxld2FyZSA9PT0gJ2Z1bmN0aW9uJywgbWlkZGxld2FyZTtcbiAgICAgICAgcm91dGVyLnVzZSh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBuYW1lKSk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEF0dGFjaGVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgIH1cblxuICAgIF93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50cmFjZU1pZGRsZXdhcmVzKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBDYWxsaW5nIFwiJHtuYW1lIHx8IG1pZGRsZXdhcmUubmFtZX1cIiAuLi5gKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1pZGRsZXdhcmUoY3R4LCBuZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtaWRkbGV3YXJlO1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICByZXR1cm4gc3VwZXIuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKS5jb25jYXQoWyB0aGlzLnRvQWJzb2x1dGVQYXRoKExpdGVyYWwuQkFDS0VORF9QQVRILCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF0pO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUm91dGFibGU7Il19
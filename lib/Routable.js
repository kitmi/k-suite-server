"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const Errors = require('./utils/Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = path.join(this.backendPath, Literal.MIDDLEWARES_PATH);
      console.log(middlewareDir);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else {
          if (!(_.isPlainObject(middlewareEntry) && 'name' in middlewareEntry)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.indexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      ctx.toUrl = (relativePath, ...pathOrQuery) => {
        return ctx.origin + this.toWebPath(relativePath, ...pathOrQuery);
      };

      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.toUrl(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return (ctx, next) => {
        this.log('debug', `Calling "${name || middleware.name}" ...`);
        return middleware(ctx, next);
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([this.toAbsolutePath(Literal.BACKEND_PATH, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwidXJsQXBwZW5kUXVlcnkiLCJ0cnlSZXF1aXJlIiwiRXJyb3JzIiwiTGl0ZXJhbCIsIktvYSIsIlJvdXRhYmxlIiwiVCIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJjbGllbnRQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJDTElFTlRfU1JDX1BBVEgiLCJwdWJsaWNQYXRoIiwiUFVCTElDX1BBVEgiLCJyb3V0ZXIiLCJ1c2UiLCJjdHgiLCJuZXh0IiwiYXBwTW9kdWxlIiwib24iLCJtaWRkbGV3YXJlRGlyIiwiam9pbiIsImJhY2tlbmRQYXRoIiwiTUlERExFV0FSRVNfUEFUSCIsImNvbnNvbGUiLCJsb2ciLCJleGlzdHNTeW5jIiwibG9hZE1pZGRsZXdhcmVzRnJvbSIsInN0YXJ0XyIsIm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkiLCJzdG9wXyIsImRpciIsImZpbGVzIiwic3luYyIsIm5vZGlyIiwiZm9yRWFjaCIsImZpbGUiLCJyZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5IiwiYmFzZW5hbWUiLCJmYWN0b3J5TWV0aG9kIiwiU2VydmVyRXJyb3IiLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImhhc093blByb3BlcnR5Iiwic2VydmVyIiwibnBtTWlkZGxld2FyZSIsInVzZU1pZGRsZXdhcmVzIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmUiLCJtaWRkbGV3YXJlRnVuY3Rpb25zIiwiaXNQbGFpbk9iamVjdCIsImZvck93biIsInB1c2giLCJjYXN0QXJyYXkiLCJlYWNoIiwibWlkZGxld2FyZUVudHJ5IiwidHlwZSIsInVuZGVmaW5lZCIsIkFycmF5IiwiaXNBcnJheSIsIm0iLCJ1c2VNaWRkbGV3YXJlIiwiYWRkUm91dGUiLCJtZXRob2QiLCJyb3V0ZSIsImFjdGlvbnMiLCJoYW5kbGVycyIsIl93cmFwTWlkZGxld2FyZVRyYWNlciIsImxhc3RJbmRleCIsImxlbmd0aCIsImFjdGlvbiIsImkiLCJpbmRleE9mIiwibWlkZGxld2FyZUl0ZW0iLCJlbmRwb2ludCIsIm9wdHMiLCJwcmVmaXgiLCJhZGRSb3V0ZXIiLCJuZXN0ZWRSb3V0ZXIiLCJyb3V0ZXMiLCJhbGxvd2VkTWV0aG9kcyIsInRvV2ViUGF0aCIsInJlbGF0aXZlUGF0aCIsInBhdGhPclF1ZXJ5IiwidXJsIiwicXVlcnkiLCJpc09iamVjdCIsInBvcCIsInVuc2hpZnQiLCJyZXBsYWNlIiwid3JhcEFjdGlvbiIsInRvVXJsIiwib3JpZ2luIiwiT2JqZWN0IiwiYXNzaWduIiwic3RhdGUiLCJfc2VsZiIsIm9yaWdpbmFsVXJsIiwiX18iLCJfbWFrZVBhdGgiLCJfbWFrZVVybCIsImNzcmYiLCJfY3NyZiIsInRyYWNlTWlkZGxld2FyZXMiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsImNvbmNhdCIsIkJBQ0tFTkRfUEFUSCIsIkZFQVRVUkVTX1BBVEgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsSUFBVDtBQUFlQyxFQUFBQSxPQUFmO0FBQXdCQyxFQUFBQSxlQUF4QjtBQUF5Q0MsRUFBQUE7QUFBekMsSUFBNEROLE9BQU8sQ0FBQyxVQUFELENBQXpFOztBQUNBLE1BQU07QUFBRU8sRUFBQUE7QUFBRixJQUFpQlAsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1RLE1BQU0sR0FBR1IsT0FBTyxDQUFDLGdCQUFELENBQXRCOztBQUNBLE1BQU1TLE9BQU8sR0FBR1QsT0FBTyxDQUFDLGdCQUFELENBQXZCOztBQUNBLE1BQU1VLEdBQUcsR0FBR1YsT0FBTyxDQUFD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QyxVQUFULEVBQXFCekMsSUFBckIsRUFBMkI7QUFBQSxVQUM1QixPQUFPeUMsVUFBUCxLQUFzQixVQURNO0FBQUEsc0JBQ01BLFVBRE47QUFBQTs7QUFFcENsQyxJQUFBQSxNQUFNLENBQUNDLEdBQVAsQ0FBVyxLQUFLb0QscUJBQUwsQ0FBMkJuQixVQUEzQixFQUF1Q3pDLElBQXZDLENBQVg7QUFDQSxTQUFLa0IsR0FBTCxDQUFTLFNBQVQsRUFBcUIsd0JBQXVCbEIsSUFBSyxJQUFqRDtBQUNIOztBQUVENEQsRUFBQUEscUJBQXFCLENBQUNuQixVQUFELEVBQWF6QyxJQUFiLEVBQW1CO0FBQ3BDLFFBQUksS0FBS0MsT0FBTCxDQUFhK0YsZ0JBQWpCLEVBQW1DO0FBQy9CLGFBQU8sQ0FBQ3ZGLEdBQUQsRUFBTUMsSUFBTixLQUFlO0FBQ2xCLGFBQUtRLEdBQUwsQ0FBUyxPQUFULEVBQW1CLFlBQVdsQixJQUFJLElBQUl5QyxVQUFVLENBQUN6QyxJQUFLLE9BQXREO0FBQ0EsZUFBT3lDLFVBQVUsQ0FBQ2hDLEdBQUQsRUFBTUMsSUFBTixDQUFqQjtBQUNILE9BSEQ7QUFJSDs7QUFFRCxXQUFPK0IsVUFBUDtBQUNIOztBQUVEd0QsRUFBQUEsdUJBQXVCLEdBQUc7QUFDdEIsV0FBTyxNQUFNQSx1QkFBTixHQUFnQ0MsTUFBaEMsQ0FBdUMsQ0FBRSxLQUFLL0YsY0FBTCxDQUFvQlIsT0FBTyxDQUFDd0csWUFBNUIsRUFBMEN4RyxPQUFPLENBQUN5RyxhQUFsRCxDQUFGLENBQXZDLENBQVA7QUFDSDs7QUE1VGlDLENBQXRDOztBQStUQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCekcsUUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IsIHVybEpvaW4sIGVuc3VyZUxlZnRTbGFzaCwgdXJsQXBwZW5kUXVlcnkgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgRXJyb3JzID0gcmVxdWlyZSgnLi91dGlscy9FcnJvcnMnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuY29uc3QgS29hID0gcmVxdWlyZSgna29hJyk7XG5cbmNvbnN0IFJvdXRhYmxlID0gVCA9PiBjbGFzcyBleHRlbmRzIFQgeyAgICBcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHJvdXRhYmxlIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFJvdXRhYmxlIG9wdGlvbnMgICAgICAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYmFja2VuZFBhdGg9J3NlcnZlciddIC0gUmVsYXRpdmUgcGF0aCBvZiBiYWNrLWVuZCBzZXJ2ZXIgc291cmNlIGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNsaWVudFBhdGg9J2NsaWVudCddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgY2xpZW50IHNvdXJjZSBmaWxlcyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnB1YmxpY1BhdGg9J3B1YmxpYyddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgc3RhdGljIGZpbGVzIFxuICAgICAqLyAgICAgICAgIFxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIobmFtZSwgb3B0aW9ucyk7ICAgICAgICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc291cmNlIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmNsaWVudFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jbGllbnRQYXRoIHx8IExpdGVyYWwuQ0xJRU5UX1NSQ19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRnJvbnRlbmQgc3RhdGljIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnB1YmxpY1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5wdWJsaWNQYXRoIHx8IExpdGVyYWwuUFVCTElDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFYWNoIGFwcCBoYXMgaXRzIG93biByb3V0ZXIuXG4gICAgICAgICAqIEBtZW1iZXIge0tvYX1cbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLnJvdXRlciA9IG5ldyBLb2EoKTtcblxuICAgICAgICAvL2luamVjdCB0aGUgYXBwTW9kdWxlIGluc3RhbmNlIGluIHRoZSBmaXJzdCBtaWRkbGV3YXJlXG4gICAgICAgIHRoaXMucm91dGVyLnVzZSgoY3R4LCBuZXh0KSA9PiB7IFxuICAgICAgICAgICAgY3R4LmFwcE1vZHVsZSA9IHRoaXM7IFxuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTsgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub24oJ2NvbmZpZ0xvYWRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIC8vbG9hZCBtaWRkbGV3YXJlcyBpZiBleGlzdHMgaW4gc2VydmVyIG9yIGFwcCBwYXRoXG4gICAgICAgICAgICBsZXQgbWlkZGxld2FyZURpciA9IHBhdGguam9pbih0aGlzLmJhY2tlbmRQYXRoLCBMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgY29uc29sZS5sb2cobWlkZGxld2FyZURpcik7XG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhtaWRkbGV3YXJlRGlyKSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZE1pZGRsZXdhcmVzRnJvbShtaWRkbGV3YXJlRGlyKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydF8oKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNaWRkbGV3YXJlIGZhY3RvcnkgcmVnaXN0cnkuXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSA9IHt9O1xuXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RvcF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGFuZCByZWdzaXRlciBtaWRkbGV3YXJlIGZpbGVzIGZyb20gYSBzcGVjaWZpZWQgcGF0aC5cbiAgICAgKiBAcGFyYW0gZGlyXG4gICAgICovXG4gICAgbG9hZE1pZGRsZXdhcmVzRnJvbShkaXIpIHtcbiAgICAgICAgbGV0IGZpbGVzID0gZ2xvYi5zeW5jKHBhdGguam9pbihkaXIsICcqLmpzJyksIHtub2RpcjogdHJ1ZX0pO1xuICAgICAgICBmaWxlcy5mb3JFYWNoKGZpbGUgPT4gdGhpcy5yZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5KHBhdGguYmFzZW5hbWUoZmlsZSwgJy5qcycpLCByZXF1aXJlKGZpbGUpKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXIgdGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbmFtZWQgbWlkZGxld2FyZS4gICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIG1pZGRsZXdhcmUgXG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZmFjdG9yeU1ldGhvZCAtIFRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG1pZGRsZXdhcmVcbiAgICAgKi9cbiAgICByZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5KG5hbWUsIGZhY3RvcnlNZXRob2QpIHtcbiAgICAgICAgcHJlOiB0eXBlb2YgZmFjdG9yeU1ldGhvZCA9PT0gJ2Z1bmN0aW9uJywgJ0ludmFsaWQgbWlkZGxld2FyZSBmYWN0b3J5OiAnICsgbmFtZTtcblxuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcnMuU2VydmVyRXJyb3IoJ01pZGRsZXdhcmUgXCInKyBuYW1lICsnXCIgYWxyZWFkeSByZWdpc3RlcmVkIScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdID0gZmFjdG9yeU1ldGhvZDtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgUmVnaXN0ZXJlZCBuYW1lZCBtaWRkbGV3YXJlIFske25hbWV9XS5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGZhY3RvcnkgbWV0aG9kIG9mIGEgbWlkZGxld2FyZSBmcm9tIG1vZHVsZSBoaWVyYXJjaHkuICAgICBcbiAgICAgKiBAcGFyYW0gbmFtZVxuICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn1cbiAgICAgKi9cbiAgICBnZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnlbbmFtZV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zZXJ2ZXIgJiYgdGhpcy5zZXJ2ZXIgIT09IHRoaXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlcnZlci5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBucG1NaWRkbGV3YXJlID0gdHJ5UmVxdWlyZShuYW1lKTtcbiAgICAgICAgaWYgKG5wbU1pZGRsZXdhcmUpIHtcbiAgICAgICAgICAgIHJldHVybiBucG1NaWRkbGV3YXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5TZXJ2ZXJFcnJvcihgRG9uJ3Qga25vdyB3aGVyZSB0byBsb2FkIG1pZGRsZXdhcmUgXCIke25hbWV9XCIuYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXNlIG1pZGRsZXdhcmVzXG4gICAgICogQHBhcmFtIHtSb3V0ZXJ9IHJvdXRlclxuICAgICAqIEBwYXJhbSB7Kn0gbWlkZGxld2FyZXMgLSBDYW4gYmUgYW4gYXJyYXkgb2YgbWlkZGxld2FyZSBlbnRyaWVzIG9yIGEga2V5LXZhbHVlIGxpc3Qgb2YgcmVnaXN0ZXJyZWQgbWlkZGxld2FyZXNcbiAgICAgKiBAcmV0dXJucyB7Um91dGFibGV9XG4gICAgICovXG4gICAgdXNlTWlkZGxld2FyZXMocm91dGVyLCBtaWRkbGV3YXJlcykge1xuICAgICAgICBsZXQgbWlkZGxld2FyZUZhY3RvcnksIG1pZGRsZXdhcmU7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRnVuY3Rpb25zID0gW107XG4gICAgICAgIFxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVzKSkge1xuICAgICAgICAgICAgXy5mb3JPd24obWlkZGxld2FyZXMsIChvcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpOyAgIFxuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKTtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lLCBtaWRkbGV3YXJlIH0pOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbWlkZGxld2FyZXMgPSBfLmNhc3RBcnJheShtaWRkbGV3YXJlcyk7ICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChtaWRkbGV3YXJlcywgbWlkZGxld2FyZUVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiBtaWRkbGV3YXJlRW50cnk7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyAnbmFtZWRNaWRkbGV3YXJlJyBdXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkodW5kZWZpbmVkLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5ICwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5Lm5hbWUgfHwgJ3VuYW1lZCBtaWRkbGV3YXJlJywgbWlkZGxld2FyZTogbWlkZGxld2FyZUVudHJ5fSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZUVudHJ5KSAmJiAnbmFtZScgaW4gbWlkZGxld2FyZUVudHJ5LCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5Lm9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSwgbWlkZGxld2FyZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMuZm9yRWFjaCgoeyBuYW1lLCBtaWRkbGV3YXJlIH0pID0+IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKG0gPT4gdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbSwgbmFtZSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSByb3V0ZSB0byBhIHJvdXRlciwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlLiAgICAgXG4gICAgICogQHBhcmFtIHJvdXRlclxuICAgICAqIEBwYXJhbSBtZXRob2RcbiAgICAgKiBAcGFyYW0gcm91dGVcbiAgICAgKiBAcGFyYW0gYWN0aW9uc1xuICAgICAqL1xuICAgIGFkZFJvdXRlKHJvdXRlciwgbWV0aG9kLCByb3V0ZSwgYWN0aW9ucykge1xuICAgICAgICBsZXQgaGFuZGxlcnMgPSBbXSwgbWlkZGxld2FyZUZhY3Rvcnk7XG5cbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhY3Rpb25zKSkge1xuICAgICAgICAgICAgXy5mb3JPd24oYWN0aW9ucywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShvcHRpb25zLCB0aGlzKSwgbmFtZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb25zID0gXy5jYXN0QXJyYXkoYWN0aW9ucyk7XG4gICAgICAgICAgICBsZXQgbGFzdEluZGV4ID0gYWN0aW9ucy5sZW5ndGggLSAxO1xuXG4gICAgICAgICAgICBfLmVhY2goYWN0aW9ucywgKGFjdGlvbiwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIGFjdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmIChpID09PSBsYXN0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbGFzdCBtaWRkbGV3YXJlIG1heSBiZSBhbiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnICYmIGFjdGlvbi5pbmRleE9mKCcuJykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2FjdGlvbicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ29iamVjdCc7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFsgJ25hbWVkTWlkZGxld2FyZScgXVxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uKTsgICBcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG51bGwsIHRoaXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vaW4gY2FzZSBpdCdzIHJlZ2lzdGVyIGJ5IHRoZSBtaWRkbGV3YXJlRmFjdG9yeSBmZWF0dXJlXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1pZGRsZXdhcmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlLmZvckVhY2goKG1pZGRsZXdhcmVJdGVtLCBpKSA9PiBoYW5kbGVycy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVJdGVtLCBgJHthY3Rpb259LSR7aX1gICsgKG1pZGRsZXdhcmUubmFtZSA/ICgnLScgKyBtaWRkbGV3YXJlLm5hbWUpIDogJycpKVxuICAgICAgICAgICAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgYWN0aW9uKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihhY3Rpb24pKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYWN0aW9uKSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IGFjdGlvbi5sZW5ndGggPiAwICYmIGFjdGlvbi5sZW5ndGggPD0gMiwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvblswXSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubGVuZ3RoID4gMSA/IGFjdGlvblsxXSA6IHVuZGVmaW5lZCwgdGhpcykpKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogXy5pc1BsYWluT2JqZWN0KGFjdGlvbikgJiYgJ25hbWUnIGluIGFjdGlvbiwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5uYW1lKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5vcHRpb25zLCB0aGlzKSwgYWN0aW9uLm5hbWUpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgcm91dGVyW21ldGhvZF0ocm91dGUsIC4uLmhhbmRsZXJzKTtcblxuICAgICAgICBsZXQgZW5kcG9pbnQgPSByb3V0ZXIub3B0cy5wcmVmaXggPyB1cmxKb2luKHRoaXMucm91dGUsIHJvdXRlci5vcHRzLnByZWZpeCwgcm91dGUpIDogdXJsSm9pbih0aGlzLnJvdXRlLCByb3V0ZSk7XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgUm91dGUgXCIke21ldGhvZH06JHtlbmRwb2ludH1cIiBpcyBhZGRlZCBmcm9tIG1vZHVsZSBbJHt0aGlzLm5hbWV9XS5gKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9ICAgIFxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoIGEgcm91dGVyIHRvIHRoaXMgYXBwIG1vZHVsZSwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlICAgICBcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gbmVzdGVkUm91dGVyXG4gICAgICovXG4gICAgYWRkUm91dGVyKG5lc3RlZFJvdXRlcikge1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLnJvdXRlcygpKTtcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG5lc3RlZFJvdXRlci5hbGxvd2VkTWV0aG9kcygpKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGEgcmVsYXRpdmUgcGF0aCBhbmQgcXVlcnkgcGFyYW1ldGVycyBpZiBhbnkgdG8gYSB1cmwgcGF0aCAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbGF0aXZlUGF0aCAtIFJlbGF0aXZlIHBhdGhcbiAgICAgKiBAcGFyYW0gey4uLip9IFtwYXRoT3JRdWVyeV0gLSBRdWVyaWVzXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICB0b1dlYlBhdGgocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkge1xuICAgICAgICBsZXQgdXJsLCBxdWVyeTtcblxuICAgICAgICBpZiAocGF0aE9yUXVlcnkgJiYgcGF0aE9yUXVlcnkubGVuZ3RoID4gMCAmJiAocGF0aE9yUXVlcnkubGVuZ3RoID4gMSB8fCBwYXRoT3JRdWVyeVswXSAhPT0gdW5kZWZpbmVkKSkge1xuICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QocGF0aE9yUXVlcnlbcGF0aE9yUXVlcnkubGVuZ3RoIC0gMV0pKSB7XG4gICAgICAgICAgICAgICAgcXVlcnkgPSBwYXRoT3JRdWVyeS5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhdGhPclF1ZXJ5LnVuc2hpZnQocmVsYXRpdmVQYXRoKTtcbiAgICAgICAgICAgIHVybCA9IHVybEpvaW4odGhpcy5yb3V0ZSwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCByZWxhdGl2ZVBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdXJsID0gZW5zdXJlTGVmdFNsYXNoKHVybCk7XG5cbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxBcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCcvPycsICc/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBQcmVwYXJlIGNvbnRleHQgZm9yIGtvYSBhY3Rpb25cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gY3R4IC0gS29hIHJlcXVlc3QgY29udGV4dFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGFjdGlvbiAtIEFjdGlvbiBmdW5jdGlvblxuICAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIHdyYXBBY3Rpb24oYWN0aW9uKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBjdHgudG9VcmwgPSAocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdHgub3JpZ2luICsgdGhpcy50b1dlYlBhdGgocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGN0eC5zdGF0ZSwge1xuICAgICAgICAgICAgICAgIF9zZWxmOiBjdHgub3JpZ2luYWxVcmwgfHwgdGhpcy50b1dlYlBhdGgoY3R4LnVybCksXG4gICAgICAgICAgICAgICAgX186IGN0eC5fXyxcbiAgICAgICAgICAgICAgICBfbWFrZVBhdGg6IChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSA9PiB0aGlzLnRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSxcbiAgICAgICAgICAgICAgICBfbWFrZVVybDogKHJlbGF0aXZlUGF0aCwgcXVlcnkpID0+IGN0eC50b1VybChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChjdHguY3NyZikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGN0eC5zdGF0ZS5fY3NyZiA9IGN0eC5jc3JmO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gYWN0aW9uKGN0eCk7XG4gICAgICAgIH07ICAgICAgICBcbiAgICB9ICAgXG5cbiAgICB1c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSwgbmFtZSkgeyAgICAgICAgICBcbiAgICAgICAgYXNzZXJ0OiB0eXBlb2YgbWlkZGxld2FyZSA9PT0gJ2Z1bmN0aW9uJywgbWlkZGxld2FyZTtcbiAgICAgICAgcm91dGVyLnVzZSh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBuYW1lKSk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEF0dGFjaGVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgIH1cblxuICAgIF93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50cmFjZU1pZGRsZXdhcmVzKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsIGBDYWxsaW5nIFwiJHtuYW1lIHx8IG1pZGRsZXdhcmUubmFtZX1cIiAuLi5gKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1pZGRsZXdhcmUoY3R4LCBuZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtaWRkbGV3YXJlO1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICByZXR1cm4gc3VwZXIuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKS5jb25jYXQoWyB0aGlzLnRvQWJzb2x1dGVQYXRoKExpdGVyYWwuQkFDS0VORF9QQVRILCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF0pO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUm91dGFibGU7Il19
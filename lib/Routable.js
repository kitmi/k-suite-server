"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const Errors = require('./utils/Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = this.toAbsolutePath(Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server && this.server !== this) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else {
          if (!(_.isPlainObject(middlewareEntry) && 'name' in middlewareEntry)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.indexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          let middleware = middlewareFactory(null, this);

          if (Array.isArray(middleware)) {
            middleware.forEach((middlewareItem, i) => handlers.push(this._wrapMiddlewareTracer(middlewareItem, `${action}-${i}` + (middleware.name ? '-' + middleware.name : ''))));
          } else {
            handlers.push(this._wrapMiddlewareTracer(middleware, action));
          }
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;
    console.log('pathOrQuery', pathOrQuery);

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);
    console.log('url', url);
    console.log('query', query);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      ctx.toUrl = (relativePath, ...pathOrQuery) => {
        return ctx.origin + this.toWebPath(relativePath, ...pathOrQuery);
      };

      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.toUrl(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  useMiddleware(router, middleware, name) {
    if (!(typeof middleware === 'function')) {
      throw new Error(middleware);
    }

    router.use(this._wrapMiddlewareTracer(middleware, name));
    this.log('verbose', `Attached middleware [${name}].`);
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return (ctx, next) => {
        this.log('debug', `Calling "${name || middleware.name}" ...`);
        return middleware(ctx, next);
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([this.toAbsolutePath(Literal.BACKEND_PATH, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwidXJsQXBwZW5kUXVlcnkiLCJ0cnlSZXF1aXJlIiwiRXJyb3JzIiwiTGl0ZXJhbCIsIktvYSIsIlJvdXRhYmxlIiwiVCIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJjbGllbnRQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJDTElFTlRfU1JDX1BBVEgiLCJwdWJsaWNQYXRoIiwiUFVCTElDX1BBVEgiLCJyb3V0ZXIiLCJ1c2UiLCJjdHgiLCJuZXh0IiwiYXBwTW9kdWxlIiwib24iLCJtaWRkbGV3YXJlRGlyIiwiTUlERExFV0FSRVNfUEFUSCIsImV4aXN0c1N5bmMiLCJsb2FkTWlkZGxld2FyZXNGcm9tIiwic3RhcnRfIiwibWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSIsInN0b3BfIiwiZGlyIiwiZmlsZXMiLCJzeW5jIiwiam9pbiIsIm5vZGlyIiwiZm9yRWFjaCIsImZpbGUiLCJyZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5IiwiYmFzZW5hbWUiLCJmYWN0b3J5TWV0aG9kIiwiU2VydmVyRXJyb3IiLCJsb2ciLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImhhc093blByb3BlcnR5Iiwic2VydmVyIiwibnBtTWlkZGxld2FyZSIsInVzZU1pZGRsZXdhcmVzIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmUiLCJtaWRkbGV3YXJlRnVuY3Rpb25zIiwiaXNQbGFpbk9iamVjdCIsImZvck93biIsInB1c2giLCJjYXN0QXJyYXkiLCJlYWNoIiwibWlkZGxld2FyZUVudHJ5IiwidHlwZSIsInVuZGVmaW5lZCIsIkFycmF5IiwiaXNBcnJheSIsIm0iLCJ1c2VNaWRkbGV3YXJlIiwiYWRkUm91dGUiLCJtZXRob2QiLCJyb3V0ZSIsImFjdGlvbnMiLCJoYW5kbGVycyIsIl93cmFwTWlkZGxld2FyZVRyYWNlciIsImxhc3RJbmRleCIsImxlbmd0aCIsImFjdGlvbiIsImkiLCJpbmRleE9mIiwibWlkZGxld2FyZUl0ZW0iLCJlbmRwb2ludCIsIm9wdHMiLCJwcmVmaXgiLCJhZGRSb3V0ZXIiLCJuZXN0ZWRSb3V0ZXIiLCJyb3V0ZXMiLCJhbGxvd2VkTWV0aG9kcyIsInRvV2ViUGF0aCIsInJlbGF0aXZlUGF0aCIsInBhdGhPclF1ZXJ5IiwidXJsIiwicXVlcnkiLCJjb25zb2xlIiwiaXNPYmplY3QiLCJwb3AiLCJ1bnNoaWZ0IiwicmVwbGFjZSIsIndyYXBBY3Rpb24iLCJ0b1VybCIsIm9yaWdpbiIsIk9iamVjdCIsImFzc2lnbiIsInN0YXRlIiwiX3NlbGYiLCJvcmlnaW5hbFVybCIsIl9fIiwiX21ha2VQYXRoIiwiX21ha2VVcmwiLCJjc3JmIiwiX2NzcmYiLCJ0cmFjZU1pZGRsZXdhcmVzIiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJjb25jYXQiLCJCQUNLRU5EX1BBVEgiLCJGRUFUVVJFU19QQVRIIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLElBQVQ7QUFBZUMsRUFBQUEsT0FBZjtBQUF3QkMsRUFBQUEsZUFBeEI7QUFBeUNDLEVBQUFBO0FBQXpDLElBQTRETixPQUFPLENBQUMsVUFBRCxDQUF6RTs7QUFDQSxNQUFNO0FBQUVPLEVBQUFBO0FBQUYsSUFBaUJQLE9BQU8sQ0FBQyxnQ0FBRCxDQUE5Qjs7QUFDQSxNQUFNUSxNQUFNLEdBQUdSLE9BQU8sQ0FBQyxnQkFBRCxDQUF0Qjs7QUFDQSxNQUFNUyxPQUFPLEdBQUdULE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFDQSxNQUFNVSxHQUFHLEdBQUdWLE9BQU8sQ0FBQyxLQUFELENBQW5COztB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YUFBT2hDLE1BQU0sQ0FBQ3BELEdBQUQsQ0FBYjtBQUNILEtBakJEO0FBa0JIOztBQUVEMkMsRUFBQUEsYUFBYSxDQUFDN0MsTUFBRCxFQUFTZ0MsVUFBVCxFQUFxQnZDLElBQXJCLEVBQTJCO0FBQUEsVUFDNUIsT0FBT3VDLFVBQVAsS0FBc0IsVUFETTtBQUFBLHNCQUNNQSxVQUROO0FBQUE7O0FBRXBDaEMsSUFBQUEsTUFBTSxDQUFDQyxHQUFQLENBQVcsS0FBS2tELHFCQUFMLENBQTJCbkIsVUFBM0IsRUFBdUN2QyxJQUF2QyxDQUFYO0FBQ0EsU0FBSytCLEdBQUwsQ0FBUyxTQUFULEVBQXFCLHdCQUF1Qi9CLElBQUssSUFBakQ7QUFDSDs7QUFFRDBELEVBQUFBLHFCQUFxQixDQUFDbkIsVUFBRCxFQUFhdkMsSUFBYixFQUFtQjtBQUNwQyxRQUFJLEtBQUtDLE9BQUwsQ0FBYThGLGdCQUFqQixFQUFtQztBQUMvQixhQUFPLENBQUN0RixHQUFELEVBQU1DLElBQU4sS0FBZTtBQUNsQixhQUFLcUIsR0FBTCxDQUFTLE9BQVQsRUFBbUIsWUFBVy9CLElBQUksSUFBSXVDLFVBQVUsQ0FBQ3ZDLElBQUssT0FBdEQ7QUFDQSxlQUFPdUMsVUFBVSxDQUFDOUIsR0FBRCxFQUFNQyxJQUFOLENBQWpCO0FBQ0gsT0FIRDtBQUlIOztBQUVELFdBQU82QixVQUFQO0FBQ0g7O0FBRUR5RCxFQUFBQSx1QkFBdUIsR0FBRztBQUN0QixXQUFPLE1BQU1BLHVCQUFOLEdBQWdDQyxNQUFoQyxDQUF1QyxDQUFFLEtBQUs5RixjQUFMLENBQW9CUixPQUFPLENBQUN1RyxZQUE1QixFQUEwQ3ZHLE9BQU8sQ0FBQ3dHLGFBQWxELENBQUYsQ0FBdkMsQ0FBUDtBQUNIOztBQWhVaUMsQ0FBdEM7O0FBbVVBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ4RyxRQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgZ2xvYiwgdXJsSm9pbiwgZW5zdXJlTGVmdFNsYXNoLCB1cmxBcHBlbmRRdWVyeSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBFcnJvcnMgPSByZXF1aXJlKCcuL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5jb25zdCBLb2EgPSByZXF1aXJlKCdrb2EnKTtcblxuY29uc3QgUm91dGFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7ICAgIFxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgcm91dGFibGUgaW5zdGFuY2UuICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gUm91dGFibGUgb3B0aW9ucyAgICAgICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5iYWNrZW5kUGF0aD0nc2VydmVyJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGJhY2stZW5kIHNlcnZlciBzb3VyY2UgZmlsZXNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY2xpZW50UGF0aD0nY2xpZW50J10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBjbGllbnQgc291cmNlIGZpbGVzICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMucHVibGljUGF0aD0ncHVibGljJ10gLSBSZWxhdGl2ZSBwYXRoIG9mIGZyb250LWVuZCBzdGF0aWMgZmlsZXMgXG4gICAgICovICAgICAgICAgXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcihuYW1lLCBvcHRpb25zKTsgICAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzb3VyY2UgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuY2xpZW50UGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmNsaWVudFBhdGggfHwgTGl0ZXJhbC5DTElFTlRfU1JDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzdGF0aWMgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucHVibGljUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLnB1YmxpY1BhdGggfHwgTGl0ZXJhbC5QVUJMSUNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVhY2ggYXBwIGhhcyBpdHMgb3duIHJvdXRlci5cbiAgICAgICAgICogQG1lbWJlciB7S29hfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucm91dGVyID0gbmV3IEtvYSgpO1xuXG4gICAgICAgIC8vaW5qZWN0IHRoZSBhcHBNb2R1bGUgaW5zdGFuY2UgaW4gdGhlIGZpcnN0IG1pZGRsZXdhcmVcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKChjdHgsIG5leHQpID0+IHsgXG4gICAgICAgICAgICBjdHguYXBwTW9kdWxlID0gdGhpczsgXG4gICAgICAgICAgICByZXR1cm4gbmV4dCgpOyBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgLy9sb2FkIG1pZGRsZXdhcmVzIGlmIGV4aXN0cyBpbiBzZXJ2ZXIgb3IgYXBwIHBhdGhcbiAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlRGlyID0gdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobWlkZGxld2FyZURpcikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRNaWRkbGV3YXJlc0Zyb20obWlkZGxld2FyZURpcik7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRfKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogTWlkZGxld2FyZSBmYWN0b3J5IHJlZ2lzdHJ5LlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkgPSB7fTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnk7XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0b3BfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbmQgcmVnc2l0ZXIgbWlkZGxld2FyZSBmaWxlcyBmcm9tIGEgc3BlY2lmaWVkIHBhdGguXG4gICAgICogQHBhcmFtIGRpclxuICAgICAqL1xuICAgIGxvYWRNaWRkbGV3YXJlc0Zyb20oZGlyKSB7XG4gICAgICAgIGxldCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLmpvaW4oZGlyLCAnKi5qcycpLCB7bm9kaXI6IHRydWV9KTtcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHRoaXMucmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShwYXRoLmJhc2VuYW1lKGZpbGUsICcuanMnKSwgcmVxdWlyZShmaWxlKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG5hbWVkIG1pZGRsZXdhcmUuICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBtaWRkbGV3YXJlIFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnlNZXRob2QgLSBUaGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlXG4gICAgICovXG4gICAgcmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShuYW1lLCBmYWN0b3J5TWV0aG9kKSB7XG4gICAgICAgIHByZTogdHlwZW9mIGZhY3RvcnlNZXRob2QgPT09ICdmdW5jdGlvbicsICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeTogJyArIG5hbWU7XG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKCdNaWRkbGV3YXJlIFwiJysgbmFtZSArJ1wiIGFscmVhZHkgcmVnaXN0ZXJlZCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXSA9IGZhY3RvcnlNZXRob2Q7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJlZ2lzdGVyZWQgbmFtZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG1pZGRsZXdhcmUgZnJvbSBtb2R1bGUgaGllcmFyY2h5LiAgICAgXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb259XG4gICAgICovXG4gICAgZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc2VydmVyICYmIHRoaXMuc2VydmVyICE9PSB0aGlzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXJ2ZXIuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbnBtTWlkZGxld2FyZSA9IHRyeVJlcXVpcmUobmFtZSk7XG4gICAgICAgIGlmIChucG1NaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnBtTWlkZGxld2FyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBFcnJvcnMuU2VydmVyRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBtaWRkbGV3YXJlIFwiJHtuYW1lfVwiLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZSBtaWRkbGV3YXJlc1xuICAgICAqIEBwYXJhbSB7Um91dGVyfSByb3V0ZXJcbiAgICAgKiBAcGFyYW0geyp9IG1pZGRsZXdhcmVzIC0gQ2FuIGJlIGFuIGFycmF5IG9mIG1pZGRsZXdhcmUgZW50cmllcyBvciBhIGtleS12YWx1ZSBsaXN0IG9mIHJlZ2lzdGVycmVkIG1pZGRsZXdhcmVzXG4gICAgICogQHJldHVybnMge1JvdXRhYmxlfVxuICAgICAqL1xuICAgIHVzZU1pZGRsZXdhcmVzKHJvdXRlciwgbWlkZGxld2FyZXMpIHtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGYWN0b3J5LCBtaWRkbGV3YXJlO1xuICAgICAgICBsZXQgbWlkZGxld2FyZUZ1bmN0aW9ucyA9IFtdO1xuICAgICAgICBcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChtaWRkbGV3YXJlcykpIHtcbiAgICAgICAgICAgIF8uZm9yT3duKG1pZGRsZXdhcmVzLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTsgICBcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3Rvcnkob3B0aW9ucywgdGhpcyk7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZSwgbWlkZGxld2FyZSB9KTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1pZGRsZXdhcmVzID0gXy5jYXN0QXJyYXkobWlkZGxld2FyZXMpOyAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICBfLmVhY2gobWlkZGxld2FyZXMsIG1pZGRsZXdhcmVFbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0eXBlb2YgbWlkZGxld2FyZUVudHJ5O1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFsgJ25hbWVkTWlkZGxld2FyZScgXVxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5KTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KHVuZGVmaW5lZCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeSAsIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeS5uYW1lIHx8ICd1bmFtZWQgbWlkZGxld2FyZScsIG1pZGRsZXdhcmU6IG1pZGRsZXdhcmVFbnRyeX0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVFbnRyeSkgJiYgJ25hbWUnIGluIG1pZGRsZXdhcmVFbnRyeSwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5vcHRpb25zLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5Lm5hbWUsIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLmZvckVhY2goKHsgbmFtZSwgbWlkZGxld2FyZSB9KSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUuZm9yRWFjaChtID0+IHRoaXMudXNlTWlkZGxld2FyZShyb3V0ZXIsIG0sIG5hbWUpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSwgbmFtZSk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgcm91dGUgdG8gYSByb3V0ZXIsIHNraXBwZWQgd2hpbGUgdGhlIHNlcnZlciBydW5uaW5nIGluIGRlYWYgbW9kZS4gICAgIFxuICAgICAqIEBwYXJhbSByb3V0ZXJcbiAgICAgKiBAcGFyYW0gbWV0aG9kXG4gICAgICogQHBhcmFtIHJvdXRlXG4gICAgICogQHBhcmFtIGFjdGlvbnNcbiAgICAgKi9cbiAgICBhZGRSb3V0ZShyb3V0ZXIsIG1ldGhvZCwgcm91dGUsIGFjdGlvbnMpIHtcbiAgICAgICAgbGV0IGhhbmRsZXJzID0gW10sIG1pZGRsZXdhcmVGYWN0b3J5O1xuXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYWN0aW9ucykpIHtcbiAgICAgICAgICAgIF8uZm9yT3duKGFjdGlvbnMsIChvcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG5hbWUpO1xuICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3Rvcnkob3B0aW9ucywgdGhpcyksIG5hbWUpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWN0aW9ucyA9IF8uY2FzdEFycmF5KGFjdGlvbnMpO1xuICAgICAgICAgICAgbGV0IGxhc3RJbmRleCA9IGFjdGlvbnMubGVuZ3RoIC0gMTtcblxuICAgICAgICAgICAgXy5lYWNoKGFjdGlvbnMsIChhY3Rpb24sIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiBhY3Rpb247XG5cbiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gbGFzdEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxhc3QgbWlkZGxld2FyZSBtYXkgYmUgYW4gYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiBhY3Rpb24uaW5kZXhPZignLicpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdhY3Rpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IGFjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICB9ICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbik7ICAgXG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShudWxsLCB0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICAvL2luIGNhc2UgaXQncyByZWdpc3RlciBieSB0aGUgbWlkZGxld2FyZUZhY3RvcnkgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZS5mb3JFYWNoKChtaWRkbGV3YXJlSXRlbSwgaSkgPT4gaGFuZGxlcnMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlSXRlbSwgYCR7YWN0aW9ufS0ke2l9YCArIChtaWRkbGV3YXJlLm5hbWUgPyAoJy0nICsgbWlkZGxld2FyZS5uYW1lKSA6ICcnKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIGFjdGlvbikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIoYWN0aW9uKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGFjdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBhY3Rpb24ubGVuZ3RoID4gMCAmJiBhY3Rpb24ubGVuZ3RoIDw9IDIsICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb25bMF0pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLmxlbmd0aCA+IDEgPyBhY3Rpb25bMV0gOiB1bmRlZmluZWQsIHRoaXMpKSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IF8uaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICduYW1lJyBpbiBhY3Rpb24sICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubmFtZSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaCh0aGlzLl93cmFwTWlkZGxld2FyZVRyYWNlcihtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ub3B0aW9ucywgdGhpcyksIGFjdGlvbi5uYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJvdXRlclttZXRob2RdKHJvdXRlLCAuLi5oYW5kbGVycyk7XG5cbiAgICAgICAgbGV0IGVuZHBvaW50ID0gcm91dGVyLm9wdHMucHJlZml4ID8gdXJsSm9pbih0aGlzLnJvdXRlLCByb3V0ZXIub3B0cy5wcmVmaXgsIHJvdXRlKSA6IHVybEpvaW4odGhpcy5yb3V0ZSwgcm91dGUpO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJvdXRlIFwiJHttZXRob2R9OiR7ZW5kcG9pbnR9XCIgaXMgYWRkZWQgZnJvbSBtb2R1bGUgWyR7dGhpcy5uYW1lfV0uYCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhIHJvdXRlciB0byB0aGlzIGFwcCBtb2R1bGUsIHNraXBwZWQgd2hpbGUgdGhlIHNlcnZlciBydW5uaW5nIGluIGRlYWYgbW9kZSAgICAgXG4gICAgICogQHBhcmFtIHtSb3V0ZXJ9IG5lc3RlZFJvdXRlclxuICAgICAqL1xuICAgIGFkZFJvdXRlcihuZXN0ZWRSb3V0ZXIpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG5lc3RlZFJvdXRlci5yb3V0ZXMoKSk7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIuYWxsb3dlZE1ldGhvZHMoKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhIHJlbGF0aXZlIHBhdGggYW5kIHF1ZXJ5IHBhcmFtZXRlcnMgaWYgYW55IHRvIGEgdXJsIHBhdGggICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWxhdGl2ZVBhdGggLSBSZWxhdGl2ZSBwYXRoXG4gICAgICogQHBhcmFtIHsuLi4qfSBbcGF0aE9yUXVlcnldIC0gUXVlcmllc1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgdG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpIHtcbiAgICAgICAgbGV0IHVybCwgcXVlcnk7XG5cbiAgICAgICAgY29uc29sZS5sb2coJ3BhdGhPclF1ZXJ5JywgcGF0aE9yUXVlcnkpO1xuXG4gICAgICAgIGlmIChwYXRoT3JRdWVyeSAmJiBwYXRoT3JRdWVyeS5sZW5ndGggPiAwICYmIChwYXRoT3JRdWVyeS5sZW5ndGggPiAxIHx8IHBhdGhPclF1ZXJ5WzBdICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICBpZiAoXy5pc09iamVjdChwYXRoT3JRdWVyeVtwYXRoT3JRdWVyeS5sZW5ndGggLSAxXSkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeSA9IHBhdGhPclF1ZXJ5LnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGF0aE9yUXVlcnkudW5zaGlmdChyZWxhdGl2ZVBhdGgpO1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCAuLi5wYXRoT3JRdWVyeSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxKb2luKHRoaXMucm91dGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICB1cmwgPSBlbnN1cmVMZWZ0U2xhc2godXJsKTtcblxuICAgICAgICBjb25zb2xlLmxvZygndXJsJywgdXJsKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3F1ZXJ5JywgcXVlcnkpO1xuXG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgdXJsID0gdXJsQXBwZW5kUXVlcnkodXJsLCBxdWVyeSk7XG4gICAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgnLz8nLCAnPycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVybDtcbiAgICB9ICAgIFxuXG4gICAgLyoqXG4gICAgICogUHJlcGFyZSBjb250ZXh0IGZvciBrb2EgYWN0aW9uXG4gICAgICogQHBhcmFtIHtPYmplY3R9IGN0eCAtIEtvYSByZXF1ZXN0IGNvbnRleHRcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBhY3Rpb24gLSBBY3Rpb24gZnVuY3Rpb25cbiAgICAgKiBAcmV0dXJuIHtmdW5jdGlvbn1cbiAgICAgKi9cbiAgICB3cmFwQWN0aW9uKGFjdGlvbikge1xuICAgICAgICByZXR1cm4gYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgICAgY3R4LnRvVXJsID0gKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3R4Lm9yaWdpbiArIHRoaXMudG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihjdHguc3RhdGUsIHtcbiAgICAgICAgICAgICAgICBfc2VsZjogY3R4Lm9yaWdpbmFsVXJsIHx8IHRoaXMudG9XZWJQYXRoKGN0eC51cmwpLFxuICAgICAgICAgICAgICAgIF9fOiBjdHguX18sXG4gICAgICAgICAgICAgICAgX21ha2VQYXRoOiAocmVsYXRpdmVQYXRoLCBxdWVyeSkgPT4gdGhpcy50b1dlYlBhdGgocmVsYXRpdmVQYXRoLCBxdWVyeSksXG4gICAgICAgICAgICAgICAgX21ha2VVcmw6IChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSA9PiBjdHgudG9VcmwocmVsYXRpdmVQYXRoLCBxdWVyeSkgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoY3R4LmNzcmYpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjdHguc3RhdGUuX2NzcmYgPSBjdHguY3NyZjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFjdGlvbihjdHgpO1xuICAgICAgICB9OyAgICAgICAgXG4gICAgfSAgIFxuXG4gICAgdXNlTWlkZGxld2FyZShyb3V0ZXIsIG1pZGRsZXdhcmUsIG5hbWUpIHsgICAgICAgICAgXG4gICAgICAgIGFzc2VydDogdHlwZW9mIG1pZGRsZXdhcmUgPT09ICdmdW5jdGlvbicsIG1pZGRsZXdhcmU7XG4gICAgICAgIHJvdXRlci51c2UodGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgbmFtZSkpO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBBdHRhY2hlZCBtaWRkbGV3YXJlIFske25hbWV9XS5gKTtcbiAgICB9XG5cbiAgICBfd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgbmFtZSkgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudHJhY2VNaWRkbGV3YXJlcykgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZygnZGVidWcnLCBgQ2FsbGluZyBcIiR7bmFtZSB8fCBtaWRkbGV3YXJlLm5hbWV9XCIgLi4uYCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiBtaWRkbGV3YXJlKGN0eCwgbmV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWlkZGxld2FyZTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkuY29uY2F0KFsgdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLkJBQ0tFTkRfUEFUSCwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdKTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJvdXRhYmxlOyJdfQ==
"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  urlAppendQuery
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const Errors = require('./Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const http = require('http');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.backendPath = this.toAbsolutePath(this.options.backendPath || Literal.BACKEND_PATH);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = this.toAbsolutePath(Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server) {
      return this.server.getMiddlewareFactory(name);
    }

    let npmMiddleware = tryRequire(name);

    if (npmMiddleware) {
      return npmMiddleware;
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else {
          if (!(_.isPlainObject(middlewareEntry) && 'name' in middlewareEntry)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this.useMiddleware(router, m, name));
      } else {
        this.useMiddleware(router, middleware, name);
      }

      this.log('verbose', `Attached middleware [${name}].`);
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(this._wrapMiddlewareTracer(middlewareFactory(options, this), name));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.indexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(null, this), action));
        } else if (type === 'function') {
          handlers.push(this._wrapMiddlewareTracer(action));
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.length > 1 ? action[1] : undefined, this)));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(this._wrapMiddlewareTracer(middlewareFactory(action.options, this), action.name));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.origin + this.toWebPath(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  restApiWrapper() {
    return async (ctx, next) => {
      try {
        await next();
        if (ctx.response.status === 404 && !ctx.response.body) ctx.throw(404);
      } catch (err) {
        ctx.status = typeof err.status === 'number' ? err.status : 500;
        ctx.app.emit('error', err, ctx);
        ctx.type = 'application/json';
        let errorObject = {
          error: err.expose ? err.message : http.STATUS_CODES[ctx.status]
        };

        if (this.env === 'development') {
          errorObject.stack = err.stack;
          errorObject.appModule = this.name;
        }

        Object.assign(errorObject, _.pick(err, ['code', 'errorCode', 'payload']));
        ctx.body = errorObject;
      }
    };
  }

  useMiddleware(router, middleware, name) {
    router.use(this._wrapMiddlewareTracer(middleware, name));
  }

  _wrapMiddlewareTracer(middleware, name) {
    if (this.options.traceMiddlewares) {
      return (ctx, next) => {
        this.log('debug', `Calling "${name || middleware.name}" ...`);
        return middleware(ctx, next);
      };
    }

    return middleware;
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([this.toAbsolutePath(Literal.BACKEND_PATH, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwidXJsQXBwZW5kUXVlcnkiLCJ0cnlSZXF1aXJlIiwiRXJyb3JzIiwiTGl0ZXJhbCIsIktvYSIsImh0dHAiLCJSb3V0YWJsZSIsIlQiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwiYmFja2VuZFBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkJBQ0tFTkRfUEFUSCIsImNsaWVudFBhdGgiLCJDTElFTlRfU1JDX1BBVEgiLCJwdWJsaWNQYXRoIiwiUFVCTElDX1BBVEgiLCJyb3V0ZXIiLCJ1c2UiLCJjdHgiLCJuZXh0IiwiYXBwTW9kdWxlIiwib24iLCJtaWRkbGV3YXJlRGlyIiwiTUlERExFV0FSRVNfUEFUSCIsImV4aXN0c1N5bmMiLCJsb2FkTWlkZGxld2FyZXNGcm9tIiwic3RhcnRfIiwibWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeSIsInN0b3BfIiwiZGlyIiwiZmlsZXMiLCJzeW5jIiwiam9pbiIsIm5vZGlyIiwiZm9yRWFjaCIsImZpbGUiLCJyZWdpc3Rlck1pZGRsZXdhcmVGYWN0b3J5IiwiYmFzZW5hbWUiLCJmYWN0b3J5TWV0aG9kIiwiU2VydmVyRXJyb3IiLCJsb2ciLCJnZXRNaWRkbGV3YXJlRmFjdG9yeSIsImhhc093blByb3BlcnR5Iiwic2VydmVyIiwibnBtTWlkZGxld2FyZSIsInVzZU1pZGRsZXdhcmVzIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmUiLCJtaWRkbGV3YXJlRnVuY3Rpb25zIiwiaXNQbGFpbk9iamVjdCIsImZvck93biIsInB1c2giLCJjYXN0QXJyYXkiLCJlYWNoIiwibWlkZGxld2FyZUVudHJ5IiwidHlwZSIsInVuZGVmaW5lZCIsIkFycmF5IiwiaXNBcnJheSIsIm0iLCJ1c2VNaWRkbGV3YXJlIiwiYWRkUm91dGUiLCJtZXRob2QiLCJyb3V0ZSIsImFjdGlvbnMiLCJoYW5kbGVycyIsIl93cmFwTWlkZGxld2FyZVRyYWNlciIsImxhc3RJbmRleCIsImxlbmd0aCIsImFjdGlvbiIsImkiLCJpbmRleE9mIiwiZW5kcG9pbnQiLCJvcHRzIiwicHJlZml4IiwiYWRkUm91dGVyIiwibmVzdGVkUm91dGVyIiwicm91dGVzIiwiYWxsb3dlZE1ldGhvZHMiLCJ0b1dlYlBhdGgiLCJyZWxhdGl2ZVBhdGgiLCJwYXRoT3JRdWVyeSIsInVybCIsInF1ZXJ5IiwiaXNPYmplY3QiLCJwb3AiLCJ1bnNoaWZ0IiwicmVwbGFjZSIsIndyYXBBY3Rpb24iLCJPYmplY3QiLCJhc3NpZ24iLCJzdGF0ZSIsIl9zZWxmIiwib3JpZ2luYWxVcmwiLCJfXyIsIl9tYWtlUGF0aCIsIl9tYWtlVXJsIiwib3JpZ2luIiwiY3NyZiIsIl9jc3JmIiwicmVzdEFwaVdyYXBwZXIiLCJyZXNwb25zZSIsInN0YXR1cyIsImJvZHkiLCJ0aHJvdyIsImVyciIsImFwcCIsImVtaXQiLCJlcnJvck9iamVjdCIsImVycm9yIiwiZXhwb3NlIiwibWVzc2FnZSIsIlNUQVRVU19DT0RFUyIsImVudiIsInN0YWNrIiwicGljayIsInRyYWNlTWlkZGxld2FyZXMiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsImNvbmNhdCIsIkZFQVRVUkVTX1BBVEgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsSUFBVDtBQUFlQyxFQUFBQSxPQUFmO0FBQXdCQyxFQUFBQSxlQUF4QjtBQUF5Q0MsRUFBQUE7QUFBekMsSUFBNEROLE9BQU8sQ0FBQyxVQUFELENBQXpFOztBQUNBLE1BQU07QUFBRU8sRUFBQUE7QUFBRixJQUFpQlAsT0FBTyxDQUFDLGdDQUFELENBQTlCOztB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QUMvQixhQUFPLENBQUNuRyxHQUFELEVBQU1DLElBQU4sS0FBZTtBQUNsQixhQUFLcUIsR0FBTCxDQUFTLE9BQVQsRUFBbUIsWUFBV2pDLElBQUksSUFBSXlDLFVBQVUsQ0FBQ3pDLElBQUssT0FBdEQ7QUFDQSxlQUFPeUMsVUFBVSxDQUFDOUIsR0FBRCxFQUFNQyxJQUFOLENBQWpCO0FBQ0gsT0FIRDtBQUlIOztBQUVELFdBQU82QixVQUFQO0FBQ0g7O0FBRURzRSxFQUFBQSx1QkFBdUIsR0FBRztBQUN0QixXQUFPLE1BQU1BLHVCQUFOLEdBQWdDQyxNQUFoQyxDQUF1QyxDQUFFLEtBQUs3RyxjQUFMLENBQW9CVCxPQUFPLENBQUNVLFlBQTVCLEVBQTBDVixPQUFPLENBQUN1SCxhQUFsRCxDQUFGLENBQXZDLENBQVA7QUFDSDs7QUE3VWlDLENBQXRDOztBQWdWQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEgsUUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IsIHVybEpvaW4sIGVuc3VyZUxlZnRTbGFzaCwgdXJsQXBwZW5kUXVlcnkgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgRXJyb3JzID0gcmVxdWlyZSgnLi9FcnJvcnMnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuY29uc3QgS29hID0gcmVxdWlyZSgna29hJyk7XG5jb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cCcpO1xuXG5jb25zdCBSb3V0YWJsZSA9IFQgPT4gY2xhc3MgZXh0ZW5kcyBUIHsgICAgXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSByb3V0YWJsZSBpbnN0YW5jZS4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBSb3V0YWJsZSBvcHRpb25zICAgICAgICAgICAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJhY2tlbmRQYXRoPSdzZXJ2ZXInXSAtIFJlbGF0aXZlIHBhdGggb2YgYmFjay1lbmQgc2VydmVyIHNvdXJjZSBmaWxlc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jbGllbnRQYXRoPSdjbGllbnQnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIGNsaWVudCBzb3VyY2UgZmlsZXMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5wdWJsaWNQYXRoPSdwdWJsaWMnXSAtIFJlbGF0aXZlIHBhdGggb2YgZnJvbnQtZW5kIHN0YXRpYyBmaWxlcyBcbiAgICAgKi8gICAgICAgICBcbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKG5hbWUsIG9wdGlvbnMpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBCYWNrZW5kIGZpbGVzIHBhdGguXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICoqL1xuICAgICAgICB0aGlzLmJhY2tlbmRQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuYmFja2VuZFBhdGggfHwgTGl0ZXJhbC5CQUNLRU5EX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzb3VyY2UgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuY2xpZW50UGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLmNsaWVudFBhdGggfHwgTGl0ZXJhbC5DTElFTlRfU1JDX1BBVEgpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGcm9udGVuZCBzdGF0aWMgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucHVibGljUGF0aCA9IHRoaXMudG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLnB1YmxpY1BhdGggfHwgTGl0ZXJhbC5QVUJMSUNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVhY2ggYXBwIGhhcyBpdHMgb3duIHJvdXRlci5cbiAgICAgICAgICogQG1lbWJlciB7S29hfVxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMucm91dGVyID0gbmV3IEtvYSgpO1xuXG4gICAgICAgIC8vaW5qZWN0IHRoZSBhcHBNb2R1bGUgaW5zdGFuY2UgaW4gdGhlIGZpcnN0IG1pZGRsZXdhcmVcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKChjdHgsIG5leHQpID0+IHsgXG4gICAgICAgICAgICBjdHguYXBwTW9kdWxlID0gdGhpczsgXG4gICAgICAgICAgICByZXR1cm4gbmV4dCgpOyBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgLy9sb2FkIG1pZGRsZXdhcmVzIGlmIGV4aXN0cyBpbiBzZXJ2ZXIgb3IgYXBwIHBhdGhcbiAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlRGlyID0gdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobWlkZGxld2FyZURpcikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRNaWRkbGV3YXJlc0Zyb20obWlkZGxld2FyZURpcik7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRfKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogTWlkZGxld2FyZSBmYWN0b3J5IHJlZ2lzdHJ5LlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkgPSB7fTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnk7XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0b3BfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbmQgcmVnc2l0ZXIgbWlkZGxld2FyZSBmaWxlcyBmcm9tIGEgc3BlY2lmaWVkIHBhdGguXG4gICAgICogQHBhcmFtIGRpclxuICAgICAqL1xuICAgIGxvYWRNaWRkbGV3YXJlc0Zyb20oZGlyKSB7XG4gICAgICAgIGxldCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLmpvaW4oZGlyLCAnKi5qcycpLCB7bm9kaXI6IHRydWV9KTtcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHRoaXMucmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShwYXRoLmJhc2VuYW1lKGZpbGUsICcuanMnKSwgcmVxdWlyZShmaWxlKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG5hbWVkIG1pZGRsZXdhcmUuICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBtaWRkbGV3YXJlIFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnlNZXRob2QgLSBUaGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlXG4gICAgICovXG4gICAgcmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShuYW1lLCBmYWN0b3J5TWV0aG9kKSB7XG4gICAgICAgIHByZTogdHlwZW9mIGZhY3RvcnlNZXRob2QgPT09ICdmdW5jdGlvbicsICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeTogJyArIG5hbWU7XG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKCdNaWRkbGV3YXJlIFwiJysgbmFtZSArJ1wiIGFscmVhZHkgcmVnaXN0ZXJlZCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXSA9IGZhY3RvcnlNZXRob2Q7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJlZ2lzdGVyZWQgbmFtZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG1pZGRsZXdhcmUgZnJvbSBtb2R1bGUgaGllcmFyY2h5LiAgICAgXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb259XG4gICAgICovXG4gICAgZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc2VydmVyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXJ2ZXIuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbnBtTWlkZGxld2FyZSA9IHRyeVJlcXVpcmUobmFtZSk7XG4gICAgICAgIGlmIChucG1NaWRkbGV3YXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnBtTWlkZGxld2FyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBFcnJvcnMuU2VydmVyRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBtaWRkbGV3YXJlIFwiJHtuYW1lfVwiLmApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZSBtaWRkbGV3YXJlc1xuICAgICAqIEBwYXJhbSB7Um91dGVyfSByb3V0ZXJcbiAgICAgKiBAcGFyYW0geyp9IG1pZGRsZXdhcmVzIC0gQ2FuIGJlIGFuIGFycmF5IG9mIG1pZGRsZXdhcmUgZW50cmllcyBvciBhIGtleS12YWx1ZSBsaXN0IG9mIHJlZ2lzdGVycmVkIG1pZGRsZXdhcmVzXG4gICAgICogQHJldHVybnMge1JvdXRhYmxlfVxuICAgICAqL1xuICAgIHVzZU1pZGRsZXdhcmVzKHJvdXRlciwgbWlkZGxld2FyZXMpIHtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGYWN0b3J5LCBtaWRkbGV3YXJlO1xuICAgICAgICBsZXQgbWlkZGxld2FyZUZ1bmN0aW9ucyA9IFtdO1xuICAgICAgICBcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChtaWRkbGV3YXJlcykpIHtcbiAgICAgICAgICAgIF8uZm9yT3duKG1pZGRsZXdhcmVzLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTsgICBcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlID0gbWlkZGxld2FyZUZhY3Rvcnkob3B0aW9ucywgdGhpcyk7XG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZSwgbWlkZGxld2FyZSB9KTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1pZGRsZXdhcmVzID0gXy5jYXN0QXJyYXkobWlkZGxld2FyZXMpOyAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICBfLmVhY2gobWlkZGxld2FyZXMsIG1pZGRsZXdhcmVFbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0eXBlb2YgbWlkZGxld2FyZUVudHJ5O1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFsgJ25hbWVkTWlkZGxld2FyZScgXVxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobWlkZGxld2FyZUVudHJ5KTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KHVuZGVmaW5lZCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeSAsIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeS5uYW1lIHx8ICd1bmFtZWQgbWlkZGxld2FyZScsIG1pZGRsZXdhcmU6IG1pZGRsZXdhcmVFbnRyeX0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogXy5pc1BsYWluT2JqZWN0KG1pZGRsZXdhcmVFbnRyeSkgJiYgJ25hbWUnIGluIG1pZGRsZXdhcmVFbnRyeSwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeS5vcHRpb25zLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5wdXNoKHsgbmFtZTogbWlkZGxld2FyZUVudHJ5Lm5hbWUsIG1pZGRsZXdhcmUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLmZvckVhY2goKHsgbmFtZSwgbWlkZGxld2FyZSB9KSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShtaWRkbGV3YXJlKSkge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUuZm9yRWFjaChtID0+IHRoaXMudXNlTWlkZGxld2FyZShyb3V0ZXIsIG0sIG5hbWUpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSwgbmFtZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEF0dGFjaGVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHJvdXRlIHRvIGEgcm91dGVyLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUuICAgICBcbiAgICAgKiBAcGFyYW0gcm91dGVyXG4gICAgICogQHBhcmFtIG1ldGhvZFxuICAgICAqIEBwYXJhbSByb3V0ZVxuICAgICAqIEBwYXJhbSBhY3Rpb25zXG4gICAgICovXG4gICAgYWRkUm91dGUocm91dGVyLCBtZXRob2QsIHJvdXRlLCBhY3Rpb25zKSB7XG4gICAgICAgIGxldCBoYW5kbGVycyA9IFtdLCBtaWRkbGV3YXJlRmFjdG9yeTtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGFjdGlvbnMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpLCBuYW1lKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjdGlvbnMgPSBfLmNhc3RBcnJheShhY3Rpb25zKTtcbiAgICAgICAgICAgIGxldCBsYXN0SW5kZXggPSBhY3Rpb25zLmxlbmd0aCAtIDE7XG5cbiAgICAgICAgICAgIF8uZWFjaChhY3Rpb25zLCAoYWN0aW9uLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0eXBlb2YgYWN0aW9uO1xuXG4gICAgICAgICAgICAgICAgaWYgKGkgPT09IGxhc3RJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBsYXN0IG1pZGRsZXdhcmUgbWF5IGJlIGFuIGFjdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycgJiYgYWN0aW9uLmluZGV4T2YoJy4nKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnYWN0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBhY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnb2JqZWN0JztcbiAgICAgICAgICAgICAgICAgICAgfSAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWyAnbmFtZWRNaWRkbGV3YXJlJyBdXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24pOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkobnVsbCwgdGhpcyksIGFjdGlvbikpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKGFjdGlvbikpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShhY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogYWN0aW9uLmxlbmd0aCA+IDAgJiYgYWN0aW9uLmxlbmd0aCA8PSAyLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uWzBdKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbi5sZW5ndGggPiAxID8gYWN0aW9uWzFdIDogdW5kZWZpbmVkLCB0aGlzKSkpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzUGxhaW5PYmplY3QoYWN0aW9uKSAmJiAnbmFtZScgaW4gYWN0aW9uLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm5hbWUpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2godGhpcy5fd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm9wdGlvbnMsIHRoaXMpLCBhY3Rpb24ubmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICByb3V0ZXJbbWV0aG9kXShyb3V0ZSwgLi4uaGFuZGxlcnMpO1xuXG4gICAgICAgIGxldCBlbmRwb2ludCA9IHJvdXRlci5vcHRzLnByZWZpeCA/IHVybEpvaW4odGhpcy5yb3V0ZSwgcm91dGVyLm9wdHMucHJlZml4LCByb3V0ZSkgOiB1cmxKb2luKHRoaXMucm91dGUsIHJvdXRlKTtcblxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBSb3V0ZSBcIiR7bWV0aG9kfToke2VuZHBvaW50fVwiIGlzIGFkZGVkIGZyb20gbW9kdWxlIFske3RoaXMubmFtZX1dLmApO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYSByb3V0ZXIgdG8gdGhpcyBhcHAgbW9kdWxlLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUgICAgIFxuICAgICAqIEBwYXJhbSB7Um91dGVyfSBuZXN0ZWRSb3V0ZXJcbiAgICAgKi9cbiAgICBhZGRSb3V0ZXIobmVzdGVkUm91dGVyKSB7XG4gICAgICAgIHRoaXMucm91dGVyLnVzZShuZXN0ZWRSb3V0ZXIucm91dGVzKCkpO1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLmFsbG93ZWRNZXRob2RzKCkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYSByZWxhdGl2ZSBwYXRoIGFuZCBxdWVyeSBwYXJhbWV0ZXJzIGlmIGFueSB0byBhIHVybCBwYXRoICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVsYXRpdmVQYXRoIC0gUmVsYXRpdmUgcGF0aFxuICAgICAqIEBwYXJhbSB7Li4uKn0gW3BhdGhPclF1ZXJ5XSAtIFF1ZXJpZXNcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIC4uLnBhdGhPclF1ZXJ5KSB7XG4gICAgICAgIGxldCB1cmwsIHF1ZXJ5O1xuXG4gICAgICAgIGlmIChwYXRoT3JRdWVyeSAmJiBwYXRoT3JRdWVyeS5sZW5ndGggPiAwICYmIChwYXRoT3JRdWVyeS5sZW5ndGggPiAxIHx8IHBhdGhPclF1ZXJ5WzBdICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgICAgICBpZiAoXy5pc09iamVjdChwYXRoT3JRdWVyeVtwYXRoT3JRdWVyeS5sZW5ndGggLSAxXSkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeSA9IHBhdGhPclF1ZXJ5LnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGF0aE9yUXVlcnkudW5zaGlmdChyZWxhdGl2ZVBhdGgpO1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCAuLi5wYXRoT3JRdWVyeSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxKb2luKHRoaXMucm91dGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICB1cmwgPSBlbnN1cmVMZWZ0U2xhc2godXJsKTtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB1cmwgPSB1cmxBcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KTtcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCcvPycsICc/Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXJsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFByZXBhcmUgY29udGV4dCBmb3Iga29hIGFjdGlvblxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjdHggLSBLb2EgcmVxdWVzdCBjb250ZXh0XG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gYWN0aW9uIC0gQWN0aW9uIGZ1bmN0aW9uXG4gICAgICogQHJldHVybiB7ZnVuY3Rpb259XG4gICAgICovXG4gICAgd3JhcEFjdGlvbihhY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIGFzeW5jIChjdHgpID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY3R4LnN0YXRlLCB7XG4gICAgICAgICAgICAgICAgX3NlbGY6IGN0eC5vcmlnaW5hbFVybCB8fCB0aGlzLnRvV2ViUGF0aChjdHgudXJsKSxcbiAgICAgICAgICAgICAgICBfXzogY3R4Ll9fLFxuICAgICAgICAgICAgICAgIF9tYWtlUGF0aDogKHJlbGF0aXZlUGF0aCwgcXVlcnkpID0+IHRoaXMudG9XZWJQYXRoKHJlbGF0aXZlUGF0aCwgcXVlcnkpLFxuICAgICAgICAgICAgICAgIF9tYWtlVXJsOiAocmVsYXRpdmVQYXRoLCBxdWVyeSkgPT4gKGN0eC5vcmlnaW4gKyB0aGlzLnRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSkgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoY3R4LmNzcmYpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjdHguc3RhdGUuX2NzcmYgPSBjdHguY3NyZjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFjdGlvbihjdHgpO1xuICAgICAgICB9OyAgICAgICAgXG4gICAgfSAgIFxuICAgIFxuICAgIHJlc3RBcGlXcmFwcGVyKCkge1xuICAgICAgICByZXR1cm4gYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCBuZXh0KCk7XG4gICAgICAgICAgICAgICAgaWYgKGN0eC5yZXNwb25zZS5zdGF0dXMgPT09IDQwNCAmJiAhY3R4LnJlc3BvbnNlLmJvZHkpIGN0eC50aHJvdyg0MDQpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY3R4LnN0YXR1cyA9IHR5cGVvZiBlcnIuc3RhdHVzID09PSAnbnVtYmVyJyA/IGVyci5zdGF0dXMgOiA1MDA7XG4gICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gYXBwbGljYXRpb25cbiAgICAgICAgICAgICAgICBjdHguYXBwLmVtaXQoJ2Vycm9yJywgZXJyLCBjdHgpO1xuICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIGFjY2VwdGVkIHR5cGVzXG4gICAgICAgICAgICAgICAgY3R4LnR5cGUgPSAnYXBwbGljYXRpb24vanNvbidcblxuICAgICAgICAgICAgICAgIGxldCBlcnJvck9iamVjdCA9IHsgZXJyb3I6IGVyci5leHBvc2UgPyBlcnIubWVzc2FnZSA6IGh0dHAuU1RBVFVTX0NPREVTW2N0eC5zdGF0dXNdIH07XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZW52ID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yT2JqZWN0LnN0YWNrID0gZXJyLnN0YWNrO1xuICAgICAgICAgICAgICAgICAgICBlcnJvck9iamVjdC5hcHBNb2R1bGUgPSB0aGlzLm5hbWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihlcnJvck9iamVjdCwgXy5waWNrKGVyciwgWydjb2RlJywgJ2Vycm9yQ29kZScsICdwYXlsb2FkJ10pKTsgXG5cbiAgICAgICAgICAgICAgICBjdHguYm9keSA9IGVycm9yT2JqZWN0O1xuICAgICAgICAgICAgfSAgICAgICAgXG4gICAgICAgIH07ICAgICAgIFxuICAgIH1cblxuICAgIHVzZU1pZGRsZXdhcmUocm91dGVyLCBtaWRkbGV3YXJlLCBuYW1lKSB7ICAgICAgICAgIFxuICAgICAgICByb3V0ZXIudXNlKHRoaXMuX3dyYXBNaWRkbGV3YXJlVHJhY2VyKG1pZGRsZXdhcmUsIG5hbWUpKTtcbiAgICB9XG5cbiAgICBfd3JhcE1pZGRsZXdhcmVUcmFjZXIobWlkZGxld2FyZSwgbmFtZSkge1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRyYWNlTWlkZGxld2FyZXMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ2RlYnVnJywgYENhbGxpbmcgXCIke25hbWUgfHwgbWlkZGxld2FyZS5uYW1lfVwiIC4uLmApO1xuICAgICAgICAgICAgICAgIHJldHVybiBtaWRkbGV3YXJlKGN0eCwgbmV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWlkZGxld2FyZTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkuY29uY2F0KFsgdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLkJBQ0tFTkRfUEFUSCwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdKTtcbiAgICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJvdXRhYmxlOyJdfQ==
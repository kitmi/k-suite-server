"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob,
  urlJoin,
  ensureLeftSlash,
  urlAppendQuery
} = require('rk-utils');

const Errors = require('./Errors');

const Literal = require('./enum/Literal');

const Koa = require('koa');

const Routable = T => class extends T {
  constructor(name, options) {
    super(name, options);
    this.backendPath = this.toAbsolutePath(this.options.backendPath || Literal.BACKEND_PATH);
    this.clientPath = this.toAbsolutePath(this.options.clientPath || Literal.CLIENT_SRC_PATH);
    this.publicPath = this.toAbsolutePath(this.options.publicPath || Literal.PUBLIC_PATH);
    this.router = new Koa();
    this.router.use((ctx, next) => {
      ctx.appModule = this;
      return next();
    });
    this.on('configLoaded', () => {
      let middlewareDir = this.toAbsolutePath(Literal.MIDDLEWARES_PATH);

      if (fs.existsSync(middlewareDir)) {
        this.loadMiddlewaresFrom(middlewareDir);
      }
    });
  }

  async start_() {
    this.middlewareFactoryRegistry = {};
    return super.start_();
  }

  async stop_() {
    delete this.middlewareFactoryRegistry;
    return super.stop_();
  }

  loadMiddlewaresFrom(dir) {
    let files = glob.sync(path.join(dir, '*.js'), {
      nodir: true
    });
    files.forEach(file => this.registerMiddlewareFactory(path.basename(file, '.js'), require(file)));
  }

  registerMiddlewareFactory(name, factoryMethod) {
    if (!(typeof factoryMethod === 'function')) {
      throw new Error('Invalid middleware factory: ' + name);
    }

    if (name in this.middlewareFactoryRegistry) {
      throw new Errors.ServerError('Middleware "' + name + '" already registered!');
    }

    this.middlewareFactoryRegistry[name] = factoryMethod;
    this.log('verbose', `Registered named middleware [${name}].`);
  }

  getMiddlewareFactory(name) {
    if (this.middlewareFactoryRegistry.hasOwnProperty(name)) {
      return this.middlewareFactoryRegistry[name];
    }

    if (this.server) {
      return this.server.getMiddlewareFactory(name);
    }

    throw new Errors.ServerError(`Don't know where to load middleware "${name}".`);
  }

  useMiddlewares(router, middlewares) {
    let middlewareFactory, middleware;
    let middlewareFunctions = [];

    if (_.isPlainObject(middlewares)) {
      _.forOwn(middlewares, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        middleware = middlewareFactory(options, this);
        middlewareFunctions.push({
          name,
          middleware
        });
      });
    } else {
      middlewares = _.castArray(middlewares);

      _.each(middlewares, middlewareEntry => {
        let type = typeof middlewareEntry;

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(middlewareEntry);
          middleware = middlewareFactory(undefined, this);
          middlewareFunctions.push({
            name: middlewareEntry,
            middleware
          });
        } else if (type === 'function') {
          middlewareFunctions.push({
            name: middlewareEntry.name || 'unamed middleware',
            middleware: middlewareEntry
          });
        } else {
          if (!(_.isPlainObject(middlewareEntry) && 'name' in middlewareEntry)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(middlewareEntry.name);
          middleware = middlewareFactory(middlewareEntry.options, this);
          middlewareFunctions.push({
            name: middlewareEntry.name,
            middleware
          });
        }
      });
    }

    middlewareFunctions.forEach(({
      name,
      middleware
    }) => {
      if (Array.isArray(middleware)) {
        middleware.forEach(m => this._useMiddleware(router, m));
      } else {
        this._useMiddleware(router, middleware);
      }

      this.log('verbose', `Attached middleware [${name}].`);
    });
    return this;
  }

  addRoute(router, method, route, actions) {
    let handlers = [],
        middlewareFactory;

    if (_.isPlainObject(actions)) {
      _.forOwn(actions, (options, name) => {
        middlewareFactory = this.getMiddlewareFactory(name);
        handlers.push(middlewareFactory(options, this));
      });
    } else {
      actions = _.castArray(actions);
      let lastIndex = actions.length - 1;

      _.each(actions, (action, i) => {
        let type = typeof action;

        if (i === lastIndex) {
          if (type === 'string' && action.indexOf('.') > 0) {
            action = {
              name: 'action',
              options: action
            };
            type = 'object';
          }
        }

        if (type === 'string') {
          middlewareFactory = this.getMiddlewareFactory(action);
          handlers.push(middlewareFactory(null, this));
        } else if (type === 'function') {
          handlers.push(action);
        } else if (Array.isArray(action)) {
          if (!(action.length > 0 && action.length <= 2)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action[0]);
          handlers.push(middlewareFactory(action.length > 1 ? action[1] : undefined, this));
        } else {
          if (!(_.isPlainObject(action) && 'name' in action)) {
            throw new Error('Invalid middleware entry');
          }

          middlewareFactory = this.getMiddlewareFactory(action.name);
          handlers.push(middlewareFactory(action.options, this));
        }
      });
    }

    router[method](route, ...handlers);
    let endpoint = router.opts.prefix ? urlJoin(this.route, router.opts.prefix, route) : urlJoin(this.route, route);
    this.log('verbose', `Route "${method}:${endpoint}" is added from module [${this.name}].`);
    return this;
  }

  addRouter(nestedRouter) {
    this.router.use(nestedRouter.routes());
    this.router.use(nestedRouter.allowedMethods());
    return this;
  }

  toWebPath(relativePath, ...pathOrQuery) {
    let url, query;

    if (pathOrQuery && pathOrQuery.length > 0 && (pathOrQuery.length > 1 || pathOrQuery[0] !== undefined)) {
      if (_.isObject(pathOrQuery[pathOrQuery.length - 1])) {
        query = pathOrQuery.pop();
      }

      pathOrQuery.unshift(relativePath);
      url = urlJoin(this.route, ...pathOrQuery);
    } else {
      url = urlJoin(this.route, relativePath);
    }

    url = ensureLeftSlash(url);

    if (query) {
      url = urlAppendQuery(url, query);
      url = url.replace('/?', '?');
    }

    return url;
  }

  wrapAction(action) {
    return async ctx => {
      Object.assign(ctx.state, {
        _self: ctx.originalUrl || this.toWebPath(ctx.url),
        __: ctx.__,
        _makePath: (relativePath, query) => this.toWebPath(relativePath, query),
        _makeUrl: (relativePath, query) => ctx.origin + this.toWebPath(relativePath, query)
      });

      if (ctx.csrf) {
        ctx.state._csrf = ctx.csrf;
      }

      return action(ctx);
    };
  }

  _useMiddleware(router, middleware) {
    router.use(middleware);
  }

  _getFeatureFallbackPath() {
    return super._getFeatureFallbackPath().concat([this.toAbsolutePath(Literal.BACKEND_PATH, Literal.FEATURES_PATH)]);
  }

};

module.exports = Routable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Sb3V0YWJsZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJ1cmxKb2luIiwiZW5zdXJlTGVmdFNsYXNoIiwidXJsQXBwZW5kUXVlcnkiLCJFcnJvcnMiLCJMaXRlcmFsIiwiS29hIiwiUm91dGFibGUiLCJUIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImJhY2tlbmRQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJCQUNLRU5EX1BBVEgiLCJjbGllbnRQYXRoIiwiQ0xJRU5UX1NSQ19QQVRIIiwicHVibGljUGF0aCIsIlBVQkxJQ19QQVRIIiwicm91dGVyIiwidXNlIiwiY3R4IiwibmV4dCIsImFwcE1vZHVsZSIsIm9uIiwibWlkZGxld2FyZURpciIsIk1JRERMRVdBUkVTX1BBVEgiLCJleGlzdHNTeW5jIiwibG9hZE1pZGRsZXdhcmVzRnJvbSIsInN0YXJ0XyIsIm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkiLCJzdG9wXyIsImRpciIsImZpbGVzIiwic3luYyIsImpvaW4iLCJub2RpciIsImZvckVhY2giLCJmaWxlIiwicmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeSIsImJhc2VuYW1lIiwiZmFjdG9yeU1ldGhvZCIsIlNlcnZlckVycm9yIiwibG9nIiwiZ2V0TWlkZGxld2FyZUZhY3RvcnkiLCJoYXNPd25Qcm9wZXJ0eSIsInNlcnZlciIsInVzZU1pZGRsZXdhcmVzIiwibWlkZGxld2FyZXMiLCJtaWRkbGV3YXJlRmFjdG9yeSIsIm1pZGRsZXdhcmUiLCJtaWRkbGV3YXJlRnVuY3Rpb25zIiwiaXNQbGFpbk9iamVjdCIsImZvck93biIsInB1c2giLCJjYXN0QXJyYXkiLCJlYWNoIiwibWlkZGxld2FyZUVudHJ5IiwidHlwZSIsInVuZGVmaW5lZCIsIkFycmF5IiwiaXNBcnJheSIsIm0iLCJfdXNlTWlkZGxld2FyZSIsImFkZFJvdXRlIiwibWV0aG9kIiwicm91dGUiLCJhY3Rpb25zIiwiaGFuZGxlcnMiLCJsYXN0SW5kZXgiLCJsZW5ndGgiLCJhY3Rpb24iLCJpIiwiaW5kZXhPZiIsImVuZHBvaW50Iiwib3B0cyIsInByZWZpeCIsImFkZFJvdXRlciIsIm5lc3RlZFJvdXRlciIsInJvdXRlcyIsImFsbG93ZWRNZXRob2RzIiwidG9XZWJQYXRoIiwicmVsYXRpdmVQYXRoIiwicGF0aE9yUXVlcnkiLCJ1cmwiLCJxdWVyeSIsImlzT2JqZWN0IiwicG9wIiwidW5zaGlmdCIsInJlcGxhY2UiLCJ3cmFwQWN0aW9uIiwiT2JqZWN0IiwiYXNzaWduIiwic3RhdGUiLCJfc2VsZiIsIm9yaWdpbmFsVXJsIiwiX18iLCJfbWFrZVBhdGgiLCJfbWFrZVVybCIsIm9yaWdpbiIsImNzcmYiLCJfY3NyZiIsIl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoIiwiY29uY2F0IiwiRkVBVFVSRVNfUEFUSCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxJQUFUO0FBQWVDLEVBQUFBLE9BQWY7QUFBd0JDLEVBQUFBLGVBQXhCO0FBQXlDQyxFQUFBQTtBQUF6QyxJQUE0RE4sT0FBTyxDQUFDLFVBQUQsQ0FBekU7O0FBQ0EsTUFBTU8sTUFBTSxHQUFHUCxPQUFPLENBQUMsVUFBRCxDQUF0Qjs7QUFDQSxNQUFNUSxPQUFPLEdBQUdSLE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFDQSxNQUFNUyxHQUFHLEdBQUdULE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUVBLE1BQU1VLFFBQVEsR0FBR0MsQ0FBQyxJQUFJLGNBQWNBLENBQWQsQ0FBZ0I7QUFRbENDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCLFVBQU1ELElBQU4sRUFBWUMsT0FBWjtBQU1BLFNBQUtDLFdBQUwsR0FBbUIsS0FBS0Ms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QUFDNUMsTUFBRCxFQUFTK0IsVUFBVCxFQUFxQjtBQUMvQi9CLElBQUFBLE1BQU0sQ0FBQ0MsR0FBUCxDQUFXOEIsVUFBWDtBQUNIOztBQUVEb0QsRUFBQUEsdUJBQXVCLEdBQUc7QUFDdEIsV0FBTyxNQUFNQSx1QkFBTixHQUFnQ0MsTUFBaEMsQ0FBdUMsQ0FBRSxLQUFLMUYsY0FBTCxDQUFvQlIsT0FBTyxDQUFDUyxZQUE1QixFQUEwQ1QsT0FBTyxDQUFDbUcsYUFBbEQsQ0FBRixDQUF2QyxDQUFQO0FBQ0g7O0FBalNpQyxDQUF0Qzs7QUFvU0FDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5HLFFBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBnbG9iLCB1cmxKb2luLCBlbnN1cmVMZWZ0U2xhc2gsIHVybEFwcGVuZFF1ZXJ5IH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgRXJyb3JzID0gcmVxdWlyZSgnLi9FcnJvcnMnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuY29uc3QgS29hID0gcmVxdWlyZSgna29hJyk7XG5cbmNvbnN0IFJvdXRhYmxlID0gVCA9PiBjbGFzcyBleHRlbmRzIFQgeyAgICBcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHJvdXRhYmxlIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFJvdXRhYmxlIG9wdGlvbnMgICAgICAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYmFja2VuZFBhdGg9J3NlcnZlciddIC0gUmVsYXRpdmUgcGF0aCBvZiBiYWNrLWVuZCBzZXJ2ZXIgc291cmNlIGZpbGVzXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNsaWVudFBhdGg9J2NsaWVudCddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgY2xpZW50IHNvdXJjZSBmaWxlcyAgICAgXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnB1YmxpY1BhdGg9J3B1YmxpYyddIC0gUmVsYXRpdmUgcGF0aCBvZiBmcm9udC1lbmQgc3RhdGljIGZpbGVzIFxuICAgICAqLyAgICAgICAgIFxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIobmFtZSwgb3B0aW9ucyk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEJhY2tlbmQgZmlsZXMgcGF0aC5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMuYmFja2VuZFBhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5iYWNrZW5kUGF0aCB8fCBMaXRlcmFsLkJBQ0tFTkRfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZyb250ZW5kIHNvdXJjZSBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5jbGllbnRQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuY2xpZW50UGF0aCB8fCBMaXRlcmFsLkNMSUVOVF9TUkNfUEFUSCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZyb250ZW5kIHN0YXRpYyBmaWxlcyBwYXRoLlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5wdWJsaWNQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMucHVibGljUGF0aCB8fCBMaXRlcmFsLlBVQkxJQ19QQVRIKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRWFjaCBhcHAgaGFzIGl0cyBvd24gcm91dGVyLlxuICAgICAgICAgKiBAbWVtYmVyIHtLb2F9XG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5yb3V0ZXIgPSBuZXcgS29hKCk7XG5cbiAgICAgICAgLy9pbmplY3QgdGhlIGFwcE1vZHVsZSBpbnN0YW5jZSBpbiB0aGUgZmlyc3QgbWlkZGxld2FyZVxuICAgICAgICB0aGlzLnJvdXRlci51c2UoKGN0eCwgbmV4dCkgPT4geyBcbiAgICAgICAgICAgIGN0eC5hcHBNb2R1bGUgPSB0aGlzOyByZXR1cm4gbmV4dCgpOyBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5vbignY29uZmlnTG9hZGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgLy9sb2FkIG1pZGRsZXdhcmVzIGlmIGV4aXN0cyBpbiBzZXJ2ZXIgb3IgYXBwIHBhdGhcbiAgICAgICAgICAgIGxldCBtaWRkbGV3YXJlRGlyID0gdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLk1JRERMRVdBUkVTX1BBVEgpO1xuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobWlkZGxld2FyZURpcikpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRNaWRkbGV3YXJlc0Zyb20obWlkZGxld2FyZURpcik7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRfKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogTWlkZGxld2FyZSBmYWN0b3J5IHJlZ2lzdHJ5LlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnkgPSB7fTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcF8oKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm1pZGRsZXdhcmVGYWN0b3J5UmVnaXN0cnk7XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLnN0b3BfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBhbmQgcmVnc2l0ZXIgbWlkZGxld2FyZSBmaWxlcyBmcm9tIGEgc3BlY2lmaWVkIHBhdGguXG4gICAgICogQHBhcmFtIGRpclxuICAgICAqL1xuICAgIGxvYWRNaWRkbGV3YXJlc0Zyb20oZGlyKSB7XG4gICAgICAgIGxldCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLmpvaW4oZGlyLCAnKi5qcycpLCB7bm9kaXI6IHRydWV9KTtcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHRoaXMucmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShwYXRoLmJhc2VuYW1lKGZpbGUsICcuanMnKSwgcmVxdWlyZShmaWxlKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG5hbWVkIG1pZGRsZXdhcmUuICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBtaWRkbGV3YXJlIFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnlNZXRob2QgLSBUaGUgZmFjdG9yeSBtZXRob2Qgb2YgYSBtaWRkbGV3YXJlXG4gICAgICovXG4gICAgcmVnaXN0ZXJNaWRkbGV3YXJlRmFjdG9yeShuYW1lLCBmYWN0b3J5TWV0aG9kKSB7XG4gICAgICAgIHByZTogdHlwZW9mIGZhY3RvcnlNZXRob2QgPT09ICdmdW5jdGlvbicsICdJbnZhbGlkIG1pZGRsZXdhcmUgZmFjdG9yeTogJyArIG5hbWU7XG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKCdNaWRkbGV3YXJlIFwiJysgbmFtZSArJ1wiIGFscmVhZHkgcmVnaXN0ZXJlZCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWlkZGxld2FyZUZhY3RvcnlSZWdpc3RyeVtuYW1lXSA9IGZhY3RvcnlNZXRob2Q7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFJlZ2lzdGVyZWQgbmFtZWQgbWlkZGxld2FyZSBbJHtuYW1lfV0uYCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSBmYWN0b3J5IG1ldGhvZCBvZiBhIG1pZGRsZXdhcmUgZnJvbSBtb2R1bGUgaGllcmFyY2h5LiAgICAgXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb259XG4gICAgICovXG4gICAgZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5taWRkbGV3YXJlRmFjdG9yeVJlZ2lzdHJ5W25hbWVdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc2VydmVyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXJ2ZXIuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLlNlcnZlckVycm9yKGBEb24ndCBrbm93IHdoZXJlIHRvIGxvYWQgbWlkZGxld2FyZSBcIiR7bmFtZX1cIi5gKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVc2UgbWlkZGxld2FyZXNcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gcm91dGVyXG4gICAgICogQHBhcmFtIHsqfSBtaWRkbGV3YXJlcyAtIENhbiBiZSBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIGVudHJpZXMgb3IgYSBrZXktdmFsdWUgbGlzdCBvZiByZWdpc3RlcnJlZCBtaWRkbGV3YXJlc1xuICAgICAqIEByZXR1cm5zIHtSb3V0YWJsZX1cbiAgICAgKi9cbiAgICB1c2VNaWRkbGV3YXJlcyhyb3V0ZXIsIG1pZGRsZXdhcmVzKSB7XG4gICAgICAgIGxldCBtaWRkbGV3YXJlRmFjdG9yeSwgbWlkZGxld2FyZTtcbiAgICAgICAgbGV0IG1pZGRsZXdhcmVGdW5jdGlvbnMgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QobWlkZGxld2FyZXMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihtaWRkbGV3YXJlcywgKG9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkobmFtZSk7ICAgXG4gICAgICAgICAgICAgICAgbWlkZGxld2FyZSA9IG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpO1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWUsIG1pZGRsZXdhcmUgfSk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtaWRkbGV3YXJlcyA9IF8uY2FzdEFycmF5KG1pZGRsZXdhcmVzKTsgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKG1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlRW50cnkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdHlwZW9mIG1pZGRsZXdhcmVFbnRyeTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KG1pZGRsZXdhcmVFbnRyeSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeSh1bmRlZmluZWQsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkgLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRnVuY3Rpb25zLnB1c2goeyBuYW1lOiBtaWRkbGV3YXJlRW50cnkubmFtZSB8fCAndW5hbWVkIG1pZGRsZXdhcmUnLCBtaWRkbGV3YXJlOiBtaWRkbGV3YXJlRW50cnl9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IF8uaXNQbGFpbk9iamVjdChtaWRkbGV3YXJlRW50cnkpICYmICduYW1lJyBpbiBtaWRkbGV3YXJlRW50cnksICdJbnZhbGlkIG1pZGRsZXdhcmUgZW50cnknO1xuXG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlRmFjdG9yeShtaWRkbGV3YXJlRW50cnkub3B0aW9ucywgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGdW5jdGlvbnMucHVzaCh7IG5hbWU6IG1pZGRsZXdhcmVFbnRyeS5uYW1lLCBtaWRkbGV3YXJlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgbWlkZGxld2FyZUZ1bmN0aW9ucy5mb3JFYWNoKCh7IG5hbWUsIG1pZGRsZXdhcmUgfSkgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobWlkZGxld2FyZSkpIHtcbiAgICAgICAgICAgICAgICBtaWRkbGV3YXJlLmZvckVhY2gobSA9PiB0aGlzLl91c2VNaWRkbGV3YXJlKHJvdXRlciwgbSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl91c2VNaWRkbGV3YXJlKHJvdXRlciwgbWlkZGxld2FyZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEF0dGFjaGVkIG1pZGRsZXdhcmUgWyR7bmFtZX1dLmApO1xuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHJvdXRlIHRvIGEgcm91dGVyLCBza2lwcGVkIHdoaWxlIHRoZSBzZXJ2ZXIgcnVubmluZyBpbiBkZWFmIG1vZGUuICAgICBcbiAgICAgKiBAcGFyYW0gcm91dGVyXG4gICAgICogQHBhcmFtIG1ldGhvZFxuICAgICAqIEBwYXJhbSByb3V0ZVxuICAgICAqIEBwYXJhbSBhY3Rpb25zXG4gICAgICovXG4gICAgYWRkUm91dGUocm91dGVyLCBtZXRob2QsIHJvdXRlLCBhY3Rpb25zKSB7XG4gICAgICAgIGxldCBoYW5kbGVycyA9IFtdLCBtaWRkbGV3YXJlRmFjdG9yeTtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGFjdGlvbnMpKSB7XG4gICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCAob3B0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIG1pZGRsZXdhcmVGYWN0b3J5ID0gdGhpcy5nZXRNaWRkbGV3YXJlRmFjdG9yeShuYW1lKTtcbiAgICAgICAgICAgICAgICBoYW5kbGVycy5wdXNoKG1pZGRsZXdhcmVGYWN0b3J5KG9wdGlvbnMsIHRoaXMpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWN0aW9ucyA9IF8uY2FzdEFycmF5KGFjdGlvbnMpO1xuICAgICAgICAgICAgbGV0IGxhc3RJbmRleCA9IGFjdGlvbnMubGVuZ3RoIC0gMTtcblxuICAgICAgICAgICAgXy5lYWNoKGFjdGlvbnMsIChhY3Rpb24sIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVvZiBhY3Rpb247XG5cbiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gbGFzdEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxhc3QgbWlkZGxld2FyZSBtYXkgYmUgYW4gYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJyAmJiBhY3Rpb24uaW5kZXhPZignLicpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdhY3Rpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IGFjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdvYmplY3QnO1xuICAgICAgICAgICAgICAgICAgICB9ICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBbICduYW1lZE1pZGRsZXdhcmUnIF1cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvbik7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaChtaWRkbGV3YXJlRmFjdG9yeShudWxsLCB0aGlzKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2goYWN0aW9uKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYWN0aW9uKSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IGFjdGlvbi5sZW5ndGggPiAwICYmIGFjdGlvbi5sZW5ndGggPD0gMiwgJ0ludmFsaWQgbWlkZGxld2FyZSBlbnRyeSc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWlkZGxld2FyZUZhY3RvcnkgPSB0aGlzLmdldE1pZGRsZXdhcmVGYWN0b3J5KGFjdGlvblswXSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnMucHVzaChtaWRkbGV3YXJlRmFjdG9yeShhY3Rpb24ubGVuZ3RoID4gMSA/IGFjdGlvblsxXSA6IHVuZGVmaW5lZCwgdGhpcykpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBfLmlzUGxhaW5PYmplY3QoYWN0aW9uKSAmJiAnbmFtZScgaW4gYWN0aW9uLCAnSW52YWxpZCBtaWRkbGV3YXJlIGVudHJ5JztcblxuICAgICAgICAgICAgICAgICAgICBtaWRkbGV3YXJlRmFjdG9yeSA9IHRoaXMuZ2V0TWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm5hbWUpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzLnB1c2gobWlkZGxld2FyZUZhY3RvcnkoYWN0aW9uLm9wdGlvbnMsIHRoaXMpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgcm91dGVyW21ldGhvZF0ocm91dGUsIC4uLmhhbmRsZXJzKTtcblxuICAgICAgICBsZXQgZW5kcG9pbnQgPSByb3V0ZXIub3B0cy5wcmVmaXggPyB1cmxKb2luKHRoaXMucm91dGUsIHJvdXRlci5vcHRzLnByZWZpeCwgcm91dGUpIDogdXJsSm9pbih0aGlzLnJvdXRlLCByb3V0ZSk7XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgUm91dGUgXCIke21ldGhvZH06JHtlbmRwb2ludH1cIiBpcyBhZGRlZCBmcm9tIG1vZHVsZSBbJHt0aGlzLm5hbWV9XS5gKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9ICAgIFxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoIGEgcm91dGVyIHRvIHRoaXMgYXBwIG1vZHVsZSwgc2tpcHBlZCB3aGlsZSB0aGUgc2VydmVyIHJ1bm5pbmcgaW4gZGVhZiBtb2RlICAgICBcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gbmVzdGVkUm91dGVyXG4gICAgICovXG4gICAgYWRkUm91dGVyKG5lc3RlZFJvdXRlcikge1xuICAgICAgICB0aGlzLnJvdXRlci51c2UobmVzdGVkUm91dGVyLnJvdXRlcygpKTtcbiAgICAgICAgdGhpcy5yb3V0ZXIudXNlKG5lc3RlZFJvdXRlci5hbGxvd2VkTWV0aG9kcygpKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGEgcmVsYXRpdmUgcGF0aCBhbmQgcXVlcnkgcGFyYW1ldGVycyBpZiBhbnkgdG8gYSB1cmwgcGF0aCAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJlbGF0aXZlUGF0aCAtIFJlbGF0aXZlIHBhdGhcbiAgICAgKiBAcGFyYW0gey4uLip9IFtwYXRoT3JRdWVyeV0gLSBRdWVyaWVzXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICB0b1dlYlBhdGgocmVsYXRpdmVQYXRoLCAuLi5wYXRoT3JRdWVyeSkge1xuICAgICAgICBsZXQgdXJsLCBxdWVyeTtcblxuICAgICAgICBpZiAocGF0aE9yUXVlcnkgJiYgcGF0aE9yUXVlcnkubGVuZ3RoID4gMCAmJiAocGF0aE9yUXVlcnkubGVuZ3RoID4gMSB8fCBwYXRoT3JRdWVyeVswXSAhPT0gdW5kZWZpbmVkKSkge1xuICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QocGF0aE9yUXVlcnlbcGF0aE9yUXVlcnkubGVuZ3RoIC0gMV0pKSB7XG4gICAgICAgICAgICAgICAgcXVlcnkgPSBwYXRoT3JRdWVyeS5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhdGhPclF1ZXJ5LnVuc2hpZnQocmVsYXRpdmVQYXRoKTtcbiAgICAgICAgICAgIHVybCA9IHVybEpvaW4odGhpcy5yb3V0ZSwgLi4ucGF0aE9yUXVlcnkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXJsID0gdXJsSm9pbih0aGlzLnJvdXRlLCByZWxhdGl2ZVBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdXJsID0gZW5zdXJlTGVmdFNsYXNoKHVybCk7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgdXJsID0gdXJsQXBwZW5kUXVlcnkodXJsLCBxdWVyeSk7XG4gICAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgnLz8nLCAnPycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVybDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQcmVwYXJlIGNvbnRleHQgZm9yIGtvYSBhY3Rpb25cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gY3R4IC0gS29hIHJlcXVlc3QgY29udGV4dFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGFjdGlvbiAtIEFjdGlvbiBmdW5jdGlvblxuICAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufVxuICAgICAqL1xuICAgIHdyYXBBY3Rpb24oYWN0aW9uKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGN0eC5zdGF0ZSwge1xuICAgICAgICAgICAgICAgIF9zZWxmOiBjdHgub3JpZ2luYWxVcmwgfHwgdGhpcy50b1dlYlBhdGgoY3R4LnVybCksXG4gICAgICAgICAgICAgICAgX186IGN0eC5fXyxcbiAgICAgICAgICAgICAgICBfbWFrZVBhdGg6IChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSA9PiB0aGlzLnRvV2ViUGF0aChyZWxhdGl2ZVBhdGgsIHF1ZXJ5KSxcbiAgICAgICAgICAgICAgICBfbWFrZVVybDogKHJlbGF0aXZlUGF0aCwgcXVlcnkpID0+IChjdHgub3JpZ2luICsgdGhpcy50b1dlYlBhdGgocmVsYXRpdmVQYXRoLCBxdWVyeSkpICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGN0eC5jc3JmKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY3R4LnN0YXRlLl9jc3JmID0gY3R4LmNzcmY7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBhY3Rpb24oY3R4KTtcbiAgICAgICAgfTsgICAgICAgIFxuICAgIH0gICAgICAgXG5cbiAgICBfdXNlTWlkZGxld2FyZShyb3V0ZXIsIG1pZGRsZXdhcmUpIHsgICAgICAgIFxuICAgICAgICByb3V0ZXIudXNlKG1pZGRsZXdhcmUpO1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICByZXR1cm4gc3VwZXIuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKS5jb25jYXQoWyB0aGlzLnRvQWJzb2x1dGVQYXRoKExpdGVyYWwuQkFDS0VORF9QQVRILCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF0pO1xuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUm91dGFibGU7Il19